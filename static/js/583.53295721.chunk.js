"use strict";(globalThis.webpackChunkfield_sustainability_helper=globalThis.webpackChunkfield_sustainability_helper||[]).push([[583],{32500:(e,t,i)=>{i.d(t,{I:()=>g,b:()=>u});var a=i(71011),r=i(33280),n=i(94951),s=i(21002),o=i(15226),l=i(10763),h=i(116),c=i(98634),d=i(64201),p=i(4760);function u(e){const t=new d.kG;return t.include(n.w,{linearDepth:!1}),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add(p.T.POSITION,"vec3"),t.attributes.add(p.T.UV0,"vec2"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.uniforms.add("textureCoordinateScaleFactor","vec2"),t.vertex.code.add(c.H`
    void main(void) {
      vpos = position;
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      vTexCoord = uv0 * textureCoordinateScaleFactor;
      gl_Position = transformPosition(proj, view, vpos);
    }
  `),t.include(r.p2,e),e.multipassTerrainEnabled&&(t.fragment.include(s.S),t.include(o.l,e)),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("opacity","float"),t.varyings.add("vTexCoord","vec2"),e.output===a.H.Alpha?t.fragment.code.add(c.H`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

      float alpha = texture2D(tex, vTexCoord).a * opacity;
      if (alpha  < ${c.H.float(l.F)}) {
        discard;
      }

      gl_FragColor = vec4(alpha);
    }
    `):(t.fragment.include(h.Y),t.fragment.code.add(c.H`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      gl_FragColor = texture2D(tex, vTexCoord) * opacity;

      if (gl_FragColor.a < ${c.H.float(l.F)}) {
        discard;
      }

      gl_FragColor = highlightSlice(gl_FragColor, vpos);
      ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    }
    `)),t}const g=Object.freeze({__proto__:null,build:u})},18300:(e,t,i)=>{i.d(t,{L:()=>l,b:()=>o});var a=i(66127),r=i(98634),n=i(64201),s=i(4760);function o(e){const t=new n.kG;return t.include(a.j,e),t.vertex.uniforms.add("modelView","mat4"),t.vertex.uniforms.add("proj","mat4"),t.attributes.add(s.T.START,"vec3"),t.attributes.add(s.T.END,"vec3"),t.attributes.add(s.T.UP,"vec3"),t.attributes.add(s.T.EXTRUDE,"vec2"),t.varyings.add("uv","vec2"),t.varyings.add("vViewStart","vec3"),t.varyings.add("vViewEnd","vec3"),t.varyings.add("vViewPlane","vec4"),t.vertex.uniforms.add("glowWidth","float"),t.vertex.uniforms.add("pixelToNDC","vec2"),t.vertex.code.add(r.H`void main() {
vec3 pos = mix(start, end, extrude.x);
vec4 viewPos = modelView * vec4(pos, 1);
vec4 projPos = proj * viewPos;
vec2 ndcPos = projPos.xy / projPos.w;
vec3 viewUp = (modelView * vec4(extrude.y * up, 0)).xyz;
vec4 projPosUp = proj * vec4(viewPos.xyz + viewUp, 1);
vec2 projExtrudeDir = normalize(projPosUp.xy / projPosUp.w - ndcPos);
vec2 lxy = abs(sign(projExtrudeDir) - ndcPos);
ndcPos += length(lxy) * projExtrudeDir;
vec3 worldPlaneNormal = normalize(cross(up, normalize(end - start)));
vec3 viewPlaneNormal = (modelView * vec4(worldPlaneNormal, 0)).xyz;
vViewStart = (modelView * vec4(start, 1)).xyz;
vViewEnd = (modelView * vec4(end, 1)).xyz;
vViewPlane = vec4(viewPlaneNormal, -dot(viewPlaneNormal, vViewStart));
float xPaddingPixels = sign(dot(viewPlaneNormal, viewPos.xyz)) * (extrude.x * 2.0 - 1.0) * glowWidth;
ndcPos.x += xPaddingPixels * pixelToNDC.x;
uv = ndcPos * 0.5 + 0.5;
gl_Position = vec4(ndcPos, 0, 1);
}`),t.fragment.uniforms.add("globalAlpha","float"),t.fragment.uniforms.add("perScreenPixelRatio","float"),t.fragment.code.add(r.H`float planeDistancePixels(vec4 plane, vec3 pos, vec3 start, vec3 end) {
vec3 origin = mix(start, end, 0.5);
vec3 basis = end - origin;
vec3 posAtOrigin = pos - origin;
float x = dot(normalize(basis), posAtOrigin);
float y = dot(plane.xyz, posAtOrigin);
float dx = max(abs(x) - length(basis), 0.0);
float dy = y;
float dist = length(vec2(dx, dy));
float width = fwidth(y);
float maxPixelDistance = length(pos) * perScreenPixelRatio * 2.0;
float pixelDist = dist / min(width, maxPixelDistance);
return abs(pixelDist);
}
void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
float distance = planeDistancePixels(vViewPlane, pos, vViewStart, vViewEnd);
vec4 color = laserlineProfile(distance);
float alpha = 1.0 - smoothstep(0.995, 0.999, abs(dot(normal, vViewPlane.xyz)));
gl_FragColor = laserlineOutput(color * alpha * depthDiscontinuityAlpha);
}`),t}const l=Object.freeze({__proto__:null,build:o})},83671:(e,t,i)=>{i.d(t,{L:()=>c,b:()=>h,d:()=>l});var a=i(16889),r=i(66127),n=i(74321),s=i(98634),o=i(64201);const l=(0,a.Vl)(6);function h(e){const t=new o.kG;return t.extensions.add("GL_OES_standard_derivatives"),t.include(n.k),t.include(r.j,e),t.fragment.uniforms.add("angleCutoff","vec2"),t.fragment.uniforms.add("globalAlpha","float"),e.heightManifoldEnabled&&t.fragment.uniforms.add("heightPlane","vec4"),e.pointDistanceEnabled&&t.fragment.uniforms.add("pointDistanceSphere","vec4"),e.lineVerticalPlaneEnabled&&t.fragment.uniforms.add("lineVerticalPlane","vec4").add("lineVerticalStart","vec3").add("lineVerticalEnd","vec3"),(e.heightManifoldEnabled||e.pointDistanceEnabled||e.lineVerticalPlaneEnabled)&&t.fragment.uniforms.add("maxPixelDistance","float"),e.intersectsLineEnabled&&t.fragment.uniforms.add("intersectsLineStart","vec3").add("intersectsLineEnd","vec3").add("intersectsLineDirection","vec3").add("intersectsLineRadius","float").add("perScreenPixelRatio","float"),(e.lineVerticalPlaneEnabled||e.heightManifoldEnabled)&&t.fragment.code.add(s.H`float planeDistancePixels(vec4 plane, vec3 pos) {
float dist = dot(plane.xyz, pos) + plane.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),e.pointDistanceEnabled&&t.fragment.code.add(s.H`float sphereDistancePixels(vec4 sphere, vec3 pos) {
float dist = distance(sphere.xyz, pos) - sphere.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),e.intersectsLineEnabled&&t.fragment.code.add(s.H`float lineDistancePixels(vec3 start, vec3 dir, float radius, vec3 pos) {
float dist = length(cross(dir, pos - start)) / (length(pos) * perScreenPixelRatio);
return abs(dist) - radius;
}`),(e.lineVerticalPlaneEnabled||e.intersectsLineEnabled)&&t.fragment.code.add(s.H`bool pointIsWithinLine(vec3 pos, vec3 start, vec3 end) {
vec3 dir = end - start;
float t2 = dot(dir, pos - start);
float l2 = dot(dir, dir);
return t2 >= 0.0 && t2 <= l2;
}`),t.fragment.code.add(s.H`void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
vec4 color = vec4(0, 0, 0, 0);`),e.heightManifoldEnabled&&t.fragment.code.add(s.H`{
float heightManifoldAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, heightPlane.xyz)));
vec4 heightManifoldColor = laserlineProfile(planeDistancePixels(heightPlane, pos));
color = max(color, heightManifoldColor * heightManifoldAlpha);
}`),e.pointDistanceEnabled&&t.fragment.code.add(s.H`{
float pointDistanceSphereDistance = sphereDistancePixels(pointDistanceSphere, pos);
vec4 pointDistanceSphereColor = laserlineProfile(pointDistanceSphereDistance);
float pointDistanceSphereAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, normalize(pos - pointDistanceSphere.xyz))));
color = max(color, pointDistanceSphereColor * pointDistanceSphereAlpha);
}`),e.lineVerticalPlaneEnabled&&t.fragment.code.add(s.H`{
if (pointIsWithinLine(pos, lineVerticalStart, lineVerticalEnd)) {
float lineVerticalDistance = planeDistancePixels(lineVerticalPlane, pos);
vec4 lineVerticalColor = laserlineProfile(lineVerticalDistance);
float lineVerticalAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, lineVerticalPlane.xyz)));
color = max(color, lineVerticalColor * lineVerticalAlpha);
}
}`),e.intersectsLineEnabled&&t.fragment.code.add(s.H`{
if (pointIsWithinLine(pos, intersectsLineStart, intersectsLineEnd)) {
float intersectsLineDistance = lineDistancePixels(intersectsLineStart, intersectsLineDirection, intersectsLineRadius, pos);
vec4 intersectsLineColor = laserlineProfile(intersectsLineDistance);
float intersectsLineAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, 1.0 - abs(dot(normal, intersectsLineDirection)));
color = max(color, intersectsLineColor * intersectsLineAlpha);
}
}`),t.fragment.code.add(s.H`gl_FragColor = laserlineOutput(color * depthDiscontinuityAlpha);
}`),t}const c=Object.freeze({__proto__:null,defaultAngleCutoff:l,build:h})},72511:(e,t,i)=>{i.d(t,{S:()=>m,b:()=>g});var a=i(43505),r=i(71011),n=i(33280),s=i(94951),o=i(21002),l=i(15226),h=i(10763),c=i(116),d=i(98634),p=i(64201),u=i(4760);function g(e){const t=new p.kG;return t.include(s.w,{linearDepth:!1}),t.include(a.A,{}),t.include(n.p2,e),t.fragment.include(c.Y),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.fragment.uniforms.add("uColor","vec4"),t.attributes.add(u.T.POSITION,"vec3"),t.varyings.add("vWorldPosition","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),e.screenSizeEnabled&&t.attributes.add(u.T.OFFSET,"vec3"),e.shadingEnabled&&(t.vertex.uniforms.add("viewNormal","mat4"),t.fragment.uniforms.add("shadedColor","vec4").add("shadingDirection","vec3"),t.attributes.add(u.T.NORMAL,"vec3"),t.varyings.add("vViewNormal","vec3")),t.vertex.code.add(d.H`
    void main(void) {
      vWorldPosition = ${e.screenSizeEnabled?"screenSizeScaling(offset, position)":"position"};
  `),e.shadingEnabled&&t.vertex.code.add(d.H`vec3 worldNormal = normal;
vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`),t.vertex.code.add(d.H`
    ${e.multipassTerrainEnabled?"depth = (view * vec4(vWorldPosition, 1.0)).z;":""}
    gl_Position = transformPosition(proj, view, vWorldPosition);
  }
  `),e.multipassTerrainEnabled&&(t.fragment.include(o.S),t.include(l.l,e)),t.fragment.code.add(d.H`
    void main() {
      discardBySlice(vWorldPosition);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    `),e.shadingEnabled?t.fragment.code.add(d.H`vec3 viewNormalNorm = normalize(vViewNormal);
float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`):t.fragment.code.add(d.H`vec4 finalColor = uColor;`),t.fragment.code.add(d.H`
      if (finalColor.a < ${d.H.float(h.bf)}) {
        discard;
      }
      ${e.output===r.H.Alpha?d.H`gl_FragColor = vec4(finalColor.a);`:""}

      ${e.output===r.H.Color?d.H`gl_FragColor = highlightSlice(finalColor, vWorldPosition); ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    }
    `),t}const m=Object.freeze({__proto__:null,build:g})},11316:(e,t,i)=>{i.d(t,{S:()=>o,b:()=>s});var a=i(98634),r=i(64201),n=i(4760);function s(){const e=new r.kG;return e.extensions.add("GL_OES_standard_derivatives"),e.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.attributes.add(n.T.POSITION,"vec3"),e.attributes.add(n.T.UV0,"vec2"),e.varyings.add("vUV","vec2"),e.vertex.code.add(a.H`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),e.fragment.uniforms.add("backgroundColor","vec4").add("gridColor","vec4").add("ratio","float").add("gridWidth","float"),e.fragment.code.add(a.H`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),e}const o=Object.freeze({__proto__:null,build:s})},151:(e,t,i)=>{function a(){return new Float32Array(4)}function r(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function n(e,t,i,a){const r=new Float32Array(4);return r[0]=e,r[1]=t,r[2]=i,r[3]=a,r}function s(){return a()}function o(){return n(1,1,1,1)}function l(){return n(1,0,0,0)}function h(){return n(0,1,0,0)}function c(){return n(0,0,1,0)}function d(){return n(0,0,0,1)}i.d(t,{a:()=>r,f:()=>n});const p=s(),u=o(),g=l(),m=h(),_=c(),f=d();Object.freeze({__proto__:null,create:a,clone:r,fromValues:n,createView:function(e,t){return new Float32Array(e,t,4)},zeros:s,ones:o,unitX:l,unitY:h,unitZ:c,unitW:d,ZEROS:p,ONES:u,UNIT_X:g,UNIT_Y:m,UNIT_Z:_,UNIT_W:f})},66576:(e,t,i)=>{i.d(t,{B:()=>_});var a=i(92026),r=i(80292),n=i(35995),s=i(71907),o=i(33397),l=i(25265),h=i(49861);function c(e){return d[function(e){return e instanceof Blob?e.type:function(e){const t=(0,n.Ml)(e);return g[t]||p}(e.url)}(e)]||u}const d={},p="text/plain",u=d[p],g={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip"};for(const b in g)d[g[b]]=b;var m=i(53283);function _(e){const t=(0,a.pC)(e)&&e.origins?e.origins:[void 0];return(i,s)=>{const d=function(e,t,i){if((0,a.pC)(e)&&"resource"===e.type)return function(e,t,i){const s=(0,o.VZ)(t,i);return{type:String,read:(e,t,i)=>{const a=(0,m.r)(e,t,i);return s.type===String?a:"function"==typeof s.type?new s.type({url:a}):void 0},write:{writer(t,o,h,d){if(!d||!d.resources)return"string"==typeof t?void(o[h]=(0,m.t)(t,d)):void(o[h]=t.write({},d));const p=function(e){return(0,a.Wi)(e)?null:"string"==typeof e?e:e.url}(t),u=p?(0,m.t)(p,{...d,verifyItemRelativeUrls:d&&d.verifyItemRelativeUrls?{writtenUrls:d.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null},m.M.NO):null,g=s.type!==String&&(!(0,r.l)(this)||d&&d.origin&&this.originIdOf(i)>(0,l.M9)(d.origin));d&&d.portalItem&&(0,a.pC)(u)&&!(0,n.YP)(u)?g?function(e,t,i,a,r,s,o,l){const h=o.portalItem.resourceFromPath(a),d=y(i,a,o);c(d)===(0,n.Ml)(h.path)?(v(e,t,h,d,o.resources.toUpdate),r[s]=a):f(e,t,i,a,r,s,o,l)}(this,i,t,u,o,h,d,e):function(e,t,i,a){a.resources.toKeep.push({resource:a.portalItem.resourceFromPath(e)}),t[i]=e}(u,o,h,d):d&&d.portalItem&&((0,a.Wi)(u)||(0,a.pC)((0,m.i)(u))||(0,n.jc)(u)||g)?f(this,i,t,u,o,h,d,e):o[h]=u}}}}(e,t,i);switch((0,a.pC)(e)&&e.type?e.type:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:t}=m.p;return{read:e,write:t}}}}(e,i,s);for(const e of t){const t=(0,h.CJ)(i,e,s);for(const e in d)t[e]=d[e]}}}function f(e,t,r,o,l,h,d,p){const u=(0,s.D)(),g=y(r,o,d),m=(0,n.v_)((0,a.U2)(p,"prefix"),u),_=`${m}.${c(g)}`,f=d.portalItem.resourceFromPath(_);(0,n.jc)(o)&&d.resources.pendingOperations.push(async function(e){const t=(await Promise.resolve().then(i.bind(i,76200))).default,{data:a}=await t(e,{responseType:"blob"});return a}(o).then((e=>{f.path=`${m}.${c(e)}`,l[h]=f.itemRelativeUrl})).catch((()=>{}))),v(e,t,f,g,d.resources.toAdd),l[h]=f.itemRelativeUrl}function v(e,t,i,a,r){r.push({resource:i,content:a,finish:i=>{!function(e,t,i){"string"==typeof e[t]?e[t]=i.url:e[t].url=i.url}(e,t,i)}})}function y(e,t,i){return"string"==typeof e?{url:t}:new Blob([JSON.stringify(e.toJSON(i))],{type:"application/json"})}},45238:(e,t,i)=>{i.d(t,{EU:()=>d,Ue:()=>o,WH:()=>p,ZZ:()=>c,qC:()=>h,uT:()=>l});var a=i(16889),r=i(48976),n=i(98131),s=i(11186);function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:g;return[e[0],e[1],e[2],e[3]]}function l(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o();return(0,s.g)(i,e),i[3]=t,i}function h(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o();return(0,r.s)(m,e,p(e)),(0,r.s)(_,t,p(t)),(0,r.m)(m,_,m),u(i,(0,a.BV)((0,r.g)(i,m)))}function c(e){return e}function d(e){return e[3]}function p(e){return(0,a.Vl)(e[3])}function u(e,t){return e[3]=t,e}const g=[0,0,1,0],m=(0,n.a)(),_=(0,n.a)();o()},96669:(e,t,i)=>{function a(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function r(e,t){return"number"==typeof e?e:e&&e.stops&&e.stops.length?function(e){let t=0,i=0;for(let a=0;a<e.length;a++){const r=e[a].size;"number"==typeof r&&(t+=r,i++)}return t/i}(e.stops):t}function n(e,t){if(!t)return e;const i=t.filter((e=>"size"===e.type)).map((t=>{const{maxSize:i,minSize:a}=t;return(r(i,e)+r(a,e))/2}));let a=0;const n=i.length;if(0===n)return e;for(let r=0;r<n;r++)a+=i[r];const s=Math.floor(a/n);return Math.max(s,e)}function s(e){const t=e&&e.renderer,i="touch"===(e&&e.event&&e.event.pointerType)?9:6;if(!t)return i;const r="visualVariables"in t?n(i,t.visualVariables):i;if("simple"===t.type)return a(r,t.symbol);if("unique-value"===t.type){let e=r;return t.uniqueValueInfos.forEach((t=>{e=a(e,t.symbol)})),e}if("class-breaks"===t.type){let e=r;return t.classBreakInfos.forEach((t=>{e=a(e,t.symbol)})),e}return t.type,r}i.d(t,{k:()=>s})},50583:(e,t,i)=>{i.r(t),i.d(t,{DrawGraphicTool3D:()=>mi,ExtentTransformTool:()=>Bn,GraphicMoveTool:()=>tr,GraphicReshapeTool:()=>Mr,GraphicTransformTool:()=>Wr});var a=i(27366),r=i(42537),n=i(92026),s=i(8537),o=i(49861),l=(i(63780),i(93169)),h=i(25243),c=i(69912),d=i(74509),p=i(64575),u=i(51995),g=i(11186),m=i(71353),_=i(100),f=i(90045),v=i(151),y=i(70444),b=i(95773),M=i(85981),S=i(40885);class w{constructor(e){this._attached=!1,this._resourcesCreated=!1,this._visible=!0,this.view=e,this.view.watch("ready",(e=>{this._resourcesCreated&&(e?this._createResources():this._destroyResources())}))}applyProps(e){let t=!1;for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.attached=!1}get attached(){return this._attached}set attached(e){e!==this._attached&&this.view._stage&&(this._attached=e,this._attached&&!this._resourcesCreated?this._createResources():!this._attached&&this._resourcesCreated&&this._destroyResources())}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.attached&&this.updateVisibility(e))}_createResources(){this.createResources(),this._resourcesCreated=!0,this.visible||this.updateVisibility(!1)}_destroyResources(){this.destroyResources(),this._resourcesCreated=!1}}var E=i(16889),x=i(6394),C=i(67077),O=i(55652),A=i(23470),P=i(50256),D=i(55158),R=i(4760),T=i(14226),L=i(81949),G=i(82144),V=i(31132),I=i(33559),z=i(27627),W=i(18300),N=i(8548),U=i(36207);class F extends V.A{initializeProgram(e){const t=F.shader.get(),i=this.configuration,a=t.build(i);return new z.$(e.rctx,a,F.attributeLocations)}bind(e,t,i){this.program.setUniform3fv("innerColor",e.innerColor),this.program.setUniform1f("innerWidth",e.innerWidth*i.pixelRatio),this.program.setUniform3fv("glowColor",e.glowColor),this.program.setUniform1f("glowWidth",e.glowWidth*i.pixelRatio),this.program.setUniform1f("glowFalloff",e.glowFalloff),this.program.setUniform1f("globalAlpha",e.globalAlpha),this.program.setUniform1f("perScreenPixelRatio",i.perScreenPixelRatio),this.program.setUniform2f("pixelToNDC",2/i.fullWidth,2/i.fullHeight),this.program.setUniformMatrix4fv("proj",i.projectionMatrix),(0,T.j)(k,i.viewMatrix,t),this.program.setUniformMatrix4fv("modelView",k),this.configuration.contrastControlEnabled&&this.program.setUniform1f("globalAlphaContrastBoost",null!=e.globalAlphaContrastBoost?e.globalAlphaContrastBoost:1)}initializePipeline(){return(0,U.sm)({blending:(0,U.if)(N.zi.ONE,N.zi.ONE_MINUS_SRC_ALPHA),colorWrite:U.BK})}}F.shader=new G.J(W.L,(()=>i.e(7515).then(i.bind(i,97515)))),F.attributeLocations=new Map([[R.T.START,0],[R.T.END,1],[R.T.UP,2],[R.T.EXTRUDE,3]]);class H extends I.m{constructor(){super(...arguments),this.contrastControlEnabled=!1}}(0,a._)([(0,I.o)()],H.prototype,"contrastControlEnabled",void 0);const k=(0,L.c)();var j=i(44070),Z=i(45412);class B{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=(0,m.c)(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const t=new Float64Array(3*e.length);let i=0;for(const a of e)t[i++]=a[0],t[i++]=a[1],t[i++]=a[2];this.buffers=[t]}set buffers(e){if(this._buffers=e,this._buffers.length>0){const e=this._buffers[0],t=3*Math.floor(e.length/3/2);(0,g.s)(this._origin,e[t+0],e[t+1],e[t+2])}else(0,g.s)(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){const t=this._ensureVAO(e);(0,n.pC)(t)&&(e.bindVAO(t),e.drawArrays(N.MX.TRIANGLES,0,this._count))}dispose(){(0,n.pC)(this._vao)&&this._vao.dispose()}_ensureVAO(e){return(0,n.Wi)(this._buffers)?null:((0,n.Wi)(this._vao)&&(this._vao=this._createVAO(e,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,t){const i=this._createDataBuffer(t);return this._dirty=!1,new Z.U(e,F.attributeLocations,{data:(0,P.K)(X)},{data:j.f.createVertex(e,N.l1.STATIC_DRAW,i)})}_ensureVertexData(e,t){if(!this._dirty)return;const i=this._createDataBuffer(t);e.vertexBuffers.data.setData(i),this._dirty=!1}_numberOfRenderVertices(e){return 2*(e.length/3-1)*3}_createDataBuffer(e){const t=e.reduce(((e,t)=>e+this._numberOfRenderVertices(t)),0);this._count=t;const i=X.createBuffer(t),a=this._origin;let r=0,n=0;for(const s of e){for(let e=0;e<s.length;e+=3){const t=(0,g.s)(Y,s[e+0],s[e+1],s[e+2]);0===e?n=this._renderCoordsHelper.getAltitude(t):this._renderCoordsHelper.setAltitude(t,n);const o=this._renderCoordsHelper.worldUpAtPosition(t,q),l=r+2*e,h=(0,g.f)(Y,t,a);if(e<s.length-3){i.up.setVec(l,o),i.up.setVec(l+3,o),i.up.setVec(l+5,o);for(let e=0;e<6;e++)i.start.setVec(l+e,h);i.extrude.setValues(l+0,0,-1),i.extrude.setValues(l+1,1,-1),i.extrude.setValues(l+2,1,1),i.extrude.setValues(l+3,0,-1),i.extrude.setValues(l+4,1,1),i.extrude.setValues(l+5,0,1)}if(e>0){i.up.setVec(l-2,o),i.up.setVec(l-4,o),i.up.setVec(l-5,o);for(let e=-6;e<0;e++)i.end.setVec(l+e,h)}}r+=this._numberOfRenderVertices(s)}return i.buffer}}const q=(0,m.c)(),Y=(0,m.c)(),X=(0,D.U$)().vec3f(R.T.START).vec3f(R.T.END).vec3f(R.T.UP).vec2f(R.T.EXTRUDE);var Q=i(32534),K=i(93822),J=i(97731),$=i(22909),ee=i(7566),te=i(83671);class ie extends V.A{initializeProgram(e){const t=ie.shader.get(),i=this.configuration,a=t.build(i);return new z.$(e.rctx,a,ee.i)}bind(e,t){this.program.setUniform3fv("innerColor",e.innerColor),this.program.setUniform1f("innerWidth",e.innerWidth*t.pixelRatio),this.program.setUniform3fv("glowColor",e.glowColor),this.program.setUniform1f("glowWidth",e.glowWidth*t.pixelRatio),this.program.setUniform1f("glowFalloff",e.glowFalloff),this.program.setUniform1f("globalAlpha",e.globalAlpha),this.configuration.contrastControlEnabled&&this.program.setUniform1f("globalAlphaContrastBoost",null!=e.globalAlphaContrastBoost?e.globalAlphaContrastBoost:1);const i=null!=e.angleCutoff?e.angleCutoff:te.d;this.program.setUniform2f("angleCutoff",Math.cos(i),Math.cos(Math.max(0,i-(0,E.Vl)(2)))),this.configuration.intersectsLineEnabled&&this.program.setUniform1f("perScreenPixelRatio",t.perScreenPixelRatio)}initializePipeline(){return(0,U.sm)({blending:(0,U.if)(N.zi.ONE,N.zi.ONE_MINUS_SRC_ALPHA),colorWrite:U.BK})}}ie.shader=new G.J(te.L,(()=>i.e(5693).then(i.bind(i,45693))));class ae extends I.m{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1,this.contrastControlEnabled=!1}}(0,a._)([(0,I.o)()],ae.prototype,"heightManifoldEnabled",void 0),(0,a._)([(0,I.o)()],ae.prototype,"pointDistanceEnabled",void 0),(0,a._)([(0,I.o)()],ae.prototype,"lineVerticalPlaneEnabled",void 0),(0,a._)([(0,I.o)()],ae.prototype,"intersectsLineEnabled",void 0),(0,a._)([(0,I.o)()],ae.prototype,"contrastControlEnabled",void 0);const re=(0,m.c)(),ne=(0,C.c)(),se={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:(0,E.Vl)(6),globalAlphaContrastBoost:2};function oe(e,t,i,a){const r=re,n=ne;(0,g.m)(r,t,a),(0,g.g)(n,i),n[3]=0,(0,f.t)(n,n,a),(0,O.Yq)(r,n,e)}class le{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{contrastControlEnabled:!1};this._renderCoordsHelper=e,this._config=i,this._technique=null,this._projInfo=(0,C.c)(),this._zScale=(0,x.a)(),this._heightManifoldEnabled=!1,this._heightManifoldTarget=(0,m.c)(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=(0,m.c)(),this._pointDistanceTarget=(0,m.c)(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=(0,M.Ue)(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=(0,M.Ue)(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=(0,m.c)(),this._tempDir=(0,m.c)(),this._tempUp=(0,m.c)(),this._tempVec3A=(0,m.c)(),this._tempVec3B=(0,m.c)(),this._tempVec4=(0,C.c)(),this._tempPlane=(0,O.Ue)(),this._tempSphere=(0,A.c)(),this._params=(0,$.Uf)(t,se)}get renderSlots(){return[this._config.contrastControlEnabled?K.r.LASERLINES_CONTRAST_CONTROL:K.r.LASERLINES]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._heightManifoldTarget}set heightManifoldTarget(e){(0,g.g)(this._heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._pointDistanceTarget}set pointDistanceTarget(e){(0,g.g)(this._pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._pointDistanceOrigin}set pointDistanceOrigin(e){(0,g.g)(this._pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){(0,M.JG)(e,this._lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._intersectsLineSegment}set intersectsLineSegment(e){(0,M.JG)(e,this._intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._intersectsLineRadius}set intersectsLineRadius(e){e!==this._intersectsLineRadius&&(this._intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,(0,n.pC)(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){(0,n.Wi)(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new B(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){(0,n.Wi)(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new B(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(e){(0,$.LO)(this._params,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx;this._quadVAO=(0,Q.ow)(t),this._techniqueRepository=e.shaderTechniqueRepository,this._techniqueConfig=new ae;const i=new H;i.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(F,i)}uninitializeRenderContext(){this._quadVAO=(0,n.O3)(this._quadVAO),this._technique=(0,n.RY)(this._technique),this._pathVerticalPlaneData=(0,n.O3)(this._pathVerticalPlaneData),this._pathTechnique=(0,n.RY)(this._pathTechnique)}prepareTechnique(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.releaseAndAcquire(ie,this._techniqueConfig,this._technique),this._technique):this._pathTechnique}render(e,t){const i=e.camera;(0,J.Xv)(i.projectionMatrix,i.fullWidth,i.fullHeight,this._projInfo,this._zScale),(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(e,t),this.pathVerticalPlaneEnabled&&this._renderPath(e)}_renderUnified(e,t){const i=e.rctx,a=i.useTechnique(t);this._bindGlobalUniforms(e,a),this._bindHeightManifoldUniforms(e,a),this._bindPointDistanceUniforms(e,a),this._bindLineVerticalPlaneUniforms(e,a),this._bindIntersectsLineUniforms(e,a),t.bind(this._params,e.camera),i.bindVAO(this._quadVAO),i.drawArrays(N.MX.TRIANGLE_STRIP,0,4)}_renderPath(e){if((0,n.Wi)(this._pathVerticalPlaneData)||(0,n.Wi)(this._pathTechnique))return;const t=e.rctx,i=this._pathTechnique,a=t.useTechnique(i);this._bindGlobalUniforms(e,a),i.bind(this._params,this._pathVerticalPlaneData.origin,e.camera),this._pathVerticalPlaneData.draw(e.rctx)}_bindHeightManifoldUniforms(e,t){if(!this.heightManifoldEnabled)return;const i=this._tempVec3A,a=this._tempPlane;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,i),oe(a,this._heightManifoldTarget,i,e.camera.viewMatrix),t.setUniform4fv("heightPlane",a)}_bindPointDistanceUniforms(e,t){if(!this._pointDistanceEnabled)return;const i=e.camera,a=this._tempSphere;(0,g.g)(a,this._pointDistanceOrigin),(0,g.m)(a,a,i.viewMatrix),a[3]=(0,g.i)(this._pointDistanceOrigin,this._pointDistanceTarget),t.setUniform4f("pointDistanceSphere",a[0],a[1],a[2],a[3])}_bindLineVerticalPlaneUniforms(e,t){if(!this._lineVerticalPlaneEnabled)return;const i=this._renderCoordsHelper,a=e.camera,r=this._tempPlane,n=this._tempVec3A,s=this._tempUp,o=this._tempDir,l=this._tempNormal;(0,M.KU)(this._lineVerticalPlaneSegment,.5,n),i.worldUpAtPosition(n,s),(0,g.n)(o,this._lineVerticalPlaneSegment.vector),(0,g.c)(l,s,o),(0,g.n)(l,l),oe(r,this._lineVerticalPlaneSegment.origin,l,a.viewMatrix),t.setUniform4fv("lineVerticalPlane",r);const h=this._tempVec3A;(0,g.g)(h,this._lineVerticalPlaneSegment.origin),i.setAltitude(h,0),(0,g.m)(h,h,a.viewMatrix),t.setUniform3fv("lineVerticalStart",h);const c=this._tempVec3B;(0,g.b)(c,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),i.setAltitude(c,0),(0,g.m)(c,c,a.viewMatrix),t.setUniform3fv("lineVerticalEnd",c)}_bindIntersectsLineUniforms(e,t){if(!this._intersectsLineEnabled)return;const i=ce,a=de;if(this._intersectsLineInfinite){const t=e.camera;if((0,y.iL)((0,S.re)(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),he),he.c0=-Number.MAX_VALUE,!(0,b.zq)(t.frustum,he))return;(0,y.Ws)(he,i),(0,y.S$)(he,a)}else(0,g.g)(i,this._intersectsLineSegment.origin),(0,g.b)(a,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const r=this._tempVec3A;(0,g.m)(r,i,e.camera.viewMatrix),t.setUniform3fv("intersectsLineStart",r);const n=this._tempVec4;(0,g.g)(n,this._intersectsLineSegment.vector),this._tempVec4[3]=0,(0,f.t)(this._tempVec4,this._tempVec4,e.camera.viewMatrix),(0,g.m)(a,a,e.camera.viewMatrix),t.setUniform3fv("intersectsLineEnd",a),(0,g.n)(n,n),t.setUniform3f("intersectsLineDirection",n[0],n[1],n[2]),t.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}_bindGlobalUniforms(e,t){const i=e.camera;t.setUniform4fv("projInfo",this._projInfo),t.setUniform2fv("zScale",this._zScale),t.setUniform2fv("nearFar",i.nearFar),this._heightManifoldEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),t.bindTexture(e.offscreenRenderingHelper.linearDepthTexture,"depthMap"),t.bindTexture(e.offscreenRenderingHelper.mainColorTexture,"frameColor")}_requestRender(){this._context&&this._context.requestRender()}}const he=(0,y.Ue)(),ce=(0,m.c)(),de=(0,m.c)();class pe extends w{constructor(e){super(e.view),this._angleCutoff=te.d,this._style={},this._heightManifoldTarget=(0,m.c)(),this._heightManifoldEnabled=!1,this._intersectsLine=(0,M.Ue)(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(e)}get testData(){return this.renderer}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){(0,n.pC)(e)?((0,g.g)(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if((0,n.Wi)(e))return void(this.intersectsLine=null);const t=this.view.renderCoordsHelper.worldUpAtPosition(e,ue);this.intersectsLine=(0,M.al)(e,t),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){(0,n.pC)(e)?((0,M.JG)(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=(0,n.pC)(e)?(0,M.JG)(e):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=(0,n.pC)(e)?{origin:(0,m.a)(e.origin),target:(0,m.a)(e.target)}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||(0,n.pC)(this._pointDistanceLine)||(0,n.pC)(this._pathVerticalPlaneBuffers))?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){(0,n.pC)(this.renderer)||(this.renderer=new le(this.view.renderCoordsHelper,void 0,{contrastControlEnabled:!0}),this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this.renderer.renderSlots,this.renderer))}_syncStyle(){(0,n.Wi)(this.renderer)||(this.renderer.setParameters(this._style),null!=this._style.intersectsLineRadius&&(this.renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){(0,n.Wi)(this.renderer)||this.renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){(0,n.Wi)(this.renderer)||(this.renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this.renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){(0,n.Wi)(this.renderer)||(this.renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this.renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){(0,n.Wi)(this.renderer)||(this.renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){(0,n.Wi)(this.renderer)||(this.renderer.pathVerticalPlaneEnabled=(0,n.pC)(this._pathVerticalPlaneBuffers)&&this.visible,(0,n.pC)(this._pathVerticalPlaneBuffers)&&(this.renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){(0,n.Wi)(this.renderer)||(this.renderer.lineVerticalPlaneEnabled=(0,n.pC)(this._lineVerticalPlaneSegment)&&this.visible,(0,n.pC)(this._lineVerticalPlaneSegment)&&(this.renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){(0,n.Wi)(this.renderer)||(this.renderer.pointDistanceEnabled=(0,n.pC)(this._pointDistanceLine)&&this.visible,(0,n.pC)(this._pointDistanceLine)&&(this.renderer.pointDistanceOrigin=this._pointDistanceLine.origin,this.renderer.pointDistanceTarget=this._pointDistanceLine.target))}_disposeRenderer(){(0,n.pC)(this.renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this.renderer),this.renderer=null)}}const ue=(0,m.c)();var ge=i(68401),me=i(59887),_e=i(97882);class fe extends w{constructor(e){super(e.view),this._resources=null,this._transform=(0,L.c)()}get object(){return(0,n.pC)(this._resources)?this._resources.object:null}get transform(){return this._transform}set transform(e){(0,T.c)(this._transform,e),(0,n.pC)(this._resources)&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if((0,n.Wi)(this._resources))return;const e=this._resources.object,t=this.view._stage;t.removeMany(e.geometries),e.removeAllGeometries(),this.createGeometries(e),this.visible||e.setVisible(this.visible),t.addMany(e.geometries)}createResources(){this.destroyResources();const e=this.view._stage;if(!e)return;const t=new _e.F({isPickable:!1,updatePolicy:ge.jq.SYNC});e.add(t);const i=new me.T({castShadow:!1});i.transformation=this._transform,this.createExternalResources(),this.createGeometries(i),e.addMany(i.geometries),this.forEachExternalMaterial((t=>e.add(t))),e.add(i),t.add(i),this.visible||i.setVisible(!1),this._resources={layer:t,object:i}}destroyResources(){const e=this.view._stage;!(0,n.Wi)(this._resources)&&e&&(e.remove(this._resources.object),e.remove(this._resources.layer),this.forEachExternalMaterial((t=>{e.remove(t),t.dispose()})),e.removeMany(this._resources.object.geometries),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){(0,n.Wi)(this._resources)||this._resources.object.setVisible(e)}}var ve=i(70619),ye=i(56529),be=i(58901);class Me extends fe{constructor(e){super(e),this._ray=(0,S.Ue)(),this._externalResources=null,this._handles=new _.Z,this._isWorldDown=!1,this._start=(0,m.c)(),this._end=(0,m.f)(1,0,0),this._width=1,this._color=(0,v.f)(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=(0,v.f)(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=Ce.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=ye.yD.OccludeAndTransparent,this._fadedExtensions=Ae,this.applyProps(e)}createExternalResources(){const e=new be.U(this.materialParameters);this._handles.add(this.view.state.watch("camera",(()=>{this._updateGeometry()})));const t=new pe({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:t}}destroyExternalResources(){(0,n.pC)(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){(0,n.pC)(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const t=[(0,m.c)(),(0,m.c)()],i=this.extensionType===Ce.FADED;i&&t.push((0,m.c)(),(0,m.c)());const a=i?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,r=ve.Z.createPolylineGeometry(t,null,a);e.addGeometry(r,(0,n.Wg)(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),(0,n.pC)(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,(0,g.g)(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),(0,g.f)(this._end,e,this._end),(0,S.zk)(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,(0,g.k)(this._start,e)||((0,g.g)(this._start,e),(0,S.zk)(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,(0,g.k)(this._end,e)||((0,g.g)(this._end,e),(0,S.zk)(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){(0,f.g)(e,this._color)||((0,f.c)(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){(0,f.g)(e,this._innerColor)||((0,f.c)(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=(0,n.pC)(e)!==(0,n.pC)(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){((0,n.Wi)(e)||(0,n.Wi)(this._stippleOffColor)||!(0,f.g)(e,this._stippleOffColor))&&(this._stippleOffColor=(0,n.pC)(e)?(0,v.a)(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&(0,n.pC)(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,(0,n.pC)(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,(0,n.pC)(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,(0,n.pC)(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=(0,n.Pt)(e,Ae),this.recreateGeometry()}_updateMaterial(){(0,n.Wi)(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){(0,n.pC)(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const t=this._extensionType===Ce.FADED?this._updateLineSegmentFinite(xe):this._updateLineSegmentInfinite(this._extensionType,xe);this._updateVertexAttributes(e,t),(0,n.pC)(this._externalResources)&&(this._externalResources.laserline.intersectsLine=t)}_updateLineSegmentFinite(e){return(0,M.zk)(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const i=this.view.state.camera;switch((0,y.iL)(this._ray,Se),e){case Ce.LINE:Se.c0=-Number.MAX_VALUE;break;case Ce.RAY:case Ce.GROUND_RAY:{const e=this._ray.origin,t=(0,n.Pt)(this.view.elevationProvider.getElevation(e[0],e[1],e[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),i=this.view.renderCoordsHelper.getAltitude(e);this._isWorldDown&&i<t&&(0,g.o)(Se.ray.direction,Se.ray.direction),this._extensionType===Ce.GROUND_RAY&&null!=t&&(Se.c1=Math.abs(i-t));break}}if(!(0,b.zq)(i.frustum,Se))return(0,M.zk)(this._start,this._end,t);const a=(0,y.Ws)(Se,we),r=(0,y.S$)(Se,Ee);return(0,M.zk)(a,r,t)}_updateVertexAttributes(e,t){const i=e.geometries[0].getMutableAttribute(R.T.POSITION).data;if(this.extensionType===Ce.FADED){const e=(0,M.KU)(t,-this.fadedExtensions.start,we);i[0]=e[0],i[1]=e[1],i[2]=e[2];const a=(0,M.KU)(t,0,we);i[3]=a[0],i[4]=a[1],i[5]=a[2];const r=(0,M.KU)(t,1,we);i[6]=r[0],i[7]=r[1],i[8]=r[2];const n=(0,M.KU)(t,1+this.fadedExtensions.end,we);i[9]=n[0],i[10]=n[1],i[11]=n[2]}else{const e=(0,M.KU)(t,0,we);i[0]=e[0],i[1]=e[1],i[2]=e[2];const a=(0,M.KU)(t,1,we);i[3]=a[0],i[4]=a[1],i[5]=a[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const Se=(0,y.Ue)(),we=(0,m.c)(),Ee=(0,m.c)(),xe=(0,M.Ue)();var Ce;!function(e){e[e.LINE=0]="LINE",e[e.RAY=1]="RAY",e[e.GROUND_RAY=2]="GROUND_RAY",e[e.FADED=3]="FADED"}(Ce||(Ce={}));const Oe=1/3,Ae={start:Oe,end:Oe};var Pe=i(17842),De=i(88396);class Re extends fe{constructor(e){super(e),this._handles=new _.Z,this._location=(0,m.c)(),this._direction=(0,m.f)(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=(0,v.f)(1,0,1,1),this._renderOccluded=ye.yD.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){(0,g.k)(this._location,e)||((0,g.g)(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){(0,g.k)(this._direction,e)||((0,g.g)(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){(0,g.n)(this._direction,(0,g.f)(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){(0,f.g)(e,this._color)||((0,f.c)(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new be.U(this.materialParameters);this._handles.add(this.view.state.watch("camera",(()=>{this._updateGeometry()}))),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const t=ve.Z.createPolylineGeometry([(0,m.c)(),(0,m.c)()]),i=ve.Z.createPolylineGeometry([(0,m.c)(),(0,m.c)()]),a=(0,n.Wg)(this._externalResources).material;e.addGeometry(t,a),e.addGeometry(i,a),this._updateVertices(e)}forEachExternalMaterial(e){(0,n.pC)(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){(0,n.Wi)(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;(0,n.Wi)(e)||this._updateVertices(e)}_updateVertices(e){const t=this.view.state.camera;t.projectToScreen(this.location,Le),(0,g.b)(Te,this.location,this.direction),t.projectToScreen(Te,Ge),(0,De.i)(Ge,(0,De.f)(Ge,Ge,Le)),this._updateVertexAttributes(t,e,0,Le,Ge,1),this._updateVertexAttributes(t,e,1,Le,Ge,-1)}_updateVertexAttributes(e,t,i,a,r,n){const s=t.geometryRecords[i],o=s.geometry.getMutableAttribute(R.T.POSITION).data,l=(0,De.g)(Ve,(0,De.s)(Ve,r[1]*n,r[0]*-n),this.offset+this.width/2),h=(0,De.m)(Ie,(0,De.m)(Ie,(0,De.m)(Ie,a,(0,De.g)(Ie,r,this.length/2)),l),l),c=(0,De.m)(ze,h,(0,De.g)(ze,r,-this.length));e.unprojectFromScreen(h,Te),o[0]=Te[0],o[1]=Te[1],o[2]=Te[2],e.unprojectFromScreen(c,Te),o[3]=Te[0],o[4]=Te[1],o[5]=Te[2],t.geometryVertexAttrsUpdated(s)}}const Te=(0,m.c)(),Le=(0,Pe.s1)(),Ge=(0,Pe.s1)(),Ve=(0,Pe.s1)(),Ie=(0,Pe.s1)(),ze=(0,Pe.s1)();var We=i(79803),Ne=i(41414),Ue=i(11185),Fe=i(79100);class He{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return(0,n.pC)(this._resources)?this._resources.object:null}get resources(){return(0,n.pC)(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const e=this.resourceFactory.view._stage;if((0,n.Wi)(this._resources)||!e)return;const t=this._resources.object;this._resources.external.forEach((t=>{t.type===Fe.U.Geometry&&e.remove(t)})),t.removeAllGeometries();const i=this.resourceFactory.recreateGeometry(this._resources.external,t,this._resources.layer);e.addMany(i)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory.view._stage;if(!e)return;const t=new _e.F({isPickable:!1,updatePolicy:ge.jq.SYNC});e.add(t);const i=new me.T({castShadow:!1}),a=this.resourceFactory.createResources(i,t);a.forEach((t=>e.add(t))),e.add(i),t.add(i);const r=this.resourceFactory.cameraChanged?(0,s.S1)(this.resourceFactory.view.state,"camera",(e=>this.resourceFactory.cameraChanged(e))):null;this._resources={layer:t,object:i,external:a,cameraHandle:r},this._syncVisible()}_destroyResources(){if((0,n.Wi)(this._resources))return;const e=this.resourceFactory.view._stage;null==e||e.remove(this._resources.object),null==e||e.remove(this._resources.layer),this._resources.external.forEach((t=>{null==e||e.remove(t),"dispose"in t&&t.dispose()})),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){(0,n.Wi)(this._resources)||this._resources.object.setVisible(this._visible)}}var ke=i(69691),je=i(78935),Ze=i(55360),Be=i(9992);class qe{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=(0,C.f)(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=(0,C.f)(1,1,1,1),this._elevationInfo=null,this.resources=new He({view:e.view,createResources:e=>this._createResources(e),recreateGeometry:(e,t)=>(e.geometry=this._recreateGeometry(t,e.material),(0,n.pC)(e.geometry)?[e.geometry]:[])});let t=!0;for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e}get attached(){return this.resources.attached}set attached(e){this.resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this.preferredTextureSize;this._size=e,t<this.preferredTextureSize?(0,n.pC)(this.resources)&&this.resources.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){(0,f.g)(e,this._color)||((0,f.c)(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,(0,n.pC)(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){(0,f.g)(e,this._outlineColor)||((0,f.c)(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()}_updateMaterial(){const e=this.resources.resources;(0,n.Wi)(e)||e.material.setParameters(this._materialParameters(e.texture.id))}_updateSizeAttribute(){const e=this.resources.resources,t=this.resources.object;if((0,n.Wi)(e)||(0,n.Wi)(t))return;const i=e.geometry;if((0,n.Wi)(i))return;const a=i.getMutableAttribute(R.T.SIZE).data,r=this.geometrySize;a[0]=r,a[1]=r,t.geometryVertexAttrsUpdated(t.geometryRecords[0])}_materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:Xe,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/Ye}_recreateGeometry(e,t){const i=this._createRenderGeometry();return(0,n.pC)(i)&&e.addGeometry(i,t),i}_createResources(e){const t=(0,Ze.cU)(this._primitive,this.preferredTextureSize),i=new Be.A(this._materialParameters(t.id)),a=this._recreateGeometry(e,i);return{material:i,texture:t,geometry:a,forEach(e){e(t),e(i),(0,n.pC)(this.geometry)&&e(this.geometry)}}}get preferredTextureSize(){return(0,E.uZ)((0,E.Sf)(2*this.geometrySize),16,128)}calculateMapBounds(e){if((0,n.Wi)(this.resources.resources)||(0,n.Wi)(this.resources.resources.geometry))return!1;const t=this.resources.resources.geometry.vertexAttributes.get(R.T.POSITION);return(0,We.SH)(t.data,this.view.renderCoordsHelper.spatialReference,Qe,this.view.spatialReference),(0,Ne.G1)(e,Qe),!0}_createRenderGeometry(){const e=this.geometry;if((0,n.Wi)(e))return null;const{renderCoordsHelper:t,elevationProvider:i}=this.view,a=(0,ke.w7)(e,i,je.o.fromElevationInfo(this.elevationInfo),t),r=(0,g.s)(Ue.WM.get(),e.x,e.y,a),s=Ue.WM.get();(0,We.SH)(r,e.spatialReference,s,t.spatialReference);const o=this.geometrySize;return ve.Z.createPointGeometry(null,s,null,[o,o],[0,0,0,1])}}const Ye=Ze.Ns,Xe=[Ye/2,Ye/2,1-Ye/2,1-Ye/2],Qe=(0,m.c)();var Ke=i(74894),Je=i(74818);class $e extends fe{constructor(e){super(e),this._handles=new _.Z,this._quadMaterial=null,this._outlineMaterial=null,this._maxSize=0,this._position=(0,m.c)(),this._up=(0,m.c)(),this._right=(0,m.c)(),this._renderOccluded=ye.yD.OccludeAndTransparent,this._color=(0,v.f)(1,0,0,1),this._outlineColor=(0,v.f)(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=ye.yD.Opaque,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){(0,f.c)(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){(0,f.c)(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const t=0===this._outlineSize!=(0===e);this._outlineSize=e,t?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry(e){let{previous:t,center:i,next:a}=e;this._maxSize=Math.min((0,g.i)(i,t),(0,g.i)(i,a))/3,(0,g.n)(this._up,(0,g.f)(this._up,t,i)),(0,g.n)(this._right,(0,g.f)(this._right,a,i)),(0,g.g)(this._position,i),this.recreateGeometry()}createExternalResources(){this._quadMaterial=new Je.E(this.quadMaterialParameters),this._outlineMaterial=new be.U(this.outlineMaterialParameters),this._handles.add(this.view.state.watch("camera",(()=>this._updateTransform())))}destroyExternalResources(){this._quadMaterial=null,this._outlineMaterial=null,this._handles.removeAll()}forEachExternalMaterial(e){e(this._quadMaterial),e(this._outlineMaterial)}createGeometries(e){this._createQuadGeometry(e),this._createOutlineGeometry(e),this._updateTransform(e)}_createQuadGeometry(e){const t=this._quadGeometryData(this._up,this._right);e.addGeometry(t,this._quadMaterial)}_createOutlineGeometry(e){if(0===this._outlineSize)return;const t=(0,g.b)(Ue.WM.get(),this._up,this._right),i=ve.Z.createPolylineGeometry([this._up,t,this._right]);e.addGeometry(i,this._outlineMaterial)}_updateTransform(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.object;const t=this.view.state.camera,i=this._size*t.computeScreenPixelSizeAt(this._position),a=Math.min(this._maxSize,i);(0,T.f)(et,this._position),(0,T.h)(et,et,[a,a,a]),(0,n.pC)(e)&&(e.transformation=et)}_quadGeometryData(e,t){const i=(0,g.b)(Ue.WM.get(),e,t);return new Ke.Z([[R.T.POSITION,{size:3,data:[0,0,0,...t,...e,...i],exclusive:!0}]],[[R.T.POSITION,new Uint16Array([0,1,2,1,2,3])]])}get quadMaterialParameters(){return{color:this._color,transparent:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded}}_updateQuadMaterial(){this._quadMaterial&&this._quadMaterial.setParameters(this.quadMaterialParameters)}get outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded}}_updateOutlineMaterial(){this._outlineMaterial&&this._outlineMaterial.setParameters(this.outlineMaterialParameters)}}const et=(0,L.c)();var tt=i(76014),it=i(64674),at=i(38561);class rt extends at.a{visualizeIntersectionPoint(e,t){const{coordinateHelper:i,elevationInfo:a,view:n}=t;return(0,r.ed)(new qe({view:n,primitive:"circle",geometry:i.vectorToPoint(e.intersectionPoint),elevationInfo:a,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:u.Z.toUnitRGBA(tt.c.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,t){const{coordinateHelper:i,elevationInfo:a,view:n}=t;return(0,r.ed)(new qe({view:n,primitive:"circle",geometry:i.vectorToPoint(e.point),elevationInfo:a,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:u.Z.toUnitRGBA(tt.c.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,t){const{coordinateHelper:i,elevationInfo:a,view:n}=t;return(0,r.ed)(this._createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,i,a,n,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{coordinateHelper:i,elevationInfo:a,view:n}=t,s=(0,it.$r)(e.lineStart,i,a,t.view),o=(0,it.$r)(e.lineEnd,i,a,t.view),l=(0,g.e)(o,s,o,.5),h=new Re({view:n,attached:!1,offset:tt.c.parallelLineHintOffset,length:tt.c.parallelLineHintLength,width:tt.c.parallelLineHintWidth,color:u.Z.toUnitRGBA(tt.c.orange),location:l,renderOccluded:ye.yD.Opaque});return h.setDirectionFromPoints(s,l),h.attached=!0,(0,r.ed)(h)}visualizeRightAngleQuad(e,t){const{coordinateHelper:i,elevationInfo:a,view:n}=t;return(0,r.ed)(new $e({view:n,attached:!0,color:u.Z.toUnitRGBA(tt.c.orange),renderOccluded:ye.yD.Transparent,outlineRenderOccluded:ye.yD.Opaque,outlineColor:u.Z.toUnitRGBA(tt.c.orange),outlineSize:tt.c.rightAngleHintOutlineSize,size:tt.c.rightAngleHintSize,geometry:{previous:(0,it.$r)(e.previousVertex,i,a,n),center:(0,it.$r)(e.centerVertex,i,a,n),next:(0,it.$r)(e.nextVertex,i,a,n)}}))}_createLineSegmentHintFromMap(e,t,i,a,r,n){let s=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],o=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const l=(0,m.c)(),h=(0,m.c)();return(0,it.gQ)(t,i,a,r,n,l,h),this._createLineSegmentHint(e,n,l,h,s,o)}_createLineSegmentHint(e,t,i,a){let r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],n=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];const s=new Me({view:t,extensionType:Ce.FADED,start:i,end:a,color:u.Z.toUnitRGBA(tt.c.orange),renderOccluded:ye.yD.Opaque});switch(e){case it.ze.TARGET:s.width=tt.c.lineHintWidthTarget,s.fadedExtensions={start:0,end:tt.c.lineHintFadedExtensions};break;case it.ze.REFERENCE_EXTENSION:s.width=tt.c.lineHintWidthReference,s.fadedExtensions={start:0,end:0};break;case it.ze.REFERENCE:s.width=tt.c.lineHintWidthReference,s.fadedExtensions={start:r?tt.c.lineHintFadedExtensions:0,end:n?tt.c.lineHintFadedExtensions:0}}return s.attached=!0,s}}var nt=i(86950),st=i(86700);const ot={main:new u.Z([255,127,0]),selected:new u.Z([255,255,255]),staged:new u.Z([12,207,255]),outline:new u.Z([0,0,0,.5]),selectedOutline:new u.Z([255,255,255])},lt=.3;function ht(e,t){const i=e.clone();return i.a*=t,i}function ct(e,t){const i=e.clone(),a=(0,nt._Y)(i);a.s*=t;const r=(0,nt.xr)(a);return i.r=r.r,i.g=r.g,i.b=r.b,i}function dt(e,t){if(t)for(const i in t)e[i]=t[i]}class pt{constructor(e){this.color=ot.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=ye.yD.Opaque,dt(this,e)}}class ut{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=ot.main,this.outlineColor=ot.outline,this.renderOccluded=ye.yD.Opaque,this.hoverOutlineColor=ot.selectedOutline,dt(this,e)}apply(e,t){const i=this[e];t.setParameters({color:wt(i),transparent:"color"!==e||i.a<1,renderOccluded:this.renderOccluded})}}class gt{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=ht(ot.main,.5),this.hoverColor=ot.main,this.renderOccluded=ye.yD.Transparent,this.minSquaredEdgeLength=900,dt(this,e)}apply(e,t){const i=this[e];t.setParameters({color:wt(i),transparent:i.a<1,renderOccluded:this.renderOccluded})}}class mt{constructor(e){this.vertex=new ut({color:ot.main,outlineColor:ot.outline}),this.edge=new ut({color:ct(ht(ot.main,2/3),.5),outlineColor:ht(ot.outline,.5),size:8,collisionPadding:8}),this.selected=new ut({color:ot.selected,outlineColor:ot.outline}),this.edgeOffset=new gt,dt(this,e)}}class _t{constructor(e){this.color=ot.selected,this.width=1.5,this.stipplePattern=(0,st.z5)(5),this.stippleOffColor=ot.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=ot.selected,this.renderOccluded=ye.yD.OccludeAndTransparent,dt(this,e)}apply(e){e.color=wt(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=wt(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=wt(this.innerColor),e.renderOccluded=this.renderOccluded}}class ft{constructor(e){this.color=ot.selected,this.size=4,this.outlineSize=1,this.outlineColor=ot.outline,this.shape="square",dt(this,e)}apply(e){e.color=wt(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=wt(this.outlineColor),e.primitive=this.shape}}class vt{constructor(e){this.innerColor=ot.selected,this.innerWidth=1,this.glowColor=ot.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=lt,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=ot.main,dt(this,e)}apply(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const i={glowColor:u.Z.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:u.Z.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*t,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=i:e.laserlineStyle=i}}class yt{constructor(e){this.outline=new _t({color:ot.outline,renderOccluded:ye.yD.OccludeAndTransparentStencil,stippleOffColor:ot.selected,stipplePattern:(0,st.z5)(5),width:1.5,innerWidth:0}),this.staged=new _t({color:ot.selected,renderOccluded:ye.yD.OccludeAndTransparentStencil,innerColor:ot.staged,stippleOffColor:ot.outline,stipplePattern:(0,st.z5)(5),width:1.5}),this.shadowStyle=new vt({globalAlpha:lt,glowColor:ot.main,glowFalloff:8,glowWidth:8,innerColor:ot.selected,innerWidth:1}),dt(this,e)}}class bt{constructor(e){this.outline=new ft({color:ot.selected,outlineColor:ot.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new vt({globalAlpha:lt,glowColor:ot.main,glowFalloff:1.5,glowWidth:6,innerColor:ot.selected,innerWidth:1,radius:2}),dt(this,e)}}class Mt extends _t{constructor(e){super(),this.extensionType=Ce.GROUND_RAY,dt(this,e)}}class St{constructor(e){this.lineGraphics=new yt,this.pointGraphics=new bt,this.heightPlane=new vt({globalAlpha:lt,glowColor:ot.main,glowFalloff:8,glowWidth:8,innerColor:ot.selected,innerWidth:1}),this.heightBox=new vt({globalAlpha:lt,glowColor:ot.main,glowFalloff:8,glowWidth:8,innerColor:ot.selected,innerWidth:0,heightFillColor:ot.main}),this.zVerticalLine=new Mt({color:ht(ot.main,.5),falloff:2,innerColor:ht(ot.selected,0),renderOccluded:ye.yD.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:Ce.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,dt(this,e)}}function wt(e){return(0,C.d)(u.Z.toUnitRGBA(e))}const Et=new class{constructor(e){this.visualElements=new St,this.reshapeManipulators=new mt,this.zManipulator=new pt,dt(this,e)}colorToVec4(e){return wt(e)}};var xt=i(91505),Ct=i(65618),Ot=i(85015),At=i(79056),Pt=i(26279),Dt=i(78289);class Rt{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return(0,n.pC)(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?(0,n.Wi)(this._resources)||(this._ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?(0,n.Wi)(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var e;this._destroyResources();const t=this.resourceFactory.createResources();this._resources={layerView:new Tt({view:this.resourceFactory.view}),external:t,geometriesAdded:!1},this._syncGeometriesToRenderer();const i=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;i&&i.registerDrapeSource(this._resources.layerView)}_destroyResources(){var e;if((0,n.Wi)(this._resources))return;this._ensureRenderGeometriesRemoved();const t=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;t&&t.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){var e;!(0,n.Wi)(this._resources)&&null!=(e=this.resourceFactory.view)&&e.basemapTerrain&&this._resources.geometriesAdded&&(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.removeGeometries(this._resources.external.geometries,this._resources.layerView,Dt.$.Geometry.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){(0,n.Wi)(this._resources)||this._resources.geometriesAdded||(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.addGeometries(this._resources.external.geometries,this._resources.layerView,Dt.$.Geometry.UPDATE),this._resources.geometriesAdded=!0)}}let Tt=class extends((0,At.I)(Ot.Z)){constructor(e){super(e),this.drapeSourceType=Pt.Lw.Features,this.updatePolicy=ge.jq.SYNC}};(0,a._)([(0,o.Cb)({constructOnly:!0})],Tt.prototype,"view",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],Tt.prototype,"drapeSourceType",void 0),Tt=(0,a._)([(0,c.j)("DrapedVisualElementLayerView")],Tt);var Lt=i(75558),Gt=i(81935),Vt=i(69831);class It{constructor(e){this.view=null,this._attachmentOrigin=(0,Ct.Tx)(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new xt.Z,this._isDraped=!1,this._geometry=null,this._width=1,this._color=(0,v.f)(1,0,1,1),this._innerWidth=0,this._innerColor=(0,v.f)(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=ye.yD.OccludeAndTransparentStencil,this.resources=new He({view:e.view,createResources:e=>this._createResources(e),recreateGeometry:(e,t)=>(e.geometries.length=0,this._recreateGeometry(t,e.material,e.geometries),e.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new Rt({view:e.view,createResources:()=>this._createDrapedResources(),recreateGeometry:e=>{e.geometries=this._createRenderGeometriesDraped(e.material),this._attachmentOriginChanged()}});let t=!0;this._laserline=new pe({view:e.view});for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this._updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&(0,n.pC)(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(e){this._updateAttached(e)}_updateAttached(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){(0,f.g)(e,this._color)||((0,f.c)(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){(0,f.g)(e,this._innerColor)||((0,f.c)(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=(0,n.pC)(e)!==(0,n.pC)(this._stipplePattern);this._stipplePattern=e,t?this.resources.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&(0,f.g)(e,this._stippleOffColor)||(this._stippleOffColor=e?(0,v.a)(e):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,(0,n.pC)(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=(0,n.pC)(this.resources.resources)?this.resources.resources.geometries:null;if(!e||0===e.length)return null;(0,g.s)(Nt,0,0,0);let t=0;for(const i of e){const e=i.vertexAttributes.get(R.T.POSITION),a=i.indices.get(R.T.POSITION),r=(0,n.Wg)(this.resources.resources).material.isClosed(e.data,a);(0,Gt.qZ)(e,a,r,Wt)&&((0,g.b)(Nt,Nt,Wt),t++)}return 0===t?null:((0,g.a)(Nt,Nt,1/t),this.view.renderCoordsHelper.fromRenderCoords(Nt,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){(0,n.pC)(this.resources.resources)&&this.resources.resources.material.setParameters(this.materialParameters),(0,n.pC)(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameters(this.materialParameters)}get isClosed(){return(0,n.pC)(this.geometry)&&"polygon"===this.geometry.type}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",polygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===ye.yD.OccludeAndTransparentStencil?ye.yD.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(e,t,i){const a=this._createRenderGeometries();for(const r of a)e.addGeometry(r,t),i.push(r);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createResources(e){const t=new be.U(this.materialParameters),i=[];return this._recreateGeometry(e,t,i),{material:t,geometries:i,forEach:e=>{e(t),i.forEach(e)}}}_createDrapedResources(){const e=new be.U(this.materialParameters);return{material:e,geometries:this._createRenderGeometriesDraped(e)}}_createRenderGeometriesDraped(e){const t=this.geometry;if((0,n.Wi)(t))return[];const i=(0,Lt.rm)(t,this.view.basemapTerrain.spatialReference),a=[];for(const{position:r}of i.lines){const t={overlayInfo:{spatialReference:this.view.basemapTerrain.spatialReference,renderCoordsHelper:this.view.renderCoordsHelper},attributeData:{position:r},removeDuplicateStartEnd:this.isClosed?Lt.NW.REMOVE:Lt.NW.KEEP},i=new Vt.z((0,Lt.YU)(t),e),n=(0,Ne.cS)(zt);(0,Ne.G1)(n,r),(0,f.s)(i.boundingSphere,.5*(n[0]+n[3]),.5*(n[1]+n[4]),0,.5*Math.sqrt((n[3]-n[0])*(n[3]-n[0])+(n[4]-n[1])*(n[4]-n[1]))),a.push(i)}return a}calculateMapBounds(e){if((0,n.Wi)(this.resources.resources))return!1;const t=this.view.renderCoordsHelper;for(const i of this.resources.resources.geometries){const a=i.vertexAttributes.get(R.T.POSITION),r=new Float64Array(a.data.length);(0,We.CM)(a.data,t.spatialReference,0,r,this.view.spatialReference,0,a.data.length/3),(0,Ne.G1)(e,r)}return!0}_createRenderGeometries(){var e;const t=this.geometry;if((0,n.Wi)(t))return[];const i=(0,Lt.VP)(t,this.view.elevationProvider,this.view.renderCoordsHelper,je.o.fromElevationInfo(null!=(e=this.elevationInfo)?e:new p.Z({mode:(0,d.VW)(t,null)}))),a=[],r=[];for(const{position:n,mapPosition:s}of i.lines){const e={overlayInfo:null,attributeData:{position:n,mapPosition:s},removeDuplicateStartEnd:this.isClosed?Lt.NW.REMOVE:Lt.NW.KEEP};a.push((0,Lt.YU)(e)),r.push(n)}return this._laserline.pathVerticalPlane=r,a}}const zt=(0,Ne.Ue)(),Wt=(0,m.c)(),Nt=(0,m.c)();var Ut=i(36759),Ft=i(25158),Ht=i(71011),kt=i(23620),jt=i(94425),Zt=i(33236),Bt=i(43505),qt=i(33280),Yt=i(15226),Xt=i(41012),Qt=i(78041),Kt=i(72511);class Jt extends V.A{initializeProgram(e){const t=Jt.shader.get(),i=this.configuration,a=t.build({output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,screenSizeEnabled:i.screenSizeEnabled,shadingEnabled:i.shadingEnabled,oitEnabled:i.transparencyPassType===ge.Am.Color,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new z.$(e.rctx,a,ei)}bindPass(e,t){const{screenSizeEnabled:i,shadingEnabled:a}=this.configuration,{color:r,shadingTint:n,shadingDirection:s}=e;(0,Xt.II)(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("uColor",r),t.multipassTerrainEnabled&&(this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,Yt.p)(this.program,t)),a&&(this.program.setUniform4fv("shadedColor",this._blendColor(ti,n,r)),this.program.setUniform3fv("shadingDirection",s),this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix)),i&&(0,Bt.o)(this.program,e,t)}bindDraw(e){(0,Xt.id)(this.program,e),(0,Xt.fb)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),(0,qt.DA)(this.program,this.configuration,e),this.program.rebindTextures()}_blendColor(e,t,i){const a=1-t[3],r=t[3]+i[3]*a;return 0===r?(e[3]=r,e):(e[0]=(t[0]*t[3]+i[0]*i[3]*a)/r,e[1]=(t[1]*t[3]+i[1]*i[3]*a)/r,e[2]=(t[2]*t[3]+i[2]*i[3]*a)/r,e[3]=i[3],e)}_setPipelineState(e){const t=this.configuration,i=e===ge.Am.NONE,a=e===ge.Am.FrontFace;return(0,U.sm)({blending:t.output!==Ht.H.Color&&t.output!==Ht.H.Alpha||!t.transparent?null:i?Qt.wu:(0,Qt.j7)(e),culling:(0,U.zp)(t.cullFace),depthTest:{func:a?N.wb.LESS:t.shadingEnabled?N.wb.LEQUAL:N.wb.LESS},depthWrite:i?t.writeDepth&&U.LZ:(0,Qt.K5)(e),colorWrite:U.BK,polygonOffset:i||a?null:Qt.E0})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}Jt.shader=new G.J(Kt.S,(()=>i.e(6556).then(i.bind(i,36556))));class $t extends I.m{constructor(){super(...arguments),this.output=Ht.H.Color,this.cullFace=ge.Vr.None,this.slicePlaneEnabled=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.transparencyPassType=ge.Am.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,a._)([(0,I.o)({count:Ht.H.COUNT})],$t.prototype,"output",void 0),(0,a._)([(0,I.o)({count:ge.Vr.COUNT})],$t.prototype,"cullFace",void 0),(0,a._)([(0,I.o)()],$t.prototype,"slicePlaneEnabled",void 0),(0,a._)([(0,I.o)()],$t.prototype,"transparent",void 0),(0,a._)([(0,I.o)()],$t.prototype,"writeDepth",void 0),(0,a._)([(0,I.o)()],$t.prototype,"screenSizeEnabled",void 0),(0,a._)([(0,I.o)()],$t.prototype,"shadingEnabled",void 0),(0,a._)([(0,I.o)({count:ge.Am.COUNT})],$t.prototype,"transparencyPassType",void 0),(0,a._)([(0,I.o)()],$t.prototype,"multipassTerrainEnabled",void 0),(0,a._)([(0,I.o)()],$t.prototype,"cullAboveGround",void 0);const ei=new Map([[R.T.POSITION,0],[R.T.NORMAL,1],[R.T.OFFSET,2]]),ti=(0,C.c)();class ii extends ye.F5{constructor(e){super(e,ri),this.supportsEdges=!0,this.techniqueConfig=new $t,this._vertexAttributeLocations=ei}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.screenSizeEnabled=this.parameters.screenSizeEnabled,this.techniqueConfig.shadingEnabled=this.parameters.shadingEnabled,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(e,t,i,a,r,n,s){if(this.parameters.screenSizeEnabled){const i=e.vertexAttributes.get(R.T.OFFSET),o={applyToVertex:(e,t,r,n)=>{const s=(0,g.s)(si,i.data[3*n+0],i.data[3*n+1],i.data[3*n+2]),o=(0,g.s)(oi,e,t,r);return(0,g.a)(s,s,this.parameters.screenSize*a.camera.computeRenderPixelSizeAt(s)),(0,g.b)(o,o,s),[o[0],o[1],o[2]]},applyToAabb:e=>{const t=(0,Ne.be)(e,si);return(0,Ne.bA)(e,this.parameters.screenSize*a.camera.computeRenderPixelSizeAt(t))}};(0,$.Bw)(e,t,a,r,n,o,s)}else(0,$.Bw)(e,t,a,r,n,void 0,s)}requiresSlot(e,t){if((0,jt.S)(t)===Ht.H.Highlight)return e===K.r.OPAQUE_MATERIAL;let i=K.r.OPAQUE_MATERIAL;return this.parameters.transparent&&(i=this.parameters.writeDepth?K.r.TRANSPARENT_MATERIAL:K.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===i||e===K.r.DRAPED_MATERIAL}createGLMaterial(e){return e.output===Ht.H.Color||e.output===Ht.H.Alpha||e.output===Ht.H.Highlight?new ai(e):null}createBufferWriter(){return new ni(this.parameters.screenSizeEnabled)}}class ai extends kt.Z{updateParameters(e){return this.ensureTechnique(Jt,e)}beginSlot(e){return this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const ri={color:[1,1,1,1],shadingTint:[0,0,0,.25],shadingDirection:(0,g.n)((0,m.c)(),[.5,-.5,-.5]),transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:ge.Vr.None,screenSizeEnabled:!1,screenSize:14,shadingEnabled:!0,...ye.mo};class ni{constructor(e){this.screenSizeEnabled=e;const t=(0,D.U$)().vec3f(R.T.POSITION).vec3f(R.T.NORMAL);this.screenSizeEnabled&&t.vec3f(R.T.OFFSET),this.vertexBufferLayout=t}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(R.T.POSITION).length}write(e,t,i,a){if((0,Zt.NK)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,a),this.screenSizeEnabled){if(!t.vertexAttributes.has(R.T.OFFSET))throw new Error(`${R.T.OFFSET} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{const r=t.vertexAttributes.get(R.T.OFFSET),n=t.indices.get(R.T.OFFSET);(0,J.hu)(3===r.size);const s=i.getField(R.T.OFFSET,Ft.ct);if(!s)throw new Error("unable to acquire view for "+R.T.OFFSET);(0,Zt.ho)(n,r.data,e.invTranspTransformation,s,a)}}}}const si=(0,m.c)(),oi=(0,m.c)();class li extends fe{constructor(e){super(e),this.view=null,this._renderOccluded=ye.yD.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=Et.colorToVec4(Et.reshapeManipulators.vertex.color),this._size=Et.reshapeManipulators.vertex.size,this._outlineColor=Et.colorToVec4(Et.reshapeManipulators.vertex.outlineColor),this._outlineSize=Et.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){(0,f.g)(e,this._color)||((0,f.c)(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){(0,f.g)(e,this._outlineColor)||((0,f.c)(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if((0,n.Wi)(e)||0===e.length)return[];const t=(0,Ut.VP)(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,je.o.fromElevationInfo(this.elevationInfo)),i=[],a=t.numVertices,r=t.position;for(let n=0;n<a;++n){const e=(0,g.s)(hi,r[3*n+0],r[3*n+1],r[3*n+2]),t=ci(.5,e),a=ci(.5,e);i.push({vertexGeometry:t,vertexOutlineGeometry:a})}return i}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:a}of t)e.addGeometry(i,this.vertexMaterial),e.addGeometry(a,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new ii({...this.vertexMaterialParameters,writeDepth:!0,cullFace:ge.Vr.Back,screenSizeEnabled:!0}),this.vertexOutlineMaterial=new ii({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:ge.Vr.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const hi=(0,m.c)();function ci(e,t){return ve.Z.createSphereGeometry(e,16,16,{offset:t})}let di=class extends xt.Z.EventedAccessor{constructor(e){super(e),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};(0,a._)([(0,o.Cb)({constructOnly:!0})],di.prototype,"graphic",void 0),(0,a._)([(0,o.Cb)()],di.prototype,"tracking",void 0),(0,a._)([(0,o.Cb)()],di.prototype,"displaying",void 0),(0,a._)([(0,o.Cb)()],di.prototype,"isDraped",void 0),di=(0,a._)([(0,c.j)("esri.views.3d.layers.graphics.GraphicState")],di);var pi=i(77566),ui=i(42046),gi=i(54016);let mi=class extends pi.T{constructor(e){super(e),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:e,offset:t}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new p.Z({mode:e,offset:t})}normalizeCtorArgs(e){if(!e.elevationInfo){var t;const i=null==(t=e.hasZ)||t;return{...e,elevationInfo:{mode:i?"absolute-height":"on-the-ground",offset:0}}}return e}initializeGraphic(e){return this._createGraphicState=new di({graphic:e}),(0,r.AL)([this.view.maskOccludee(e),this.view.trackGraphicState(this._createGraphicState),(0,s.S1)(this._createGraphicState,"isDraped",(e=>{(0,n.pC)(this._outlineVisualElement)&&(this._outlineVisualElement.isDraped=e)}))])}makeDrawOperation(){return new ui.w({view:this.view,manipulators:this.manipulators,geometryType:(0,pi.I)(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new gi.iW(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new gi.aL(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new rt})}onActiveVertexChanged(e){return(0,n.pC)(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[e],null):(this._activeVertexVisualElement=new li({view:this.view,spatialReference:this.view.spatialReference,vertices:[e],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:Et.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=Et.colorToVec4(Et.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,(0,r.kB)((()=>{this._activeVertexVisualElement=(0,n.SC)(this._activeVertexVisualElement)})))}onOutlineChanged(e){if((0,n.pC)(this._outlineVisualElement))return this._outlineVisualElement.geometry=e,null;const t=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new It({view:this.view,geometry:e,elevationInfo:t,isDraped:(0,n.pC)(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===(0,d.Zz)(this.hasZ,t),attached:!1}),Et.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),Et.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,(0,r.kB)((()=>{this._outlineVisualElement=(0,n.SC)(this._outlineVisualElement)}))}onRegularVerticesChanged(e){return(0,n.pC)(this._verticesVisualElement)?(this._verticesVisualElement.vertices=e,null):(this._verticesVisualElement=new li({view:this.view,spatialReference:this.view.spatialReference,vertices:e,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:Et.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,(0,r.kB)((()=>{this._verticesVisualElement=(0,n.SC)(this._verticesVisualElement)})))}};(0,a._)([(0,o.Cb)({constructOnly:!0})],mi.prototype,"elevationInfo",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0})],mi.prototype,"geometryType",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],mi.prototype,"type",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],mi.prototype,"view",void 0),mi=(0,a._)([(0,c.j)("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],mi);var _i=i(81608),fi=i(41691),vi=i(37818),yi=(i(59486),i(41644)),bi=i(23879),Mi=i(22753),Si=i(11873),wi=i(92183),Ei=i(65156),xi=i(77648);function Ci(e,t,i){return function(e,t,i){const a=(0,Pe.Wv)((0,De.c)(Ue.WM.get(),t));if(a[2]=0,!e.unprojectFromRenderScreen(a,i.origin))return null;const r=(0,Pe.Wv)((0,De.c)(Ue.WM.get(),t));r[2]=1;const s=e.unprojectFromRenderScreen(r,Ue.WM.get());return(0,n.Wi)(s)?null:((0,g.f)(i.direction,s,i.origin),i)}(e,e.screenToRender(t,(0,Pe.Wv)(Ue.WM.get())),i)}var Oi=i(30425),Ai=i(99034),Pi=i(7882);class Di{constructor(e){this.camera=new Oi.Z,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=[],this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=(0,L.c)(),this._worldFrame=null,this._renderLocation=(0,m.c)(),this._renderLocationDirty=!0,this._location=new Pi.Z({x:0,y:0,z:0}),this._elevationAlignedLocation=new Pi.Z,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=Ai.jg.None,this._focused=!1,this.events=new xt.Z.EventEmitter,this._screenLocation={screenPointArray:(0,Pe.s1)(),renderScreenPointArray:(0,Pe.J$)(),pixelSize:0},this._screenLocationDirty=!0,this._applyObjectTransform=null,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayer=null,this._materialIdReferences=null,this._location.spatialReference=e.view.spatialReference;for(const t in e)this[t]=e[t];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}destroy(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this.camera=null}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),{remove:(0,bi.IH)((()=>{this._noDisplayCount--,0===this._noDisplayCount&&this._updateEngineObject()}))}}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){Ri(e)&&(this._screenLocationDirty=!0),(0,T.c)(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=(0,L.c)()),function(e,t,i){switch(e.viewingMode){case"local":return(0,T.i)(i),!0;case"global":{const a=(0,wi.Iu)(e.renderCoordsHelper.spatialReference);(0,We.PR)(t,0,Ni,0,a.radius),(0,We.yH)((0,E.Vl)(Ni[0]),(0,E.Vl)(Ni[1]),i)}}}(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){(0,vi.WG)(e,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){(0,vi.WG)(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;const e=(0,n.pC)(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=this.location.spatialReference,this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,t){t?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:!0===e?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;let e;if(this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1,Ri(this._modelTransform)){const t=this._calculateModelTransformOffset(ji);e=(0,g.b)(t,t,this.renderLocation)}else e=this.renderLocation;this.camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}intersectionDistance(e,t){if(!this.available)return null;const i=(0,Pe.md)(e,Ti),a=this._getCollisionRadius(t),r=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if((0,De.a)(this.screenLocation.screenPointArray,i)<a*a)return this.screenLocation.renderScreenPointArray[2]+r;break;case"line":{const e=this.collisionType.paths,t=this._getWorldToScreenObjectScale(),s=this._calculateObjectTransform(t,zi),o=a*this.screenLocation.pixelSize,l=Ci(this.camera,i,Gi);if((0,n.Wi)(l))return null;for(const i of e){if(0===i.length)continue;const e=(0,g.m)(Ni,i[0],s);for(let t=1;t<i.length;t++){const a=(0,g.m)(Ui,i[t],s),n=(0,M.Gr)((0,M.zk)(e,a,Li),l);if(null!=n&&n<o*o){const t=(0,g.b)(Ue.WM.get(),e,a);(0,g.a)(t,t,.5);const i=(0,Pe.So)(Ue.WM.get());return this.camera.projectToRenderScreen(t,i),i[2]+r}(0,g.g)(e,a)}}break}case"disc":{var s;const e=this.collisionType.direction,t=null!=(s=this.collisionType.offset)?s:m.Z,o=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(o,zi),h=a*this.screenLocation.pixelSize,c=Ci(this.camera,i,Gi);if((0,n.Wi)(c))return null;const d=(0,Mi.f)(Vi,l),p=(0,g.t)(Hi,e,d),u=(0,g.m)(ki,t,l);(0,O.Yq)(u,p,Wi);const _=Fi;if((0,O.BR)(Wi,c,_)&&(0,g.h)(_,u)<h*h)return this.screenLocation.renderScreenPointArray[2]+r;break}case"ribbon":{const{paths:e,direction:t}=this.collisionType,s=this._getWorldToScreenObjectScale(),o=this._calculateObjectTransform(s,zi),l=a*this.camera.computeScreenPixelSizeAt(this.renderLocation),h=Ci(this.camera,i,Gi);if((0,n.Wi)(h))return null;const c=(0,Mi.f)(Vi,o),d=(0,g.t)(Hi,t,c),p=this._calculateModelTransformPosition(ki);(0,O.Yq)(p,d,Wi);const u=Fi;if(!(0,O.BR)(Wi,h,u))break;for(const i of e){if(0===i.length)continue;const e=(0,g.m)(Ni,i[0],o);for(let t=1;t<i.length;t++){const a=(0,g.m)(Ui,i[t],o),n=(0,M.Jk)((0,M.zk)(e,a,Li),u);if(null!=n&&n<l*l){const t=(0,g.b)(Ue.WM.get(),e,a);(0,g.a)(t,t,.5);const i=(0,Pe.So)(Ue.WM.get());return this.camera.projectToRenderScreen(t,i),i[2]+r}(0,g.g)(e,a)}}break}default:(0,yi.Bg)(this.collisionType)}return null}attach(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{manipulator3D:{}};var t;if(!this.view._stage)return;const i=e.manipulator3D;if((0,n.Wi)(i.engineLayerId)){const e=new _e.F({isPickable:!1,updatePolicy:ge.jq.SYNC});this.view._stage.add(e),i.engineLayerId=e.id,this._engineLayer=e}else null!=(t=this.view._stage)&&t.getObject&&(this._engineLayer=this.view._stage.getObject(i.engineLayerId));i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._materialIdReferences=i.materialIdReferences,(0,n.Wi)(this._materialIdReferences)&&(this._materialIdReferences=new Map,i.materialIdReferences=this._materialIdReferences),this.camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),(0,We.Up)(this._location.spatialReference,this.view.spatialReference)||(this.location=new Pi.Z({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{manipulator3D:{}}).manipulator3D;e.engineLayerReferences--;const t=0===e.engineLayerReferences;t&&(e.engineLayerId=null),this._removeResourcesFromStage(t),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this.camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){(0,We.nF)(this.location,Zi,e.spatialReference),(0,Ei.Qn)(e.extent,Zi)&&(this.location=this._location)}_evaluateElevationAlignment(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.location;if((0,n.Wi)(this.elevationInfo))return!1;let t=null,i=0;const a=(0,n.Pt)(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":t=(0,n.Pt)((0,xi.KO)(this.view.elevationProvider,e,"ground"),0);break;case"relative-to-ground":i=(0,n.Pt)((0,xi.KO)(this.view.elevationProvider,e,"ground"),0)+a;break;case"relative-to-scene":i=(0,n.Pt)((0,xi.KO)(this.view.elevationProvider,e,"scene"),0)+a;break;case"absolute-height":i=a}return(i!==this._elevation.offset||t!==this._elevation.override)&&(this._elevation.offset=i,this._elevation.override=t,!0)}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=zi;if(!0===this.autoScaleRenderObjects){const i=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(i,t)}else this._calculateObjectTransform(e,t);const{objectsByState:i}=this._ensureEngineResources(),a=(this.focused?Ai.Q9.Focused:Ai.Q9.Unfocused)|(this.selected?Ai.Q9.Selected:Ai.Q9.Unselected),r=this._noDisplayCount>0;for(const{stateMask:n,objects:s}of i){if(r){for(const e of s)e.setVisible(!1);continue}const e=(n&Ai.Q9.All)!==Ai.Q9.None,i=(n&Ai.jg.All)!==Ai.jg.None,o=!e||(a&n)==(n&Ai.Q9.All),l=!i||(this.state&n)==(n&Ai.jg.All);if(o&&l)for(const a of s)a.setVisible(!0),a.transformation=t;else for(const t of s)t.setVisible(!1)}}_ensureEngineResources(){if((0,n.Wi)(this._engineResources)){const e=(0,n.Wg)(this._engineLayer),t=[],i=new Set;this.renderObjects.forEach((e=>{let{material:a}=e;i.has(a)||(t.push(a),i.add(a))}));const a=(e,t)=>{const{geometry:i,material:a,transform:r}=t;Array.isArray(i)?i.forEach((t=>e.addGeometry(t,a,r))):e.addGeometry(i,a,r)},r=new Map;this._renderObjects.forEach((e=>{const t=new me.T({castShadow:!1});a(t,e);const i=e.stateMask||0,n=r.get(i)||[];n.push(t),r.set(i,n)}));const s=[];r.forEach(((e,t)=>s.push({stateMask:t,objects:e}))),this._engineResources={objectsByState:s,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){if(this._engineResourcesAddedToStage||(0,n.Wi)(this._engineResources))return;const{objectsByState:e,layer:t,materials:i}=this._engineResources;i.forEach((e=>{const t=(0,n.Wg)(this._materialIdReferences),i=t.get(e.id)||0;0===i&&this.view._stage.add(e),t.set(e.id,i+1)})),e.forEach((e=>{let{objects:i}=e;t.addMany(i),this.view._stage.addMany(i)})),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this._engineResourcesAddedToStage||(0,n.Wi)(this._engineResources)||!this.view._stage)return;const{objectsByState:t,layer:i,materials:a}=this._engineResources;t.forEach((e=>{let{objects:t}=e;i.removeMany(t),this.view._stage.removeMany(t)})),a.forEach((e=>{const t=(0,n.Wg)(this._materialIdReferences),i=t.get(e.id);1===i?(this.view._stage.remove(e),t.delete(e.id)):t.set(e.id,i-1)})),e&&this.view._stage.remove(i),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*("touch"===e?this.touchMultiplier:1)}_getFocusedSize(e,t){return e*(t?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,Ii);return(0,g.s)(e,i[12],i[13],i[14])}_calculateModelTransformOffset(e){const t=this._calculateModelTransformPosition(e);return(0,g.f)(e,t,this.renderLocation)}_calculateObjectTransform(e,t){return(0,T.s)(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&(0,T.m)(t,t,this._worldFrame),(0,T.m)(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,(0,n.pC)(this._applyObjectTransform)&&this._applyObjectTransform(t),t}get test(){let e=!1;if((0,n.pC)(this._engineResources))for(const t in this._engineResources.objectsByState){const i=this._engineResources.objectsByState[t];for(const t of i.objects)if(t.isVisible){e=!0;break}if(e)break}return{areAnyResourcesVisible:e}}}function Ri(e){return 0!==e[12]||0!==e[13]||0!==e[14]}const Ti=(0,Pe.s1)(),Li=(0,M.Ue)(),Gi=(0,S.Ue)(),Vi=(0,Si.c)(),Ii=(0,L.c)(),zi=(0,L.c)(),Wi=(0,O.Ue)(),Ni=(0,m.c)(),Ui=(0,m.c)(),Fi=(0,m.c)(),Hi=(0,m.c)(),ki=(0,m.c)(),ji=(0,m.c)(),Zi=new Pi.Z({x:0,y:0,z:0,spatialReference:null});var Bi=i(96387);function qi(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ye.yD.OccludeAndTransparent,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const a=(0,C.f)(e[0],e[1],e[2],e.length>3?e[3]:1),r=e[3]<1;return i?new ii({color:a,transparent:r,writeDepth:!0,cullFace:ge.Vr.Back,renderOccluded:t}):new Je.E({color:a,transparent:r,writeDepth:!0,cullFace:ge.Vr.Back,renderOccluded:t})}function Yi(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ye.yD.OccludeAndTransparent;const i=(0,C.f)(e[0],e[1],e[2],4===e.length?e[3]:1);return new Je.E({color:i,transparent:!0,writeDepth:!0,cullFace:ge.Vr.Front,renderOccluded:t})}function Xi(e,t,i,a){const r=(0,g.f)(Ue.WM.get(),e,i),n=Qi(r,(0,g.c)(Ue.WM.get(),a,r),i,Ue.MP.get());(0,T.a)(n,n);const s=(0,g.m)(Ue.WM.get(),t,n);return Math.atan2(s[1],s[0])}function Qi(e,t,i,a){const r=(0,g.n)(Ue.WM.get(),e),n=(0,g.n)(Ue.WM.get(),t),s=(0,g.c)(Ue.WM.get(),r,n);return a[0]=r[0],a[1]=r[1],a[2]=r[2],a[3]=0,a[4]=n[0],a[5]=n[1],a[6]=n[2],a[7]=0,a[8]=s[0],a[9]=s[1],a[10]=s[2],a[11]=0,a[12]=i[0],a[13]=i[1],a[14]=i[2],a[15]=1,a}function Ki(e,t){const i=e.getViewForGraphic(t);return(0,n.pC)(i)&&"computeAttachmentOrigin"in i?i.computeAttachmentOrigin(t,e.spatialReference):null}function Ji(e,t,i){const a=Ki(e,i);(0,n.pC)(a)?t.elevationAlignedLocation=a:function(e,t){if((0,n.Wi)(t))return;const i="mesh"===t.type?t.anchor:(0,Bi.zE)(t);(0,n.Wi)(i)||(e.location=(0,vi.kB)(i))}(t,i.geometry)}var $i,ea,ta=i(77498);function ia(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,d.RL)(e);return"on-the-ground"!==t.mode&&!((0,n.Wi)(e.geometry)||!e.geometry.hasZ)}!function(e){e[e.NONE=0]="NONE",e[e.ANY=1]="ANY",e[e.Z=2]="Z",e[e.XY=4]="XY"}($i||($i={})),function(e){e[e.TRANSLATE_Z=0]="TRANSLATE_Z",e[e.TRANSLATE_XY=1]="TRANSLATE_XY",e[e.SCALE=2]="SCALE",e[e.ROTATE=3]="ROTATE",e[e.SCALE_ROTATE=4]="SCALE_ROTATE"}(ea||(ea={}));class aa{constructor(){this.grabbingState=$i.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=$i.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator(((e,t)=>{if(t===ea.TRANSLATE_Z&&(this.zManipulator=e),e instanceof Di&&(e.selected&&(0===this.numSelected&&(this.firstSelected=e),this.numSelected++),(0,n.Wi)(this.firstGrabbedXY)&&e.grabbing&&t===ea.TRANSLATE_XY&&(this.firstGrabbedXY=e)),e.grabbing)switch(this.grabbingState|=$i.ANY,t){case ea.TRANSLATE_Z:this.grabbingState|=$i.Z;break;case ea.TRANSLATE_XY:this.grabbingState|=$i.XY}}))}}function ra(e){const{view:t,graphic:i}=e,a=new di({graphic:i}),n=function(e,t){const{view:i,graphic:a}=e,n=new It({view:i,geometry:sa(a)?a.geometry:null,elevationInfo:(0,d.RL)(a),attached:!1});Et.visualElements.lineGraphics.shadowStyle.apply(n);const s=()=>{n.attached=t.displaying};Et.visualElements.lineGraphics.outline.apply(n);const o=[t.watch("displaying",s),t.watch("isDraped",(e=>n.isDraped=e)),t.on("changed",(()=>n.geometry=sa(a)?a.geometry:null)),(0,r.ed)(n)];return s(),{visualElement:n,remove:()=>(0,r.AL)(o).remove()}}(e,a),s=[n,na(e,n.visualElement,a),t.maskOccludee(i),t.trackGraphicState(a)];return{visualElement:n.visualElement,remove:()=>(0,r.AL)(s).remove()}}function na(e,t,i){const{graphic:a,view:s}=e,o=[],l=(0,d.RL)(a),h="on-the-ground"===l.mode||!l.offset&&"absolute-height"!==l.mode,c=new aa,p=new Me({view:s,extensionType:Et.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:ye.yD.OccludeAndTransparent});Et.visualElements.pointGraphics.shadowStyle.apply(p);const u=(0,E.Vl)(Et.visualElements.heightPlaneAngleCutoff),m=new pe({view:s,attached:!1,angleCutoff:u});Et.visualElements.heightPlane.apply(m);let _=1,f=1;const v=()=>{if(c.update(e),!i.displaying||h&&(i.isDraped||!sa(a)||!a.geometry.hasZ))return t.laserlineEnabled=!1,p.attached=!1,void(m.attached=!1);t.laserlineEnabled=!0;{const e=c.grabbingState&$i.XY?Et.visualElements.laserlineAlphaMultiplier:1;e!==_&&(_=e,Et.visualElements.lineGraphics.shadowStyle.apply(t,e),Et.visualElements.pointGraphics.shadowStyle.apply(p,e))}{const e=c.grabbingState&$i.Z?Et.visualElements.laserlineAlphaMultiplier:1;e!==f&&(f=e,Et.visualElements.heightPlane.apply(m,e))}(function(e,t){const i=1===t.numSelected?t.firstSelected:t.numSelected>1&&(0,n.pC)(t.firstGrabbedXY)?t.firstGrabbedXY:null;(0,n.pC)(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1})(p,c),function(e,t,i,a){if(a.numSelected>0){(0,g.s)(oa,0,0,0);let t=0;e.forEachManipulator(((e,i)=>{i===ea.TRANSLATE_XY&&e.selected&&e instanceof Di&&((0,g.b)(oa,oa,e.renderLocation),t++)})),t>0?(i.heightManifoldTarget=(0,g.a)(oa,oa,1/t),i.attached=!0):i.attached=!1}else{const a=t.attachmentOrigin;(0,n.pC)(a)&&e.view.renderCoordsHelper.toRenderCoords(a,oa)?(i.heightManifoldTarget=oa,i.attached=!0):i.attached=!1}}(e,t,m,c)};Et.visualElements.zVerticalLine.apply(p),o.push(i.on("changed",v),i.watch("displaying",v),t.events.on("attachment-origin-changed",v),(0,r.ed)(p),(0,r.ed)(m));const y=[],b=()=>{(0,r.AL)(y).remove(),y.length=0,e.forEachManipulator((e=>y.push(e.events.on("grab-changed",v)))),e.forEachManipulator((e=>y.push(e.events.on("select-changed",v)))),v()};return b(),o.push(e.onManipulatorsChanged(b),(0,r.iU)((()=>(0,r.AL)(y)))),(0,r.AL)(o)}function sa(e){return(0,n.pC)(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const oa=(0,m.c)();function la(e){const{view:t,graphic:i}=e,a=new di({graphic:i}),o=[],l=function(e,t,i){const{view:a,graphic:o}=e,l=new qe({view:a,geometry:ha(o),elevationInfo:(0,d.RL)(o),attached:!1});return function(e,t,i,a){const o=()=>t.attached=i.displaying;(function(e,t,i,a){const{view:s,graphic:o}=e;let l=null;const h=e=>{(0,n.pC)(l)&&(l.remove(),l=null),i.isDraped&&(0,n.pC)(e)&&(l=function(e,t,i){const a=e.elevationProvider.spatialReference;(0,We.KC)(t,ca,a);const r=ca[0],n=ca[1];return e.elevationProvider.on("elevation-change",(e=>{(0,Ei.jE)(e.extent,r,n)&&i()}))}(s,e,(()=>{t.geometry=e})))},c=()=>{const e=ha(o);h(e),t.geometry=e};a.push(i.on("changed",c),(0,r.iU)((()=>l))),c()})(e,t,i,a),Et.visualElements.pointGraphics.outline.apply(t),a.push((0,s.S1)(i,"displaying",o))}(e,l,t,i),i.push((0,r.ed)(l)),l}(e,a,o);return function(e,t,i,a){const{view:s,graphic:o}=e,l=new Me({view:s,extensionType:Et.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:ye.yD.OccludeAndTransparent});Et.visualElements.zVerticalLine.apply(l);const h=new pe({view:s,intersectsLineInfinite:!0,attached:!1});Et.visualElements.pointGraphics.shadowStyle.apply(h);const c=(0,E.Vl)(Et.visualElements.heightPlaneAngleCutoff),p=new pe({view:s,attached:!1,angleCutoff:c});Et.visualElements.heightPlane.apply(p);const u=(0,d.RL)(e.graphic),m=je.o.fromElevationInfo(u),_="on-the-ground"===u.mode||!u.offset&&"absolute-height"!==u.mode,f=new aa;let v=1,y=1;const b=()=>{f.update(e);const i=ha(o),r=_&&(t.isDraped||(0,n.Wi)(i)||!i.hasZ);let c=!0;if(!r&&(0,n.pC)(i)){const e=(0,ke.w7)(i,s.elevationProvider,m,s.renderCoordsHelper);(0,g.s)(ca,i.x,i.y,e),(0,We.SH)(ca,i.spatialReference,ca,s.renderCoordsHelper.spatialReference),l.setStartEndFromWorldDownAtLocation(ca),h.intersectsWorldUpAtLocation=ca}else c=!1;const d=f.grabbingState&$i.Z?Et.visualElements.laserlineAlphaMultiplier:1;d!==v&&(v=d,Et.visualElements.heightPlane.apply(p,d));const u=(0,Ne.cS)(da);!r&&t.displaying&&a.calculateMapBounds(u)&&(0,We.SH)((0,Ne.KE)(u,ca),s.spatialReference,ca,s.renderCoordsHelper.spatialReference)?(p.heightManifoldTarget=ca,p.attached=!0):p.attached=!1;const b=f.grabbingState&$i.XY?Et.visualElements.laserlineAlphaMultiplier:1;b!==y&&(y=b,Et.visualElements.pointGraphics.shadowStyle.apply(h,b));const M=c&&t.displaying&&!r;h.attached=M,l.attached=M};i.push(t.watch(["displaying","isDraped"],b),t.on("changed",b)),e.forEachManipulator((e=>{i.push(e.events.on("grab-changed",b))})),i.push((0,r.ed)(h)),i.push((0,r.ed)(l)),i.push((0,r.ed)(p)),b()}(e,a,o,l),o.push(t.trackGraphicState(a)),{visualElement:l,remove(){(0,r.AL)(o).remove()}}}function ha(e){const t=e.geometry;return(0,n.Wi)(t)?null:"point"===t.type?t:"mesh"===t.type?t.anchor.clone():null}const ca=(0,m.c)(),da=(0,Ne.Ue)();function pa(e){switch((0,n.Wg)(e.graphic.geometry).type){case"point":case"mesh":return la(e);case"polygon":case"polyline":return ra(e);default:return null}}const ua=[1,.5,0],ga=70,ma=Math.ceil(ga/3*2),_a=160,fa=5*Math.PI/12,va=1*Math.PI/3;class ya{constructor(){this._available=!0}set location(e){this._forEachManipulator3D((t=>t.location=e))}set elevationAlignedLocation(e){this._forEachManipulator3D((t=>t.elevationAlignedLocation=e))}set elevationInfo(e){this._forEachManipulator3D((t=>t.elevationInfo=e))}get renderLocation(){let e;return this._forEachManipulator3D((t=>{e||(e=t.renderLocation)})),e}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D((t=>t.available=e))}get grabbing(){return this.someManipulator((e=>e.grabbing))}get dragging(){return this.someManipulator((e=>e.dragging))}hasManipulator(e){return this.someManipulator((t=>t===e))}someManipulator(e){let t=!1;return this.forEachManipulator((i=>{!t&&e(i)&&(t=!0)})),t}_forEachManipulator3D(e){this.forEachManipulator(((t,i)=>{t instanceof Di&&e(t,i)}))}}var ba,Ma=i(40927),Sa=(i(81268),i(54463),i(76783),i(74229));function wa(e,t){return Ea(e,(()=>t))}function Ea(e,t){const i=(0,m.c)(),a=(0,m.c)();let r=!1;return s=>{const o=t(s);if("start"===s.action){const t=(0,Pe.md)(s.screenStart,(0,Pe.c$)(Ue.qW.get())),a=Ci(e.state.camera,t,Ta);(0,n.pC)(a)&&(r=(0,O.BR)(o,a,i))}if(!r)return null;const l=(0,Pe.md)(s.screenEnd,(0,Pe.c$)(Ue.qW.get())),h=Ci(e.state.camera,l,Ta);return(0,n.Wi)(h)?null:(0,O.BR)(o,h,a)?{...s,renderStart:i,renderEnd:a,plane:o,ray:h}:null}}function xa(e,t,i){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=null;return o=>{if("start"===o.action&&(s=e.sceneIntersectionHelper.intersectElevationFromScreen((0,Pe.s1)(o.screenStart.x,o.screenStart.y),t,i,r),(0,n.pC)(s)&&(0,n.pC)(a)&&!(0,We.nF)(s,s,a)))return null;if((0,n.Wi)(s))return null;const l=e.sceneIntersectionHelper.intersectElevationFromScreen((0,Pe.s1)(o.screenEnd.x,o.screenEnd.y),t,i,r);return(0,n.pC)(l)?(0,n.pC)(a)&&!(0,We.nF)(l,l,a)?null:{...o,mapStart:s,mapEnd:l}:null}}function Ca(e,t,i){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return xa(e,i,(0,d.Ou)(t,e,i),a,r)}function Oa(e,t,i){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return Ca(e,i,(0,d.RL)(t),a,r)}function Aa(e,t,i){let a=null;const r=new Sa.hM;return r.next(wa(e,function(e,t){const i=Da,a=Ra,r=(0,O.Ue)();e.renderCoordsHelper.worldUpAtPosition(t,i);const n=(0,g.c)(r,i,(0,g.f)(a,t,e.state.camera.eye));return(0,g.c)(n,n,i),(0,O.Yq)(t,n,r)}(e,t))).next(function(e,t){const i=(0,m.c)(),a=(0,g.l)(t);e.renderCoordsHelper.worldUpAtPosition(t,i);const r=(0,m.c)(),n=(0,m.c)(),s=r=>((0,g.f)(r,r,t),(0,Ma.nF)(i,r,r),"global"===e.viewingMode&&(0,g.l)(r)*Math.sign((0,g.d)(i,r))<.001-a&&(0,g.f)(r,(0,g.a)(r,i,.001),t),(0,g.b)(r,r,t),r);return e=>(e.renderStart=s((0,g.g)(r,e.renderStart)),e.renderEnd=s((0,g.g)(n,e.renderEnd)),e)}(e,t)).next(Pa(e,i)).next((e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,a=e})),e=>(a=null,r.execute(e),a)}function Pa(e,t){const i=e.renderCoordsHelper;return e=>{const a=i.fromRenderCoords(e.renderStart,t),r=i.fromRenderCoords(e.renderEnd,t);return(0,n.pC)(a)&&(0,n.pC)(r)?{...e,mapStart:a,mapEnd:r}:null}}!function(e){e[e.GROUND=0]="GROUND",e[e.OTHER=1]="OTHER"}(ba||(ba={}));const Da=(0,m.c)(),Ra=(0,m.c)(),Ta=(0,S.Ue)();function La(e,t,i,a){const r=e.graphic,n=(e,i)=>t({action:e,graphic:r,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY});return i(((e,t,i)=>{const s=t.next((e=>("start"===e.action&&n("start",e),e))).next((0,Sa.a9)(r,a)).next((e=>{switch(e.action){case"start":case"update":(e.translationX||e.translationY||e.translationZ)&&n("update",e);break;case"end":n("end",e)}return e}));return i.next((0,Sa.bD)(r)).next((()=>{n("end",{screenDeltaX:0,screenDeltaY:0})})),s}))}function Ga(e){if((0,n.Wi)(e)||"polyline"!==e.type&&"polygon"!==e.type)return 0;const t=("polyline"===e.type?e.paths:e.rings)[0];if(!t||t.length<2)return 0;const i=t[0],a=t[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}class Va extends ya{constructor(e){super(),this._handles=new _.Z,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=ga,this._updateAfterDrag=!1,this.events=new xt.Z,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._handles=(0,n.SC)(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:t}of this._arrowManipulatorInfos)e(t,ea.TRANSLATE_XY)}createGraphicDragPipeline(e,t,i){const a=t.graphic,r=(0,d.RL)(a),s=(0,n.Wg)(a.geometry).spatialReference;return La(t,i,(t=>this.createDragPipeline(((i,a,r,n,s)=>t(i,e(i,a,r,n,s),r)),r,s,a)),this._view.state.viewingMode)}createDragPipeline(e,t,i,a){return(0,r.AL)(this._arrowManipulatorInfos.map(((r,n)=>{let{manipulator:s}=r;return(0,Sa.Xd)(s,((r,s,o,l,h)=>{const c=s.next((e=>({...e,manipulatorType:ea.TRANSLATE_XY}))).next((0,Sa.kY)(this._view,r.elevationAlignedLocation)).next(Ca(this._view,r.elevationAlignedLocation,t,i,a)).next((0,Sa.M2)(r.location,this.angle+(n+1)*Math.PI*.5)).next((0,Sa.zh)());e(r,c,o,l,h)}))})))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator(e,t){let{manipulator:i,transform:a}=e;const r=this._radius/ga,n=54*r,s=n*Math.sqrt(3)/2,o=ve.Z.createExtrudedTriangle(s,n/2,n/2,.02);ve.Z.transformInPlace(o,(0,T.f)(Ue.MP.get(),(0,g.s)(Ue.WM.get(),0,-s/3,0))),i.renderObjects=[{geometry:o,material:this._opaqueMaterial,stateMask:Ai.Q9.Focused},{geometry:o,material:this._transparentMaterial,stateMask:Ai.Q9.Unfocused}],i.radius=s/3*2*1.2;const l=(0,T.b)(Ue.MP.get(),t*Math.PI/2),h=(0,T.f)(Ue.MP.get(),(0,g.s)(Ue.WM.get(),0,100*r,0));(0,T.m)(a,l,h)}_createManipulators(){for(let e=0;e<4;e++){const t=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(t)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,t=(0,T.d)(Ue.MP.get(),e,(0,m.f)(0,0,1)),i=(0,T.u)(Ue.MP.get(),(0,g.s)(Ue.WM.get(),this.displayScale,this.displayScale,this.displayScale)),a=(0,T.m)(Ue.MP.get(),i,t);for(const r of this._arrowManipulatorInfos){const e=(0,T.m)(Ue.MP.get(),a,r.transform);r.manipulator.modelTransform=e}}_createArrowManipulator(e){const t=new Di({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:(0,m.f)(0,0,1)}}),i={manipulator:t,transform:(0,L.c)()};return this._updateArrowManipulator(i,e),this._handles.add(t.events.on("drag",(e=>{this._updateAfterDrag&&"end"===e.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}_createMaterial(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;const t=u.Z.toUnitRGBA(ot.main);return t[3]*=e,new Je.E({color:t,transparent:1!==e,cullFace:ge.Vr.Back,renderOccluded:ye.yD.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((e=>{let{manipulator:t}=e;return t}))}}}class Ia{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new Sa.hM,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&(0,n.pC)(this.lastDragEvent)){const t=this.lastDragEvent.mapEnd,i=this._snap(this.lastDragEvent.screenEnd);if((0,n.pC)(i)){const a={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:!0===e?i:t,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(a)}}this._enabled=e}_snap(e){const t=(0,n.pC)(this.view)?this.view.toMap(e,{exclude:[]}):null;return(0,n.pC)(t)&&(0,n.pC)(this.view)&&(t.z=(0,d.Ou)(t,this.view,this.elevationInfo)),t}createDragEventPipelineStep(e,t){return this.view=e,this.elevationInfo=t,this.lastDragEvent=null,e=>{if(this.lastDragEvent="end"!==e.action?{...e}:null,this._enabled){const t=this._snap(e.screenEnd);return(0,n.pC)(t)?{action:e.action,mapStart:e.mapStart,mapEnd:t,screenStart:e.screenStart,screenEnd:e.screenEnd}:null}return{action:e.action,mapStart:e.mapStart,mapEnd:e.mapEnd,screenStart:e.screenStart,screenEnd:e.screenEnd}}}}class za extends ya{constructor(e){super(),this._handles=new _.Z,this._snapToScene=new Ia,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=ga,this._view=e.view,this._tool=e.tool,null!=e.snapToScene&&(this.snapToScene=e.snapToScene),null!=e.radius&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,ea.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,t,i){const a=t.graphic,r=(0,d.RL)(a),s=(0,n.Wg)(a.geometry).spatialReference;return La(t,i,(t=>this.createDragPipeline(((i,a,r,n,s)=>t(i,e(i,a,r,n,s),r)),r,s,a)),this._view.state.viewingMode)}createDragPipeline(e,t,i,a){const r=this._view;return(0,Sa.Xd)(this._manipulator,((n,s,o,l,h)=>{const c=s.next((0,Sa.kY)(r,n.elevationAlignedLocation)).next(Ca(r,n.elevationAlignedLocation,t,i,a)).next(this._snapToScene.createDragEventPipelineStep(r,t),this._snapToScene.next).next((e=>({...e,manipulatorType:ea.TRANSLATE_XY}))).next((0,Sa.zh)());e(n,c,o,l,h)}))}_updateManipulatorTransform(){const e=(0,T.u)(Ue.MP.get(),(0,g.s)(Ue.WM.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new Di({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:(0,m.f)(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=ve.Z.createCylinderGeometry(.02,1,128,(0,m.f)(0,0,1),(0,m.f)(0,0,0)),t=(0,T.u)((0,L.c)(),(0,m.f)(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:t,stateMask:Ai.Q9.Focused},{geometry:e,material:this._discMaterialTransparent,transform:t,stateMask:Ai.Q9.Unfocused}],this._manipulator.radius=this._radius/ga*80}_createMaterial(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;const t=u.Z.toUnitRGBA(ot.main);return t[3]*=e,new Je.E({color:t,transparent:1!==e,cullFace:ge.Vr.Back,renderOccluded:ye.yD.Transparent})}get test(){return{discManipulator:this._manipulator}}}class Wa extends ya{constructor(e){super(),this._handles=new _.Z,this._radius=ga,this.events=new xt.Z,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))}forEachManipulator(e){e(this._manipulator,ea.TRANSLATE_Z)}createGraphicDragPipeline(e,t,i){const a=(0,n.Wg)(t.graphic.geometry).spatialReference;return La(t,i,(t=>this.createDragPipeline(((i,a,r,n,s)=>t(i,e(i,a,r,n,s),r)),a)),this._view.state.viewingMode)}createDragPipeline(e,t){const i=this._view;return(0,Sa.Xd)(this._manipulator,((a,r,n,s,o)=>{const l=r.next((e=>({...e,manipulatorType:ea.TRANSLATE_Z}))).next(Aa(i,a.renderLocation,t)).next((0,Sa.zh)());e(a,l,n,s,o)}))}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._radius/ga,t=Et.zManipulator.height*e,i=Et.zManipulator.coneHeight*e,a=Et.zManipulator.coneWidth*e,r=Et.zManipulator.width*e,n=[(0,m.f)(0,0,0),(0,m.f)(0,0,t)],s=ve.Z.createTubeGeometry(n,r/2,16,!1),o=ve.Z.createConeGeometry(i,a/2,16,!1),l=[(0,m.f)(0,0,0),(0,m.f)(0,0,t+i)],h=(e=>{const i=(0,L.c)();if((0,T.j)(i,i,[0,0,t]),(0,T.r)(i,i,Math.PI/2),e){const t=1+2*e/a;(0,T.h)(i,i,[t,t,t])}return i})(0),c=(e,t)=>{const i=(0,nt._j)(Et.zManipulator.color,t);return[i.r/255,i.g/255,i.b/255,Et.zManipulator.color.a*e]},d=qi(c(1,.25),ye.yD.Occlude),p=qi(c(1,0),ye.yD.Occlude),u=qi(c(.7,0),Et.zManipulator.renderOccluded),g=qi(c(.85,0),Et.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:o,transform:h,material:d,stateMask:Ai.Q9.Unfocused},{geometry:s,material:d,stateMask:Ai.Q9.Unfocused},{geometry:o,transform:h,material:p,stateMask:Ai.Q9.Focused},{geometry:s,material:p,stateMask:Ai.Q9.Focused},{geometry:o,transform:h,material:u,stateMask:Ai.Q9.Unfocused},{geometry:s,material:u,stateMask:Ai.Q9.Unfocused},{geometry:o,transform:h,material:g,stateMask:Ai.Q9.Focused},{geometry:s,material:g,stateMask:Ai.Q9.Focused}],this._manipulator.radius=r/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){const e=new Di({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const t=this._view.state.camera,i=Na;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const a=(0,g.j)(t.eye,i),r=t.computeRenderPixelSizeAtDist(a),n=(0,g.f)(Ua,i,t.eye);(0,g.n)(n,n);const s=Fa;this._view.renderCoordsHelper.worldUpAtPosition(Na,s);const o=Math.abs((0,g.d)(n,s)),l=(0,g.c)(Ua,n,s),h=(0,g.c)(Ua,l,s),c=(0,E.uZ)(o,.01,1),d=1-Math.sqrt(1-c*c)/c/t.fullWidth,p=this._radius/ga,u=Et.zManipulator.width*p;(0,g.a)(h,(0,g.n)(h,h),(1/d-1)*a+r*u),e[12]-=Ua[0],e[13]-=Ua[1],e[14]-=Ua[2]},this._manipulator=e,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const Na=(0,m.c)(),Ua=(0,m.c)(),Fa=(0,m.c)();class Ha extends ya{constructor(e){super(),this._handles=new _.Z,this._angleDeferred=null,this._interactive=!0;const{tool:t,view:i,snapToScene:a,radius:r}=e;this._view=i,this.xyManipulation=new za({tool:t,view:i,snapToScene:a,radius:r}),this.xyAxisManipulation=new Va({tool:t,view:i,radius:r}),this.zManipulation=new Wa({tool:t,view:i,radius:r}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator((e=>{this._handles.add(e.events.on("grab-changed",(()=>this._updateManipulatorInteractivity())))}))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,t,i){return(0,r.AL)([this.xyManipulation.createGraphicDragPipeline(((t,i,a,r,n)=>e(ja.XY,t,i,a,r,n)),t,i),this.xyAxisManipulation.createGraphicDragPipeline(((t,i,a,r,n)=>e(ja.XY_AXIS,t,i,a,r,n)),t,i),this.zManipulation.createGraphicDragPipeline(((t,i,a,r,n)=>e(ja.Z,t,i,a,r,n)),t,i)])}createDragPipeline(e,t,i,a){return(0,r.AL)([this.xyManipulation.createDragPipeline(((t,i,a,r,n)=>e(ja.XY,t,i,a,r,n)),t,i,a),this.xyAxisManipulation.createDragPipeline(((t,i,a,r,n)=>e(ja.XY_AXIS,t,i,a,r,n)),t,i,a),this.zManipulation.createDragPipeline(((t,i,a,r,n)=>e(ja.Z,t,i,a,r,n)),i)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator((t=>e(t,ea.TRANSLATE_XY))),this.xyAxisManipulation.forEachManipulator((t=>e(t,ea.TRANSLATE_XY))),this.zManipulation.forEachManipulator((t=>e(t,ea.TRANSLATE_Z)))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator((e=>e.focused))||this.xyAxisManipulation.someManipulator((e=>e.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||e}_autoHideXYAxis(){const e=this.xyAxisManipulation,t=this.xyManipulation;if((0,l.Z)("esri-mobile"))return;const i=[];t.forEachManipulator((e=>i.push(e))),e.forEachManipulator((e=>i.push(e)));const a=()=>{const t=[];this.xyAxisVisible?(0,n.pC)(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator((e=>t.push(e.disableDisplay()))),this._handles.remove(ka),this._handles.add(t,ka)};for(const r of i)this._handles.add(r.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",a)),a()}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator((t=>{t.interactive=!e&&this._interactive||t.grabbing}))}static radiusForSymbol(e){const t=(0,n.pC)(e)&&"point-3d"===e.type&&e.symbolLayers;return t&&t.length>0&&t.some((e=>"icon"===e.type))?ma:ga}}const ka="disable-xy-axis-display";var ja;!function(e){e[e.XY=0]="XY",e[e.XY_AXIS=1]="XY_AXIS",e[e.Z=2]="Z"}(ja||(ja={}));var Za=i(2346);class Ba extends ya{constructor(e){super(),this._handles=new _.Z,this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,ea.TRANSLATE_XY)}createGraphicDragPipeline(e){return La(this._graphicState,e,(e=>this.createDragPipeline(e)),this._view.state.viewingMode)}createDragPipeline(e){const t=this._view,i=this._graphicState.graphic,a=(0,n.pC)(i.geometry)?i.geometry.spatialReference:null;return(0,Sa.Xd)(this._manipulator,((r,s,o,l,h)=>{const c=s.next(function(e,t,i,a){const r=t.toMap(e.screenStart,{include:[i]});return(0,n.pC)(r)?Oa(t,i,r,a):null}(h,t,i,a)).next((0,Sa.AN)()).next((0,Sa.zh)());e(r,c,o,l,h)}))}_createManipulator(){const e=this._view,t=this._graphicState.graphic;this._manipulator=new Za.L({graphic:t,view:e,selectable:!0,cursor:"move"})}}var qa=i(57889),Ya=i(29919),Xa=i(87268),Qa=i(34019),Ka=i(80151);class Ja{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class $a{constructor(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"}}class er{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let tr=class extends((0,fi.p)(xt.Z.EventedMixin(Ya.m))){constructor(e){super(e),this.graphics=new _i.Z,this.enableZ=!0,this.type="move-3d",this._toolHandles=new _.Z,this.snappingPipeline=new Ka.n}initialize(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>(0,qa.P)(e)===ta.e.SUPPORTED)).map((e=>new ir(e)));e.length&&(this._createManipulators(e),this._createVisualElements(e),this.handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this._updateMoveManipulation(e))}_createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Ba({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:i.graphic}),e.stopPropagation()}))))),this.handles.add(t.manipulationXY.createDragPipeline(((t,i,a,r)=>this._buildDragEventPipeline(e,ja.XY,t,i,a,r))))}this._createMoveManipulation(e)}_createMoveManipulation(e){const t=new Ha({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?Ha.radiusForSymbol(e[0].graphic.symbol):ga});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this.handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this._updateMoveManipulation(e);for(const r of e)this.handles.add([r.state.on("changed",i),r.state.watch("displaying",i)]);const a=e[e.length-1];this.handles.add(a.state.on("changed",(()=>this._updateMoveManipulationAngle(a)))),this.handles.add(t.createDragPipeline(((t,i,a,r,n)=>this._buildDragEventPipeline(e,t,i,a,r,n)),(0,d.RL)(a.graphic),(0,n.Wg)(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)}_createVisualElements(e){for(const t of e){const i=t.graphic,a=pa({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>(0,r.kB)()});(0,n.Wi)(a)||(t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof It&&this.handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this._updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this._updateMoveManipulation(e)))]),this.handles.add(a))}}_updateMoveManipulationAngle(e){this._moveManipulation.angleDeferred=()=>Ga(e.graphic.geometry)}_updateMoveManipulation(e){const t=(0,Ct.Tx)(0,0,0,this.view.spatialReference);let i=0,a=!1;const r=this._moveManipulation;for(const s of e){if(!s.state.displaying)continue;const e=s.state.graphic;this.enableZ&&ia(e)&&(a=!0);const r=s.geometryRepresentation instanceof It&&!s.state.isDraped?s.geometryRepresentation.attachmentOrigin:Ki(this.view,e);(0,n.pC)(r)&&(t.x+=r.x,t.y+=r.y,t.z+=r.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,r.location=t,r.xyManipulation.available=!0,r.xyAxisManipulation.available=!0,r.zManipulation.available=a):r.available=!1}_buildDragEventPipeline(e,t,i,a,r,n){const s=[],o=[];let l=null,h=null;const c=()=>{for(const e of s)e.dragging=!1;s.length=0,o.length=0,l=null,h=null,this._moveManipulation.interactive=!0};if(1===e.length&&t===ja.XY){const t=e[0].graphic;a=this._buildSnappingPipelineSteps(t,(0,d.RL)(t),a,r,n)}const p=a.next((t=>{if("start"===t.action){s.length=0,o.length=0;for(const t of e)t.dragging||!t.manipulationXY.hasManipulator(i)&&t.manipulationXY.grabbing||(s.push(t),o.push(t.graphic),t.dragging=!0);if(0!==o.length&&(this._moveManipulation.interactive=!1,l=(0,Sa.oq)(o,this.view.state.viewingMode),h=(0,Sa.QY)(o),this.emit("graphic-move-start",new Ja(o)),this.destroyed))return null}return 0!==o.length?t:null})).next((e=>l(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),a=i.x-t.x,r=i.y-t.y;if(this.emit("graphic-move",new $a(a,r,o)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new er(o)),this.destroyed)return null;c()}}));return r.next((e=>h(e))).next((()=>{if(this.emit("graphic-move-stop",new er(o)),this.destroyed)return null;c()})),p}_buildSnappingPipelineSteps(e,t,i,a,r){const s=e.geometry;if((0,n.Wi)(s)||"point"!==s.type&&"mesh"!==s.type)return i;const o=("point"===s.type?s:s.anchor).clone(),l=new Qa.N({elevationInfo:t,pointer:r,editGeometryOperations:Xa.c.fromGeometry(o,this.view.state.viewingMode),visualizer:new rt,excludeFeature:e}),h=this.snappingManager;return i.next((t=>(o.z=(0,d.vQ)(this.view,o,(0,d.RL)(e),{mode:"absolute-height",offset:0}),{...t,snapOrigin:l.coordinateHelper.pointToVector(o)}))).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:l,snappingManager:h,cancel:a,updatingHandles:this.updatingHandles}),this.snappingPipeline.next)}};(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],tr.prototype,"view",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],tr.prototype,"graphics",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],tr.prototype,"enableZ",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0})],tr.prototype,"snappingManager",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],tr.prototype,"type",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],tr.prototype,"updating",null),tr=(0,a._)([(0,c.j)("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],tr);class ir{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new di({graphic:e})}get graphic(){return this.state.graphic}}var ar=i(46684),rr=i(29909),nr=i(74579),sr=i(3711);function or(e,t,i){const a="on-the-ground"===i.mode?sr.v.XY:sr.v.XYZ;return new sr.A(e,a,t,0)}function lr(e,t,i){const a=(0,m.c)();if(!e.renderCoordsHelper.toRenderCoords(t,a))return null;const r=hr(e,t,(0,O.mJ)(i.plane)),s=hr(e,t,i.edgeDirection);if((0,n.Wi)(r)||(0,n.Wi)(s))return null;const o=(0,g.c)((0,m.c)(),r,s);return(0,O.Yq)(a,o,(0,O.Ue)())}function hr(e,t,i){const a=(0,Ct.Tx)(t.x+i[0],t.y+i[1],t.z+i[2],t.spatialReference),r=(0,m.c)(),n=(0,m.c)();return e.renderCoordsHelper.toRenderCoords(t,r)&&e.renderCoordsHelper.toRenderCoords(a,n)?(0,g.r)(n,r,n):null}var cr=i(63920),dr=i(153);let pr=class extends(xt.Z.EventedMixin(fi.r)){constructor(e){super(e),this._vertexManipulatorMaterial=qi(Et.colorToVec4(Et.reshapeManipulators.vertex.color),Et.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=Yi(Et.colorToVec4(Et.reshapeManipulators.vertex.outlineColor),Et.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Yi(Et.colorToVec4(Et.reshapeManipulators.vertex.hoverOutlineColor),Et.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=qi(Et.colorToVec4(Et.reshapeManipulators.edge.color),Et.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=Yi(Et.colorToVec4(Et.reshapeManipulators.edge.outlineColor),Et.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=qi(Et.colorToVec4(Et.reshapeManipulators.edgeOffset.color),Et.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=qi(Et.colorToVec4(Et.reshapeManipulators.edgeOffset.hoverColor),Et.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=qi(Et.colorToVec4(Et.reshapeManipulators.selected.color),Et.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=Yi(Et.colorToVec4(Et.reshapeManipulators.selected.outlineColor),Et.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Yi(Et.colorToVec4(Et.reshapeManipulators.selected.hoverOutlineColor),Et.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new _.Z,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=yr.NONE,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._snappingPipeline=new Ka.n,this._snappingPipelineHandle=new Ka.n,this._vertexLaserLineVisualElement=null}initialize(){const e=new di({graphic:this.graphic});this._graphicState=e,this.handles.add([e.watch("displaying",(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),this.view.trackGraphicState(e)])}destroy(){this._editGeometryOperations=(0,n.SC)(this._editGeometryOperations),this._moveManipulation=(0,n.SC)(this._moveManipulation),this._graphicMoveManipulation=(0,n.SC)(this._graphicMoveManipulation),this._manipulatorHandles=(0,n.SC)(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return(0,n.pC)(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}removeSelectedVertices(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.handle.type));this._removeVertices(e)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=(0,n.SC)(this._moveManipulation),this._graphicMoveManipulation=(0,n.SC)(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if((0,n.Wi)(this._editGeometryOperations))return;const e=(0,d.RL)(this.graphic);for(const t of this._editGeometryOperations.data.components){for(const i of t.vertices)this._createVertexOrEdgeManipulator(i,e);for(const i of t.edges)this._createVertexOrEdgeManipulator(i,e)}this._createGraphicMoveManipulators(e)}get canRedo(){return(0,n.pC)(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return(0,n.pC)(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if((0,n.Wi)(this._editGeometryOperations))return null;const e=this._editGeometryOperations.redo();return(0,n.pC)(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}undo(){if((0,n.Wi)(this._editGeometryOperations))return null;this.emit("undo");const e=this._editGeometryOperations.undo();return(0,n.pC)(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._createManipulators()}_recreateEditGeometryAndManipulators(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.inputGeometry;this._removeManipulators(),this._resetGrabbingDragging(),(0,n.Wi)(e)||((0,n.SC)(this._editGeometryOperations),this._editGeometryOperations=Xa.c.fromGeometry(e,this.view.state.viewingMode),this._createManipulators())}_perGraphicManipulatorDragAction(e,t){if("end"===t.action)return;let i=0;const a=[],r=this._manipulatorInfos.some((e=>"vertex"===e.handle.type&&e.manipulator.selected)),n=e===br.SELECTED_OR_ALL&&r;for(const s of this._manipulatorInfos)gr(s)&&(s.manipulator.grabbing||n&&!s.manipulator.selected||a.push(s),i++);if(0!==a.length)if(this._moveVertices(a,t),a.length===i){if(this._updateEventState(yr.MOVING),this.destroyed)return;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(yr.RESHAPING),this.destroyed)return;this.emit("reshape",{type:"reshape",mover:this.graphic})}}_isMultiVertexSelection(){let e=0;for(const t of this._manipulatorInfos)gr(t)&&t.manipulator.selected&&e++;return e>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(yr.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:a}=e;if(!t&&!i&&!a)return;const r=[];for(const n of this._manipulatorInfos)gr(n)&&(n.manipulator.selected&&!n.manipulator.grabbing||n===e.info)&&r.push(n);this._moveVertices(r,e,dr.O.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case yr.NONE:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case yr.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case yr.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case yr.MOVING:switch(this._reshapeEventState){case yr.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case yr.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case yr.RESHAPING:switch(this._reshapeEventState){case yr.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case yr.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulators(e){if(this._graphicMoveManipulation=new Ba({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic){let e=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((t,i,a)=>{i.next((e=>this._trackNumDragging(e))).next((t=>("start"===t.action&&(e=(0,n.Wg)(this._editGeometryOperations).createUndoGroup()),t))).next((t=>{this._perGraphicManipulatorDragAction(br.ALL,t),"end"===t.action&&(e=(0,n.hw)(e))})),a.next(this._cancelDragOperation((()=>e=(0,n.hw)(e))))})))}else this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null}));this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()}))]))),this._moveManipulation=new Ha({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&ia(this.graphic),snapToScene:!1,radius:Ha.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((e=>{this.handles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(t=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const t=(0,n.Wg)(this.graphic.geometry).spatialReference;this.handles.add([this._moveManipulation.createDragPipeline(((t,i,a,r,s)=>{const o=a.next((e=>this._trackNumDragging(e))).next((e=>{const t=this._manipulatorInfos.filter((e=>gr(e)&&e.manipulator.selected));return e.manipulatorType===ea.TRANSLATE_XY&&1===t.length?{...e,info:t[0],snapOrigin:t[0].handle.pos}:{...e,info:null}})).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:e=>!!e.info,cancel:r,snappingManager:this.tool.snappingManager,snappingContext:new Qa.N({editGeometryOperations:(0,n.Wg)(this._editGeometryOperations),elevationInfo:e,pointer:s,excludeFeature:this.graphic,visualizer:new rt}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next((0,Sa.AN)()).next((e=>(this._perGraphicManipulatorDragAction(br.SELECTED_OR_ALL,e),e)));return r.next(this._cancelDragOperation()),o}),e,t,this.graphic),(0,s.S1)(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),(0,s.S1)(this._graphicState,"isDraped",(()=>{const e="align-move-manipulation";this._graphicState.isDraped?this.handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this.handles.remove(e)}))]),this._updateMoveManipulationPosition();const i=pa({view:this.view,graphic:this.graphic,forEachManipulator:e=>{if(!this.destroyed){(0,n.pC)(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,ea.TRANSLATE_XY);this._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});(0,n.pC)(i)&&(this._outlineVisualElement=i.visualElement instanceof It?i.visualElement:null),(0,n.pC)(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,d.RL)(this.graphic);const i=Et.reshapeManipulators.edgeOffset,a=i.size/2,s=a+i.collisionPadding;if((0,n.Wi)(this._edgeOffsetManipulatorGeometryInside)||(0,n.Wi)(this._edgeOffsetManipulatorGeometryOutside)){const e=a/s,t=e*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=ve.Z.createExtrudedTriangle(t,e/2,e/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=ve.Z.createExtrudedTriangle(-t,e/2,e/2,i.height,-i.offset)}const o=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:Ai.Q9.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:Ai.Q9.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:Ai.Q9.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:Ai.Q9.Focused}],l=new Di({view:this.view,renderObjects:o,elevationInfo:"on-the-ground"!==t.mode||(0,nr.YW)(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:s,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:(0,m.f)(0,0,1)},collisionPriority:1}),h=new Di({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),c={manipulator:l,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:h,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(c,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(c);const p=this._getManipulatorInfoFromHandle(c.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c))),u=this._getManipulatorInfoFromHandle(c.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c)));c.locationUpdateHandle=(0,r.AL)([p,u]),this._manipulatorHandles.add(c.locationUpdateHandle,l),this._manipulatorHandles.add([this._watchAndUpdateGrabState(l,!0),this._watchAndUpdateGrabState(h,!0)],l),this._manipulatorHandles.add((0,Sa.Xd)(l,this._createEdgeOffsetPipeline(c,t)),l),this._manipulatorHandles.add((0,Sa.Xd)(h,((e,i,a,r)=>{if("touch"===r)this._createEdgeOffsetPipeline(c,t)(e,i,a);else if(this.enableMoveGraphic){const r=this.graphic,s=(0,n.pC)(r.geometry)?r.geometry.spatialReference:null;i.next((e=>this._trackNumDragging(e))).next((0,Sa.kY)(this.view,e.elevationAlignedLocation)).next(Ca(this.view,e.elevationAlignedLocation,t,s,r)).next((0,Sa.zh)()).next((0,Sa.AN)()).next((e=>this._perGraphicManipulatorDragAction(br.ALL,e))),a.next(this._cancelDragOperation())}})),l);const g=e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()};return this._manipulatorHandles.add([l.events.on("immediate-click",g),h.events.on("immediate-click",g)],l),this._manipulatorInfos.push(c),this.manipulators.add(l),this.manipulators.add(h),this.emit("manipulators-changed"),c}_autoHideEdgeOffsetManipulator(e,t){const i=e.manipulator,a=e.edgeManipulator,s=()=>{(0,n.hw)(e.visibilityHandle);const s=function(e,t,i){const a=i.projectToRenderScreen(e,(0,Pe.J$)()),r=i.projectToRenderScreen(t,(0,Pe.J$)());return(0,n.pC)(a)&&(0,n.pC)(r)?(0,g.p)((0,g.f)(a,a,r)):0}(this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<t;(!i.focused&&!a.focused||s)&&(i.grabbable=!s,a.grabbable=!s,e.visibilityHandle=(0,r.AL)([i.disableDisplay(),{remove:()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",s),a.events.on("focus-changed",s),{remove:()=>{(0,n.hw)(e.visibilityHandle),this.manipulators.remove(a)}}],i),s()}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const t=(0,n.Wg)(this._editGeometryOperations).data.coordinateHelper,i=lr(this.view,e.manipulator.elevationAlignedLocation,or(t,e.handle,(0,n.Wg)(e.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator.renderLocation,r=this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator.renderLocation,s=(0,n.pC)(i)?function(e,t,i){const a=(0,O.mJ)(e),r=(0,g.r)((0,m.c)(),t,i),n=(0,g.c)((0,m.c)(),r,a),s=(0,g.c)((0,m.c)(),r,n);return(0,L.f)(r[0],r[1],r[2],0,n[0],n[1],n[2],0,s[0],s[1],s[2],0,0,0,0,1)}(i,a,r):L.I;e.manipulator.modelTransform=s,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=s;const o=(0,g.l)((0,g.f)(fr,a,r))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-o,0,0],[o,0,0]]]}}_createEdgeOffsetPipeline(e,t){return(i,a,r)=>{this._clearSelection();const{step:s,cleanup:o}=this._initializeEdgeOffset(e,t);a.next((e=>this._trackNumDragging(e))).next((0,Sa.kY)(this.view,i.elevationAlignedLocation)).next(s).next(function(e){return Ea(e,(e=>e.plane))}(this.view)).next(Pa(this.view,(0,n.Wg)(this._editGeometryOperations).data.spatialReference)).next((0,Sa.AN)()).next(this._applyEdgeOffsetStep(e)).next((e=>{"end"===e.action&&o()})),r.next((e=>(o(),e))).next(this._cancelDragOperation())}}_initializeEdgeOffset(e,t){const i=(0,n.Wg)(this._editGeometryOperations),a=or(i.data.coordinateHelper,e.handle,t),s=i.createUndoGroup(),o=lr(this.view,e.manipulator.elevationAlignedLocation,a);a.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge),1),a.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge),0);const l=()=>new rr.Z({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:(0,n.Wg)(this._editGeometryOperations).data.spatialReference}),h=new It({view:this.view,isDraped:this._graphicState.isDraped,geometry:l(),elevationInfo:e.elevationInfo,width:Et.visualElements.lineGraphics.outline.width,color:Et.colorToVec4(ot.main),attached:!0});let c;const d=()=>{this._cleanEdgeOffsetCollapsedEdges(e),c=(0,n.hw)(c)},p=this.on("undo",d);return c=(0,r.AL)([(0,r.ed)(h),this._graphicState.watch("isDraped",(e=>h.isDraped=e)),this._graphicState.on("changed",(()=>h.geometry=l())),s,p]),{step:e=>(0,n.Wi)(a)||(0,n.Wi)(o)?(d(),null):{...e,operation:a,plane:o},cleanup:d}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||(0,n.Wi)(t.operation))return t;this._updateEventState(yr.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:r}=t;return(i||a||r)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_cleanEdgeOffsetCollapsedEdges(e){var t,i;const a=null==(t=e.handle.leftVertex.leftEdge)?void 0:t.leftVertex,r=e.handle.leftVertex,s=null==(i=e.handle.rightVertex.rightEdge)?void 0:i.rightVertex,o=e.handle.rightVertex,l=(0,n.Wg)(this._editGeometryOperations).data.coordinateHelper,h=1e-6,c=[];a&&l.distance(a.pos,r.pos)<h&&c.push(this._getManipulatorInfoFromHandle(r)),(l.distance(r.pos,o.pos)<h||s&&l.distance(s.pos,o.pos)<h)&&c.push(this._getManipulatorInfoFromHandle(o)),c.length&&this._removeVertices(c)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}}_createVertexOrEdgeManipulator(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,d.RL)(this.graphic);if("edge"===e.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if((0,n.Wi)(this._vertexManipulatorGeometry)||(0,n.Wi)(this._vertexManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(Et.reshapeManipulators.vertex);this._vertexManipulatorGeometry=ve.Z.createSphereGeometry(e,16,16),this._vertexManipulatorOutlineGeometry=ve.Z.createSphereGeometry(t,16,16)}if((0,n.Wi)(this._edgeManipulatorGeometry)||(0,n.Wi)(this._edgeManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(Et.reshapeManipulators.edge);this._edgeManipulatorGeometry=ve.Z.createSphereGeometry(e,16,16),this._edgeManipulatorOutlineGeometry=ve.Z.createSphereGeometry(t,16,16)}const i=(0,n.pC)(this.graphic.geometry)&&"point"===this.graphic.geometry.type?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:vr.Vertex|Ai.Q9.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:vr.Vertex|Ai.Q9.Unfocused|Ai.Q9.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:vr.Vertex|Ai.Q9.Focused|Ai.Q9.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:Ai.Q9.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:Ai.Q9.Selected|Ai.Q9.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:Ai.Q9.Selected|Ai.Q9.Focused}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:vr.Edge|Ai.Q9.Focused|Ai.Q9.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:vr.Edge|Ai.Q9.Focused|Ai.Q9.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:vr.Edge|Ai.Q9.Unfocused|Ai.Q9.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:vr.Edge|Ai.Q9.Unfocused|Ai.Q9.Unselected});const a=new Di({view:this.view,renderObjects:i,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,e,t);const s="edge"===e.type?{manipulator:a,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(s),this.manipulators.add(a),this._updateManipulatorPosition(s),"edge"===s.type){const e=this._getManipulatorInfoFromHandle(s.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(s))),t=this._getManipulatorInfoFromHandle(s.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(s)));s.locationUpdateHandle=(0,r.AL)([e,t]),this._manipulatorHandles.add(s.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const o=(0,Sa.Xd)(a,((e,i,a,r)=>{let o=null;i.next((e=>this._trackNumDragging(e))).next((e=>{if("start"===e.action&&(o=(0,n.Wg)(this._editGeometryOperations).createUndoGroup()),mr(s)){const t=this._splitEdgeManipulator(s);return{...e,info:t,snapOrigin:t.handle.pos}}return{...e,info:s,snapOrigin:s.handle.pos}})).next((0,Sa.kY)(this.view,e.elevationAlignedLocation)).next(Oa(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:a,snappingManager:this.tool.snappingManager,snappingContext:new Qa.N({editGeometryOperations:(0,n.Wg)(this._editGeometryOperations),elevationInfo:t,pointer:r,excludeFeature:this.graphic,visualizer:new rt}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next((0,Sa.AN)()).next((e=>{this._perVertexManipulatorDragAction(e),"end"===e.action&&(o=(0,n.hw)(o))})),a.next(this._cancelDragOperation((()=>o=(0,n.hw)(o))))}));return this._manipulatorHandles.add(o,a),this._manipulatorHandles.add([a.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,s))),a.events.on("select-changed",(()=>{s.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))],a),this.emit("manipulators-changed"),s}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_cancelDragOperation(e){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=(0,n.pC)(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,(0,n.pC)(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._reshapeEventState){case yr.NONE:break;case yr.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case yr.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(yr.NONE)}}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=vr.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=Et.reshapeManipulators.vertex.size/2+Et.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i,e.interactive=(0,n.pC)(this.graphic.geometry)&&"point"!==this.graphic.geometry.type;break;case"edge":e.state=vr.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=Et.reshapeManipulators.edge.size/2+Et.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"!==i.mode||(0,nr.YW)(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",(i=>{if("start"===i.action)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(yr.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==i.pointerType||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((e=>{e.manipulator.interactive=!this._numGrabbing&&(0,n.pC)(this.graphic.geometry)&&"point"!==this.graphic.geometry.type,"edgeManipulator"in e&&(e.edgeManipulator.interactive=!this._numGrabbing)})),(0,n.Wg)(this._graphicMoveManipulation).forEachManipulator((e=>e.interactive=!this._numGrabbing)))}))}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null}_updateManipulatorPosition(e){if(!e)return;const t=(0,n.Wg)(this._editGeometryOperations);if("vertex"===e.handle.type)e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,_r),e.manipulator.grabbing&&(0,n.pC)(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){const i=this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator,a=this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator;if((0,n.pC)(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const r=i.location,n=a.location,s=.5,o=r.x+s*(n.x-r.x),l=r.y+s*(n.y-r.y),h=r.hasZ&&n.hasZ?0:void 0;e.manipulator.location=(0,Ct.Tx)(o,l,h,t.data.spatialReference)}else(0,g.e)(fr,i.renderLocation,a.renderLocation,.5),e.manipulator.renderLocation=fr}}_splitEdgeManipulator(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;const i=(0,n.Wg)(this._editGeometryOperations),a=(0,n.Wg)(i.splitEdge(e.handle,t).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const r=(0,d.RL)(this.graphic);let s;this.enableEdgeOffset?(this._removeManipulator(e),s=this._createVertexOrEdgeManipulator(a)):(s=e,s.handle=a,s.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,r)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(s),this._updateSelection(e.manipulator);const o=this._updateEventState(yr.RESHAPING),l=i.data.coordinateHelper.vectorToArray(s.handle.pos),h=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:l,componentIndex:h,vertexIndex:(0,n.Wg)(a.index)}],added:l}),o&&this._updateEventState(yr.NONE),s}_updateMoveManipulationPosition(){const e=(0,g.s)(fr,0,0,0);let t=0,i=!1,a=null,r=null;for(const s of this._manipulatorInfos)gr(s)&&(s.manipulator.selected?(t++,(0,g.b)(e,e,s.manipulator.renderLocation),(0,n.Wi)(a)||s.selectedIndex>a.selectedIndex?(r=a,a=s):((0,n.Wi)(r)||s.selectedIndex>r.selectedIndex)&&(r=s)):i=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZVertex&&ia(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZShape&&ia(this.graphic)}if(0!==t){let e=0;if((0,n.pC)(a)){const t=a.handle.pos,i=(0,n.pC)(r)?r.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,s=!(0,n.pC)(r)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;i&&s?this._moveManipulation.xyAxisManipulation.available=!1:i?e=ur(i,t):s&&(e=ur(t,s))}this._moveManipulation.angle=e,this._moveManipulation.radius=ma}else this._moveManipulation.angleDeferred=()=>Ga((0,n.Wg)(this.graphic.geometry)),this._moveManipulation.radius=Ha.radiusForSymbol(this.graphic.symbol);0!==t&&i?((0,g.a)(e,e,1/t),_r.spatialReference=(0,n.Wg)(this._editGeometryOperations).data.spatialReference,_r.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,_r),this._moveManipulation.elevationAlignedLocation=_r):(0,n.pC)(this._outlineVisualElement)&&!this._graphicState.isDraped&&(0,n.pC)(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:Ji(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){const t=[],i=(0,n.Wg)(this._editGeometryOperations);for(const a of e)if("vertex"===a.handle.type&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const e=(0,n.Wg)(i.removeVertices([a.handle]).removedVertices[0].createdEdge);e&&this._createVertexOrEdgeManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=i.data.components.indexOf(e.component);return{coordinates:i.data.coordinateHelper.vectorToArray(e.pos),componentIndex:t,vertexIndex:(0,n.Wg)(e.index)}}));this.outputGeometry=i.data.geometry;const a=this._updateEventState(yr.RESHAPING);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(a&&(this._updateEventState(yr.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"start"===t.action?dr.O.NEW_STEP:dr.O.ACCUMULATE_STEPS;const a=(0,n.Wg)(this._editGeometryOperations);a.moveVertices(e.map((e=>e.handle)),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const r of e)this._updateManipulatorPosition(r)}_offsetEdge(e,t){if((0,n.Wi)(t.operation))return;const i=(0,n.Wg)(this._editGeometryOperations),a=t.operation.clone();a.distance=t.operation.signedDistanceToPoint(t.mapEnd),i.updateVertices([e.handle.leftVertex,e.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&e.button===cr.t.Right&&this._removeVertices([t]),mr(t)&&e.button===cr.t.Left&&this._splitEdgeManipulator(t),e.stopPropagation()}};function ur(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function gr(e){return"vertex"===e.handle.type}function mr(e){return"edge"===e.handle.type}(0,a._)([(0,o.Cb)({constructOnly:!0})],pr.prototype,"tool",void 0),(0,a._)([(0,o.Cb)()],pr.prototype,"inputGeometry",null),(0,a._)([(0,o.Cb)()],pr.prototype,"outputGeometry",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],pr.prototype,"updating",null),pr=(0,a._)([(0,c.j)("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],pr);const _r=(0,Ct.Tx)(0,0,null,null),fr=(0,m.c)();var vr,yr,br;!function(e){e.Vertex=Ai.jg.Custom1,e.Edge=Ai.jg.Custom2}(vr||(vr={})),function(e){e[e.NONE=0]="NONE",e[e.MOVING=1]="MOVING",e[e.RESHAPING=2]="RESHAPING"}(yr||(yr={})),function(e){e[e.ALL=0]="ALL",e[e.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(br||(br={}));let Mr=class extends(xt.Z.EventedMixin(Ya.m)){constructor(e){super(e),this._handles=new _.Z,this._reshapeOperation=null,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.snappingManager=null,this.automaticManipulatorSelection=!1}destroy(){this._handles=(0,n.SC)(this._handles),this._reshapeOperation=(0,n.SC)(this._reshapeOperation),this._set("view",null),this._set("graphic",null)}get updating(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.updating)&&e}_updateGeometry(){const e=(0,ar.b)(this.graphic);this._reshapeOperation.inputGeometry=(0,n.pC)(e)?e.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),(0,ar.P)(this.graphic)!==ta.e.SUPPORTED)return;const e=this.watch("graphic.geometry",(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),!0);this._handles.add(e,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(e){this._internalGeometryUpdate=!0,this.graphic.geometry=e,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){(0,n.Wi)(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}initialize(){this._reshapeOperation=new pr({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",(e=>{"reshape"===e.type&&this._onReshapeGeometryChanged(),this.emit("reshape",e)})),this._reshapeOperation.on("move",(e=>{"move"===e.type&&this._onReshapeGeometryChanged(),this.emit("move",e)})),this._reshapeOperation.on("vertex-add",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)})),this._reshapeOperation.on("vertex-remove",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)})),this._reshapeOperation.on("immediate-click",(e=>this.emit("immediate-click",e))),this.view.on("pointer-down",["Shift"],(e=>{e.stopPropagation()})),(0,s.S1)(this,"graphic",(()=>{this._updateGraphic()}),!0)]),this.finishToolCreation()}get canUndo(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.canUndo)&&e}undo(){(0,n.pC)(this.snappingManager)&&this.snappingManager.doneSnapping(),(0,n.pC)(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.canRedo)&&e}redo(){(0,n.pC)(this.snappingManager)&&this.snappingManager.doneSnapping(),(0,n.pC)(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(e){"key-down"!==e.type||"Delete"!==e.key&&"Backspace"!==e.key||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager}}};(0,a._)([(0,o.Cb)()],Mr.prototype,"_reshapeOperation",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Mr.prototype,"view",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0})],Mr.prototype,"graphic",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Mr.prototype,"enableZShape",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Mr.prototype,"enableZVertex",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Mr.prototype,"enableMoveGraphic",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Mr.prototype,"enableMidpoints",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Mr.prototype,"enableEdgeOffset",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],Mr.prototype,"type",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0})],Mr.prototype,"snappingManager",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],Mr.prototype,"updating",null),(0,a._)([(0,o.Cb)()],Mr.prototype,"automaticManipulatorSelection",void 0),Mr=(0,a._)([(0,c.j)("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],Mr);var Sr,wr,Er=i(50951),xr=i(99346),Cr=i(80064);!function(e){e.ScaleIn=Ai.jg.Custom2,e.ScaleOut=Ai.jg.Custom3,e.RotateLeft=Ai.jg.Custom4,e.RotateRight=Ai.jg.Custom5,e.Unlocked=Ai.jg.Custom7,e.DelayedFocused=Ai.jg.Custom8,e.TouchInput=Ai.jg.Custom12}(Sr||(Sr={}));class Or{constructor(e){this.mode=null,this._handles=new _.Z,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new xt.Z,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>(0,n.pC)(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this.adapter.scale:1,this.tool=e.tool,this.mode=e.mode,this.adapter=e.adapter,this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform()}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(e){this.ringManipulator.location=e}set elevationAlignedLocation(e){this.ringManipulator.elevationAlignedLocation=e}get grabbing(){return this.ringManipulator.grabbing}set interactive(e){this.ringManipulator.interactive=e}destroy(){(0,n.pC)(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=(0,n.SC)(this._handles),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(e){this.cancelActiveAnimation(),e.start();const t=(0,xr.A)({update:t=>{let{deltaTime:i}=t;e.update(i)&&this.cancelActiveAnimation()}});this._activeAnimation={...e,frameTask:t}}cancelActiveAnimation(){(0,n.pC)(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=(0,n.SC)(this._activeAnimation))}forEachManipulator(e){e(this.ringManipulator,ea.SCALE_ROTATE)}_createManipulator(){this.ringManipulator=this._createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const e=this.ringManipulator,t=this.tool.graphicState.graphic,i=(0,Sa.Xd)(e,((e,i,a)=>{this._scaleRotateDragData=null,this.adapter.restart();const r={mode:"none",origin:(0,m.a)(e.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=r,this._updateDragState();const s=Ue.WM.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(e.renderLocation,s),i.next(wa(this.tool.view,(0,O.Yq)(e.renderLocation,s,(0,O.Ue)()))).next((e=>{const i=(0,O.mJ)(e.plane),a=Xi(e.renderStart,e.renderEnd,r.origin,i),s=Cr.Q4.shortestSignedDiff(r.angle,a);r.angleDir=(0,E.uZ)(r.angleDir+s,-.3,.3),r.angle=a;const o=function(e,t){const i=(0,g.f)(Ue.WM.get(),t.renderStart,e.origin),a=(0,g.f)(Ue.WM.get(),t.renderEnd,e.origin),r=(0,g.l)(i),n=(0,g.l)(a);return 0===r?0:n/r}(r,e),l=o-this.adapter.scale;if(r.scaleDir=(0,E.uZ)(r.scaleDir+l,-.2,.2),this._onScaleChanged(),"none"===r.mode){const i=this.mode||function(e,t,i,a){const{renderStart:r,renderEnd:n}=e,s=Ar(r,a,Ue.WM.get()),o=Ar(n,a,Ue.WM.get());if((0,g.h)(s,o)<100)return null;const l=(0,g.f)(Ue.WM.get(),r,i),h=(0,g.c)(Ue.WM.get(),l,(0,O.mJ)(t)),c=r,d=(0,g.b)(Ue.WM.get(),c,h),p=Ar(i,a,Ue.WM.get()),u=s,m=Ar(d,a,Ue.WM.get()),_=(0,g.f)(Ue.WM.get(),m,u),f=(0,g.f)(Ue.WM.get(),s,p),v=(0,S.re)(u,_),y=(0,S.re)(p,f);return(0,S.Jk)(v,o)<(0,S.Jk)(y,o)?"rotate":"scale"}(e,e.plane,r.origin,this.tool.view.state.camera);if((0,n.pC)(i)){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}r.mode=i}}switch(r.mode){case"rotate":this.adapter.angle=r.initialAngle+a;break;case"scale":this.adapter.scale=o,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),e.action){case"start":case"update":switch(r.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:(0,E.BV)(r.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,xScale:o,yScale:o})}break;case"end":switch(r.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:(0,E.BV)(r.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:o,yScale:o})}}"end"===e.action&&(this.startAnimation(Pr(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState())})),a.next((()=>{if(this.adapter.cancel(),(0,n.pC)(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:1,yScale:1})}this.startAnimation(Pr(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}}))}));this._handles.add(i),this._handles.add([this.ringManipulator.events.on("focus-changed",(e=>{"focus"===e.action?this.startAnimation(function(e,t){let i=0,a=null;const r=()=>!1;return{start:()=>{a=e.getFocused,e.getFocused=r,i=0,t()},update:e=>(i+=e,!a()||i>200?wr.STOP:wr.CONTINUE),destroy:()=>{e.getFocused=a,t()}}}(this,(()=>this._updateDelayedFocusedState()))):this._updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(e=>{e.stopPropagation()})),(0,s.S1)(this.tool.graphicState,"displaying",(e=>this.ringManipulator.available=e))])}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(Sr.DelayedFocused,this.getFocused())}_updateDragState(){if(this.ringManipulator.updateStateEnabled(Sr.Unlocked,!((0,n.pC)(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),(0,n.pC)(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(Sr.ScaleIn|Sr.ScaleOut,!1),this.ringManipulator.updateStateEnabled(Sr.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(Sr.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(Sr.RotateLeft|Sr.RotateRight,!1),this.ringManipulator.updateStateEnabled(Sr.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(Sr.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(Sr.ScaleIn|Sr.ScaleOut|Sr.RotateLeft|Sr.RotateRight,!1)}_updateManipulatorTransform(){const e=(0,T.d)(Ue.MP.get(),this.adapter.angle,(0,m.f)(0,0,1)),t=this.getScale(),i=(0,T.u)(Ue.MP.get(),(0,g.s)(Ue.WM.get(),t,t,t));this.ringManipulator.modelTransform=(0,T.m)(Ue.MP.get(),i,e)}_createRingManipulator(){const e=(e,t,i)=>{const a=[],r=Math.ceil(128*(t-e)/(2*Math.PI));for(let n=0;n<r+1;n++){const s=e+n*(t-e)/r;a.push((0,m.f)(i*Math.cos(s),i*Math.sin(s),0))}return a},t=t=>e(0,2*Math.PI,t),i=(e,t)=>ve.Z.createPathExtrusionGeometry((e=>[[-e/2,0],[e/2,0],[e/2,.25],[-e/2,.25]])(t),e,[],[],!1),a=t(_a),r=i(a,24),n={left:[],right:[]},s=[];for(let d=0;d<2;d++){const t=d*Math.PI-Math.PI/4,a=Math.PI/2-fa,r=t+a,o=t+Math.PI/2-a,l=e(r,o,190),h=i(l,9);s.push(l),s.push(e(r,o,201)),n.left.push(h),n.right.push(h);for(let e=0;e<2;e++){const t=0===e,i=(0,L.c)();if(t){(0,T.h)(i,i,[1,-1,1]),(0,T.e)(i,i,-r,[0,0,1]);const e=Math.round(.2*(l.length-1));i[12]=l[e][0],i[13]=l[e][1],i[14]=l[e][2]}else{(0,T.e)(i,i,o,[0,0,1]);const e=Math.round(.8*(l.length-1));i[12]=l[e][0],i[13]=l[e][1],i[14]=l[e][2]}const a=ve.Z.createExtrudedTriangle(60,0,23,.5);ve.Z.transformInPlace(a,i),(t?n.left:n.right).push(a)}}const o=[];for(let d=0;d<2;d++){const t=d*Math.PI-Math.PI/4,a=Math.PI/2-va,r=t+a,n=t+Math.PI/2-a,s=e(r,n,213);o.push(i(s,9))}const l=t(190),h=t(213),c=i(l,9),p=i(h,9),u=t(130),g=t(107),_=i(u,9),f=i(g,9),v=this._createMaterial(),y=this._createMaterial(.66),b=this._createMaterial(.5),M=this._createMaterial(.33);let S=[{geometry:r,material:v,stateMask:Sr.DelayedFocused},{geometry:r,material:b,stateMask:Ai.Q9.None}];this.mode&&"scale"!==this.mode||(S=S.concat([{geometry:o,material:v,stateMask:Sr.DelayedFocused|Sr.Unlocked},{geometry:c,material:y,stateMask:Sr.DelayedFocused|Sr.ScaleIn},{geometry:p,material:M,stateMask:Sr.DelayedFocused|Sr.ScaleIn},{geometry:_,material:y,stateMask:Sr.DelayedFocused|Sr.ScaleOut},{geometry:f,material:M,stateMask:Sr.DelayedFocused|Sr.ScaleOut}])),this.mode&&"rotate"!==this.mode||(S=S.concat([{geometry:n.right,material:v,stateMask:Sr.DelayedFocused|Sr.Unlocked},{geometry:n.left,material:v,stateMask:Sr.DelayedFocused|Sr.RotateLeft},{geometry:n.right,material:v,stateMask:Sr.DelayedFocused|Sr.RotateRight}]));const w=[a,...s];return new Di({view:this.tool.view,renderObjects:S,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:(0,d.RL)(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:w,direction:(0,m.f)(0,0,1)}})}_createMaterial(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;const t=[...ua,e];return new Je.E({color:t,transparent:1!==e,cullFace:ge.Vr.Back,renderOccluded:ye.yD.Transparent})}get test(){return{ringManipulator:this.ringManipulator}}}function Ar(e,t,i){return t.projectToScreen(e,Dr),(0,g.s)(i,Dr[0],Dr[1],0)}function Pr(e,t){let i=null,a=1;const r=()=>a;return{start:()=>{a=e.getScale(),i=e.getScale,e.getScale=r,t()},update:e=>(a+=((a+1)/2-a)*Math.min(3*e,1),t(),Math.abs(a-1)<.01?wr.STOP:wr.CONTINUE),destroy:()=>{e.getScale=i,t()}}}!function(e){e[e.CONTINUE=0]="CONTINUE",e[e.STOP=1]="STOP"}(wr||(wr={}));const Dr=(0,Pe.s1)();var Rr=i(94172),Tr=i(45238);function Lr(e){return(0,n.pC)(e.geometry)&&"mesh"===e.geometry.type?function(e){return(0,n.pC)(e.transform)?function(e,t){let i=t.clone(),a=null;return{undo:t=>{a=(0,n.pC)(e.transform)?e.transform.clone():null,e.transform=i,t.notifyGeometryChanged()},redo:t=>{i=(0,n.pC)(e.transform)?e.transform.clone():null,e.transform=a,t.notifyGeometryChanged()}}}(e,e.transform):function(e){let t,i=e.vertexAttributes.clonePositional();return{undo:a=>{t=e.vertexAttributes.clonePositional(),e.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=e.vertexAttributes.clonePositional(),e.vertexAttributes=t,a.notifyGeometryChanged()}}}(e)}(e.geometry):function(e){let t=e.geometry,i=n.YP;return{undo(e){i=e.geometry,e.geometry=t},redo(e){t=e.geometry,e.geometry=i}}}(e)}let Gr=class extends fi.r{constructor(e){super(e),this.angle=0,this.scale=1,this.initialAngle=0,this.previousAngle=0,this.previousScale=1}initialize(){this.restart()}restart(){this.handles.remove(Vr);const e=this.geometry.transform;if(this.scale=1,(0,n.pC)(e)){const t=(0,Tr.ZZ)(e.rotation)[2];Math.abs(t)>.999999&&(this.angle=(0,E.Vl)((0,Tr.EU)(e.rotation))*Math.sign(t))}this.initialAngle=this.angle,this.previousAngle=this.angle,this.previousScale=this.scale,this.handles.add((0,Rr.YP)((()=>({angle:this.angle,scale:this.scale})),(e=>this._update(e)),Rr.Z_),Vr)}cancel(){this.scale=1,this.angle=this.initialAngle}createUndoRecord(){return Lr(this.graphic)}_update(e){let{scale:t,angle:i}=e;const a=this.geometry.anchor,r=this.viewingMode===Er.JY.Global;t!==this.previousScale&&(this.geometry.scale(t/this.previousScale,{origin:a,geographic:r}),this.previousScale=t,(0,n.pC)(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()),i!==this.previousAngle&&(this.geometry.rotate(0,0,(0,E.BV)(i-this.previousAngle),{origin:a,geographic:r}),this.previousAngle=i,(0,n.pC)(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged())}};(0,a._)([(0,o.Cb)({constructOnly:!0})],Gr.prototype,"graphic",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0})],Gr.prototype,"geometry",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0})],Gr.prototype,"viewingMode",void 0),(0,a._)([(0,o.Cb)()],Gr.prototype,"angle",void 0),(0,a._)([(0,o.Cb)()],Gr.prototype,"scale",void 0),Gr=(0,a._)([(0,c.j)("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],Gr);const Vr="scale-heading-update-key";let Ir=class extends fi.r{constructor(e){super(e),this.angle=0,this.scale=1,this.symbol=null,this.initialAngle=0}initialize(){this.restart()}restart(){this.handles.remove(zr);const e=(0,n.pC)(this.graphic.symbol)&&"point-3d"===this.graphic.symbol.type?this.graphic.symbol:n.YP;if(this.symbol=(0,n.pC)(e)?e.clone():null,this.initialSizes=[],(0,n.pC)(e)){const t=this.findLayerView();(0,n.pC)(t)&&(this.initialSizes=e.symbolLayers.map((i=>"object"===i.type?t.getSymbolLayerSize(e,i):null)).toArray())}this.angle=0,(0,n.pC)(e)&&e.symbolLayers.some((e=>!("object"!==e.type||!(0,n.pC)(e.heading))&&(this.angle=-(0,E.Vl)(e.heading),!0))),this.initialAngle=this.angle,this.scale=1,this.handles.add((0,Rr.YP)((()=>({angle:this.angle,scale:this.scale})),(e=>this._updateSymbol(e)),Rr.Z_),zr)}cancel(){this.graphic.symbol=this.symbol}createUndoRecord(){let e=this.graphic.symbol,t=null;return{undo:i=>{t=i.symbol,i.symbol=e,this.restart()},redo:i=>{e=i.symbol,i.symbol=t,this.restart()}}}_updateSymbol(e){let{scale:t,angle:i}=e;const a=this.graphic.symbol;if((0,n.Wi)(this.symbol)||(0,n.Wi)(a)||"point-3d"!==a.type)return;const r=a.clone(),s=-(0,E.BV)(i-this.initialAngle);let o=!1;this._forEachObjectSymbolLayerPair(this.symbol,r,((e,i,a)=>{const r=(0,n.Pt)(e.heading,0)+s;i.heading!==r&&(i.heading=r,o=!0);const l=this.initialSizes[a];if((0,n.pC)(l)&&"width"in l){l.width=this.sizeFilter(l.width),l.height=this.sizeFilter(l.height),l.depth=this.sizeFilter(l.depth);const e=l.width*t;i.width!==e&&(i.width=e,o=!0);const a=l.depth*t;i.depth!==a&&(i.depth=a,o=!0);const r=l.height*t;i.height!==r&&(i.height=r,o=!0)}})),o&&(this.graphic.symbol=r)}_forEachObjectSymbolLayerPair(e,t,i){e.symbolLayers.forEach(((e,a)=>{const r=t.symbolLayers.getItemAt(a);"object"===e.type&&"object"===r.type&&i(e,r,a)}))}};(0,a._)([(0,o.Cb)()],Ir.prototype,"angle",void 0),(0,a._)([(0,o.Cb)()],Ir.prototype,"scale",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0})],Ir.prototype,"graphic",void 0),(0,a._)([(0,o.Cb)()],Ir.prototype,"symbol",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0})],Ir.prototype,"findLayerView",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0})],Ir.prototype,"sizeFilter",void 0),Ir=(0,a._)([(0,c.j)("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],Ir);const zr="scale-heading-update-key";let Wr=class extends((0,fi.p)(xt.Z.EventedMixin(Ya.m))){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.scaleRotate=null,this.snappingPipeline=new Ka.n}initialize(){this.graphicState=new di({graphic:this.graphic}),this.moveManipulation=new Ha({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&ia(this.graphic),radius:Ha.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:this.graphicState.graphic}),e.stopPropagation()}))))),this.moveManipulation.elevationInfo=(0,d.RL)(this.graphic);const e=this.graphic.geometry;if(this.moveManipulation.createGraphicDragPipeline(((t,i,a,r,s)=>((0,n.pC)(e)&&t===ja.XY&&(a=a.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new Qa.N({elevationInfo:(0,d.RL)(this.graphic),pointer:s,editGeometryOperations:Xa.c.fromGeometry(new Pi.Z({spatialReference:e.spatialReference}),this.view.state.viewingMode),visualizer:new rt,excludeFeature:this.graphic}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:r}),this.snappingPipeline.next)),a)),this.graphicState,(e=>{const{action:t,graphic:i,dxScreen:a,dyScreen:r}=e,n={graphic:i,dxScreen:a,dyScreen:r};switch(t){case"start":this.emit("graphic-translate-start",n),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",n);break;case"end":this.emit("graphic-translate-stop",n)}})),this.moveManipulation.angle=(0,n.pC)(this.scaleRotate)?this.scaleRotate.angle:0,this.scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(this.scaleRotateAdapter.watch("angle",(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const e=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new Or({tool:this,mode:e,adapter:this.scaleRotateAdapter}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.handles.add([pa({view:this.view,graphic:this.graphic,forEachManipulator:e=>this._forEachManipulator(e),onManipulatorsChanged:()=>(0,r.kB)()}),this.graphicState.on("changed",(()=>this._onGeometryChanged())),this._hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this._updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((e=>{e instanceof Di&&this.handles.add(e.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()}_updateManipulatorsInteractive(){(0,n.Wi)(this.scaleRotate)||(this.scaleRotate.interactive=!this.moveManipulation.grabbing,this.moveManipulation.interactive=!this.scaleRotate.grabbing)}_createScaleRotateAdapter(){return(0,n.pC)(this.graphic.geometry)&&"mesh"===this.graphic.geometry.type?new Gr({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new Ir({graphic:this.graphic,sizeFilter:e=>this._enforceNonZeroSize(e),findLayerView:()=>this.view.allLayerViews.find((e=>e.layer===this.graphic.layer))})}_forEachManipulator(e){this.moveManipulation.forEachManipulator(e),(0,n.pC)(this.scaleRotate)&&this.scaleRotate.forEachManipulator(e)}_hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",(e=>{this._forEachManipulator((t=>t.available=e)),this.moveManipulation.zManipulation.available=e&&this.enableZ&&ia(this.graphic)}))}_createGeometryUndoRecord(){return Lr(this.graphic)}destroy(){this.moveManipulation.destroy(),this.scaleRotate=(0,n.SC)(this.scaleRotate),this.scaleRotateAdapter=(0,n.SC)(this.scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}set snapToScene(e){this.moveManipulation&&(this.moveManipulation.snapToScene=e),this._set("snapToScene",e)}get updating(){return this.updatingHandles.updating}set location(e){this.moveManipulation.location=e,(0,n.pC)(this.scaleRotate)&&(this.scaleRotate.location=e)}set elevationAlignedLocation(e){this.moveManipulation.elevationAlignedLocation=e,(0,n.pC)(this.scaleRotate)&&(this.scaleRotate.elevationAlignedLocation=e)}reset(){}onHide(){(0,n.pC)(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if((0,n.Wi)(this.scaleRotate))return;const e=this.scaleRotate.getScale();this.moveManipulation.displayScale=e}_updateMoveAngle(){this.view.state.viewingMode===Er.JY.Local||this.view.scale<1e6?this.moveManipulation.angle=this.scaleRotateAdapter.angle:this.moveManipulation.angle=0}_onGeometryChanged(){Ji(this.view,this,this.graphic)}_enforceNonZeroSize(e){return e||this.view.state.camera.computeRenderPixelSizeAt(this.moveManipulation.renderLocation)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,zManipulator:this.moveManipulation.zManipulation.test.manipulator,ringManipulator:(0,n.pC)(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Wr.prototype,"view",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Wr.prototype,"graphic",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Wr.prototype,"enableZ",void 0),(0,a._)([(0,o.Cb)()],Wr.prototype,"enableRotation",void 0),(0,a._)([(0,o.Cb)()],Wr.prototype,"enableScaling",void 0),(0,a._)([(0,o.Cb)({value:!1})],Wr.prototype,"snapToScene",null),(0,a._)([(0,o.Cb)({constructOnly:!0})],Wr.prototype,"snappingManager",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],Wr.prototype,"type",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],Wr.prototype,"updating",null),Wr=(0,a._)([(0,c.j)("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],Wr);var Nr=i(68860),Ur=i(82218),Fr=i(11582),Hr=i(46784),kr=i(89125),jr=i(66576);let Zr=class extends((0,Fr.J)(Hr.wq)){constructor(e){super(e),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(e){return this.heading===e.heading&&this.tilt===e.tilt&&(0,n._W)(this.position,e.position)&&this.width===e.width&&this.height===e.height}};(0,a._)([(0,o.Cb)({readOnly:!0,json:{read:!1,write:!0}})],Zr.prototype,"type",void 0),(0,a._)([(0,o.Cb)({type:Pi.Z}),(0,jr.B)()],Zr.prototype,"position",void 0),(0,a._)([(0,o.Cb)({type:Number,nonNullable:!0,range:{min:0,max:360}}),(0,jr.B)(),(0,kr.p)((e=>Cr.LU.normalize((0,h.q9)(e),0,!0)))],Zr.prototype,"heading",void 0),(0,a._)([(0,o.Cb)({type:Number,nonNullable:!0,range:{min:0,max:360}}),(0,jr.B)(),(0,kr.p)((e=>Cr.LU.normalize((0,h.q9)(e),0,!0)))],Zr.prototype,"tilt",void 0),(0,a._)([(0,o.Cb)({type:Number,nonNullable:!0}),(0,jr.B)()],Zr.prototype,"width",void 0),(0,a._)([(0,o.Cb)({type:Number,nonNullable:!0}),(0,jr.B)()],Zr.prototype,"height",void 0),Zr=(0,a._)([(0,c.j)("esri.analysis.SlicePlane")],Zr);var Br=i(32718),qr=i(48976);i(14320);(0,l.Z)("mac"),Math.cos((0,E.Vl)(45)),Math.cos((0,E.Vl)(5));const Yr=[1,.5,0],Xr=[...Yr,1],Qr=[1,1,1,1],Kr=[1,.8,.6,1],Jr=[1,.93,.86,1],$r=[...Yr,1],en=[...Yr,1],tn=40,an=[...Yr,1];(0,L.c)();var rn=i(64226),nn=i(11316);class sn extends V.A{initializeProgram(e){const t=sn.shader.get().build();return new z.$(e.rctx,t,ee.i)}bindPass(e,t){(0,Xt.II)(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("backgroundColor",e.backgroundColor),this.program.setUniform4fv("gridColor",e.gridColor),this.program.setUniform1f("gridWidth",e.gridWidth)}bindDraw(e){(0,Xt.id)(this.program,e),this.program.rebindTextures()}initializePipeline(){return(0,U.sm)({blending:(0,U.wK)(N.zi.ONE,N.zi.ONE,N.zi.ONE_MINUS_SRC_ALPHA,N.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:N.wb.LESS},colorWrite:U.BK})}}sn.shader=new G.J(nn.S,(()=>i.e(8492).then(i.bind(i,18492))));ye.mo;i(78952);(0,m.c)();(0,m.c)();i(92028);var on=i(40485),ln=i(50411),hn=i(32500);class cn extends V.A{initializeProgram(e){const t=cn.shader.get(),i=this.configuration,a=t.build({output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,oitEnabled:i.transparencyPassType===ge.Am.Color,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new z.$(e.rctx,a,ee.i)}bindPass(e,t){(0,Xt.II)(this.program,t.camera.projectionMatrix),this.program.setUniform1f("opacity",e.opacity),t.multipassTerrainEnabled&&(this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,Yt.p)(this.program,t))}bindDraw(e){(0,Xt.id)(this.program,e),(0,qt.DA)(this.program,this.configuration,e),this.program.rebindTextures()}_setPipelineState(e,t){const i=this.configuration,a=e===ge.Am.NONE,r=e===ge.Am.FrontFace;return(0,U.sm)({blending:i.output!==Ht.H.Color&&i.output!==Ht.H.Alpha||!i.transparent?null:a?dn:(0,Qt.j7)(e),culling:(0,U.zp)(i.cullFace),depthTest:{func:(0,Qt.Bh)(e)},depthWrite:a?i.writeDepth&&U.LZ:(0,Qt.K5)(e),colorWrite:U.BK,stencilWrite:i.sceneHasOcludees?ln.s3:null,stencilTest:i.sceneHasOcludees?t?ln.eD:ln.RY:null,polygonOffset:a||r?null:(0,Qt.je)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}cn.shader=new G.J(hn.I,(()=>i.e(8957).then(i.bind(i,18957))));const dn=(0,U.if)(N.zi.ONE,N.zi.ONE_MINUS_SRC_ALPHA);class pn extends I.m{constructor(){super(...arguments),this.output=Ht.H.Color,this.cullFace=ge.Vr.None,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=ge.Am.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,a._)([(0,I.o)({count:Ht.H.COUNT})],pn.prototype,"output",void 0),(0,a._)([(0,I.o)({count:ge.Vr.COUNT})],pn.prototype,"cullFace",void 0),(0,a._)([(0,I.o)()],pn.prototype,"slicePlaneEnabled",void 0),(0,a._)([(0,I.o)()],pn.prototype,"transparent",void 0),(0,a._)([(0,I.o)()],pn.prototype,"enableOffset",void 0),(0,a._)([(0,I.o)()],pn.prototype,"writeDepth",void 0),(0,a._)([(0,I.o)()],pn.prototype,"sceneHasOcludees",void 0),(0,a._)([(0,I.o)({count:ge.Am.COUNT})],pn.prototype,"transparencyPassType",void 0),(0,a._)([(0,I.o)()],pn.prototype,"multipassTerrainEnabled",void 0),(0,a._)([(0,I.o)()],pn.prototype,"cullAboveGround",void 0);class un extends ye.F5{constructor(e){super(e,mn),this.supportsEdges=!0,this.techniqueConfig=new pn}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<Qt.ve,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,a,r,n,s){(0,$.Bw)(e,t,a,r,n,void 0,s)}requiresSlot(e,t){return e===K.r.DRAPED_MATERIAL||((0,jt.S)(t)===Ht.H.Highlight?e===K.r.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?K.r.TRANSPARENT_MATERIAL:K.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:K.r.OPAQUE_MATERIAL))}createGLMaterial(e){return e.output===Ht.H.Color||e.output===Ht.H.Alpha||e.output===Ht.H.Highlight?new gn(e):void 0}createBufferWriter(){return new rn.G_(rn.W1)}}class gn extends on.Z{constructor(e){super({...e,...e.material.parameters})}updateParameters(e){const t=this._material.parameters;return this.updateTexture(t.textureId),this.ensureTechnique(cn,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&(this._material.setParameters({sceneHasOcludees:e.hasOccludees}),this.updateParameters(e))}beginSlot(e){return this._output!==Ht.H.Color&&this._output!==Ht.H.Alpha||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){this.bindTextures(t.program),this.bindTextureScale(t.program),t.bindPass(this._material.parameters,e)}}const mn={transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:ge.Vr.None,sceneHasOcludees:!1,opacity:1,textureId:null,initTextureTransparent:!0,...ye.mo};var _n=i(99196);i(53866);Br.Z.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");var fn;function vn(e,t){switch(t){case fn.POSITIVE_X:return{basis:e.basis1,direction:1,position:(0,g.b)(Ue.WM.get(),e.origin,e.basis1),edge:t};case fn.POSITIVE_Y:return{basis:e.basis2,direction:1,position:(0,g.b)(Ue.WM.get(),e.origin,e.basis2),edge:t};case fn.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:(0,g.f)(Ue.WM.get(),e.origin,e.basis1),edge:t};case fn.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:(0,g.f)(Ue.WM.get(),e.origin,e.basis2),edge:t}}}function yn(e){const t=(0,g.l)(e.basis1),i=(0,g.l)(e.basis2);return.3*Math.min(t,i)}function bn(e){return yn(e)}function Mn(e){return 0!==e.direction[0]&&0!==e.direction[1]}function Sn(e,t){const i=Mn(t),a=i?[(0,m.f)(1,0,0),(0,m.f)(0,0,0),(0,m.f)(0,1,0)]:[(0,m.f)(1,0,0),(0,m.f)(-1,0,0)],r=ve.Z.createPolylineGeometry(a),n=an,s=i?4:1,o=2*s,l=e=>e>1?(e=>new be.U({color:n,width:e,renderOccluded:ye.yD.OccludeAndTransparent}))(e):new _n.Y({color:n,renderOccluded:ye.yD.OccludeAndTransparent}),h=[{geometry:r,material:l(s),stateMask:Ai.Q9.Unfocused|Tn},{geometry:r,material:l(o),stateMask:Ai.Q9.Focused|Tn},{geometry:r,material:l(1),stateMask:Ln}],c=new Di({view:e,renderObjects:h,collisionType:{type:"line",paths:[a]},autoScaleRenderObjects:!1,worldSized:!0,radius:i?6:4});return c.state=Tn,c}function wn(e,t,i){const a=a=>{const r=(a?t:e).slice(0),s=(0,g.f)(Ue.WM.get(),r[0],r[1]);(0,g.n)(s,s);const o=(0,g.f)(Ue.WM.get(),r[r.length-1],r[r.length-2]);if((0,g.n)(o,o),i.padding>0){const e=(0,g.a)((0,m.c)(),o,-i.padding);if(r[r.length-1]=(0,g.b)(e,e,r[r.length-1]),i.bothEnds){const e=(0,g.a)((0,m.c)(),s,-i.padding);r[0]=(0,g.b)(e,e,r[0])}}const l=a?i.tipFocusMultiplier:1,h=i.tipLength*(i.focusTipLength?l:1),c=i.tipRadius*l,d=(0,T.i)(Ue.MP.get());if(i.padding>0){const e=h/4,t=(0,g.s)(Ue.WM.get(),0,e,0),a=1+i.padding/e;(0,T.j)(d,d,t),(0,T.h)(d,d,(0,g.s)(Ue.WM.get(),a,a,a)),(0,T.j)(d,d,(0,g.a)(t,t,-1/a))}const p=(0,T.i)((0,L.c)()),u=(0,m.f)(0,1,0),_=(0,T.k)((0,L.c)(),(0,qr.r)(Ue.vD.get(),u,o));_[12]=r[r.length-1][0],_[13]=r[r.length-1][1],_[14]=r[r.length-1][2],(0,T.m)(_,_,d);const f=[{part:"tube",geometry:En(i.tubeRadius*(a?i.tubeFocusMultiplier:1)+i.padding,i.flat,r),transform:p}];let v,y;if((0,n.pC)(i.flat)?v=ve.Z.createExtrudedTriangle(h,c,c,i.flat.thickness):(v=ve.Z.createConeGeometry(h,c,24,!1,!1,!0),y=ve.Z.createConeGeometry(h,c,24,!1,!0,!1)),f.push({part:"tip",geometry:v,transform:_}),y&&f.push({part:"cap",geometry:y,transform:_}),i.bothEnds){const e=(0,T.k)((0,L.c)(),(0,qr.r)(Ue.vD.get(),u,s));e[12]=r[0][0],e[13]=r[0][1],e[14]=r[0][2],(0,T.m)(e,e,d),f.push({part:"tip",geometry:v,transform:e}),y&&f.push({part:"cap",geometry:y,transform:e})}return f};return{normal:a(!1),focused:a(!0)}}function En(e,t,i){const a=[];if((0,n.pC)(t))a.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else{const t=12;for(let i=0;i<t;i++){const r=i/t*2*Math.PI;a.push([Math.cos(r)*e,Math.sin(r)*e])}}return ve.Z.createPathExtrusionGeometry(a,i,[],[],!1)}function xn(e,t){const i=(0,g.f)((0,m.c)(),e[e.length-1],e[e.length-2]);if((0,g.n)(i,i),(0,g.a)(i,i,12),(0,g.b)(i,i,e[e.length-1]),t){const t=(0,g.f)((0,m.c)(),e[0],e[1]);return(0,g.n)(t,t),(0,g.a)(t,t,12),(0,g.b)(t,t,e[0]),[t,...e,i]}return[...e,i]}function Cn(e,t){return(0,Ma.cp)(t,e.basis2,e.basis1)+Rn}!function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"}(fn||(fn={}));const On=Ai.jg.Custom1;var An,Pn;!function(e){e[e.HEADING=1]="HEADING",e[e.TILT=2]="TILT"}(An||(An={})),function(e){e[e.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.TILTED=3]="TILTED"}(Pn||(Pn={}));const Dn=Ai.jg.Custom2,Rn=((0,S.Ue)(),Math.PI/2),Tn=Ai.jg.Custom1,Ln=Ai.jg.Custom2;var Gn;!function(e){e[e.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",e[e.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"}(Gn||(Gn={}));const Vn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAACuFBMVEUAAAD/AAD/gAD/VQD/gAD/bQD/gAD/cQD/gAD/dAD/eAD/gAD/gAD/egD/gAD/ewD/gAD/fAD/gAD/fQD/gAD/fQD/fQD/egD/fQD/gAD/fQD/ewD/fQD/gAD/gAD/fQD/gAD/fAD/fgD/fgD/fAD/fgD/fAD/fgD/fAD/fgD/gAD/fAD/fgD/fAD/fQD/fgD/fgD/fQD/fgD/fgD/fQD/fgD/fQD/fQD/fgD/fgD/fQD/fQD/fgD/fQD/fgD/fQD/fgD/fQD/fgD/fgD/gAL/fgD/gAb/gAT/gwr/gQj/hA7/hAz/hxH/iBP/ixn/iRf/jBz/jR7/jyP/kCX/kyr/lS7/lCz/li//mTT/mTf/nDr/mjn/nTz/n0H/nT//oET/oEL/okf/oEX/o0r/pU3/o0v/pU//qFL/plH/qFX/qFP/qVb/q1n/rV3/rFz/rmD/rl7/sGL/rmH/tW3/s2v/tW//tW7/t3L/tnD/uHT/unb/unn/unf/vHv/vX3/v4D/vX7/w4n/xY3/xIv/x4//xY3/x5H/yZP/x5H/yJP/y5f/yZX/zZv/y5n/zZ3/zJv/z5//z6D/z6H/0aT/0KP/0qb/06j/1av/06r/1q3/1q//17H/2rb/2rb/2rj/3bz/4MH/38D/38H/4sX/4MT/48f/4sb/4sf/5Mr/5s3/5cz/5s3/59D/59D/6dT/6dP/6dT/6tb/6tX/6tf/69n/69j/7dr/7Nn/7dz/7dv/7t3/7t7/7t3/7+H/8eL/8uX/8eP/8+j/8+f/9On/8+j/9Or/9ez/9e3/9ez/9e3/9+//9+7/+PD/9+//+PH/+PD/+fL/+PH/+fT/+vX/+fT/+vb/+vX/+/b/+vb/+/j/+/j//Pr//Pn//fv//v3//vz//fz//fv//v3//fz//////v7//v3///9vf1WOAAAA53RSTlMAAQIDBgcICQoLERIYGRobKCkqKywtLzAxMjM4OTo+P0BAQUVGR0hPUFFSUlNUWlthYmNlZmdoamtvcHR1dnd4eXx9f4CAgYGCgoODhIWGhoeIiYqLjIyNjo+QkJGSkpOTlJSVlpaXmJiZmZqbnJydnZ6eoqKjo6Skpaanp6ipqqqvsLCxsbKzs7S1tbe3uLi5uru8vL2+wMDBwsTGx8jLzc3O0NDR0dLT1dXW19ja2tvc3N3e3t/f4ODh4uLl5ufn6urr6+zt7u7v8PDx8fLy8/P09fX29vf3+Pn6+vv8/Pz8/f3+/v7EBDCzAAADmklEQVR42qXXd3sUVRQG8BNDKkU3KLYUIFkLLBo0yRJNBszuuwQlGISIDUTFhljAhhUbtlXEYEcjoEJUNCqKPXZUUCDU0FvI+RpkZpa5c9iZzMzD7+/d88yde+95z5CbvIIhIyqrtbo6rboyUlKQR4GcGI7GIMSi4QHkU1bRKDgaVZRF3nKGanClDc4hD4Nq0CvtzAzqRd8L4GlkX3IVGg0fxpxMzjLOgk9hx2VkRuBbJNPh/+cjpQnezkuvcC6Q8vVseItkkKTWP6Pr17HwVkbCQFg+YJ4P3U0vtrS1t//c9u6zM+DgFLH/av+m7Gfe1IhpLf+ysmbxVBxrdD4ptvPzDvdY2trNUvfytBLlZDkdloZt3GPvPk5z8K0EpFMpJacWlmTqmdnBd1dBqMkm01BY4n+waTsb1nd0drHl/2kQSsiQpcHyKKd0MP/YfOt4AJfPWtTOKRumw04z+0MRlNV81PezoNz5JZv+boRdIemisMxkS+ck2M3rZMPHskcZ/Q/KR6y8D2HqWjbMh11/IgrDfoiU7lsgXGNW6GgQB1quYPrClk9+WnuITash3WGWfw02VUR5MUCKX3n7w8m3P1z121xIzazbMg5KLJcK4Ntl5vV4EDYhGgz/XmDdcnmWRsC/iQeM1wibYVSBAL5g3WQoF9JFCOBN1t0PpZo0BDCPdU9BqaU6BPAA65JQLglWYDbrFooCGgJ4jHXPiSUEeokvse4hKNXBtnEF624W2xiBf/GN3GP3pVCG0xAIE57+9h64uZd1bbApFpcpMXfFLuaVcLOKdS/DJiSu87UHucfhOb0+wIEmeZ0pCqWVdX+Nh5MJ61i3BDaVsqVhphkCnyaQrt68SYdvhE0pEQ2AzRI2LBuX3k1a2fAe7PoRyTU0/seGb66ANPkHNqxpEG1dBIvhvkNs2PLMWCiJ5FY27LlbBouMNsOTXWz6p/lqmK57fR2buh+HjDYVrsqCLhWmK5cuXvbZBhUVzzuGK+XUwO6J3exs5yMQLs6mlNMg3PY7O/nlBkiDyDISQv2CHXysrckEpHI5ZEmTXpUzyp+vTOx1yHLIp/icN74y927z54vuiiNNiISwc5hNub6pHoo8xNI5CCSS4T5sw/ewLZ1wNnwbnklOyuBPrJRcnKTBhzEDyVV+OTyV5x/fZ98Z5CG7RIOr2pJs8tanMApH0cI+5FP/sqoYhFhVaT8KJDdUHKkwP/8rhhWHct1+dwRTps/cplDIpwAAAABJRU5ErkJggg==";var In=i(76873);const zn={mipmap:!0,preMultiplyAlpha:!0,width:64,height:64};class Wn{constructor(){this.lastDragEvent=null,this.next=new Sa.hM,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&(0,n.pC)(this.lastDragEvent)){const t={...this.lastDragEvent,action:"update"};e&&this._adjustScaleFactors(t),this.next.execute(t)}this._enabled=e}createDragEventPipelineStep(){return this.lastDragEvent=null,e=>(this.lastDragEvent="end"!==e.action?{...e}:null,this._enabled&&this._adjustScaleFactors(e),e)}_adjustScaleFactors(e){const t=Mn(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):0===e.handle.direction[0]?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-t:t,e.factor2=e.factor2<0?-t:t}get test(){return{_adjustScaleFactors:e=>this._adjustScaleFactors(e)}}}var Nn=i(34778),Un=i(254),Fn=i(12225),Hn=i(29014);function kn(e,t){return Zn(e,t,!1)}function jn(e,t){return Zn(e,t,!0)}function Zn(e,t,i){if(e instanceof Nn.y){if(e.operation instanceof Un.z)return function(e,t){const i=arguments.length>2&&void 0!==arguments[2]&&arguments[2]?-1:1,a=(0,m.f)(i*e.dx,i*e.dy,i*e.dz);(0,g.b)(t.origin,t.origin,a)}(e.operation,t,i),!0;if(e.operation instanceof Fn.S)return function(e,t){const i=arguments.length>2&&void 0!==arguments[2]&&arguments[2]?-e.angle:e.angle;(0,g.G)(t.basis1,t.basis1,m.Z,i),(0,g.G)(t.basis2,t.basis2,m.Z,i)}(e.operation,t,i),!0;if(e.operation instanceof Hn.q)return function(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const a=i?1/e.factor1:e.factor1,r=i?1/e.factor2:e.factor2;(0,g.a)(t.basis1,t.basis1,a),(0,g.a)(t.basis2,t.basis2,r),(0,De.q)(t.origin,t.origin,e.origin,e.axis1,a),(0,De.q)(t.origin,t.origin,e.origin,e.axis2,r)}(e.operation,t,i),!0}return!1}let Bn=class extends(xt.Z.EventedMixin(Ya.m)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this._preserveAspectRatio=new Wn,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new _.Z,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=(0,Ur.c)(),this.mapBoundsStart=(0,Ur.c)(),this.displayBounds=(0,Ur.c)(),this.displayBoundsStart=(0,Ur.c)(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}]}initialize(){this.graphicState=new di({graphic:this.graphic});const e=this.graphic.geometry;this.editGeometryOperations=Xa.c.fromGeometry(e,this.view.state.viewingMode),this.graphicMoveManipulation=new Ba({tool:this,view:this.view,graphicState:this.graphicState}),this.handles.add(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=function(e){const t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:Gn.CENTER_ON_ARROW)===Gn.CENTER_ON_CALLOUT?tn:0,i=[(0,m.f)(t,0,-24),(0,m.f)(t,0,24)],a=xn(i,!0),r=(e,t)=>wn(i,i,{tubeRadius:3,tipRadius:11,tipLength:22.5,tubeFocusMultiplier:1.15,tipFocusMultiplier:1.15,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:t}),n=r(0,!1),s=r(2.25,!0),o=new Je.E({color:Qr,cullFace:ge.Vr.Back,renderOccluded:ye.yD.Opaque}),l=new Je.E({color:Kr,cullFace:ge.Vr.Back,renderOccluded:ye.yD.Opaque}),h=new Je.E({color:Jr,cullFace:ge.Vr.Back,renderOccluded:ye.yD.Opaque}),c=new Je.E({color:en,transparent:!0,writeDepth:!1,cullFace:ge.Vr.Front,renderOccluded:ye.yD.Transparent}),d=ve.Z.createPolylineGeometry([[t,0,0],[t-tn,0,0]]),p=ve.Z.createPolylineGeometry([[t,0,0],[t-tn,0,0]]),u=new _n.Y({color:$r,renderOccluded:ye.yD.OccludeAndTransparent});return new Di({view:e,renderObjects:[...n.normal.map((e=>{let{part:t,geometry:i,transform:a}=e;return{geometry:i,material:"tip"===t?o:"cap"===t?l:h,transform:a,stateMask:Ai.Q9.Unfocused|On}})),...s.normal.map((e=>{let{geometry:t,transform:i}=e;return{geometry:t,material:c,transform:i,stateMask:Ai.Q9.Unfocused|On}})),{geometry:d,material:u,stateMask:Ai.Q9.Unfocused|On|Dn},...n.focused.map((e=>{let{part:t,geometry:i,transform:a}=e;return{geometry:i,material:"tip"===t?o:"cap"===t?l:h,transform:a,stateMask:Ai.Q9.Focused|On}})),...s.focused.map((e=>{let{geometry:t,transform:i}=e;return{geometry:t,material:c,transform:i,stateMask:Ai.Q9.Focused|On}})),{geometry:p,material:u,stateMask:Ai.Q9.Focused|On|Dn}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[a]},collisionPriority:1,radius:11,state:On})}(this.view,Gn.CENTER_ON_CALLOUT),this.moveZManipulator.state|=Dn,this.handles.add(this.watch("enableZ",(()=>this._updateManipulatorAvailability(this.moveZManipulator,ea.TRANSLATE_Z)))),this.handles.add(this._createMoveZDragPipeline()),this.manipulators.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map((e=>{const t=Sn(this.view,e);return this.handles.add(this.watch("enableScaling",(()=>this._updateManipulatorAvailability(t,ea.SCALE)))),t.events.on("grab-changed",(e=>this._onResizeGrab(e))),this.handles.add(this._createResizeDragPipeline(t,e)),t})),this.manipulators.addMany(this.resizeManipulators),this.rotateManipulatorTexture=function(e){return e.fromData(Vn,(()=>new In.x(Vn,zn)))}(this.view.toolViewManager.textures),this.rotateManipulator=function(e,t){const i=new un({transparent:!0,writeDepth:!1,textureId:t.id,renderOccluded:ye.yD.Opaque}),a=40,r=27*1.1,n=e=>{const t=new Uint32Array([0,1,2,2,3,0]);return new Ke.Z([[R.T.POSITION,{size:3,data:[a-e,-e,0,a+e,-e,0,a+e,e,0,a-e,e,0],exclusive:!0}],[R.T.UV0,{size:2,data:[0,0,1,0,1,1,0,1]}]],[[R.T.POSITION,t],[R.T.UV0,t]])},s=ve.Z.createPolylineGeometry([[0,0,0],[13,0,0]]),o=ve.Z.createPolylineGeometry([[0,0,0],[a-r,0,0]]),l=new _n.Y({color:Xr,renderOccluded:ye.yD.OccludeAndTransparent}),h=[{geometry:n(27),material:i,stateMask:Ai.Q9.Unfocused|On},{geometry:s,material:l,stateMask:Ai.Q9.Unfocused|On},{geometry:n(r),material:i,stateMask:Ai.Q9.Focused|On},{geometry:o,material:l,stateMask:Ai.Q9.Focused|On}];return new Di({view:e,renderObjects:h,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[a,0,0]},collisionPriority:1,radius:13.5,state:On})}(this.view,this.rotateManipulatorTexture.texture),this.handles.add(this.watch("enableRotation",(()=>this._updateManipulatorAvailability(this.rotateManipulator,ea.ROTATE)))),this.rotateManipulator.events.on("grab-changed",(e=>{this._onRotateGrab(e)})),this.handles.add(this._createRotateDragPipeline(this.rotateManipulator)),this.manipulators.add(this.rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const t=pa({view:this.view,graphic:this.graphic,forEachManipulator:e=>this._forEachManipulator(e),onManipulatorsChanged:()=>(0,r.kB)()});(0,n.pC)(t)&&(this.outlineVisualElement=t.visualElement instanceof It?t.visualElement:null),(0,n.pC)(this.outlineVisualElement)&&this.handles.add(this.outlineVisualElement.events.on("attachment-origin-changed",(()=>this._updateDisplayBounds()))),this.handles.add(t),this.handles.add([this.graphicState.on("changed",(()=>this._onGeometryChanged())),this.graphicState.watch("displaying",(()=>this._updateAllManipulatorAvailability())),(0,s.S1)(this.graphicState,"isDraped",(()=>this._graphicDrapedChanged())),this.view.trackGraphicState(this.graphicState)]);const i=this.view.pointsOfInterest;i&&this.handles.add(i.centerOnSurfaceFrequent.watch("location",(()=>this._updateDisplayBounds())));this._forEachManipulator((e=>{this.handles.add(e.events.on("grab-changed",(()=>{this.grabbing=e.grabbing,this._updateAllManipulatorAvailability()})))}));this._forEachManipulator(((e,t)=>{this.handles.add(e.events.on("immediate-click",(e=>{t===ea.TRANSLATE_XY&&this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()})))})),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this.finishToolCreation()}_graphicDrapedChanged(){this.handles.remove(qn),this._updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",(e=>{(0,n.pC)(this.attachmentOrigin)&&(0,Ei.jE)(e.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this._updateDisplayBounds()})),qn)}_updateAllManipulatorAvailability(){this._forEachManipulator(((e,t)=>this._updateManipulatorAvailability(e,t)))}_updateManipulatorAvailability(e,t){const i=this.grabbing&&!e.grabbing;if(e.interactive=!i,e instanceof Di){const a=this.graphicState.displaying,r=this.enableZ&&ia(this.graphic);switch(t){case ea.ROTATE:e.available=a&&this.enableRotation;break;case ea.SCALE:e.available=a&&(this.enableScaling||this.enableRotation||r),e.interactive=!i&&this.enableScaling,e.state=this.enableScaling?Tn:Ln;break;case ea.TRANSLATE_Z:e.available=a&&r;break;default:e.available=a}}}_forEachManipulator(e){this.graphicMoveManipulation.forEachManipulator(e),this.resizeManipulators.forEach((t=>e(t,ea.SCALE))),e(this.rotateManipulator,ea.ROTATE),e(this.moveZManipulator,ea.TRANSLATE_Z)}destroy(){this.mapBounds=null,this.displayBounds=null,this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._set("view",null),this._set("graphic",null)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(e){this._preserveAspectRatio.enabled=e,this._set("preserveAspectRatio",e)}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const e=this.graphic.geometry,t=this.editGeometryOperations.data,i=t.components[0].edges[0],a=(0,De.f)(Ue.qW.get(),i.leftVertex.pos,i.rightVertex.pos);(0,De.i)(a,a);const r=(0,n.Pt)(Ki(this.view,this.graphic),e.extent.center);let s=Xn*this.view.pixelSizeAt(r);const o=this.view.spatialReference;o!==e.spatialReference&&(s*=(0,Nr.c9)(o)/(0,Nr.c9)(e.spatialReference)),function(e,t,i,a){a||(a=(0,Ur.c)());const r=(0,De.s)(Ue.qW.get(),e[1],-e[0]),n=(0,De.s)(Ue.qW.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),s=(0,De.s)(Ue.qW.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),o=Ue.qW.get();t.components.forEach((t=>t.vertices.forEach((t=>{const i=t.pos;(0,De.s)(o,(0,De.k)(e,i),(0,De.k)(r,i)),(0,De.x)(n,n,o),(0,De.y)(s,s,o)}))));const l=1e-6,h=(0,De.s)(Ue.qW.get(),s[0]-n[0]<l?i/2:0,s[1]-n[1]<l?i/2:0);(0,De.f)(n,n,h),(0,De.m)(s,s,h),(0,De.g)(a.basis1,e,(s[0]-n[0])/2),(0,De.g)(a.basis2,r,(s[1]-n[1])/2),(0,De.s)(a.origin,n[0]*e[0]+n[1]*r[0],n[0]*e[1]+n[1]*r[1]),(0,De.m)(a.origin,a.origin,a.basis1),(0,De.m)(a.origin,a.origin,a.basis2)}(a,t,s,this.mapBounds)}_updateDisplayBounds(){const e=this.graphic.geometry;if((0,n.Wi)(e))return;const t=(0,n.pC)(this.outlineVisualElement)&&!this.graphicState.isDraped&&(0,n.pC)(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:Ki(this.view,this.graphic);this.attachmentOrigin=(0,n.Pt)(t,e.extent.center);const i=(0,n.pC)(t)?t.z:(0,ke.w7)(this.mapBounds.origin,this.view.elevationProvider,je.o.fromElevationInfo((0,d.RL)(this.graphic)),this.view.renderCoordsHelper),a=(0,Ur.a)(this.mapBounds);a.origin[2]=i,function(e,t,i){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4?arguments[4]:void 0;r||(r=(0,Ur.c)()),t.toRenderCoords(e.origin,i,r.origin);const n=Ue.WM.get();(0,g.b)(n,e.origin,e.basis1),(0,g.b)(n,n,e.basis2),t.toRenderCoords(n,i,n);const s=Ue.WM.get();(0,g.b)(s,e.origin,e.basis1),(0,g.f)(s,s,e.basis2),t.toRenderCoords(s,i,s);const o=Ue.WM.get();(0,g.f)(o,e.origin,e.basis1),(0,g.f)(o,o,e.basis2),t.toRenderCoords(o,i,o);const l=Ue.WM.get();(0,g.f)(l,e.origin,e.basis1),(0,g.b)(l,l,e.basis2),t.toRenderCoords(l,i,l);const h=(0,g.e)(Ue.WM.get(),n,s,.5);(0,g.f)(h,h,r.origin);const c=(0,g.e)(Ue.WM.get(),o,l,.5);(0,g.f)(c,r.origin,c),(0,g.e)(r.basis1,h,c,.5);const d=(0,g.e)(Ue.WM.get(),l,n,.5);(0,g.f)(d,d,r.origin);const p=(0,g.e)(Ue.WM.get(),s,o,.5);(0,g.f)(p,r.origin,p),(0,g.e)(r.basis2,d,p,.5);const u=(0,g.c)(Ue.WM.get(),r.basis1,r.basis2),m=(0,g.c)(u,u,r.basis1);(0,g.n)(m,m),(0,g.a)(r.basis2,m,(0,g.d)(r.basis2,m)),(0,g.a)(r.basis1,r.basis1,1+a/(0,g.l)(r.basis1)),(0,g.a)(r.basis2,r.basis2,1+a/(0,g.l)(r.basis2)),(0,Ur.u)(r)}(a,this.view.renderCoordsHelper,e.spatialReference,this.displayBoundsMargin,this.displayBounds),this._updateManipulators()}get displayBoundsMargin(){const e=this.view.pointsOfInterest,t=e?e.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return Yn*this.view.pixelSizeAt(t)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline(((e,t,i)=>this._applyGraphicMoveSteps(t,i)))}_createMoveZDragPipeline(){const e=this.view,t=this.editGeometryOperations.data.spatialReference;return(0,Sa.Xd)(this.moveZManipulator,((i,a,r)=>{const n=(0,m.a)(i.renderLocation),s=a.next(Aa(e,n,t)).next((0,Sa.zh)());this._applyGraphicMoveSteps(s,r)}))}_applyGraphicMoveSteps(e,t){const i=e.next((e=>("start"===e.action&&(this.inputState={type:"move"},(0,Ur.a)(this.mapBounds,this.mapBoundsStart),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:e.screenDeltaX,dyScreen:e.screenDeltaY})),e))).next((0,Sa.AN)()).next(this._moveDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,dxScreen:e.screenDeltaX,dyScreen:e.screenDeltaY};switch(e.action){case"start":case"update":(e.mapEnd.x-e.mapStart.x||e.mapEnd.y-e.mapStart.y||e.mapEnd.z-e.mapStart.z)&&this.emit("graphic-translate",t);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",t)}return e}));return t.next((()=>{(0,n.pC)(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()})),i}_moveDragUpdateGeometry(){return e=>{if((0,n.Wi)(this.inputState)||"move"!==this.inputState.type)return e;const t=[];for(const a of this.editGeometryOperations.data.components)t.push(...a.vertices);const i="start"===e.action?dr.O.NEW_STEP:dr.O.ACCUMULATE_STEPS;return kn(this.editGeometryOperations.moveVertices(t,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}_onResizeGrab(e){if("start"!==e.action)return;const t=this._calculatePickRay(e.screenPoint);(0,O.BR)(this.displayBounds.plane,t,Ue.WM.get())&&((0,Ur.a)(this.displayBounds,this.displayBoundsStart),(0,Ur.a)(this.mapBounds,this.mapBoundsStart),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(e,t){return(0,Sa.Xd)(e,((e,i,a)=>{(0,n.Wi)(this.inputState)||(i.next((e=>("start"===e.action&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),e))).next(wa(this.view,this.displayBoundsStart.plane)).next((e=>({...e,handle:t}))).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,xScale:e.factor1,yScale:e.factor2};switch(e.action){case"start":case"update":this.emit("graphic-scale",t);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",t)}return e})),a.next((()=>{(0,n.pC)(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()})))}))}_resizeDragRenderPlaneToFactors(){return e=>{const t=this.displayBoundsStart,i=e.handle.direction,a=this.displayBoundsMargin,r=this.displayBoundsMarginStart,n=(0,g.g)(Ue.WM.get(),t.origin);(0,g.F)(n,n,t.basis1,-i[0]),(0,g.F)(n,n,t.basis2,-i[1]);const s=(0,g.f)(Ue.WM.get(),e.renderEnd,n),o=(0,g.f)(Ue.WM.get(),e.renderStart,n),l=Mn(e.handle),h=bn(t),c=bn(this.displayBounds)/h,d=(e,t)=>{if(0===e)return 1;let i=(0,g.l)(t),n=.5*e*(0,g.d)(t,s)/i;const h=n<0?-1:1;l&&(n+=(i-.5*e*(0,g.d)(t,o)/i)*h*c);const d=i<1.5*r?1:Qn;return i=Math.max(i-r,Qn),h>0&&(n-=a),h*Math.max(h*(n/i),d)};return{...e,factor1:d(i[0],t.basis1),factor2:d(i[1],t.basis2)}}}_resizeDragUpdateGeometry(){return e=>{const t=(0,g.g)((0,m.c)(),this.mapBoundsStart.origin);(0,g.F)(t,t,this.mapBoundsStart.basis1,-e.handle.direction[0]),(0,g.F)(t,t,this.mapBoundsStart.basis2,-e.handle.direction[1]);const i=(0,De.s)((0,x.a)(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);(0,De.i)(i,i);const a=[];for(const s of this.editGeometryOperations.data.components)a.push(...s.vertices);const r="start"===e.action?dr.O.NEW_STEP:dr.O.ACCUMULATE_STEPS,n=this.editGeometryOperations.scaleVertices(a,t,i,e.factor1,e.factor2,r,Nn.w.REPLACE);return(0,Ur.a)(this.mapBoundsStart,this.mapBounds),kn(n,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}_onRotateGrab(e){if("start"!==e.action)return;const t=function(e,t,i,a){const r=t.worldUpAtPosition(e.origin,Ue.WM.get()),n=Ue.WM.get();switch(i){case An.HEADING:(0,g.g)(n,r);break;case An.TILT:(0,g.g)(n,e.basis1)}return(0,O.Yq)(e.origin,n,a)}(this.displayBounds,this.view.renderCoordsHelper,An.HEADING,(0,O.Ue)()),i=this._calculatePickRay(e.screenPoint);(0,O.BR)(t,i,Ue.WM.get())&&((0,Ur.a)(this.displayBounds,this.displayBoundsStart),(0,Ur.a)(this.mapBounds,this.mapBoundsStart),this.inputState={type:"rotate",rotatePlane:t})}_createRotateDragPipeline(e){return(0,Sa.Xd)(e,((e,t,i)=>{const a=this.inputState;(0,n.Wi)(a)||(t.next((e=>("start"===e.action&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),e))).next(wa(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,angle:(0,E.BV)(e.rotateAngle)};switch(e.action){case"start":case"update":this.emit("graphic-rotate",t);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",t)}return e})),i.next((()=>{(0,n.pC)(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()})))}))}_rotateDragRenderPlaneToRotate(e){return t=>{const i=(0,O.mJ)(e.rotatePlane),a=Xi(t.renderStart,t.renderEnd,this.displayBounds.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){return e=>{const t=(0,g.g)((0,m.c)(),this.mapBoundsStart.origin),i=[];for(const n of this.editGeometryOperations.data.components)i.push(...n.vertices);const a="start"===e.action?dr.O.NEW_STEP:dr.O.ACCUMULATE_STEPS,r=this.editGeometryOperations.rotateVertices(i,t,e.rotateAngle,a,Nn.w.REPLACE);return(0,Ur.a)(this.mapBoundsStart,this.mapBounds),kn(r,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}_calculatePickRay(e){const t=(0,S.Ue)(),i=(0,Pe.md)(e);return Ci(this.view.state.camera,i,t),(0,g.n)(t.direction,t.direction),t}_updateManipulators(){if(!this.visible)return;const e=function(e,t){return Qi(e.basis1,e.basis2,e.origin,t)}(this.displayBounds,Ue.MP.get());(function(e,t,i,a){const r=a.worldUpAtPosition(i.origin,Ue.WM.get()),n=vn(i,fn.POSITIVE_X),s=(0,T.b)(Ue.MP.get(),n.edge*Math.PI/2);(0,T.r)(s,s,-Cn(i,r)),(0,T.m)(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=n.position})(this.rotateManipulator,e,this.displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this.moveZManipulator,e),this.resizeManipulators.forEach(((t,i)=>{!function(e,t,i,a){const r=(0,g.l)(a.basis1),n=(0,g.l)(a.basis2),s=yn(a),o=bn(a),l=(0,g.s)(Ue.WM.get(),0,0,0);(0,g.b)(l,(0,g.a)(Ue.WM.get(),a.basis1,t.direction[0]),(0,g.a)(Ue.WM.get(),a.basis2,t.direction[1])),(0,g.b)(l,a.origin,l);let h=0,c=1;if(Mn(t))1===t.direction[0]&&-1===t.direction[1]?h=Rn:1===t.direction[0]&&1===t.direction[1]?h=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(h=3*Math.PI/2),c=o;else{const e=0!==t.direction[0]?1:2;h=1===e?Rn:0,c=(1===e?n:r)-s}const d=(0,T.b)(Ue.MP.get(),h);(0,T.h)(d,d,(0,g.s)(Ue.WM.get(),c,c,c)),(0,T.m)(d,i,d),d[12]=0,d[13]=0,d[14]=0,e.modelTransform=d,e.renderLocation=l}(t,this.resizeHandles[i],e,this.displayBounds)}))}_updateZMoveHandle(e,t){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:(0,g.f)(Ue.WM.get(),i.origin,i.basis1),edge:2},r=Ue.MP.get();(0,T.g)(r,t,a.edge*Math.PI/2),r[12]=0,r[13]=0,r[14]=0,e.modelTransform=r,e.renderLocation=a.position}_cancel(){const e=this.editGeometryOperations.lastOperation;(0,n.Wi)(e)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,jn(e,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if((0,n.pC)(this.inputState))this.view.activeTool=null;else if(this.canUndo){const e=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,jn((0,n.Wg)(e),this.mapBounds),this._updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const e=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,kn((0,n.Wg)(e),this.mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator}}};(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Bn.prototype,"view",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Bn.prototype,"graphic",void 0),(0,a._)([(0,o.Cb)({constructOnly:!0,nonNullable:!0})],Bn.prototype,"enableZ",void 0),(0,a._)([(0,o.Cb)()],Bn.prototype,"enableRotation",void 0),(0,a._)([(0,o.Cb)()],Bn.prototype,"enableScaling",void 0),(0,a._)([(0,o.Cb)()],Bn.prototype,"preserveAspectRatio",null),(0,a._)([(0,o.Cb)()],Bn.prototype,"grabbing",void 0),(0,a._)([(0,o.Cb)()],Bn.prototype,"inputState",void 0),(0,a._)([(0,o.Cb)({readOnly:!0})],Bn.prototype,"type",void 0),Bn=(0,a._)([(0,c.j)("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],Bn);const qn="draped-elevation-changes",Yn=10,Xn=80,Qn=1e-6},66127:(e,t,i)=>{i.d(t,{j:()=>s});var a=i(21002),r=i(98634);function n(e){e.fragment.uniforms.add("projInfo","vec4"),e.fragment.uniforms.add("zScale","vec2"),e.fragment.code.add(r.H`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}function s(e,t){e.extensions.add("GL_OES_standard_derivatives"),e.fragment.include(a.S),e.include(n),e.fragment.uniforms.add("glowColor","vec3"),e.fragment.uniforms.add("glowWidth","float"),e.fragment.uniforms.add("glowFalloff","float"),e.fragment.uniforms.add("innerColor","vec3"),e.fragment.uniforms.add("innerWidth","float"),e.fragment.uniforms.add("depthMap","sampler2D"),e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("frameColor","sampler2D"),t.contrastControlEnabled&&e.fragment.uniforms.add("globalAlphaContrastBoost","float"),e.fragment.code.add(r.H`vec4 blendPremultiplied(vec4 source, vec4 dest) {
float oneMinusSourceAlpha = 1.0 - source.a;
return vec4(
source.rgb + dest.rgb * oneMinusSourceAlpha,
source.a + dest.a * oneMinusSourceAlpha
);
}`),e.fragment.code.add(r.H`vec4 premultipliedColor(vec3 rgb, float alpha) {
return vec4(rgb * alpha, alpha);
}`),e.fragment.code.add(r.H`vec4 laserlineProfile(float dist) {
if (dist > glowWidth) {
return vec4(0.0);
}
float innerAlpha = (1.0 - smoothstep(0.0, innerWidth, dist));
float glowAlpha = pow(max(0.0, 1.0 - dist / glowWidth), glowFalloff);
return blendPremultiplied(
premultipliedColor(innerColor, innerAlpha),
premultipliedColor(glowColor, glowAlpha)
);
}`),e.fragment.code.add(r.H`bool laserlineReconstructFromDepth(out vec3 pos, out vec3 normal, out float depthDiscontinuityAlpha) {
float depth = linearDepthFromTexture(depthMap, uv, nearFar);
if (-depth == nearFar[0]) {
return false;
}
pos = reconstructPosition(gl_FragCoord.xy, depth);
normal = normalize(cross(dFdx(pos), dFdy(pos)));
float ddepth = fwidth(depth);
depthDiscontinuityAlpha = 1.0 - smoothstep(0.0, 0.01, -ddepth / depth);
return true;
}`),t.contrastControlEnabled?e.fragment.code.add(r.H`float rgbToLuminance(vec3 color) {
return dot(vec3(0.2126, 0.7152, 0.0722), color);
}
vec4 laserlineOutput(vec4 color) {
float backgroundLuminance = rgbToLuminance(texture2D(frameColor, uv).rgb);
float alpha = clamp(globalAlpha * max(backgroundLuminance * globalAlphaContrastBoost, 1.0), 0.0, 1.0);
return color * alpha;
}`):e.fragment.code.add(r.H`vec4 laserlineOutput(vec4 color) {
return color * globalAlpha;
}`)}},43505:(e,t,i)=>{i.d(t,{A:()=>r,o:()=>n});var a=i(98634);function r(e){e.vertex.uniforms.add("cameraPosition","vec3").add("perScreenPixelRatio","float").add("screenSize","float"),e.vertex.code.add(a.H`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance*perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSize * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function n(e,t,i){e.setUniform1f("perScreenPixelRatio",i.camera.perScreenPixelRatio),e.setUniform1f("screenSize",t.screenSize)}},2346:(e,t,i)=>{i.d(t,{L:()=>v});var a=i(27366),r=i(85015),n=i(91505),s=i(92026),o=i(17842),l=i(49861),h=(i(63780),i(93169),i(25243),i(69912)),c=i(88396),d=i(11186),p=i(71353),u=i(79803),g=i(74509),m=i(61574),_=i(64575),f=i(45008);let v=class extends r.Z{constructor(e){super(e),this.layer=null,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.dragging=!1,this.cursor=null,this.events=new n.Z.EventEmitter,this._circleCollisionCache=null,this._graphicSymbolChangedHandle=null,this._originalSymbol=null}set graphic(e){this._circleCollisionCache=null,this._originalSymbol=e.symbol,this._set("graphic",e),this.attachSymbolChanged()}get elevationInfo(){const e="elevationInfo"in this.graphic.layer&&this.graphic.layer.elevationInfo,t=(0,g.vu)(this.graphic),i=e?e.offset:0;return new _.Z({mode:t,offset:i})}set focusedSymbol(e){e!==this._get("focusedSymbol")&&(this._set("focusedSymbol",e),this._updateGraphicSymbol(),this._circleCollisionCache=null)}grabbableForEvent(){return!0}set grabbing(e){e!==this._get("grabbing")&&(this._set("grabbing",e),this._updateGraphicSymbol())}set hovering(e){e!==this._get("hovering")&&(this._set("hovering",e),this._updateGraphicSymbol())}set selected(e){e!==this._get("selected")&&(this._set("selected",e),this._updateGraphicSymbol(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get _focused(){return this._get("hovering")||this._get("grabbing")}destroy(){this.detachSymbolChanged(),this._resetGraphicSymbol(),this._set("view",null)}intersectionDistance(e){const t=this.graphic;if(!1===t.visible)return null;const i=t.geometry;if((0,s.Wi)(i))return null;const a=this._get("focusedSymbol"),r=(0,s.pC)(a)?a:t.symbol;return"2d"===this.view.type?this._intersectDistance2D(this.view,e,i,r):this._intersectDistance3D(this.view,e,t)}attach(){this.attachSymbolChanged(),(0,s.pC)(this.layer)&&this.layer.add(this.graphic)}detach(){this.detachSymbolChanged(),this._resetGraphicSymbol(),(0,s.pC)(this.layer)&&this.layer.remove(this.graphic)}attachSymbolChanged(){this.detachSymbolChanged(),this._graphicSymbolChangedHandle=this.graphic.watch("symbol",(e=>{(0,s.pC)(e)&&e!==this.focusedSymbol&&e!==this._originalSymbol&&(this._originalSymbol=e,this._focused&&(0,s.pC)(this.focusedSymbol)&&(this.graphic.symbol=this.focusedSymbol))}),!0)}detachSymbolChanged(){(0,s.pC)(this._graphicSymbolChangedHandle)&&(this._graphicSymbolChangedHandle.remove(),this._graphicSymbolChangedHandle=null)}_updateGraphicSymbol(){this.graphic.symbol=this._focused&&(0,s.pC)(this.focusedSymbol)?this.focusedSymbol:this._originalSymbol}_resetGraphicSymbol(){this.graphic.symbol=this._originalSymbol}_intersectDistance2D(e,t,i,a){if(a=a||(0,m.js)(i),(0,s.Wi)(a))return null;let r=this._circleCollisionCache;if("point"!==i.type||"simple-marker"!==a.type)return(0,f.D)(t,i,e)?1:null;if((0,s.Wi)(r)||!r.originalPoint.equals(i)){const t=i,n=e.spatialReference;if((0,u.Up)(t.spatialReference,n)){const e=(0,u.iV)(t,n);r={originalPoint:t.clone(),mapPoint:e,radiusPx:(0,o.F2)(a.size)},this._circleCollisionCache=r}}if((0,s.pC)(r)){const i=(0,o.md)(t,b),n=e.toScreen(r.mapPoint),s=r.radiusPx,l=n.x+(0,o.F2)(a.xoffset),h=n.y-(0,o.F2)(a.yoffset);return(0,c.a)(i,[l,h])<s*s?1:null}return null}_intersectDistance3D(e,t,i){const a=e.toMap(t,{include:[i]});return a&&(0,u.KC)(a,y,e.renderSpatialReference)?(0,d.i)(y,e.state.camera.eye):null}};(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],v.prototype,"graphic",null),(0,a._)([(0,l.Cb)({readOnly:!0})],v.prototype,"elevationInfo",null),(0,a._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],v.prototype,"view",void 0),(0,a._)([(0,l.Cb)({value:null})],v.prototype,"focusedSymbol",null),(0,a._)([(0,l.Cb)({constructOnly:!0})],v.prototype,"layer",void 0),(0,a._)([(0,l.Cb)()],v.prototype,"interactive",void 0),(0,a._)([(0,l.Cb)()],v.prototype,"selectable",void 0),(0,a._)([(0,l.Cb)()],v.prototype,"grabbable",void 0),(0,a._)([(0,l.Cb)({value:!1})],v.prototype,"grabbing",null),(0,a._)([(0,l.Cb)()],v.prototype,"dragging",void 0),(0,a._)([(0,l.Cb)()],v.prototype,"hovering",null),(0,a._)([(0,l.Cb)({value:!1})],v.prototype,"selected",null),(0,a._)([(0,l.Cb)()],v.prototype,"cursor",void 0),v=(0,a._)([(0,h.j)("esri.views.interactive.GraphicManipulator")],v);const y=(0,p.c)(),b=(0,o.s1)()},45008:(e,t,i)=>{i.d(t,{D:()=>l,K:()=>o});i(59486);var a=i(92026),r=i(68860),n=i(96669),s=i(53866);function o(e,t,i){let n,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new s.Z;if("2d"===i.type)n=t*i.resolution;else if("3d"===i.type){const s=i.overlayPixelSizeInMapUnits(e),o=i.basemapSpatialReference;n=(0,a.pC)(o)&&!o.equals(i.spatialReference)?(0,r.c9)(o)/(0,r.c9)(i.spatialReference):t*s}const l=e.x-n,h=e.y-n,c=e.x+n,d=e.y+n,{spatialReference:p}=i;return o.xmin=Math.min(l,c),o.ymin=Math.min(h,d),o.xmax=Math.max(l,c),o.ymax=Math.max(h,d),o.spatialReference=p,o}function l(e,t,i){const r=i.toMap(e);return!(0,a.Wi)(r)&&o(r,(0,n.k)(),i,h).intersects(t)}const h=new s.Z}}]);
//# sourceMappingURL=583.53295721.chunk.js.map