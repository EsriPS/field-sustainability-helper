"use strict";(globalThis.webpackChunkfield_sustainability_helper=globalThis.webpackChunkfield_sustainability_helper||[]).push([[1221],{4685:(e,t,r)=>{r.d(t,{C:()=>m,b:()=>f});var i=r(60750),n=r(53685),o=r(29202),s=r(41481),a=r(85586),l=r(8973),c=r(116),d=r(78980),h=r(98634),u=r(64201),p=r(4760);function f(){const e=new u.kG;return e.attributes.add(p.T.POSITION,"vec2"),e.varyings.add("worldRay","vec3"),e.vertex.uniforms.add("inverseProjectionMatrix","mat4"),e.vertex.uniforms.add("inverseViewMatrix","mat4"),e.vertex.code.add(h.H`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),e.fragment.uniforms.add("lightingMainDirection","vec3"),e.fragment.include(c.Y),e.fragment.include(d.n),e.include(n.v),e.include(i._,{pbrMode:s.f7.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(a.e),e.include(o.D),e.include(l.j),e.fragment.code.add(h.H`void main() {
vec4 cloudsColor = crossFade == 0 ? renderCloud(normalize(worldRay), cameraPosition) : renderCloudCrossFade(normalize(worldRay), cameraPosition);
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),e}const m=Object.freeze({__proto__:null,build:f})},45028:(e,t,r)=>{r.d(t,{C:()=>v,b:()=>g});var i=r(71011),n=r(33280),o=r(94951),s=r(48655),a=r(16574),l=r(137),c=r(21002),d=r(15226),h=r(10763),u=r(116),p=r(98634),f=r(64201),m=r(4760);function g(e){const t=new f.kG,r=e.output===i.H.Depth;return t.include(o.w,{linearDepth:r}),t.include(s.c,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add(m.T.POSITION,"vec3"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),r&&(t.include(a.F,e),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("linearDepth","float")),t.vertex.code.add(p.H`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${r?p.H`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:p.H`transformPosition(proj, view, vpos);`}
    }
  `),t.include(n.p2,e),t.fragment.include(u.Y),e.multipassTerrainEnabled&&(t.fragment.include(c.S),t.include(d.l,e)),t.fragment.uniforms.add("eColor","vec4"),e.output===i.H.Highlight&&t.include(l.bA),t.fragment.code.add(p.H`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = ${e.attributeColor?"vColor * eColor;":"eColor;"}

    if (fColor.a < ${p.H.float(h.bf)}) {
      discard;
    }

    ${e.output===i.H.Alpha?p.H`gl_FragColor = vec4(fColor.a);`:""}

    ${e.output===i.H.Color?p.H`gl_FragColor = highlightSlice(fColor, vpos); ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${e.output===i.H.Highlight?p.H`outputHighlight();`:""};
    ${e.output===i.H.Depth?p.H`outputDepth(linearDepth);`:""};
  }
  `),t}const v=Object.freeze({__proto__:null,build:g})},4170:(e,t,r)=>{r.d(t,{C:()=>i,a:()=>l,b:()=>a});var i,n=r(74321),o=r(98634),s=r(64201);function a(e){const t=new s.kG;return t.include(n.k),t.fragment.uniforms.add("tex","sampler2D"),e.function===i.Standard&&(e.hasOpacityFactor?(t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(o.H`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):t.fragment.code.add(o.H`void main() {
gl_FragColor = texture2D(tex, uv);
}`)),e.function===i.OverlayWithTransparency&&(t.fragment.uniforms.add("overlayIdx","int"),e.hasOpacityFactor&&t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(o.H`
      void main() {
        vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
        gl_FragColor = texture2D(tex, overlayUV) ${e.hasOpacityFactor?"* opacity":""};
      }`)),e.function===i.TransparentToHUDVisibility&&t.fragment.code.add(o.H`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),e.function===i.Transparency&&(t.fragment.uniforms.add("colorTexture","sampler2D"),t.fragment.uniforms.add("alphaTexture","sampler2D"),t.fragment.uniforms.add("frontFaceTexture","sampler2D"),t.fragment.code.add(o.H`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`)),t}!function(e){e[e.Standard=0]="Standard",e[e.TransparentToHUDVisibility=1]="TransparentToHUDVisibility",e[e.Transparency=2]="Transparency",e[e.OverlayWithTransparency=3]="OverlayWithTransparency",e[e.COUNT=4]="COUNT"}(i||(i={}));const l=Object.freeze({__proto__:null,get CompositingFunction(){return i},build:a})},18442:(e,t,r)=>{r.d(t,{H:()=>E,a:()=>x,b:()=>b,c:()=>O});var i=r(88396),n=r(6394),o=r(67077),s=r(55360),a=r(71011),l=r(33280),c=r(28156),d=r(50600),h=r(50913),u=r(137),p=r(18607),f=r(10763),m=r(116),g=r(78980),v=r(62993),_=r(98634),y=r(64201),T=r(4760);function x(e){const t=new y.kG,r=e.signedDistanceFieldEnabled;if(t.include(c.H),t.include(d.RL,e),t.include(l.p2,e),e.output===a.H.Occlusion)return t.include(h.R,e),t;t.include(v.c),t.fragment.include(g.n),t.fragment.include(m.Y),t.include(p.kl,e),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&t.varyings.add("voccluded","float"),t.vertex.uniforms.add("screenOffset","vec2").add("anchorPos","vec2").add("textureCoordinateScaleFactor","vec2").add("materialColor","vec4"),r&&t.vertex.uniforms.add("outlineColor","vec4"),e.screenSizePerspectiveEnabled&&t.vertex.uniforms.add("screenSizePerspective","vec4"),(e.debugDrawLabelBorder||e.binaryHighlightOcclusionEnabled)&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(T.T.UV0,"vec2"),t.attributes.add(T.T.COLOR,"vec4"),t.attributes.add(T.T.SIZE,"vec2"),t.attributes.add(T.T.AUXPOS2,"vec4"),t.vertex.code.add(_.H`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.screenSizePerspectiveEnabled?_.H`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:_.H`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const i=_.H`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPos) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,n=e.pixelSnappingEnabled?r?_.H`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:_.H`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:_.H`posProj += quadOffset;`;t.vertex.code.add(_.H`
      ${e.occlusionTestEnabled?"if (visible) {":""}
      ${i}
      ${e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

      bool alphaDiscard = vcolor.a < ${_.H.float(f.bf)};
      ${r?`alphaDiscard = alphaDiscard && outlineColor.a < ${_.H.float(f.bf)};`:""}
      if (alphaDiscard) {
        // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      } else {
        ${n}
        gl_Position = posProj;
      }

      vtc = uv * textureCoordinateScaleFactor;

      ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
      vsize = inputSize;
      ${e.occlusionTestEnabled?_.H`} else { vtc = vec2(0.0);
        ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
    }
    `),t.fragment.uniforms.add("tex","sampler2D"),r&&(t.fragment.uniforms.add("outlineColor","vec4"),t.fragment.uniforms.add("outlineSize","float"));const o=e.debugDrawLabelBorder?_.H`(isBorder > 0.0 ? 0.0 : ${_.H.float(f.F)})`:_.H.float(f.F),x=_.H`
    ${e.debugDrawLabelBorder?_.H`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${r?_.H`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = ${_.H.float(s.Ph)};
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${o} ||
          fillPixelColor.a + outlinePixelColor.a < ${_.H.float(f.bf)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${o}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:_.H`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${o}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${e.debugDrawLabelBorder?_.H`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;return e.output===a.H.Alpha&&t.fragment.code.add(_.H`
      void main() {
        ${x}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),e.output===a.H.Color&&t.fragment.code.add(_.H`
    void main() {
      ${x}
      ${e.frontFacePass?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),e.output===a.H.Highlight&&(t.include(u.bA),t.fragment.code.add(_.H`
    void main() {
      ${x}
      ${e.binaryHighlightOcclusionEnabled?_.H`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),t}function b(e,t,r){e.setUniform4fv("materialColor",t.color),t.textureIsSignedDistanceField&&(t.outlineColor[3]<=0||t.outlineSize<=0?(e.setUniform4fv("outlineColor",o.Z),e.setUniform1f("outlineSize",0)):(e.setUniform4fv("outlineColor",t.outlineColor),e.setUniform1f("outlineSize",t.outlineSize))),e.setUniform2f("screenOffset",2*t.screenOffset[0]*r,2*t.screenOffset[1]*r),e.setUniform2fv("anchorPos",O(t))}function O(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:C;return e.textureIsSignedDistanceField?S(e.anchorPos,e.distanceFieldBoundingBox,t):(0,i.c)(t,e.anchorPos),t}function S(e,t,r){r[0]=e[0]*(t[2]-t[0])+t[0],r[1]=e[1]*(t[3]-t[1])+t[1]}const C=(0,n.a)(),E=Object.freeze({__proto__:null,build:x,bindHUDMaterialUniforms:b,calculateAnchorPosForRendering:O})},23819:(e,t,r)=>{r.d(t,{H:()=>d,b:()=>c});var i=r(74321),n=r(10763),o=r(98634),s=r(64201),a=r(68401),l=r(65322);function c(e){const t=new s.kG,{mode:r}=e;return t.include(i.k),t.include(n.sj,{alphaDiscardMode:a.JJ.Blend}),t.fragment.uniforms.add("densityMap","sampler2D"),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("densityNormalizer","float"),t.fragment.uniforms.add("minDensity","float"),r===l.H.KernelDensity&&t.fragment.uniforms.add("densityMultiplier","float"),t.fragment.code.add(o.H`
    void main() {
      float density = texture2D(densityMap, uv).r${r===l.H.KernelDensity?o.H` * densityMultiplier`:""};
      float densityRatio = (density - minDensity) * densityNormalizer;

      vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));

      discardOrAdjustAlpha(color);
      gl_FragColor = color;
    }
  `),t}const d=Object.freeze({__proto__:null,build:c,get HeatmapMode(){return l.H}})},65322:(e,t,r)=>{r.d(t,{H:()=>i,a:()=>l,b:()=>a});var i,n=r(98634),o=r(64201),s=r(4760);function a(e){const t=new o.kG,{mode:r,isAttributeDriven:a}=e;return t.attributes.add(s.T.POSITION,"vec3"),t.attributes.add(s.T.UV0,"vec2"),e.isAttributeDriven&&(t.attributes.add(s.T.FEATUREATTRIBUTE,"float"),t.varyings.add("attributeValue","float")),t.varyings.add("unitCirclePos","vec2"),t.vertex.uniforms.add("radius","float"),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),t.vertex.code.add(n.H`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${s.T.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${a?n.H`attributeValue = ${s.T.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),r===i.KernelDensity?t.fragment.code.add(n.H`
      void main() {
        float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
        if (radiusRatioSquared > 1.0) {
          discard;
        }

        float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
        float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${a?n.H` * attributeValue`:""};
        gl_FragColor = vec4(density);
      }
    `):r===i.GaussianBlur&&(t.fragment.uniforms.add("kernel","sampler2D"),t.fragment.code.add(n.H`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      vec2 uv = abs(unitCirclePos);
      vec2 uvX = vec2(uv.x, 0.5);
      vec2 uvY = vec2(uv.y, 0.5);
      float intensity = texture2D(kernel, uvX).r * texture2D(kernel, uvY).r${a?n.H` * attributeValue`:""};
      gl_FragColor = vec4(intensity);
    }
  `)),t}!function(e){e[e.GaussianBlur=0]="GaussianBlur",e[e.KernelDensity=1]="KernelDensity"}(i||(i={}));const l=Object.freeze({__proto__:null,get HeatmapMode(){return i},build:a})},99337:(e,t,r)=>{r.d(t,{N:()=>f,b:()=>p});var i=r(71011),n=r(33280),o=r(94951),s=r(48655),a=r(137),l=r(37248),c=r(10763),d=r(98634),h=r(64201),u=r(4760);function p(e){const t=new h.kG;return t.include(o.w,{linearDepth:!1}),t.include(s.c,e),t.include(l.q,{...e,stippleRequiresStretchMeasure:!1}),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.stippleEnabled&&(t.vertex.uniforms.add("ndcToPixel","vec2"),t.attributes.add(u.T.UV0,"vec2"),t.attributes.add(u.T.AUXPOS1,"vec3")),t.attributes.add(u.T.POSITION,"vec3"),t.varyings.add("vpos","vec3"),t.vertex.code.add(d.H`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),e.stippleEnabled&&(t.vertex.code.add(d.H`vec4 vpos2 = transformPosition(proj, view, auxpos1);
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),e.draped||t.vertex.code.add(d.H`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.vertex.code.add(d.H`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),e.draped?t.vertex.code.add(d.H`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):t.vertex.code.add(d.H`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.vertex.code.add(d.H`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),t.vertex.code.add(d.H`}`),e.output===i.H.Highlight&&t.include(a.bA),t.include(n.p2,e),t.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),t.fragment.code.add(d.H`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${d.H.float(c.bf)}) {
      discard;
    }

    ${e.output===i.H.Color?d.H`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===i.H.Highlight?d.H`outputHighlight();`:""}
  }
  `),t}const f=Object.freeze({__proto__:null,build:p})},98186:(e,t,r)=>{r.d(t,{C:()=>v,N:()=>g,R:()=>y,b:()=>_});var i=r(71011),n=r(33280),o=r(48353),s=r(16574),a=r(21002),l=r(37248),c=r(15226),d=r(85586),h=r(10763),u=r(116),p=r(98634),f=r(64201),m=r(4760);const g=1;var v;function _(e){const t=new f.kG,r=e.capType!==v.BUTT,_=e.capType===v.ROUND,y=e.stippleEnabled&&_,T=e.falloffEnabled||y,x=e.innerColorEnabled||_,b=e.stippleEnabled&&e.stippleScaleWithLineWidth||_,O=e.stippleEnabled&&e.stippleScaleWithLineWidth,S=e.stippleEnabled||_;return t.include(d.e),t.include(o.U,e),t.include(l.q,{...e,stippleRequiresStretchMeasure:!0}),e.output===i.H.Depth&&t.include(s.F,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("nearFar","vec2").add("pixelRatio","float").add("miterLimit","float").add("screenSize","vec2").add("inverseProjectionMatrix","mat4"),t.vertex.constants.add("LARGE_HALF_FLOAT","float",65500),t.attributes.add(m.T.POSITION,"vec3"),t.attributes.add(m.T.SUBDIVISIONFACTOR,"float"),t.attributes.add(m.T.UV0,"vec2"),t.attributes.add(m.T.AUXPOS1,"vec3"),t.attributes.add(m.T.AUXPOS2,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("linearDepth","float"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),b&&t.varyings.add("vLineWidth","float"),O&&t.varyings.add("vLineSizeInv","float"),x&&t.varyings.add("vLineDistance","float"),T&&t.varyings.add("vLineDistanceNorm","float"),e.falloffEnabled&&t.fragment.uniforms.add("falloff","float"),e.innerColorEnabled&&(t.fragment.uniforms.add("innerColor","vec4"),t.fragment.uniforms.add("innerWidth","float")),_&&(t.varyings.add("vSegmentSDF","float"),t.varyings.add("vReverseSegmentSDF","float")),t.vertex.code.add(p.H`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),t.vertex.code.add(p.H`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),t.vertex.code.add(p.H`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${e.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),t.vertex.code.add(p.H`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${b?p.H`vLineWidth = lineWidth;`:""}
      ${O?p.H`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);

      clipAndTransform(pos, prev, next, isStartVertex);

      vec2 left = (pos.xy - prev.xy);
      vec2 right = (next.xy - pos.xy);

      float leftLen = length(left);
      float rightLen = length(right);
  `),S&&t.vertex.code.add(p.H`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${_?p.H`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),t.vertex.code.add(p.H`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?t.vertex.code.add(p.H`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${e.stippleEnabled?p.H`min(1.0, subdivisionFactor * ${p.H.float((g+2)/(g+1))})`:p.H`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):t.vertex.code.add(p.H`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`),t.vertex.code.add(p.H`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${r?p.H`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),t.vertex.code.add(p.H`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${T||x?p.H`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${x?p.H`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${T?p.H`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),_&&t.vertex.code.add(p.H`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),e.stippleEnabled&&(e.draped||t.vertex.code.add(p.H`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.vertex.code.add(p.H`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),e.draped?t.vertex.code.add(p.H`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):t.vertex.code.add(p.H`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.vertex.code.add(p.H`
      float patternLength = ${e.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;

      // Disable stipple distance limits on caps
      vStippleDistanceLimits = isJoin ?
                                 vStippleDistanceLimits :
                                 isStartVertex ?
                                  vec2(-1e038, vStippleDistanceLimits.y) :
                                  vec2(vStippleDistanceLimits.x, 1e038);
    `)),t.vertex.code.add(p.H`
      // Convert back into NDC
      pos.xy = (pos.xy / screenSize) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
    }
  }
  `),e.multipassTerrainEnabled&&(t.fragment.include(a.S),t.include(c.l,e)),t.include(n.p2,e),t.fragment.uniforms.add("intrinsicColor","vec4"),t.fragment.include(u.Y),t.fragment.code.add(p.H`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),e.wireframe?t.fragment.code.add(p.H`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(_&&t.fragment.code.add(p.H`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${p.H.float(h.bf)}) {
        discard;
      }
    `),y?t.fragment.code.add(p.H`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${p.H.float(h.bf)}, stippleCoverage);
      `):t.fragment.code.add(p.H`float stippleAlpha = getStippleAlpha();`),t.fragment.code.add(p.H`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);
vec4 color = intrinsicColor * vColor;`),e.innerColorEnabled&&t.fragment.code.add(p.H`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`),t.fragment.code.add(p.H`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&t.fragment.code.add(p.H`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`)),t.fragment.code.add(p.H`
    if (finalColor.a < ${p.H.float(h.bf)}) {
      discard;
    }

    ${e.output===i.H.Alpha?p.H`gl_FragColor = vec4(finalColor.a);`:""}
    ${e.output===i.H.Color?p.H`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===i.H.Color&&e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${e.output===i.H.Highlight?p.H`gl_FragColor = vec4(1.0);`:""}
    ${e.output===i.H.Depth?p.H`outputDepth(linearDepth);`:""}
  }
  `),t}!function(e){e[e.BUTT=0]="BUTT",e[e.SQUARE=1]="SQUARE",e[e.ROUND=2]="ROUND",e[e.COUNT=3]="COUNT"}(v||(v={}));const y=Object.freeze({__proto__:null,NUM_ROUND_JOIN_SUBDIVISIONS:g,get CapType(){return v},build:_})},61863:(e,t,r)=>{r.d(t,{T:()=>a,b:()=>s});var i=r(74321),n=r(98634),o=r(64201);function s(){const e=new o.kG;return e.include(i.k),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("uColor","vec4"),e.fragment.code.add(n.H`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * uColor;
}`),e}const a=Object.freeze({__proto__:null,build:s})},49810:(e,t,r)=>{r.d(t,{W:()=>O,b:()=>b});var i=r(22357),n=r(71011),o=r(33280),s=r(94951),a=r(137),l=r(21002),c=r(60750),d=r(53685),h=r(15226),u=r(8555),p=r(41481),f=r(23235),m=r(68618),g=r(79246),v=r(10763),_=r(116),y=r(98634),T=r(64201),x=r(4760);function b(e){const t=new T.kG;return t.include(s.w,{linearDepth:!1}),t.attributes.add(x.T.POSITION,"vec3"),t.attributes.add(x.T.UV0,"vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),e.output!==n.H.Color&&e.output!==n.H.Alpha||(t.include(u.n,e),t.include(i.q,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),t.fragment.uniforms.add("localOrigin","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(y.H`
      void main(void) {
        if (waterColor.a < ${y.H.float(v.bf)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${e.output===n.H.Color?"forwardLinearDepth();":""}
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(l.S),t.include(h.l,e)),e.output===n.H.Alpha&&(t.include(o.p2,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(y.H`
        void main() {
          discardBySlice(vpos);
          ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),e.output===n.H.Color&&(t.include(d.v),t.include(c._,{pbrMode:p.f7.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(g.M,e),t.include(o.p2,e),e.receiveShadows&&t.include(f.hX,e),t.include(m.B,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("lightingSpecularStrength","float").add("lightingEnvironmentStrength","float").add("cameraPosition","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(_.Y),t.fragment.code.add(y.H`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${e.receiveShadows?y.H`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output===n.H.Normal&&(t.include(u.n,e),t.include(g.M,e),t.include(o.p2,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(y.H`
        void main(void) {
          if (waterColor.a < ${y.H.float(v.bf)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(y.H`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),e.output===n.H.Draped&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(y.H`
        void main(void) {
          if (waterColor.a < ${y.H.float(v.bf)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(y.H`void main() {
gl_FragColor = waterColor;
}`)),e.output===n.H.Highlight&&(t.include(a.bA),t.varyings.add("vpos","vec3"),t.vertex.code.add(y.H`
      void main(void) {
        if (waterColor.a < ${y.H.float(v.bf)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(o.p2,e),t.fragment.code.add(y.H`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const O=Object.freeze({__proto__:null,build:b})},82218:(e,t,r)=>{r.d(t,{a:()=>_,c:()=>v,g:()=>w,h:()=>b,u:()=>T});r(93169);var i=r(32718),n=r(16889),o=r(21530),s=r(14226),a=r(81949),l=r(11186),c=r(71353),d=r(14320),h=r(85981),u=r(55652),p=r(40885),f=r(40927),m=r(11185);const g=i.Z.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");function v(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:F;return{plane:(0,u.Ue)(e.plane),origin:(0,c.a)(e.origin),basis1:(0,c.a)(e.basis1),basis2:(0,c.a)(e.basis2)}}function _(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:v();return y(e.origin,e.basis1,e.basis2,t)}function y(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:v();return(0,l.g)(i.origin,e),(0,l.g)(i.basis1,t),(0,l.g)(i.basis2,r),T(i),N(i,"fromValues()"),i}function T(e){(0,u.my)(e.basis2,e.basis1,e.origin,e.plane)}function x(e,t,r){e!==r&&_(e,r);const i=(0,l.a)(m.WM.get(),I(e),t);return(0,l.b)(r.origin,r.origin,i),r.plane[3]-=t,r}function b(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:v();const r=(e[2]-e[0])/2,i=(e[3]-e[1])/2;return(0,l.s)(t.origin,e[0]+r,e[1]+i,0),(0,l.s)(t.basis1,r,0,0),(0,l.s)(t.basis2,0,i,0),(0,u.al)(0,0,1,0,t.plane),t}function O(e,t,r){return!!(0,u.BR)(e.plane,t,r)&&D(e,r)}function S(e,t,r){const i=U.get();L(e,t,i,U.get());let o=Number.POSITIVE_INFINITY;for(const s of G){const a=H(e,s,z.get()),c=m.WM.get();if((0,u.rx)(i,a,c)){const e=(0,l.r)(m.WM.get(),t.origin,c),i=Math.abs((0,n.ZF)((0,l.d)(t.direction,e)));i<o&&(o=i,(0,l.g)(r,c))}}return o===Number.POSITIVE_INFINITY?C(e,t,r):r}function C(e,t,r){if(O(e,t,r))return r;const i=U.get(),n=U.get();L(e,t,i,n);let o=Number.POSITIVE_INFINITY;for(const s of G){const a=H(e,s,z.get()),c=m.WM.get();if((0,u.dZ)(i,a,c)){const e=(0,p.Jk)(t,c);if(!(0,u.Ac)(n,c))continue;e<o&&(o=e,(0,l.g)(r,c))}}return R(e,t.origin)<o&&E(e,t.origin,r),r}function E(e,t,r){const i=(0,u.nF)(e.plane,t,m.WM.get()),n=(0,h.ct)(M(e,e.basis1),i,-1,1,m.WM.get()),o=(0,h.ct)(M(e,e.basis2),i,-1,1,m.WM.get());return(0,l.f)(r,(0,l.b)(m.WM.get(),n,o),e.origin),r}function A(e,t,r){const{origin:i,basis1:n,basis2:o}=e,s=(0,l.f)(m.WM.get(),t,i),a=(0,f.SR)(n,s),c=(0,f.SR)(o,s),d=(0,f.SR)(I(e),s);return(0,l.s)(r,a,c,d)}function R(e,t){const r=A(e,t,m.WM.get()),{basis1:i,basis2:n}=e,o=(0,l.l)(i),s=(0,l.l)(n),a=Math.max(Math.abs(r[0])-o,0),c=Math.max(Math.abs(r[1])-s,0),d=r[2];return a*a+c*c+d*d}function w(e,t){return Math.sqrt(R(e,t))}function P(e,t){const r=-e.plane[3];return(0,f.SR)(I(e),t)-r}function I(e){return(0,u.mJ)(e.plane)}function D(e,t){const r=(0,l.f)(m.WM.get(),t,e.origin),i=(0,l.p)(e.basis1),n=(0,l.p)(e.basis2),o=(0,l.d)(e.basis1,r),s=(0,l.d)(e.basis2,r);return-o-i<0&&o-i<0&&-s-n<0&&s-n<0}function M(e,t){const r=z.get();return(0,l.g)(r.origin,e.origin),(0,l.g)(r.vector,t),r}function H(e,t,r){const{basis1:i,basis2:n,origin:o}=e,s=(0,l.a)(m.WM.get(),i,t.origin[0]),a=(0,l.a)(m.WM.get(),n,t.origin[1]);(0,l.b)(r.origin,s,a),(0,l.b)(r.origin,r.origin,o);const c=(0,l.a)(m.WM.get(),i,t.direction[0]),d=(0,l.a)(m.WM.get(),n,t.direction[1]);return(0,l.a)(r.vector,(0,l.b)(c,c,d),2),r}function N(e,t){Math.abs((0,l.d)(e.basis1,e.basis2)/((0,l.l)(e.basis1)*(0,l.l)(e.basis2)))>1e-6&&g.warn(t,"Provided basis vectors are not perpendicular"),Math.abs((0,l.d)(e.basis1,I(e)))>1e-6&&g.warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-(0,l.d)(I(e),e.origin)-e.plane[3])>1e-6&&g.warn(t,"Plane offset is not consistent with plane origin")}function L(e,t,r,i){const n=I(e);(0,u.my)(n,t.direction,t.origin,r),(0,u.my)((0,u.mJ)(r),n,t.origin,i)}const F={plane:(0,u.Ue)(),origin:(0,c.f)(0,0,0),basis1:(0,c.f)(1,0,0),basis2:(0,c.f)(0,1,0)},U=new o.x(u.Ue),z=new o.x(h.Ue),V=(0,c.c)(),j=new o.x((()=>({origin:null,basis1:null,basis2:null,plane:null}))),G=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],B=(0,a.c)(),W=(0,a.c)();Object.freeze({__proto__:null,BoundedPlaneClass:class{constructor(){this.plane=(0,u.Ue)(),this.origin=(0,c.c)(),this.basis1=(0,c.c)(),this.basis2=(0,c.c)()}},create:v,wrap:function(e,t,r){const i=j.get();return i.origin=e,i.basis1=t,i.basis2=r,i.plane=(0,u.re)(0,0,0,0),T(i),i},copy:_,copyWithoutVerify:function(e,t){(0,l.g)(t.origin,e.origin),(0,l.g)(t.basis1,e.basis1),(0,l.g)(t.basis2,e.basis2),(0,u.JG)(t.plane,e.plane)},fromValues:y,updateUnboundedPlane:T,elevate:x,setExtent:function(e,t,r){return b(t,r),x(r,P(e,e.origin),r),r},fromAABoundingRect:b,intersectRay:O,intersectRayClosestSilhouette:function(e,t,r){if(O(e,t,r))return r;const i=S(e,t,m.WM.get());return(0,l.b)(r,t.origin,(0,l.a)(m.WM.get(),t.direction,(0,l.i)(t.origin,i)/(0,l.l)(t.direction))),r},closestPointOnSilhouette:S,closestPoint:C,projectPoint:E,projectPointLocal:A,distance2:R,distance:w,distanceToSilhouette:function(e,t){let r=Number.NEGATIVE_INFINITY;for(const i of G){const n=H(e,i,z.get()),o=(0,h.Jk)(n,t);o>r&&(r=o)}return Math.sqrt(r)},extrusionContainsPoint:function(e,t){return(0,u.Ac)(e.plane,t)&&D(e,t)},axisAt:function(e,t,r,i){return function(e,t,r){switch(t){case d.R.X:(0,l.g)(r,e.basis1),(0,l.n)(r,r);break;case d.R.Y:(0,l.g)(r,e.basis2),(0,l.n)(r,r);break;case d.R.Z:(0,l.g)(r,I(e))}return r}(e,r,i)},altitudeAt:P,setAltitudeAt:function(e,t,r,i){const n=P(e,t),o=(0,l.a)(V,I(e),r-n);return(0,l.b)(i,t,o),i},equals:function(e,t){return(0,l.k)(e.basis1,t.basis1)&&(0,l.k)(e.basis2,t.basis2)&&(0,l.k)(e.origin,t.origin)},transform:function(e,t,r){return e!==r&&_(e,r),(0,s.a)(B,t),(0,s.t)(B,B),(0,l.m)(r.basis1,e.basis1,B),(0,l.m)(r.basis2,e.basis2,B),(0,l.m)((0,u.mJ)(r.plane),(0,u.mJ)(e.plane),B),(0,l.m)(r.origin,e.origin,t),(0,u.T5)(r.plane,r.plane,r.origin),r},rotate:function(e,t,r,i){return e!==i&&_(e,i),(0,s.d)(W,t,r),(0,l.m)(i.basis1,e.basis1,W),(0,l.m)(i.basis2,e.basis2,W),T(i),i},normal:I,UP:F})},79347:(e,t,r)=>{r.d(t,{e:()=>a});var i,n,o,s={exports:{}};i=s,n=function(){function e(e,r,n){n=n||2;var o,s,a,c,d,h,u,p=r&&r.length,f=p?r[0]*n:e.length,m=t(e,0,f,n,!0),g=[];if(!m||m.next===m.prev)return g;if(p&&(m=l(e,r,m,n)),e.length>80*n){o=a=e[0],s=c=e[1];for(var v=n;v<f;v+=n)(d=e[v])<o&&(o=d),(h=e[v+1])<s&&(s=h),d>a&&(a=d),h>c&&(c=h);u=0!==(u=Math.max(a-o,c-s))?1/u:0}return i(m,g,n,o,s,u),g}function t(e,t,r,i,n){var o,s;if(n===R(e,t,r,i)>0)for(o=t;o<r;o+=i)s=C(o,e[o],e[o+1],s);else for(o=r-i;o>=t;o-=i)s=C(o,e[o],e[o+1],s);if(s&&y(s,s.next)){var a=s.next;E(s),s=a}return s}function r(e,t){if(!e)return e;t||(t=e);var r,i=e;do{if(r=!1,i.steiner||!y(i,i.next)&&0!==_(i.prev,i,i.next))i=i.next;else{var n=i.prev;if(E(i),(i=t=n)===i.next)break;r=!0}}while(r||i!==t);return t}function i(e,t,l,c,d,h,u){if(e){!u&&h&&p(e,c,d,h);for(var f,m,g=e;e.prev!==e.next;)if(f=e.prev,m=e.next,h?o(e,c,d,h):n(e))t.push(f.i/l),t.push(e.i/l),t.push(m.i/l),E(e),e=m.next,g=m.next;else if((e=m)===g){u?1===u?i(e=s(r(e),t,l),t,l,c,d,h,2):2===u&&a(e,t,l,c,d,h):i(r(e),t,l,c,d,h,1);break}}}function n(e){var t=e.prev,r=e,i=e.next;if(_(t,r,i)>=0)return!1;for(var n=e.next.next;n!==e.prev;){if(g(t.x,t.y,r.x,r.y,i.x,i.y,n.x,n.y)&&_(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function o(e,t,r,i){var n=e.prev,o=e,s=e.next;if(_(n,o,s)>=0)return!1;for(var a=n.x<o.x?n.x<s.x?n.x:s.x:o.x<s.x?o.x:s.x,l=n.y<o.y?n.y<s.y?n.y:s.y:o.y<s.y?o.y:s.y,c=n.x>o.x?n.x>s.x?n.x:s.x:o.x>s.x?o.x:s.x,d=n.y>o.y?n.y>s.y?n.y:s.y:o.y>s.y?o.y:s.y,h=f(a,l,t,r,i),u=f(c,d,t,r,i),p=e.prevZ,m=e.nextZ;p&&p.z>=h&&m&&m.z<=u;){if(p!==e.prev&&p!==e.next&&g(n.x,n.y,o.x,o.y,s.x,s.y,p.x,p.y)&&_(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,m!==e.prev&&m!==e.next&&g(n.x,n.y,o.x,o.y,s.x,s.y,m.x,m.y)&&_(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(;p&&p.z>=h;){if(p!==e.prev&&p!==e.next&&g(n.x,n.y,o.x,o.y,s.x,s.y,p.x,p.y)&&_(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;m&&m.z<=u;){if(m!==e.prev&&m!==e.next&&g(n.x,n.y,o.x,o.y,s.x,s.y,m.x,m.y)&&_(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function s(e,t,i){var n=e;do{var o=n.prev,s=n.next.next;!y(o,s)&&T(o,n,n.next,s)&&O(o,s)&&O(s,o)&&(t.push(o.i/i),t.push(n.i/i),t.push(s.i/i),E(n),E(n.next),n=e=s),n=n.next}while(n!==e);return r(n)}function a(e,t,n,o,s,a){var l=e;do{for(var c=l.next.next;c!==l.prev;){if(l.i!==c.i&&v(l,c)){var d=S(l,c);return l=r(l,l.next),d=r(d,d.next),i(l,t,n,o,s,a),void i(d,t,n,o,s,a)}c=c.next}l=l.next}while(l!==e)}function l(e,i,n,o){var s,a,l,d=[];for(s=0,a=i.length;s<a;s++)(l=t(e,i[s]*o,s<a-1?i[s+1]*o:e.length,o,!1))===l.next&&(l.steiner=!0),d.push(m(l));for(d.sort(c),s=0;s<d.length;s++)n=r(n=h(d[s],n),n.next);return n}function c(e,t){return e.x-t.x}function d(e){if(e.next.prev===e)return e;let t=e;for(;;){const r=t.next;if(r.prev===t||r===t||r===e)break;t=r}return t}function h(e,t){var i=function(e,t){var r,i=t,n=e.x,o=e.y,s=-1/0;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){var a=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=n&&a>s){if(s=a,a===n){if(o===i.y)return i;if(o===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!r)return null;if(n===s)return r;var l,c=r,d=r.x,h=r.y,p=1/0;i=r;do{n>=i.x&&i.x>=d&&n!==i.x&&g(o<h?n:s,o,d,h,o<h?s:n,o,i.x,i.y)&&(l=Math.abs(o-i.y)/(n-i.x),O(i,e)&&(l<p||l===p&&(i.x>r.x||i.x===r.x&&u(r,i)))&&(r=i,p=l)),i=i.next}while(i!==c);return r}(e,t);if(!i)return t;var n=S(i,e),o=r(i,i.next);let s=d(n);return r(s,s.next),o=d(o),d(t===i?o:t)}function u(e,t){return _(e.prev,e,t.prev)<0&&_(t.next,e,e.next)<0}function p(e,t,r,i){var n=e;do{null===n.z&&(n.z=f(n.x,n.y,t,r,i)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,function(e){var t,r,i,n,o,s,a,l,c=1;do{for(r=e,e=null,o=null,s=0;r;){for(s++,i=r,a=0,t=0;t<c&&(a++,i=i.nextZ);t++);for(l=c;a>0||l>0&&i;)0!==a&&(0===l||!i||r.z<=i.z)?(n=r,r=r.nextZ,a--):(n=i,i=i.nextZ,l--),o?o.nextZ=n:e=n,n.prevZ=o,o=n;r=i}o.nextZ=null,c*=2}while(s>1)}(n)}function f(e,t,r,i,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*n)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*n)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function m(e){var t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function g(e,t,r,i,n,o,s,a){return(n-s)*(t-a)-(e-s)*(o-a)>=0&&(e-s)*(i-a)-(r-s)*(t-a)>=0&&(r-s)*(o-a)-(n-s)*(i-a)>=0}function v(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&T(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&(O(e,t)&&O(t,e)&&function(e,t){var r=e,i=!1,n=(e.x+t.x)/2,o=(e.y+t.y)/2;do{r.y>o!=r.next.y>o&&r.next.y!==r.y&&n<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==e);return i}(e,t)&&(_(e.prev,e,t.prev)||_(e,t.prev,t))||y(e,t)&&_(e.prev,e,e.next)>0&&_(t.prev,t,t.next)>0)}function _(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function y(e,t){return e.x===t.x&&e.y===t.y}function T(e,t,r,i){var n=b(_(e,t,r)),o=b(_(e,t,i)),s=b(_(r,i,e)),a=b(_(r,i,t));return n!==o&&s!==a||!(0!==n||!x(e,r,t))||!(0!==o||!x(e,i,t))||!(0!==s||!x(r,e,i))||!(0!==a||!x(r,t,i))}function x(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function b(e){return e>0?1:e<0?-1:0}function O(e,t){return _(e.prev,e,e.next)<0?_(e,t,e.next)>=0&&_(e,e.prev,t)>=0:_(e,t,e.prev)<0||_(e,e.next,t)<0}function S(e,t){var r=new A(e.i,e.x,e.y),i=new A(t.i,t.x,t.y),n=e.next,o=t.prev;return e.next=t,t.prev=e,r.next=n,n.prev=r,i.next=r,r.prev=i,o.next=i,i.prev=o,i}function C(e,t,r,i){var n=new A(e,t,r);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function E(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function A(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function R(e,t,r,i){for(var n=0,o=t,s=r-i;o<r;o+=i)n+=(e[s]-e[o])*(e[o+1]+e[s+1]),s=o;return n}return e.deviation=function(e,t,r,i){var n=t&&t.length,o=n?t[0]*r:e.length,s=Math.abs(R(e,0,o,r));if(n)for(var a=0,l=t.length;a<l;a++){var c=t[a]*r,d=a<l-1?t[a+1]*r:e.length;s-=Math.abs(R(e,c,d,r))}var h=0;for(a=0;a<i.length;a+=3){var u=i[a]*r,p=i[a+1]*r,f=i[a+2]*r;h+=Math.abs((e[u]-e[f])*(e[p+1]-e[u+1])-(e[u]-e[p])*(e[f+1]-e[u+1]))}return 0===s&&0===h?0:Math.abs((h-s)/s)},e.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},i=0,n=0;n<e.length;n++){for(var o=0;o<e[n].length;o++)for(var s=0;s<t;s++)r.vertices.push(e[n][o][s]);n>0&&(i+=e[n-1].length,r.holes.push(i))}return r},e},void 0!==(o=n())&&(i.exports=o);const a=s.exports},59447:(e,t,r)=>{r.d(t,{r:()=>i});class i{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return 0===this._outer.size}get(e,t){var r;return null==(r=this._outer.get(e))?void 0:r.get(t)}set(e,t,r){const i=this._outer.get(e);i?i.set(t,r):this._outer.set(e,new Map([[t,r]]))}delete(e,t){const r=this._outer.get(e);r&&(r.delete(t),0===r.size&&this._outer.delete(e))}forEach(e){this._outer.forEach(((t,r)=>e(t,r)))}}},46228:(e,t,r)=>{r.d(t,{I:()=>n,v:()=>o});var i=r(16889);function n(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=(0,i.uZ)(e,0,l);for(let i=0;i<4;i++)t[r+i]=Math.floor(256*c(n*s[i]))}function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=0;for(let i=0;i<4;i++)r+=e[t+i]*a[i];return r}const s=[1,256,65536,16777216],a=[1/256,1/65536,1/16777216,1/4294967296],l=o(new Uint8ClampedArray([255,255,255,255]));function c(e){return e-Math.floor(e)}},70444:(e,t,r)=>{r.d(t,{S$:()=>c,Ue:()=>s,Ws:()=>l,iL:()=>a});var i=r(21530),n=r(11186),o=r(40885);r(11185);function s(e){return e?{ray:(0,o.Ue)(e.ray),c0:e.c0,c1:e.c1}:{ray:(0,o.Ue)(),c0:0,c1:Number.MAX_VALUE}}function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:s();return(0,o.JG)(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function l(e,t){return d(e,e.c0,t)}function c(e,t){return d(e,e.c1,t)}function d(e,t,r){return(0,n.b)(r,e.ray.origin,(0,n.a)(r,e.ray.direction,t))}new i.x((()=>({c0:0,c1:0,ray:null})))},95773:(e,t,r)=>{r.d(t,{JG:()=>g,Nu:()=>i,Ue:()=>m,hr:()=>y,q_:()=>v,zq:()=>T});var i,n,o,s=r(21530),a=r(14226),l=r(11186),c=r(71353),d=r(90045),h=r(67077),u=r(70444),p=r(55652),f=r(11185);function m(e){return e?[(0,p.Ue)(e[0]),(0,p.Ue)(e[1]),(0,p.Ue)(e[2]),(0,p.Ue)(e[3]),(0,p.Ue)(e[4]),(0,p.Ue)(e[5])]:[(0,p.Ue)(),(0,p.Ue)(),(0,p.Ue)(),(0,p.Ue)(),(0,p.Ue)(),(0,p.Ue)()]}function g(e,t){for(let r=0;r<x.NUM;r++)(0,p.JG)(e[r],t[r])}function v(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S;const n=(0,a.m)(f.MP.get(),t,e);(0,a.a)(n,n);for(let o=0;o<b.NUM;++o){const e=(0,d.t)(f.o6.get(),O[o],n);(0,l.s)(i[o],e[0]/e[3],e[1]/e[3],e[2]/e[3])}_(r,i)}function _(e,t){(0,p.zk)(t[n.FAR_BOTTOM_LEFT],t[n.NEAR_BOTTOM_LEFT],t[n.NEAR_TOP_LEFT],e[i.LEFT]),(0,p.zk)(t[n.NEAR_BOTTOM_RIGHT],t[n.FAR_BOTTOM_RIGHT],t[n.FAR_TOP_RIGHT],e[i.RIGHT]),(0,p.zk)(t[n.FAR_BOTTOM_LEFT],t[n.FAR_BOTTOM_RIGHT],t[n.NEAR_BOTTOM_RIGHT],e[i.BOTTOM]),(0,p.zk)(t[n.NEAR_TOP_LEFT],t[n.NEAR_TOP_RIGHT],t[n.FAR_TOP_RIGHT],e[i.TOP]),(0,p.zk)(t[n.NEAR_BOTTOM_LEFT],t[n.NEAR_BOTTOM_RIGHT],t[n.NEAR_TOP_RIGHT],e[i.NEAR]),(0,p.zk)(t[n.FAR_BOTTOM_RIGHT],t[n.FAR_BOTTOM_LEFT],t[n.FAR_TOP_LEFT],e[i.FAR])}function y(e,t){for(let r=0;r<x.NUM;r++){const i=e[r];if(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]>=t[3])return!1}return!0}function T(e,t){for(let r=0;r<x.NUM;r++){const i=e[r];if(!(0,p.Er)(i,t))return!1}return!0}(o=i||(i={}))[o.LEFT=0]="LEFT",o[o.RIGHT=1]="RIGHT",o[o.BOTTOM=2]="BOTTOM",o[o.TOP=3]="TOP",o[o.NEAR=4]="NEAR",o[o.FAR=5]="FAR",function(e){e[e.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",e[e.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",e[e.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",e[e.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",e[e.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",e[e.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",e[e.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",e[e.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(n||(n={}));n.FAR_BOTTOM_RIGHT,n.NEAR_BOTTOM_RIGHT,n.NEAR_BOTTOM_LEFT,n.FAR_BOTTOM_LEFT,n.NEAR_BOTTOM_LEFT,n.NEAR_BOTTOM_RIGHT,n.NEAR_TOP_RIGHT,n.NEAR_TOP_LEFT,n.FAR_BOTTOM_RIGHT,n.FAR_BOTTOM_LEFT,n.FAR_TOP_LEFT,n.FAR_TOP_RIGHT,n.NEAR_BOTTOM_RIGHT,n.FAR_BOTTOM_RIGHT,n.FAR_TOP_RIGHT,n.NEAR_TOP_RIGHT,n.FAR_BOTTOM_LEFT,n.NEAR_BOTTOM_LEFT,n.NEAR_TOP_LEFT,n.FAR_TOP_LEFT,n.FAR_TOP_LEFT,n.NEAR_TOP_LEFT,n.NEAR_TOP_RIGHT,n.FAR_TOP_RIGHT;var x,b;!function(e){e[e.NUM=6]="NUM"}(x||(x={})),function(e){e[e.NUM=8]="NUM"}(b||(b={}));const O=[(0,h.f)(-1,-1,-1,1),(0,h.f)(1,-1,-1,1),(0,h.f)(1,1,-1,1),(0,h.f)(-1,1,-1,1),(0,h.f)(-1,-1,1,1),(0,h.f)(1,-1,1,1),(0,h.f)(1,1,1,1),(0,h.f)(-1,1,1,1)],S=(new s.x(u.Ue),[(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)()])},35888:(e,t,r)=>{r.d(t,{d:()=>n});var i=r(16889);function n(e,t,r){var n;const c=e.byteLength/(4*t),d=new Uint32Array(e,0,c*t);let h=new Uint32Array(c);const u=null!=(n=null==r?void 0:r.minReduction)?n:0,p=(null==r?void 0:r.originalIndices)||null,f=p?p.length:0,m=(null==r?void 0:r.componentOffsets)||null;let g=0;if(m)for(let i=0;i<m.length-1;i++){const e=m[i+1]-m[i];e>g&&(g=e)}else g=c;const v=Math.floor(1.1*g)+1;(null==l||l.length<2*v)&&(l=new Uint32Array((0,i.Sf)(2*v)));for(let i=0;i<2*v;i++)l[i]=0;let _=0;const y=!!m&&!!p,T=y?f:c,x=y?new Uint32Array(f):null,b=1.96;let O=0!==u?Math.ceil(4*b*b/(u*u)*u*(1-u)):T,S=1,C=m?m[1]:T;for(let i=0;i<T;i++){if(i===O){const e=1-_/i;if(e+b*Math.sqrt(e*(1-e)/i)<u)return null;O*=2}if(i===C){for(let e=0;e<2*v;e++)l[e]=0;if(p)for(let e=m[S-1];e<m[S];e++)x[e]=h[p[e]];C=m[++S]}const e=y?p[i]:i,r=e*t,n=a(d,r,t);let s=n%v,c=_;for(;0!==l[2*s+1];){if(l[2*s]===n){const e=l[2*s+1]-1;if(o(d,r,e*t,t)){c=h[e];break}}s++,s>=v&&(s-=v)}c===_&&(l[2*s]=n,l[2*s+1]=e+1,_++),h[e]=c}if(0!==u&&1-_/c<u)return null;if(y){for(let e=m[S-1];e<x.length;e++)x[e]=h[p[e]];h=x}const E=new Uint32Array(t*_);_=0;for(let i=0;i<T;i++)h[i]===_&&(s(d,(y?p[i]:i)*t,E,_*t,t),_++);if(p&&!y){const e=new Uint32Array(f);for(let t=0;t<e.length;t++)e[t]=h[p[t]];h=e}return{buffer:E.buffer,indices:h,uniqueCount:_}}function o(e,t,r,i){for(let n=0;n<i;n++)if(e[t+n]!==e[r+n])return!1;return!0}function s(e,t,r,i,n){for(let o=0;o<n;o++)r[i+o]=e[t+o]}function a(e,t,r){let i=0;for(let n=0;n<r;n++)i=e[t+n]+i|0,i=i+(i<<11)+(i>>>2)|0;return i>>>0}let l=null},91320:(e,t,r)=>{r.d(t,{Mk:()=>l,ZI:()=>i,bT:()=>a});var i,n=r(79347),o=r(69662),s=r(35888);function a(e){const t=l(e.rings,e.hasZ,i.CCW_IS_HOLE),r=[];let o=0,a=0;for(const i of t.polygons){const e=i.count,s=i.index,l=new Float64Array(t.position.buffer,3*s*t.position.BYTES_PER_ELEMENT,3*e),c=i.holeIndices.map((e=>e-s)),d=new Uint32Array((0,n.e)(l,c,3));r.push({position:l,faces:d}),o+=l.length,a+=d.length}const c=function(e,t,r){if(1===e.length)return e[0];const i=new Float64Array(t),n=new Uint32Array(r);let o=0,s=0,a=0;for(const l of e){for(let e=0;e<l.position.length;e++)i[o++]=l.position[e];for(let e=0;e<l.faces.length;e++)n[s++]=l.faces[e]+a;a=o/3}return{position:i,faces:n}}(r,o,a),d=(0,s.d)(c.position.buffer,6,{originalIndices:c.faces});return c.position=new Float64Array(d.buffer),c.faces=d.indices,c}function l(e,t,r){const n=e.length,o=new Array(n),s=new Array(n),a=new Array(n);let l=0,h=0,u=0,p=0;for(let i=0;i<n;++i)p+=e[i].length;const f=new Float64Array(3*p);let m=0;for(let g=n-1;g>=0;g--){const p=e[g],v=r===i.CCW_IS_HOLE&&d(p);if(v&&1!==n)o[l++]=p;else{let e=p.length;for(let t=0;t<l;++t)e+=o[t].length;const r={index:m,pathLengths:new Array(l+1),count:e,holeIndices:new Array(l)};r.pathLengths[0]=p.length,p.length>0&&(a[u++]={index:m,count:p.length}),m=v?c(p,p.length-1,-1,f,m,p.length,t):c(p,0,1,f,m,p.length,t);for(let i=0;i<l;++i){const e=o[i];r.holeIndices[i]=m,r.pathLengths[i+1]=e.length,e.length>0&&(a[u++]={index:m,count:e.length}),m=c(e,0,1,f,m,e.length,t)}l=0,r.count>0&&(s[h++]=r)}}for(let i=0;i<l;++i){const e=o[i];e.length>0&&(a[u++]={index:m,count:e.length}),m=c(e,0,1,f,m,e.length,t)}return h<n&&(s.length=h),u<n&&(a.length=u),{position:f,polygons:s,outlines:a}}function c(e,t,r,i,n,o,s){n*=3;for(let a=0;a<o;++a){const o=e[t];i[n++]=o[0],i[n++]=o[1],i[n++]=s?o[2]:0,t+=r}return n/3}function d(e){return!(0,o.bu)(e,!1,!1)}!function(e){e[e.NONE=0]="NONE",e[e.CCW_IS_HOLE=1]="CCW_IS_HOLE"}(i||(i={}))},70178:(e,t,r)=>{r.d(t,{k:()=>i});r(93169);function i(e,t){return!!n(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function n(e,t){return e===t||e&&t&&e.equals(t)}},81020:(e,t,r)=>{function i(e){return"point"===e.type}r.d(t,{f:()=>i})},65618:(e,t,r)=>{r.d(t,{FS:()=>h,MS:()=>p,Pj:()=>l,R3:()=>d,S6:()=>a,TF:()=>u,Tx:()=>c,Wh:()=>s});r(59896),r(93169);var i=r(92026),n=(r(78952),r(41414)),o=r(65156);r(58971),r(27823),r(83040),r(70178);class s{constructor(e,t,r){this.uid=e,this.geometry=t,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null}}function a(e){return(0,i.pC)(e.geometry)}class l{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}}function c(e,t,r,i){return{x:e,y:t,z:r,hasZ:null!=r,hasM:!1,spatialReference:i,type:"point"}}function d(e){if((0,i.Wi)(e))return 0;switch(e.type){case"point":return 1;case"polyline":{let t=0;for(const r of e.paths)t+=r.length;return t}case"polygon":{let t=0;for(const r of e.rings)t+=r.length;return t}case"multipoint":return e.points.length;case"extent":return 2;case"mesh":{const t=e.vertexAttributes&&e.vertexAttributes.position;return t?t.length/3:0}default:return}}function h(e,t){switch((0,n.cS)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(let r=0;r<e.paths.length;r++)(0,n.Wi)(t,e.paths[r],e.hasZ);break;case"polygon":for(let r=0;r<e.rings.length;r++)(0,n.Wi)(t,e.rings[r],e.hasZ);break;case"multipoint":(0,n.Wi)(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax)}}function u(e,t){switch((0,o.cS)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(let r=0;r<e.paths.length;r++)(0,o.Wi)(t,e.paths[r]);break;case"polygon":for(let r=0;r<e.rings.length;r++)(0,o.Wi)(t,e.rings[r]);break;case"multipoint":(0,o.Wi)(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function p(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}(0,n.Ue)(),(0,o.Ue)()},37818:(e,t,r)=>{r.d(t,{Ou:()=>c,WG:()=>g,kB:()=>u,mW:()=>h});var i=r(52639),n=(r(93169),r(84652)),o=r(92026),s=r(18722),a=r(77981),l=r(65618);function c(e){return"declaredClass"in e}function d(e){return"declaredClass"in e}function h(e,t){if(!e)return null;if(function(e){return"declaredClass"in e}(e))return e;const r=new i.Z({layer:t,sourceLayer:t});return r.visible=e.visible,r.symbol=(0,n.d9)(e.symbol),r.attributes=(0,n.d9)(e.attributes),r.geometry=u(e.geometry),r}function u(e){return(0,o.Wi)(e)?null:c(e)?e:(0,a.im)(function(e){const t=e.spatialReference.toJSON();switch(e.type){case"point":{const{x:r,y:i,z:n,m:o}=e;return{x:r,y:i,z:n,m:o,spatialReference:t}}case"polygon":{const{rings:r,hasZ:i,hasM:n}=e;return{rings:p(r),hasZ:i,hasM:n,spatialReference:t}}case"polyline":{const{paths:r,hasZ:i,hasM:n}=e;return{paths:p(r),hasZ:i,hasM:n,spatialReference:t}}case"extent":{const{xmin:r,xmax:i,ymin:n,ymax:o,zmin:s,zmax:a,mmin:l,mmax:c,hasZ:d,hasM:h}=e;return{xmin:r,xmax:i,ymin:n,ymax:o,zmin:s,zmax:a,mmin:l,mmax:c,hasZ:d,hasM:h,spatialReference:t}}case"multipoint":{const{points:r,hasZ:i,hasM:n}=e;return{points:m(r)?f(r):r,hasZ:i,hasM:n,spatialReference:t}}default:return}}(e))}function p(e){return function(e){for(const t of e)if(0!==t.length)return m(t);return!1}(e)?e.map((e=>f(e))):e}function f(e){return e.map((e=>(0,s.qo)(e)))}function m(e){return e.length&&((0,s.xZ)(e[0])||(0,s.fS)(e[0]))}function g(e,t){if(!e)return null;let r;if(d(e)){if(null==t)return e.clone();if(d(t))return t.copy(e)}return null!=t?(r=t,r.x=e.x,r.y=e.y,r.spatialReference=e.spatialReference,e.hasZ?(r.z=e.z,r.hasZ=e.hasZ):(r.z=null,r.hasZ=!1),e.hasM?(r.m=e.m,r.hasM=!0):(r.m=null,r.hasM=!1)):(r=(0,l.Tx)(e.x,e.y,e.z,e.spatialReference),e.hasM&&(r.m=e.m,r.hasM=!0)),r}},27811:(e,t,r)=>{r.d(t,{QM:()=>o,cR:()=>a,hy:()=>s,uI:()=>n});var i=r(16889);const n=(()=>{if(!("document"in globalThis))return()=>null;const e=document.createElement("canvas"),t=e.getContext("2d");return e.height=512,e.width=1,r=>{t.clearRect(0,0,1,e.height);const i=t.createLinearGradient(0,0,0,e.height);for(const{ratio:e,color:t}of r)i.addColorStop(Math.max(e,.001),`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a})`);return t.fillStyle=i,t.fillRect(0,0,1,e.height),t.getImageData(0,0,1,e.height).data}})();function o(e,t,r,i){const{blurRadius:n,fieldOffset:o,field:s}=t,l=new Float64Array(r*i),c=a(n),d=Math.round(3*n);let h,u=Number.NEGATIVE_INFINITY;const p=function(e,t){return null!=e?"string"==typeof t?t=>-1*+t.readAttribute(e):r=>+r.readAttribute(e)+t:e=>1}(s,o),f=new Set;for(const a of e){const e=a.getCursor();for(;e.next();){const t=e.getObjectId();if(f.has(t))continue;f.add(t);const n=e.readLegacyPointGeometry(),o=128;if(n.x<-o||n.x>=r+o||n.y<-o||n.y>i+o)continue;const s=+p(e),a=Math.round(n.x)-d,m=Math.round(n.y)-d,g=Math.max(0,a),v=Math.max(0,m),_=Math.min(i,Math.round(n.y)+d),y=Math.min(r,Math.round(n.x)+d);for(let e=v;e<_;e++){const t=c[e-m];for(let i=g;i<y;i++){const n=c[i-a];h=l[e*r+i]+=t*n*s,h>u&&(u=h)}}}}return{matrix:l.buffer,max:u}}function s(e,t,r,n,o,s){e.canvas.width=e.canvas.height=t,e.clearRect(0,0,t,t);const a=e.getImageData(0,0,t,t);r&&n&&a.data.set(new Uint8ClampedArray(function(e,t,r,n,o){const s=new Uint32Array(e*e),a="buffer"in t?t:new Float64Array(t),l="buffer"in r?new Uint32Array(r.buffer):new Uint32Array(new Uint8Array(r).buffer),c=l.length/(o-n);for(let d=0;d<a.length;d++){const e=a[d],t=Math.floor((e-n)*c);s[d]=l[(0,i.uZ)(t,0,l.length-1)]}return s.buffer}(t,r,n,o,s))),e.putImageData(a,0,0)}function a(e){const t=Math.round(3*e),r=2*e*e,i=new Float64Array(2*t+1);for(let n=0;n<=i.length;n++)i[n]=Math.exp(-((n-t)**2)/r)/Math.sqrt(2*Math.PI)*(e/2);return i}},78935:(e,t,r)=>{r.d(t,{o:()=>s});var i=r(92026),n=r(88152),o=r(8821);class s{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=(0,n.Z7)(e)}get requiresSampledElevationInfo(){return"absolute-height"!==this.mode}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const r=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?r:e+r}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const r=this.featureExpressionInfoContext;return null!=r&&(t+=(0,o.ht)(r)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=(0,n.lt)(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=(0,i.Pt)(e.offset,0)}updateFeatureExpressionInfoContext(e,t,r){if((0,i.Wi)(e))return void(this._featureExpressionInfoContext=null);const n=e&&e.arcade;n&&(0,i.pC)(t)&&(0,i.pC)(r)?(this._featureExpressionInfoContext=(0,o.d9)(e),(0,o.aO)(this._featureExpressionInfoContext,(0,o.Tz)(n.modules,t,r))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new s;return(0,i.pC)(e)&&t.setFromElevationInfo(e),t}}},61310:(e,t,r)=>{r.d(t,{ZF:()=>n,a1:()=>s,rD:()=>o});var i=r(67077);const n=1.2,o=i.Z,s=i.O},69691:(e,t,r)=>{r.d(t,{B5:()=>_,GC:()=>g,Lm:()=>T,Xf:()=>v,bD:()=>y,lO:()=>i,qZ:()=>f,rR:()=>p,w7:()=>m});var i,n=r(41644),o=r(92026),s=r(14226),a=r(81949),l=r(71353),c=r(79803),d=r(81020),h=r(96387),u=r(77648);function p(e,t,r,i,n,o,s,a,l,d,h){const u=x[h.mode];let p,f,m=0;if((0,c.CM)(e,t,r,i,l.spatialReference,n,a))return u.requiresAlignment(h)?(m=u.applyElevationAlignmentBuffer(i,n,o,s,a,l,d,h),p=o,f=s):(p=i,f=n),(0,c.CM)(p,l.spatialReference,f,o,d.spatialReference,s,a)?m:void 0}function f(e,t,r,i,s){const a=((0,d.f)(e)?e.z:(0,u.Fb)(e)?e.array[e.offset+2]:e[2])||0;switch(r.mode){case"on-the-ground":{const r=(0,o.Pt)((0,u.KO)(t,e,"ground"),0);return s.verticalDistanceToGround=0,s.sampledElevation=r,void(s.z=r)}case"relative-to-ground":{const n=(0,o.Pt)((0,u.KO)(t,e,"ground"),0),l=r.geometryZWithOffset(a,i);return s.verticalDistanceToGround=l,s.sampledElevation=n,void(s.z=l+n)}case"relative-to-scene":{const n=(0,o.Pt)((0,u.KO)(t,e,"scene"),0),l=r.geometryZWithOffset(a,i);return s.verticalDistanceToGround=l,s.sampledElevation=n,void(s.z=l+n)}case"absolute-height":{const n=r.geometryZWithOffset(a,i),l=(0,o.Pt)((0,u.KO)(t,e,"ground"),0);return s.verticalDistanceToGround=n-l,s.sampledElevation=l,void(s.z=n)}default:return(0,n.Bg)(r.mode),void(s.z=0)}}function m(e,t,r,i){return f(e,t,r,i,O),O.z}function g(e,t,r){return null==t||null==r?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===r?e.staysOnTheGround:t===r||"on-the-ground"!==t&&"on-the-ground"!==r?i.UPDATE:e.onTheGroundChanged}function v(e){return"relative-to-ground"===e||"relative-to-scene"===e}function _(e){return"absolute-height"!==e}function y(e,t,r,i,n){f(t,r,n,i,O),(0,h.CV)(e,O.verticalDistanceToGround);const o=O.sampledElevation,a=(0,s.c)(b,e.transformation);return S[0]=t.x,S[1]=t.y,S[2]=O.z,(0,c.Bm)(t.spatialReference,S,a,i.spatialReference)?e.transformation=a:console.warn("Could not locate symbol object properly, it might be misplaced"),o}class T{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(i||(i={}));const x={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,r,i,n,o,s,a){const l=a.calculateOffsetRenderUnits(s),c=a.featureExpressionInfoContext;t*=3,i*=3;for(let d=0;d<n;++d){const n=e[t+0],o=e[t+1],s=e[t+2];r[i+0]=n,r[i+1]=o,r[i+2]=null==c?s+l:l,t+=3,i+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,r=e.featureExpressionInfoContext;return 0!==t||null!=r}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,r,i,n,s){let a=0;const l=s.spatialReference;t*=3,i*=3;for(let c=0;c<n;++c){const n=e[t+0],c=e[t+1],d=e[t+2],h=(0,o.Pt)(s.getElevation(n,c,d,l,"ground"),0);a+=h,r[i+0]=n,r[i+1]=c,r[i+2]=h,t+=3,i+=3}return a/n},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,r,i,n,s,a,l){let c=0;const d=l.calculateOffsetRenderUnits(a),h=l.featureExpressionInfoContext,u=s.spatialReference;t*=3,i*=3;for(let p=0;p<n;++p){const n=e[t+0],a=e[t+1],l=e[t+2],p=(0,o.Pt)(s.getElevation(n,a,l,u,"ground"),0);c+=p,r[i+0]=n,r[i+1]=a,r[i+2]=null==h?l+p+d:p+d,t+=3,i+=3}return c/n},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,r,i,n,s,a,l){let c=0;const d=l.calculateOffsetRenderUnits(a),h=l.featureExpressionInfoContext,u=s.spatialReference;t*=3,i*=3;for(let p=0;p<n;++p){const n=e[t+0],a=e[t+1],l=e[t+2],p=(0,o.Pt)(s.getElevation(n,a,l,u,"scene"),0);c+=p,r[i+0]=n,r[i+1]=a,r[i+2]=null==h?l+p+d:p+d,t+=3,i+=3}return c/n},requiresAlignment:()=>!0}},b=(0,a.c)(),O=new T,S=(0,l.c)()},8821:(e,t,r)=>{r.d(t,{O$:()=>p,Tz:()=>c,WI:()=>u,aO:()=>d,d9:()=>a,ht:()=>h,kr:()=>l});var i=r(32718),n=r(37818),o=r(819);const s=i.Z.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function a(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}async function l(e,t,r){const i=e&&e.expression;if("string"!=typeof i)return null;const n=m(i);if(null!=n)return{cachedResult:n};const s=await(0,o.LC)(),a=s.arcadeUtils,l=a.createSyntaxTree(i);return a.dependsOnView(l)?(null!=r&&r.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:a.createFunction(l),context:a.createExecContext(null,{sr:t}),modules:s}}}function c(e,t,r){return e.arcadeUtils.createFeature(t.attributes,t.geometry,r)}function d(e,t){if(null!=e&&!f(e)){if(!t||!e.arcade)return void s.errorOncePerTick("Arcade support required but not provided");const r=t;r._geometry&&(r._geometry=(0,n.kB)(r._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function h(e){if(null!=e){if(f(e))return e.cachedResult;const t=e.arcade;let r=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof r&&(e.cachedResult=0,r=0),r}return 0}function u(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e&&e.featureExpressionInfo;const i=r&&r.expression;return t||"0"===i||(r=null),r}const p={cachedResult:0};function f(e){return null!=e.cachedResult}function m(e){return"0"===e?0:null}},96387:(e,t,r)=>{r.d(t,{CV:()=>x,Go:()=>T,Si:()=>A,Uu:()=>b,ZL:()=>C,_Z:()=>E,bD:()=>O,bh:()=>S,zE:()=>v});var i=r(92026),n=r(14226),o=r(81949),s=r(71353),a=r(90045),l=r(67077),c=r(79803),d=r(41414),h=r(65156),u=r(4954),p=r(69662),f=r(65618),m=r(37818),g=r(4760);function v(e,t){if("point"===e.type)return y(e,t,!1);if((0,m.Ou)(e))switch(e.type){case"extent":return y(e.center,t,!1);case"polygon":return y(e.centroid,t,!1);case"polyline":return y(_(e),t,!0);case"mesh":return y(e.origin,t,!1)}else switch(e.type){case"extent":return y(function(e){const t=isFinite(e.zmin);return(0,f.Tx)(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),t?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return y(function(e){const t=e.rings[0];if(!t||0===t.length)return null;const r=(0,u.a)(e.rings,e.hasZ);return(0,f.Tx)(r[0],r[1],r[2],e.spatialReference)}(e),t,!0);case"polyline":return y(_(e),t,!0)}}function _(e){const t=e.paths[0];if(!t||0===t.length)return null;const r=(0,p.n8)(t,(0,p.ok)(t)/2);return(0,f.Tx)(r[0],r[1],r[2],e.spatialReference)}function y(e,t,r){const i=r?e:(0,m.WG)(e);return t&&e?(0,c.nF)(e,i,t)?i:null:i}function T(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(e){t||(t=(0,h.Ue)());const n=e;let o=.5*n.width*(r-1),s=.5*n.height*(r-1);return n.width<1e-7*n.height?o+=s/20:n.height<1e-7*n.width&&(s+=o/20),(0,a.s)(t,n.xmin-o-i,n.ymin-s-i,n.xmax+o+i,n.ymax+s+i),t}return null}function x(e,t){for(let r=0;r<e.geometries.length;++r){const i=e.geometries[r].getMutableAttribute(g.T.AUXPOS1);i&&i.data[3]!==t&&(i.data[3]=t,e.geometryVertexAttrsUpdated(e.geometryRecords[r]))}}function b(e,t){const r=(0,l.b)(l.O);return(0,i.pC)(e)&&(r[0]=e[0],r[1]=e[1],r[2]=e[2]),(0,i.pC)(t)?r[3]=t:(0,i.pC)(e)&&e.length>3&&(r[3]=e[3]),r}function O(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.O,t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;const o=new Array(3);if((0,i.Wi)(t)||(0,i.Wi)(r))o[0]=1,o[1]=1,o[2]=1;else{let i,n=0;for(let s=2;s>=0;s--){const a=e[s];let l;const c=null!=a,d=0===s&&!i&&!c,h=r[s];"symbol-value"===a||d?l=0!==h?t[s]/h:1:c&&"proportional"!==a&&isFinite(a)&&(l=0!==h?a/h:1),null!=l&&(o[s]=l,i=l,n=Math.max(n,Math.abs(l)))}for(let e=2;e>=0;e--)null==o[e]?o[e]=i:0===o[e]&&(o[e]=.001*n)}for(let i=2;i>=0;i--)o[i]/=n;return(0,s.d)(o)}function S(e){return function(e){return null!=e.isPrimitive}(e)&&(e=[e.width,e.depth,e.height]),C(e)?null:"Symbol sizes may not be negative values"}function C(e){if(Array.isArray(e)){for(const t of e)if(!C(t))return!1;return!0}return null==e||e>=0}function E(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,o.c)();const s=e||0,a=t||0,l=r||0;return 0!==s&&(0,n.g)(i,i,-s/180*Math.PI),0!==a&&(0,n.r)(i,i,a/180*Math.PI),0!==l&&(0,n.o)(i,i,l/180*Math.PI),i}function A(e,t){return null!=t.minDemResolution?t.minDemResolution:(0,d.wp)(e)?t.minDemResolutionForPoints:.01*(0,d.aO)(e)}},75558:(e,t,r)=>{r.d(t,{NW:()=>i,VP:()=>x,YU:()=>T,rm:()=>O,u9:()=>E});r(93169);var i,n=r(92026),o=r(18722),s=r(88396),a=r(11186),l=r(71353),c=r(79803),d=r(92183),h=r(91320),u=r(50951),p=r(61310),f=r(69691),m=r(38967),g=r(68401),v=r(74894),_=r(4760),y=r(98186);function T(e){const t=[],r=[];!function(e,t,r){const{attributeData:{position:n},removeDuplicateStartEnd:s}=e,a=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(n)&&s===i.REMOVE,l=n.length/3-(a?1:0),c=new Uint32Array(2*(l-1)),d=a?(0,o.tP)(n,0,n.length-3):n;let h=0;for(let i=0;i<l-1;i++)c[h++]=i,c[h++]=i+1;t.push([_.T.POSITION,{size:3,data:d,exclusive:a}]),r.push([_.T.POSITION,c])}(e,r,t);const l=r[0][1].data,h=t[0][1].length,f=new Uint16Array(h);return function(e,t,r){const i=e.attributeData.mapPosition;(0,n.Wi)(i)||(r.push([_.T.MAPPOS,r[0][1]]),t.push([_.T.MAPPOS,{size:3,data:i}]))}(e,r,t),function(e,t,r,i){if((0,n.pC)(e.attributeData.colorFeature))return;const o=e.attributeData.color;t.push([_.T.COLOR,{size:4,data:(0,n.Pt)(o,p.a1)}]),r.push([_.T.COLOR,i])}(e,r,t,f),function(e,t,r,i){if((0,n.pC)(e.attributeData.sizeFeature))return;const o=e.attributeData.size;t.push([_.T.SIZE,{size:1,data:[(0,n.Pt)(o,1)]}]),r.push([_.T.SIZE,i])}(e,r,t,f),function(e,t,r,i){const o=e.attributeData.colorFeature;(0,n.Wi)(o)||(t.push([_.T.COLORFEATUREATTRIBUTE,{size:1,data:new Float32Array([o])}]),r.push([_.T.COLOR,i]))}(e,r,t,f),function(e,t,r,i){const o=e.attributeData.sizeFeature;(0,n.Wi)(o)||(t.push([_.T.SIZEFEATUREATTRIBUTE,{size:1,data:new Float32Array([o])}]),r.push([_.T.SIZEFEATUREATTRIBUTE,i]))}(e,r,t,f),function(e,t,r,i){const o=e.attributeData.opacityFeature;(0,n.Wi)(o)||(t.push([_.T.OPACITYFEATUREATTRIBUTE,{size:1,data:new Float32Array([o])}]),r.push([_.T.OPACITYFEATUREATTRIBUTE,i]))}(e,r,t,f),function(e,t,r,i){if((0,n.Wi)(e.overlayInfo)||e.overlayInfo.renderCoordsHelper.viewingMode!==u.JY.Global||!e.overlayInfo.spatialReference.isGeographic)return;const o=new Float64Array(i.length),l=(0,d.Iu)(e.overlayInfo.spatialReference);for(let n=0;n<o.length;n+=3)(0,c.gH)(i,n,o,n,l);const h=i.length/3,p=new Float32Array(h+1);let f=S,m=C,g=0,v=0;(0,a.s)(f,o[v++],o[v++],o[v++]),p[0]=0;for(let n=1;n<h+1;++n)n===h&&(v=0),(0,a.s)(m,o[v++],o[v++],o[v++]),g+=(0,s.d)(f,m),p[n]=g,[f,m]=[m,f];t.push([_.T.DISTANCETOSTART,{size:1,data:p}]),r.push([_.T.DISTANCETOSTART,r[0][1]])}(e,r,t,l),new v.Z(r,t,g.MX.Line)}function x(e,t,r,i){const n="polygon"===e.type?h.ZI.CCW_IS_HOLE:h.ZI.NONE,o="polygon"===e.type?e.rings:e.paths,{position:s,outlines:a}=(0,h.Mk)(o,e.hasZ,n),l=new Float64Array(s.length),c=(0,f.rR)(s,e.spatialReference,0,l,0,s,0,s.length/3,t,r,i),d=null!=c;return{lines:d?b(a,s,l):[],projectionSuccess:d,sampledElevation:c}}function b(e,t,r){const i=new Array;for(const{index:n,count:o}of e){if(o<=1)continue;const e=3*n,s=e+3*o;i.push({position:t.subarray(e,s),mapPosition:r?r.subarray(e,s):void 0})}return i}function O(e,t){const r="polygon"===e.type?h.ZI.CCW_IS_HOLE:h.ZI.NONE,i="polygon"===e.type?e.rings:e.paths,{position:n,outlines:o}=(0,h.Mk)(i,!1,r),s=(0,c.CM)(n,e.spatialReference,0,n,t,0,n.length/3);for(let a=2;a<n.length;a+=3)n[a]=m.Rn;return{lines:s?b(o,n):[],projectionSuccess:s}}!function(e){e[e.KEEP=0]="KEEP",e[e.REMOVE=1]="REMOVE"}(i||(i={}));const S=(0,l.c)(),C=(0,l.c)();function E(e){switch(e){case"butt":return y.C.BUTT;case"square":return y.C.SQUARE;case"round":return y.C.ROUND;default:return null}}},36759:(e,t,r)=>{r.d(t,{S_:()=>g,VP:()=>v,dO:()=>m,km:()=>f});var i=r(92026),n=r(81949),o=r(71353),s=r(79803),a=r(41414),l=r(69662),c=r(65618),d=r(69691),h=r(96387),u=r(59887);const p=(0,o.c)();function f(e,t,r,o,l,c,h,f){const m=r?r.length:0,g=e.clippingExtent;if((0,s.KC)(t,p,e.elevationProvider.spatialReference),(0,i.pC)(g)&&!(0,a.BD)(g,p))return null;(0,s.KC)(t,p,e.renderCoordsHelper.spatialReference);const v=e.localOriginFactory.getOrigin(p),_=new u.T({castShadow:!1,metadata:{layerUid:c,graphicUid:h,usesVerticalDistanceToGround:!0}});for(let i=0;i<m;i++){const e=n.I;_.addGeometry(r[i],o[i],e,v,f)}return{object:_,sampledElevation:(0,d.bD)(_,t,e.elevationProvider,e.renderCoordsHelper,l)}}function m(e,t,r){const i=e.elevationContext,n=r.spatialReference;(0,s.KC)(t,p,n),i.centerPointInElevationSR=(0,c.Tx)(p[0],p[1],t.hasZ?p[2]:0,n)}function g(e){switch(e.type){case"point":return e;case"polygon":case"extent":return(0,h.zE)(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const r=(0,l.n8)(t,(0,l.ok)(t)/2);return(0,c.Tx)(r[0],r[1],r[2],e.spatialReference)}case"mesh":return e.origin}return null}function v(e,t,r,i,n){const o=new Float64Array(3*e.length),s=new Float64Array(o.length);e.forEach(((e,t)=>{o[3*t+0]=e[0],o[3*t+1]=e[1],o[3*t+2]=e.length>2?e[2]:0}));const a=(0,d.rR)(o,t,0,s,0,o,0,o.length/3,r,i,n),l=null!=a;return{numVertices:e.length,position:o,mapPosition:s,projectionSuccess:l,sampledElevation:a}}},55360:(e,t,r)=>{r.d(t,{Ns:()=>a,Ph:()=>s,cU:()=>l});r(93169);var i=r(46228),n=r(76873),o=r(8548);const s=128,a=.5;function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:s,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t*a,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const l=c(e,t,r,i);return new n.x(l,{mipmap:!1,wrap:{s:o.e8.CLAMP_TO_EDGE,t:o.e8.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0})}function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:s,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t*a,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;switch(e){case"circle":default:return d(t,r);case"square":return h(t,r);case"cross":return p(t,r,i);case"x":return f(t,r,i);case"kite":return u(t,r);case"triangle":return m(t,r);case"arrow":return g(t,r)}}function d(e,t){const r=e/2-.5;return x(e,y(r,r,t/2))}function h(e,t){return v(e,t,!1)}function u(e,t){return v(e,t,!0)}function p(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return _(e,t,!1,r)}function f(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return _(e,t,!0,r)}function m(e,t){return x(e,T(e/2,t,t/2))}function g(e,t){const r=t,i=t/2,n=e/2,o=.8*r,s=y(n,(e-t)/2-o,Math.sqrt(o*o+i*i)),a=T(n,r,i);return x(e,((e,t)=>Math.max(a(e,t),-s(e,t))))}function v(e,t,r){return r&&(t/=Math.SQRT2),x(e,((i,n)=>{let o=i-.5*e+.25,s=.5*e-n-.75;if(r){const e=(o+s)/Math.SQRT2;s=(s-o)/Math.SQRT2,o=e}return Math.max(Math.abs(o),Math.abs(s))-.5*t}))}function _(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;t-=i,r&&(t*=Math.SQRT2);const n=.5*t;return x(e,((t,o)=>{let s,a=t-.5*e,l=.5*e-o-1;if(r){const e=(a+l)/Math.SQRT2;l=(l-a)/Math.SQRT2,a=e}return a=Math.abs(a),l=Math.abs(l),s=a>l?a>n?Math.sqrt((a-n)*(a-n)+l*l):l:l>n?Math.sqrt(a*a+(l-n)*(l-n)):a,s-=i/2,s}))}function y(e,t,r){return(i,n)=>{const o=i-e,s=n-t;return Math.sqrt(o*o+s*s)-r}}function T(e,t,r){const i=Math.sqrt(t*t+r*r);return(n,o)=>{const s=Math.abs(n-e)-r,a=o-e+t/2+.75,l=(t*s+r*a)/i,c=-a;return Math.max(l,c)}}function x(e,t){const r=new Uint8Array(4*e*e);for(let n=0;n<e;n++)for(let o=0;o<e;o++){const s=o+e*n;let a=t(o,n);a=a/e+.5,(0,i.I)(a,r,4*s)}return r}},26279:(e,t,r)=>{var i,n,o;r.d(t,{Lw:()=>i,al:()=>n}),function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(i||(i={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(n||(n={})),function(e){e[e.LAYER_VIEW=0]="LAYER_VIEW",e[e.EXTERNAL=1]="EXTERNAL"}(o||(o={}))},77648:(e,t,r)=>{r.d(t,{Fb:()=>s,KO:()=>a,sb:()=>o});var i=r(92026),n=r(81020);class o{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.array=e,this.spatialReference=t,this.offset=r}}function s(e){return"array"in e}function a(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"ground";if((0,n.f)(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,r);if(s(t)){let n=t.offset;return e.getElevation(t.array[n++],t.array[n++],t.array[n]||0,(0,i.Pt)(t.spatialReference,e.spatialReference),r)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,r)}},50256:(e,t,r)=>{r.d(t,{K:()=>o});var i=r(8548),n=r(61109);function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const r=e.stride;return e.fieldNames.filter((t=>{const r=e.fields.get(t).optional;return!(r&&r.glPadding)})).map((i=>{const o=e.fields.get(i),a=o.constructor.ElementCount,l=s(o.constructor.ElementType),c=o.offset,d=!(!o.optional||!o.optional.glNormalized);return new n.G(i,a,l,c,r,d,t)}))}function s(e){const t=a[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const a={u8:i.g.UNSIGNED_BYTE,u16:i.g.UNSIGNED_SHORT,u32:i.g.UNSIGNED_INT,i8:i.g.BYTE,i16:i.g.SHORT,i32:i.g.INT,f32:i.g.FLOAT}},94463:(e,t,r)=>{r.d(t,{Z:()=>l});var i=r(27366),n=r(85015),o=r(49861),s=(r(63780),r(93169),r(25243),r(69912));let a=class extends n.Z{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};(0,i._)([(0,o.Cb)()],a.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"SCENEVIEW_LOCKING_LOG",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"DECONFLICTOR_SHOW_GRID",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"LABELS_SHOW_BORDER",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"TEXT_SHOW_BASELINE",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"TEXT_SHOW_BORDER",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"OVERLAY_SHOW_CENTER",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"SHOW_POI",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"I3S_TREE_SHOW_TILES",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"I3S_SHOW_MODIFICATIONS",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),(0,i._)([(0,o.Cb)()],a.prototype,"LINE_WIREFRAMES",void 0),a=(0,i._)([(0,s.j)("esri.views.3d.support.DebugFlags")],a);const l=new a},38967:(e,t,r)=>{r.d(t,{Rn:()=>sr});var i,n,o,s,a,l=r(27366),c=r(85015),d=r(91505),h=r(100),u=r(32718),p=r(77427),f=r(92026),m=r(27546),g=r(92377),v=r(8537),_=r(49861),y=(r(63780),r(93169),r(25243),r(69912)),T=r(14226),x=r(6394),b=r(71353),O=r(81949),S=r(50951),C=r(26279),E=r(94463);!function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"}(i||(i={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(n||(n={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(o||(o={})),function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.Water=3]="Water",e[e.Occluded=4]="Occluded"}(s||(s={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(a||(a={}));var A,R=r(16889),w=r(65156),P=r(68401),I=r(61403);!function(e){e[e.None=0]="None",e[e.ColorAndWater=1]="ColorAndWater",e[e.Highlight=2]="Highlight",e[e.Occluded=3]="Occluded"}(A||(A={}));class D{constructor(e,t){this.index=e,this.renderTargets=t,this.extent=(0,w.Ue)(),this.resolution=0,this.renderLocalOrigin=(0,I.al)(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new M,this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(t.renderTargets.length).fill(!1)}getValidTarget(e){return this.validTargets[e]?this.renderTargets.getTarget(e):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const t=e===A.ColorAndWater?this.renderTargets.getTarget(s.Color):e===A.Highlight?this.renderTargets.getTarget(s.Highlight):this.renderTargets.getTarget(s.Occluded);return t?t.getTexture():null}getNormalTexture(e){const t=e===A.ColorAndWater?this.renderTargets.getTarget(s.Water):null;return t?t.getTexture():null}draw(e,t){const r=this.computeRenderTargetValidityBitfield(),i=this.needsColorWithoutRasterImage;for(const n of this.renderTargets.renderTargets)n.type===s.ColorNoRasterImage&&!1===i?this.validTargets[n.type]=!1:this.validTargets[n.type]=e.drawTarget(this,n,t);return r^this.computeRenderTargetValidityBitfield()?P.Yg.CHANGED:P.Yg.UNCHANGED}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[s.Color]|+e[s.ColorNoRasterImage]<<1|+e[s.Highlight]<<2|+e[s.Water]<<3|+e[s.Occluded]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this.extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,w.cv)(this.extent,e.range,0,t)}if(this.extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,w.cv)(this.extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,(0,w.JG)(this.canvasGeometries.extents[0],this.extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}applyViewport(e){e.setViewport(this.index===i.INNER?0:this.resolution,0,this.resolution,this.resolution)}}class M{constructor(){this.extents=[(0,w.Ue)(),(0,w.Ue)(),(0,w.Ue)()],this.numViews=0}}var H=r(15245),N=r(8548),L=r(53634);class F{constructor(e,t){this.size=(0,H.c)(),this._fbo=null,this._fbo=new L.X(e,{colorTarget:N.Lm.TEXTURE,depthStencilTarget:N.OU.NONE},{target:N.No.TEXTURE_2D,pixelFormat:N.VI.RGBA,dataType:N.Br.UNSIGNED_BYTE,wrapMode:N.e8.CLAMP_TO_EDGE,samplingMode:N.cw.LINEAR_MIPMAP_LINEAR,hasMipmap:t,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=(0,f.O3)(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return null!==this._fbo}resize(e,t){this.size[0]=e,this.size[1]=t,this._fbo.resize(this.size[0],this.size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var e;null==(e=this._fbo)||e.resize(0,0)}get gpuMemoryUsage(){var e,t;return null!=(e=null==(t=this._fbo)?void 0:t.gpuMemoryUsage)?e:0}}var U=r(68198);class z{constructor(e){const t=function(t,r){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return{type:r,fbo:new F(e,i),renderPass:t,valid:!1,lastUsed:1/0}};this.renderTargets=[t(U.C.MATERIAL,s.Color),t(U.C.MATERIAL,s.ColorNoRasterImage),t(U.C.MATERIAL_HIGHLIGHT,s.Highlight,!1),t(U.C.MATERIAL_NORMAL,s.Water),t(U.C.MATERIAL,s.Occluded)]}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,t,r){if(e)t.lastUsed=r;else if(r-t.lastUsed>V)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce(((e,t)=>e+t.fbo.gpuMemoryUsage),0)}}const V=1e3;var j=r(59447);class G{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class B{constructor(e){this._context=e,this._perConstructorInstances=new j.r,this._frameCounter=0,this._keepAliveFrameCount=W}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e,t){const r=t.key;let i=this._perConstructorInstances.get(e,r);if((0,f.Wi)(i)){const n=new e(this._context,t,(()=>this.release(n)));i=new G(n),this._perConstructorInstances.set(e,r,i)}return++i.refCount,i.technique}releaseAndAcquire(e,t,r){if((0,f.pC)(r)){if(t.key===r.key)return r;this.release(r)}return this.acquire(e,t)}release(e){if((0,f.Wi)(e)||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);(0,f.Wi)(t)||(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==W&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,r)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,r))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,r)=>{e.push((async(e,t)=>{const r=t.shader;r&&(await r.reload(),e.forEach((e=>{e.technique.reload(this._context)})))})(t,r))})),await Promise.all(e)}}const W=-1,q=e=>class extends e{constructor(){super(...arguments),this._isDisposed=!1}dispose(){for(const t of null!=(e=this._managedDisposables)?e:[]){var e;const r=this[t];this[t]=null,r&&"function"==typeof r.dispose&&r.dispose()}this._isDisposed=!0}get isDisposed(){return this._isDisposed}};q(class{});var Z=r(30425),k=(r(75366),r(32534));class ${constructor(){this.adds=new m.Z,this.removes=new m.Z,this.updates=new m.Z({allocator:e=>e||new J,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class J{}class X{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function Y(e){return e.data.indexCount>=1}var K=r(50256),Q=r(94425),ee=r(56529),te=r(78289),re=r(97731),ie=r(82694);class ne{constructor(e){this.first=e.from,this.count=e.to-e.from}}class oe{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.from=e,this.to=t}}class se extends oe{constructor(e,t,r,i,n,o){super(t,r),this.id=e,this.isVisible=i,this.hasHighlights=n,this.hasOccludees=o}}function ae(e){return Array.from(e.values()).sort(le)}function le(e,t){return e.from===t.from?e.to-t.to:e.from-t.from}function ce(e,t){if(0===e.length)return void e.push(new ne(t));const r=e[e.length-1];if(function(e,t){return e.first+e.count>=t.from}(r,t)){const e=t.from-r.first+t.to-t.from;r.count=e}else e.push(new ne(t))}class de{constructor(e,t){this._pool=e,this._size=0,this._buffer=e.newBuffer(he(t))}dispose(){this._buffer=this._pool.deleteBuffer(this._buffer),this._size=0}release(){this.erase(0,this._size),this.dispose()}get vao(){return this._buffer.vao}get array(){return this._buffer.array}get size(){return this._size}grow(e){this._resize(this._size+e,!0).dispose()}alloc(e){return this._resize(e,!1)}_resize(e,t){let r;const i=function(e,t,r){return t<=r?e>=r?e:he(Math.max(2*e,r)):e<=2*r?e:he(r)}(this._buffer.length,this._size,e);if(this._buffer.length!==i){const e=this._pool.newBuffer(i);t&&(e.array.set(this._buffer.array.subarray(0,Math.min(this._size,i))),e.vao.vertexBuffers.geometry.setSubData(e.array,0,0,e.array.byteLength)),r=this._buffer,this._buffer=e}const n=this._size;return this._size=e,r?{dispose:()=>{r.array.fill(0,0,n),this._pool.deleteBuffer(r)},copy:(e,t,i)=>this._buffer.array.set(r.array.subarray(t,i),e),hasNewBuffer:!0}:{dispose:()=>{},copy:(e,t,r)=>{e!==t&&this._buffer.array.copyWithin(e,t,r)},hasNewBuffer:!1}}erase(e,t){this._buffer.array.fill(0,e,t)}}function he(e){return 65536*Math.ceil(e/65536)}var ue=r(18759),pe=r(95439),fe=r(44070),me=r(45412);class ge{constructor(e,t,r,i){this.vao=new me.U(e,t,{geometry:r},{geometry:fe.f.createVertex(e,N.l1.STATIC_DRAW)}),this.array=new Float32Array(i),this.vao.vertexBuffers.geometry.setSize(this.array.byteLength)}dispose(){this.vao.dispose(!0)}get length(){return this.array.length}}const ve=ue.an+1;class _e{constructor(e,t,r){this._rctx=e,this._locations=t,this._layout=r,this._cache=e.newCache(`MergedRenderer pool ${(0,pe.D)()}`,ye)}dispose(){this._cache.destroy()}newBuffer(e){const t=e.toString(),r=this._cache.pop(t);if((0,f.pC)(r)){const e=r.pop();return r.length>0&&this._cache.put(t,r,e.array.byteLength*r.length,ve),e}return new ge(this._rctx,this._locations,this._layout,e)}deleteBuffer(e){const t=e.array.byteLength,r=e.array.length.toString(),i=this._cache.pop(r);return(0,f.pC)(i)?(i.push(e),this._cache.put(r,i,t*i.length,-1)):this._cache.put(r,[e],t,-1),null}}function ye(e,t){if(t===ue.lN.ALL)return void e.forEach((e=>e.dispose()));const r=e.pop(),i=e.length*r.array.byteLength;return r.dispose(),i}var Te=r(32683);class xe{constructor(e,t,r){this._rctx=e,this._materialRepository=t,this._material=r,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new m.Z,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new Q.p(this._material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._bufferPool=new _e(e,r.vertexAttributeLocations,(0,K.K)(this._bufferWriter.vertexBufferLayout))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.buffer.dispose())),this._dataByOrigin.clear(),this._bufferPool.dispose()}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this._material instanceof ie.H}get rendersOccluded(){return!this.isEmpty&&this._material.renderOccluded!==ee.yD.Occlude}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateRenderCommands()}_addAndRemoveGeometries(e,t){const r=this._bufferWriter,i=r.vertexBufferLayout.stride/4,n=this._dataByOrigin,o=function(e,t){const r=new Map;for(const i of e)Oe(r,i,!0);for(const i of t)Oe(r,i,!1);return r}(e,t);o.forEach(((e,t)=>{o.delete(t);const s=e.toAdd.reduce(((e,t)=>e+r.elementCount(t.data)),0);let a=n.get(t);if(null==a)(0,re.hu)(0===e.toRemove.length),a=new Ae(e.origin,new de(this._bufferPool,s*i)),n.set(t,a);else if(0===e.toAdd.length&&a.instances.size===e.toRemove.length)return a.buffer.dispose(),void n.delete(t);let l=0;a.instances.forEach((e=>l+=e.to-e.from));const c=e.toRemove.reduce(((e,t)=>e+r.elementCount(t.data)),0),d=a.buffer.size,h=(l+s-c)*i,u=we;if(h<d/2?this._removeAndRebuild(a,e.toRemove,i,h,u):e.toRemove.length>0&&this._remove(a,e.toRemove,i,u),e.toAdd.length>0){const t=Pe;(0,re.u_)(t,-e.origin[0],-e.origin[1],-e.origin[2]),this._add(a,e.toAdd,i,t,u)}const p=a.buffer.vao.vertexBuffers.geometry;Ee(u),u.forAll((e=>{let{from:t,to:r}=e;if(t<r){const e=a.buffer.array,i=4,n=t*i,o=r*i;p.setSubData(e,n,n,o)}})),u.clear(),a.drawCommandsDirty=!0}))}_updateGeometries(e){const t=this._bufferWriter,r=t.vertexBufferLayout.stride/4;for(const i of e){const e=i.renderGeometry,n=this._dataByOrigin.get(e.origin.id),o=n&&n.instances.get(e.id);if(!o)return;const s=i.updateType;if(s&te.$.State.VISIBILITIES&&(o.isVisible=e.instanceParameters.visible),s&(te.$.State.HIGHLIGHTS|te.$.State.VISIBILITIES)){const t=e.instanceParameters.visible;o.hasHighlights=!!e.instanceParameters.highlights&&t}if(s&te.$.State.OCCLUDEES&&(o.hasOccludees=!!e.instanceParameters.occludees),s&(te.$.State.VERTEXATTRS|te.$.State.TRANSFORMATION)){const{array:i,vao:s}=n.buffer;(0,Te.bZ)(e,Ie,De),t.write({transformation:Ie,invTranspTransformation:De},e.data,t.vertexBufferLayout.createView(i.buffer),o.from),(0,re.hu)(o.from+t.elementCount(e.data)===o.to,"material VBO layout has changed"),s.vertexBuffers.geometry.setSubData(i,o.from*r*4,o.from*r*4,o.to*r*4)}n.drawCommandsDirty=!0}}_updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,(0,p.oE)(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));const e=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,0===e.instances.size)return;if(!Se(e)){const t=this._bufferWriter.vertexBufferLayout.stride,r=4*e.buffer.size/t;return void(e.drawCommandsDefault=[{first:0,count:r}])}const t=ae(e.instances);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const r of t)r.isVisible&&(r.hasOccludees?ce(e.drawCommandsOccludees,r):ce(e.drawCommandsDefault,r),r.hasHighlights?ce(e.drawCommandsHighlight,r):ce(e.drawCommandsShadowHighlightRest,r))};this._dataByOrigin.forEach((t=>{t.drawCommandsDirty&&(e(t),t.drawCommandsDirty=!1)}))}updateAnimation(e){return this._material.update(e)}requiresSlot(e,t){return null==e||this._material.requiresSlot(e,t)}render(e,t,r){if(!this.requiresSlot(e,t))return!1;const i=t===U.C.MATERIAL_HIGHLIGHT||t===U.C.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT;if(i&&!this._hasHighlights)return!1;const n=t===U.C.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,o=!(i||n);if(this._dataByOrigin.forEach((e=>{if(i&&!e.hasHighlights)return;const t=(i?e.drawCommandsHighlight:n&&Se(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,r=o&&e.drawCommandsOccludees||null;((0,f.pC)(t)||(0,f.pC)(r))&&this._renderCommandData.push(new Re(e.origin,e.buffer,t,r))})),0===this._renderCommandData.length)return!1;const s=this._rctx,a=this._glMaterials.load(s,t);if((0,f.Wi)(a))return this._renderCommandData.clear(),!1;const l=a.beginSlot(r);return s.useTechnique(l,e,!1),a.bind(r,l),this._renderCommandData.forAll((t=>{let{origin:i,buffer:n,renderCommands:o,occludeeCommands:a}=t;r.origin=i,l.bindDraw(r),l.ensureAttributeLocations(n.vao),s.bindVAO(n.vao);const c=l.primitiveType;(0,f.pC)(o)&&this._renderCommands(s,c,o),(0,f.pC)(a)&&(l.bindPipelineState(s,e,!0),this._renderCommands(s,c,a),l.bindPipelineState(s,e,!1))})),this._renderCommandData.clear(),!0}_renderCommands(e,t,r){for(let i=0;i<r.length;i++)e.drawArrays(t,r[i].first,r[i].count)}_removeAndRebuild(e,t,r,i,n){for(const c of t)e.instances.delete(c.id);const o=ae(e.instances);e.instances.clear();const s=e.buffer.size,a=e.buffer.alloc(i);let l=0;for(const c of o){const t=c.from*r,i=c.to*r;a.copy(l,t,i),c.from=l/r,l+=i-t,c.to=l/r,e.instances.set(c.id,c)}n.push(new oe(0,a.hasNewBuffer?e.buffer.array.length:s)),a.dispose(),e.buffer.erase(l,n.back().to),e.holes.clear()}_remove(e,t,r,i){for(const n of t){const t=n.id,o=e.instances.get(t),s=o.from*r,a=o.to*r;e.buffer.erase(s,a),e.holes.push(new oe(o.from,o.to)),e.instances.delete(t),i.push(new oe(s,a))}Ee(e.holes)}_add(e,t,r,i,n){if(0===t.length)return;const o=this._bufferWriter;let s=o.vertexBufferLayout.createView(e.buffer.array.buffer);const a=e.holes.length>0;let l=Number.MAX_SAFE_INTEGER,c=Number.MIN_SAFE_INTEGER;for(const d of t){const t=(0,f.pC)(d.transformation)?(0,T.m)(Ie,i,d.transformation):i;(0,T.a)(De,t);const h=(0,T.t)(De,De),u=o.elementCount(d.data),p=u*r;let m=Ce(e.holes,u);(0,f.Wi)(m)&&(m=e.buffer.size/r,e.buffer.grow(p),s=o.vertexBufferLayout.createView(e.buffer.array.buffer)),o.write({transformation:t,invTranspTransformation:h},d.data,s,m);const g=d.instanceParameters.visible,v=!!d.instanceParameters.highlights&&g,_=!!d.instanceParameters.occludees,y=new se(d.id,m,m+u,g,v,_);(0,re.hu)(null==e.instances.get(d.id)),e.instances.set(d.id,y),a?n.push(new oe(y.from*r,y.to*r)):(l=Math.min(y.from,l),c=Math.max(y.to,c))}a||n.push(new oe(l*r,c*r))}get test(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}class be{constructor(e){this.origin=e,this.toAdd=new Array,this.toRemove=new Array}}function Oe(e,t,r){const i=t.origin;if((0,f.Wi)(i))return;let n=e.get(i.id);null==n&&(n=new be(i.vec3),e.set(i.id,n)),r?n.toAdd.push(t):n.toRemove.push(t)}function Se(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function Ce(e,t){let r;if(!e.some((e=>!(e.to-e.from<t)&&(r=e,!0))))return null;const i=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),i}function Ee(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let r=!0;for(;r;)r=!1,e.forEach((i=>{const n=t.get(i.to);n&&(i.to=n.to,t.delete(n.from),e.removeUnordered(n),r=!0)}))}class Ae{constructor(e,t){this.origin=e,this.buffer=t,this.instances=new Map,this.holes=new m.Z({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1}}class Re{constructor(e,t,r,i){this.origin=e,this.buffer=t,this.renderCommands=r,this.occludeeCommands=i}}const we=new m.Z({deallocator:null}),Pe=(0,O.c)(),Ie=(0,O.c)(),De=(0,O.c)();let Me=class extends c.Z{constructor(){super(...arguments),this._pending=new He,this._changes=new $,this._materialRenderers=new Map,this._sortedMaterialRenderers=new m.Z,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return(0,p.oE)(this._materialRenderers,(e=>e.rendersOccluded))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=function(e){const t=new Map,r=e=>{let r=t.get(e);return r||(r=new X,t.set(e,r)),r};return e.removes.forAll((e=>{Y(e)&&r(e.material).removes.push(e)})),e.adds.forAll((e=>{Y(e)&&r(e.material).adds.push(e)})),e.updates.forAll((e=>{Y(e.renderGeometry)&&r(e.renderGeometry.material).updates.push(e)})),t}(this._changes);let t=!1,r=!1,i=!1;return e.forEach(((e,n)=>{let o=this._materialRenderers.get(n);if(!o&&e.adds.length>0&&(o=new xe(this.rctx,this.materialRepository,n),this._materialRenderers.set(n,o),t=!0,r=!0,i=!0),!o)return;const s=r||o.hasHighlights,a=i||o.hasWater;o.modify(e),r=r||s!==o.hasHighlights,i=i||a!==o.hasWater,o.isEmpty&&(this._materialRenderers.delete(n),o.dispose(),t=!0)})),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),r&&(this._hasHighlights=(0,p.oE)(this._materialRenderers,(e=>e.hasHighlights))),i&&(this._hasWater=(0,p.oE)(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}add(e){if(0===e.length)return;const t=this._pending.empty;for(const r of e)this._pending.adds.add(r);t&&this.notifyChange("updating")}remove(e){const t=this._pending.empty;for(const r of e)this._pending.adds.has(r)?(this._pending.removed.add(r),this._pending.adds.delete(r)):this._pending.removed.has(r)||this._pending.removes.add(r);t&&!this._pending.empty&&this.notifyChange("updating")}modify(e,t){const r=0===this._changes.updates.length;for(const i of e){const e=this._changes.updates.pushNew();e.renderGeometry=i,e.updateType=t}r&&this._changes.updates.length>0&&this.notifyChange("updating")}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll((r=>{let{materialRenderer:i}=r;return t=i.updateAnimation(e)||t})),t}render(e,t){for(let r=0;r<this._sortedMaterialRenderers.length;r++){const i=this._sortedMaterialRenderers.data[r];i.material.shouldRender(e)&&i.materialRenderer.render(t.slot,e.pass,t)}}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((t,r)=>{r.insertOrder=e++,this._sortedMaterialRenderers.push({material:r,materialRenderer:t})})),this._sortedMaterialRenderers.sort(((e,t)=>{const r=t.material.renderPriority-e.material.renderPriority;return 0!==r?r:e.material.insertOrder-t.material.insertOrder}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};(0,l._)([(0,_.Cb)()],Me.prototype,"rctx",void 0),(0,l._)([(0,_.Cb)()],Me.prototype,"materialRepository",void 0),(0,l._)([(0,_.Cb)()],Me.prototype,"updating",null),Me=(0,l._)([(0,y.j)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Me);class He{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}var Ne,Le=r(55158),Fe=r(23620),Ue=r(93822),ze=r(4760),Ve=r(33236),je=r(27811),Ge=r(41012),Be=r(82144),We=r(31132),qe=r(33559),Ze=r(7566),ke=r(27627),$e=r(65322),Je=r(36207),Xe=r(51378);!function(e){e[e.Screen=0]="Screen",e[e.World=1]="World"}(Ne||(Ne={}));class Ye extends We.A{constructor(e,t,r){super(e,t,r),this._kernelBlurRadius=1;const{R32F:i,textureFloatLinear:n}=e.rctx.capabilities.textureFloat,o=null!=i;this._kernelTextureChannels=o?1:4,this._floatInterpolationDisabled=!n;const s={target:N.No.TEXTURE_2D,pixelFormat:o?N.VI.RED:N.VI.RGBA,internalFormat:o?N.lP.R32F:N.VI.RGBA,dataType:N.Br.FLOAT,samplingMode:N.cw.NEAREST,wrapMode:N.e8.CLAMP_TO_EDGE,width:1,height:1};this._kernel=new Xe.x(e.rctx,s)}initializeProgram(e){const t=Ye.shader.get().build({isAttributeDriven:this.configuration.isAttributeDriven,mode:this.configuration.mode});return new ke.$(e.rctx,t,Ze.i)}initializePipeline(){return(0,Je.sm)({blending:(0,Je.if)(N.zi.ONE,N.zi.ONE,N.db.ADD),colorWrite:Je.BK,depthTest:null,depthWrite:null})}bindPass(e,t){const{camera:r}=t,{mode:i}=this.configuration;switch((0,Ge.II)(this.program,r.projectionMatrix),i){case $e.H.KernelDensity:this._bindKernelDensityPass(e,t);break;case $e.H.GaussianBlur:this._bindGaussianBlurPass(e,t)}}bindDraw(e){(0,Ge.id)(this.program,e)}_bindKernelDensityPass(e,t){let{searchRadius:r,resolutionForScale:i}=e,{camera:n,screenToWorldRatio:o}=t;0!==i&&(r/=o/i),this.program.setUniform1f("radius",r*n.pixelRatio/n.fullViewport[2])}_bindGaussianBlurPass(e,t){let{searchRadius:r,resolutionForScale:i}=e,{camera:n,screenToWorldRatio:o}=t;const s=Math.round(r),a=3*(0===i?s:s*i/o);0===i||this._floatInterpolationDisabled?this._kernel.setSamplingMode(N.cw.NEAREST):this._kernel.setSamplingMode(N.cw.LINEAR),this._kernelBlurRadius!==s&&this._recomputeKernel(s),this.program.setUniform1f("radius",2*a*n.pixelRatio/n.fullViewport[2]),this.program.bindTexture(this._kernel,"kernel")}_recomputeKernel(e){const t=(0,je.cR)(e),r=Math.ceil(t.length/2),i=this._kernelTextureChannels,n=new Float32Array(r*i);for(let o=0;o<r;++o){const e=t[r-1-o];for(let t=0;t<i;++t)n[o*i+t]=e}this._kernel.resize(r,1),this._kernel.setData(n),this._kernelBlurRadius=e}destroy(){this._kernel=(0,f.O3)(this._kernel),super.destroy()}}Ye.shader=new Be.J($e.a,(()=>r.e(7682).then(r.bind(r,7682))));class Ke extends qe.m{constructor(){super(...arguments),this.isAttributeDriven=!1,this.mode=$e.H.GaussianBlur}}(0,l._)([(0,qe.o)()],Ke.prototype,"isAttributeDriven",void 0),(0,l._)([(0,qe.o)()],Ke.prototype,"mode",void 0);const Qe={searchRadius:128,resolutionForScale:0,colorRampData:null,isAttributeDriven:!1,minDensity:0,maxDensity:100,fieldTotal:0,pixelRatio:1,...ee.mo};class et extends ee.F5{constructor(e){super(e,Qe),this._techniqueConfig=new Ke}requiresSlot(e,t){return e===Ue.r.DRAPED_MATERIAL&&t===U.C.MATERIAL}getTechniqueConfig(){return this._techniqueConfig.isAttributeDriven=this.parameters.isAttributeDriven,this._techniqueConfig}createGLMaterial(e){return new tt(e)}intersect(){}createBufferWriter(){return new rt(this.parameters.isAttributeDriven?nt:it)}}class tt extends Fe.Z{constructor(e){super(e)}beginSlot(e){return this.updateParameters(e)}updateParameters(e){return this.ensureTechnique(Ye,e)}bind(e,t){t.bindPass(this._material.parameters,e)}}class rt{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(ze.T.POSITION).length*ot}write(e,t,r,i){(0,Ve.ho)(t.indices.get(ze.T.POSITION),t.vertexAttributes.get(ze.T.POSITION).data,e.transformation,r.position,i,ot);const n=t.indices.get(ze.T.POSITION).length,o=r.uv0;let s=i;for(let l=0;l<n;++l)o.setValues(s++,-1,-1),o.setValues(s++,1,-1),o.setValues(s++,1,1),o.setValues(s++,1,1),o.setValues(s++,-1,1),o.setValues(s++,-1,-1);const a="featureAttribute"in r?r.featureAttribute:null;a&&(0,Ve.XW)(t.indices.get(ze.T.FEATUREATTRIBUTE),t.vertexAttributes.get(ze.T.FEATUREATTRIBUTE).data,a,i,ot)}}const it=(0,Le.U$)().vec3f(ze.T.POSITION).vec2f(ze.T.UV0),nt=it.clone().f32(ze.T.FEATUREATTRIBUTE),ot=6;var st=r(78041),at=r(23819);class lt extends We.A{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){const t=lt.shader.get().build({mode:this.configuration.mode});return new ke.$(e.rctx,t,Ze.i)}initializePipeline(e){return(0,Je.sm)({blending:st.wu,colorWrite:Je.BK,depthTest:null,depthWrite:null})}bindPass(e,t){const{densityMap:r,colorRamp:i,maxDensity:n,minDensity:o,searchRadius:s}=e;this.program.bindTexture(r,"densityMap"),this.program.bindTexture(i,"tex"),this.configuration.mode===$e.H.KernelDensity&&this.program.setUniform1f("densityMultiplier",3/(s*s*Math.PI)),this.program.setUniform1f("densityNormalizer",1/(n-o)),this.program.setUniform1f("minDensity",o)}get primitiveType(){return N.MX.TRIANGLE_STRIP}}lt.shader=new Be.J(at.H,(()=>r.e(8259).then(r.bind(r,28259))));class ct extends qe.m{constructor(){super(...arguments),this.mode=$e.H.GaussianBlur}}(0,l._)([(0,qe.o)()],ct.prototype,"mode",void 0);var dt=r(3384);let ht=class extends Me{constructor(){super(...arguments),this.type="draped-heatmap"}initialize(){super.initialize();const e={colorTarget:N.Lm.TEXTURE,depthStencilTarget:N.OU.NONE,width:0,height:0},{capabilities:t}=this.rctx,{R32F:r}=t.colorBufferFloat,{textureFloatLinear:i}=t.textureFloat,n=null!=r,o={target:N.No.TEXTURE_2D,pixelFormat:n?N.VI.RED:N.VI.RGBA,internalFormat:n?N.lP.R32F:N.VI.RGBA,dataType:N.Br.FLOAT,samplingMode:i?N.cw.LINEAR:N.cw.NEAREST,wrapMode:N.e8.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new L.X(this.rctx,e,o),this._quad=(0,k.ow)(this.rctx);const s={target:N.No.TEXTURE_2D,pixelFormat:N.VI.RGBA,dataType:N.Br.UNSIGNED_BYTE,samplingMode:N.cw.LINEAR,wrapMode:N.e8.CLAMP_TO_EDGE,width:1,height:1},a=new Xe.x(this.rctx,s,new Uint8ClampedArray(4));this._colorRamp=a,this._technique=new lt({rctx:this.rctx,viewingMode:S.JY.Local},new ct),this._heatmapParameters={colorRamp:a,densityMap:this._densityMap.colorTexture,searchRadius:1,minDensity:0,maxDensity:100,fieldTotal:0}}destroy(){this._technique=(0,f.RY)(this._technique),this._densityMap=(0,f.O3)(this._densityMap),this._quad=(0,f.O3)(this._quad),this._colorRamp=(0,f.O3)(this._colorRamp)}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}get _heatmapDensityMaterialRenderers(){return this._sortedMaterialRenderers.filter(ut)}add(e){super.add(e)}remove(e){super.remove(e)}render(e,t){const r=this._heatmapDensityMaterialRenderers,i=r.length;if(i<1)return;const n=this.rctx.getBoundFramebufferObject(),o=this.rctx.getViewport(),s=r[0].material.parameters,{pixelRatio:a}=s,l=Math.ceil(o.width*a),c=Math.ceil(o.height*a);this._densityMap.resize(l,c),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,l,c),this.rctx.clear(N.lk.COLOR_BUFFER_BIT);let d=!1;for(let f=0;f<i;f++){const i=r[f];i.material.shouldRender(e)&&(d=d||i.materialRenderer.render(t.slot,e.pass,t))}if(this.rctx.bindFramebuffer(n),this.rctx.setViewport(o.x,o.y,o.width,o.height),!d)return;const{searchRadius:h,minDensity:u,maxDensity:p,fieldTotal:m,colorRampData:g}=s,v=this._heatmapParameters;if(v.searchRadius=h,v.fieldTotal=m,v.searchRadius=h,v.minDensity=u,v.maxDensity=p,(0,f.pC)(g)&&g!==this._colorRampData){const{colorRamp:e}=v,t=e.descriptor.width,r=g.length/4;r!==t&&e.resize(r,1),e.setData(g),this._colorRampData=g}this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(v,t),this.rctx.drawArrays(this._technique.primitiveType,0,(0,dt._V)(this._quad,"geometry"))}};function ut(e){return function(e){return e instanceof et}(e.material)}ht=(0,l._)([(0,y.j)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],ht);const pt=u.Z.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository");class ft{constructor(e){this._glMaterial=e,this.refCnt=0,this._glMaterial=e}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,(0,re.hu)(this.refCnt>=0)}getRefCnt(){return this.refCnt}get glMaterial(){return this._glMaterial}}class mt{constructor(e,t,r,i){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=r,this.requestRender=i,this._id2glMaterialRef=new j.r}dispose(){this._textureRepository.dispose()}acquire(e,t){this._ownMaterial(e);let r=this._id2glMaterialRef.get(t,e.id);if((0,f.Wi)(r)){const i=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:t});r=new ft(i),this._id2glMaterialRef.set(t,e.id,r)}return r.incRefCnt(),r.glMaterial}release(e,t){const r=this._id2glMaterialRef.get(t,e.id);(0,f.pC)(r)&&(r.decRefCnt(),0===r.getRefCnt()&&((0,f.O3)(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){(0,f.pC)(e.repository)&&e.repository!==this&&pt.error("Material is already owned by a different material repository"),e.repository=this}}var gt=r(19962),vt=r(81268),_t=r(54463);class yt{constructor(e){this.rctx=e,this.camera=null,this.lastFrameCamera=new Z.Z,this.pass=U.C.MATERIAL,this.slot=Ue.r.OPAQUE_MATERIAL,this.highlightDepthTexture=null,this.renderOccludedMask=Tt,this.hasOccludees=!1,this.hasFillLights=!0}resetRenderOccludedMask(){this.renderOccludedMask=Tt}get isHighlightPass(){return this.pass===U.C.MATERIAL_HIGHLIGHT}}const Tt=ee.yD.Occlude|ee.yD.OccludeAndTransparent|ee.yD.OccludeAndTransparentStencil;var xt=r(61863);class bt extends We.A{initializeProgram(e){const t=bt.shader.get().build();return new ke.$(e.rctx,t,Ze.i)}initializePipeline(){return this.configuration.hasAlpha?(0,Je.sm)({blending:(0,Je.wK)(N.zi.SRC_ALPHA,N.zi.ONE,N.zi.ONE_MINUS_SRC_ALPHA,N.zi.ONE_MINUS_SRC_ALPHA),colorWrite:Je.BK}):(0,Je.sm)({colorWrite:Je.BK})}}bt.shader=new Be.J(xt.T,(()=>r.e(7026).then(r.bind(r,77026))));class Ot extends qe.m{constructor(){super(...arguments),this.hasAlpha=!1}}(0,l._)([(0,qe.o)()],Ot.prototype,"hasAlpha",void 0);class St{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,b.c)();this.intensity=e}}class Ct{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,b.c)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,b.f)(.57735,.57735,.57735);this.intensity=e,this.direction=t}}class Et{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,b.c)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,b.f)(.57735,.57735,.57735),r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;this.intensity=e,this.direction=t,this.castShadows=r,this.specularStrength=i,this.environmentStrength=n}}class At{constructor(){this.r=[0],this.g=[0],this.b=[0]}}var Rt=r(11186);function wt(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]*t[i];return r}function Pt(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]*t;return r}function It(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]+t[i];return r}function Dt(e){return(e+1)*(e+1)}function Mt(e,t,r){const i=e[0],n=e[1],o=e[2],s=r||[];return s.length=Dt(t),t>=0&&(s[0]=.28209479177),t>=1&&(s[1]=.4886025119*i,s[2]=.4886025119*o,s[3]=.4886025119*n),t>=2&&(s[4]=1.09254843059*i*n,s[5]=1.09254843059*n*o,s[6]=.31539156525*(3*o*o-1),s[7]=1.09254843059*i*o,s[8]=.54627421529*(i*i-n*n)),s}function Ht(e,t){const r=function(e){return(0,R.uZ)(Math.floor(Math.sqrt(e)-1),0,2)}(t.r.length);for(const i of e)(0,Rt.o)(jt,i.direction),Mt(jt,r,zt),wt(zt,Gt),Pt(zt,i.intensity[0],Vt),It(t.r,Vt),Pt(zt,i.intensity[1],Vt),It(t.g,Vt),Pt(zt,i.intensity[2],Vt),It(t.b,Vt);return t}function Nt(e,t,r,i){(function(e,t){const r=Dt(e),i=t||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=r;for(let n=0;n<r;n++)i.r[n]=i.g[n]=i.b[n]=0})(t,i),(0,Rt.s)(r.intensity,0,0,0);let n=!1;const o=Lt,s=Ft,a=Ut;o.length=0,s.length=0,a.length=0;for(const l of e)l instanceof Et&&!n?((0,Rt.g)(r.direction,l.direction),(0,Rt.g)(r.intensity,l.intensity),r.specularStrength=l.specularStrength,r.environmentStrength=l.environmentStrength,r.castShadows=l.castShadows,n=!0):l instanceof Et||l instanceof Ct?o.push(l):l instanceof St?s.push(l):l instanceof At&&a.push(l);Ht(o,i),function(e,t){Mt(jt,0,zt);for(const r of e)t.r[0]+=zt[0]*Gt[0]*r.intensity[0]*4*Math.PI,t.g[0]+=zt[0]*Gt[0]*r.intensity[1]*4*Math.PI,t.b[0]+=zt[0]*Gt[0]*r.intensity[2]*4*Math.PI}(s,i);for(const l of a)It(i.r,l.r),It(i.g,l.g),It(i.b,l.b)}const Lt=[],Ft=[],Ut=[],zt=[0],Vt=[0],jt=(0,b.c)(),Gt=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class Bt{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:(0,b.c)(),ambient:{color:(0,b.c)(),intensity:1},diffuse:{color:(0,b.c)(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new At,this._mainLight={intensity:(0,b.c)(),direction:(0,b.f)(1,0,0),castShadows:!1,specularStrength:1,environmentStrength:1}}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(e){e.setUniform3fv("lightingMainDirection",this._mainLight.direction)}setUniforms(e,t,r){const i=t?(1-this.groundLightingFactor)*(1-this.globalFactor):0;e.setUniform1f("lightingFixedFactor",i),e.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),e.setUniform1f("lightingSpecularStrength",this._mainLight.specularStrength),e.setUniform1f("lightingEnvironmentStrength",this._mainLight.environmentStrength),e.setUniform1f("ambientBoostFactor",this._ambientBoost),e.setUniform1b("hasFillLights",r);const n=this._sphericalHarmonics;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",n.r[0],n.r[1],n.r[2],n.r[3]),e.setUniform4f("lightingAmbientSH_G",n.g[0],n.g[1],n.g[2],n.g[3]),e.setUniform4f("lightingAmbientSH_B",n.b[0],n.b[1],n.b[2],n.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]),e.setUniform4f("lightingAmbientSH_R1",n.r[1],n.r[2],n.r[3],n.r[4]),e.setUniform4f("lightingAmbientSH_G1",n.g[1],n.g[2],n.g[3],n.g[4]),e.setUniform4f("lightingAmbientSH_B1",n.b[1],n.b[2],n.b[3],n.b[4]),e.setUniform4f("lightingAmbientSH_R2",n.r[5],n.r[6],n.r[7],n.r[8]),e.setUniform4f("lightingAmbientSH_G2",n.g[5],n.g[6],n.g[7],n.g[8]),e.setUniform4f("lightingAmbientSH_B2",n.b[5],n.b[6],n.b[7],n.b[8]))}set(e){Nt(e,this._shOrder,this._mainLight,this._sphericalHarmonics),(0,Rt.g)(this._oldSunlight.direction,this._mainLight.direction);const t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*t,(0,Rt.a)(this._oldSunlight.diffuse.color,this._mainLight.intensity,t),(0,Rt.g)(Wt,this._oldSunlight.diffuse.color),(0,Rt.a)(Wt,Wt,this._ambientBoost*this.globalFactor),(0,Rt.b)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,Wt)}get old(){return this._oldSunlight}}const Wt=(0,b.c)();var qt=r(46228);class Zt{constructor(e){this._rctx=e,this.cache=new Map}dispose(){this.cache.forEach((e=>e.texture=(0,f.O3)(e.texture))),this.cache.clear()}_acquire(e){if((0,f.Wi)(e))return null;const t=this._patternId(e),r=this.cache.get(t);if(r)return r.refCount++,r.bind;const i=e.pixelRatio,{encodedData:n,sdfNormalizer:o,pixels:s,paddedPixels:a}=function(e,t){const r=e.map((e=>Math.round(e*t))),i=1/t,n=Math.floor(r.reduce(((e,t)=>e+t))),o=r.reduce(((e,t)=>Math.max(e,t))),s=(Math.floor(.5*(o-1))+.5)*i,a=[];let l=1;for(const f of r){for(let e=0;e<f;e++){const t=l*(Math.min(e,f-1-e)+.5)*i/s*.5+.5;a.push(t)}l=-l}const c=Math.round(r[0]/2),d=[...a.slice(c),...a.slice(0,c)],h=n+2,u=new Uint8Array(4*h);let p=4;for(const f of d)(0,qt.I)(f,u,p),p+=4;return u.copyWithin(0,p-4,p),u.copyWithin(p,4,8),{encodedData:u,sdfNormalizer:s,paddedPixels:h,pixels:n}}(e.pattern,i),l=s/i,c={refCount:1,texture:null,bind:e=>((0,f.Wi)(c.texture)&&(c.texture=new Xe.x(this._rctx,{width:a,height:1,internalFormat:N.VI.RGBA,pixelFormat:N.VI.RGBA,dataType:N.Br.UNSIGNED_BYTE,wrapMode:N.e8.CLAMP_TO_EDGE},n)),e.bindTexture(c.texture,"stipplePatternTexture"),{pixelSize:l,sdfNormalizer:o,pixels:s})};return this.cache.set(t,c),c.bind}release(e){if((0,f.Wi)(e))return;const t=this._patternId(e),r=this.cache.get(t);r&&(r.refCount--,0===r.refCount&&((0,f.pC)(r.texture)&&r.texture.dispose(),this.cache.delete(t)))}swap(e,t){const r=this._acquire(t);return this.release(e),r}_patternId(e){return`${e.pattern.join(",")}-r${e.pixelRatio}`}}var kt,$t=r(4170);!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(kt||(kt={}));class Jt extends We.A{initializeProgram(e){const t=Jt.shader.get().build(this.configuration);return new ke.$(e.rctx,t,Ze.i)}initializePipeline(){if(this.configuration.function===$t.C.TransparentToHUDVisibility)return(0,Je.sm)({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case kt.None:return(0,Je.sm)({colorWrite:Je.BK});case kt.Alpha:return(0,Je.sm)({blending:(0,Je.wK)(N.zi.SRC_ALPHA,N.zi.ONE,N.zi.ONE_MINUS_SRC_ALPHA,N.zi.ONE_MINUS_SRC_ALPHA),colorWrite:Je.BK});default:return(0,Je.sm)({blending:(0,Je.if)(N.zi.ONE,N.zi.ONE_MINUS_SRC_ALPHA),colorWrite:Je.BK})}}}Jt.shader=new Be.J($t.a,(()=>r.e(4016).then(r.bind(r,44016))));class Xt extends qe.m{constructor(){super(...arguments),this.function=$t.C.Standard,this.alphaMode=kt.None,this.hasOpacityFactor=!1}}(0,l._)([(0,qe.o)({count:$t.C.COUNT})],Xt.prototype,"function",void 0),(0,l._)([(0,qe.o)({count:kt.COUNT})],Xt.prototype,"alphaMode",void 0),(0,l._)([(0,qe.o)()],Xt.prototype,"hasOpacityFactor",void 0);var Yt=r(99912);const Kt=u.Z.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let Qt=class extends(q(c.Z)){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new Bt,this._handles=new h.Z,this._frameTask=Yt.sq,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new m.Z,this._geometries=new Map,this.worldToPCSRatio=1,this.events=new d.Z,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new yt(this._rctx);const t=e.waterTextureRepository;this._stippleTextureRepository=new Zt(e.renderingContext),this._shaderTechniqueRepository=new B({rctx:this._rctx,viewingMode:S.JY.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._handles.add([(0,v.S1)(t,"loadingState",(()=>this.events.emit("content-changed"))),(0,v.S1)(this,"spatialReference",(e=>this._localOrigins=new gt.C1(e)))]),this._materialRepository=new mt(e.textureRepository,this._shaderTechniqueRepository,(e=>{(e.renderOccluded&ar)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")}),(()=>this.events.emit("content-changed"))),this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new St((0,b.f)(1,1,1))]),this._bindParameters={slot:Ue.r.DRAPED_MATERIAL,highlightDepthTexture:(0,k.hf)(this._rctx),camera:ir,inverseViewport:(0,x.a)(),origin:null,screenToWorldRatio:null,screenToPCSRatio:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:O.I,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:P.Am.NONE,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:!0},this._frameTask=this.view.resourceController.scheduler.registerTask(Yt.T8.STAGE,this),this._handles.add(this._frameTask)}dispose(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.destroy())),this._layerRenderers.clear(),this._debugTextureTechnique=(0,f.RY)(this._debugTextureTechnique),this._debugPatternTexture=(0,f.O3)(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=(0,f.O3)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=(0,f.O3)(this._shaderTechniqueRepository),this._temporaryFBO=(0,f.O3)(this._temporaryFBO),this._quadVAO=(0,f.O3)(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedLayerRenderersDirty||this._frameTask.updating||(0,p.oE)(this._layerRenderers,(e=>e.updating))}get hasOverlays(){return(0,f.pC)(this._overlays)&&(0,f.pC)(this._overlayRenderTarget)}get gpuMemoryUsage(){return(0,f.pC)(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(e){let t=!1;if((0,f.pC)(this._overlayRenderTarget))for(const r of this._overlayRenderTarget.renderTargets){const i=this.overlays[0].validTargets[r.type]||!this.overlays[1].validTargets[r.type];t=this._overlayRenderTarget.validateUsageForTarget(i,r,e)||t}return t}get overlays(){return(0,f.Pt)(this._overlays,[])}ensureDrapeTargets(e){(0,f.pC)(this._overlays)&&this._overlays.forEach((t=>{t.hasTargetWithoutRasterImage=(0,g.f)(e,(e=>e.drapeTargetType===C.al.WithoutRasterImage))}))}ensureDrapeSources(e){(0,f.pC)(this._overlays)&&this._overlays.forEach((t=>{t.hasDrapedFeatureSource=(0,p.oE)(e,((e,t)=>t.drapeSourceType===C.Lw.Features)),t.hasDrapedRasterSource=(0,p.oE)(e,((e,t)=>t.drapeSourceType===C.Lw.RasterImage))}))}ensureOverlays(e,t){(0,f.Wi)(this._overlays)&&(this._overlayRenderTarget=new z(this._rctx),this._overlays=[new D(i.INNER,this._overlayRenderTarget),new D(i.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=(0,f.O3)(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>!0;this._frameTask.processQueue(e),e.done||this._processLayers(e,t)}_processLayers(e,t){let r=!1;for(const[i,n]of this._layerRenderers){if(e.done)break;(i.destroyed||t(i))&&(n.commitChanges()&&(r=!0,e.madeProgress()),n.isEmpty&&(r=!0,this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(i),this._handles.remove(i),n.destroy()))}this._updateSortedLayerRenderers(),r&&((0,f.pC)(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncLayers(){this._processLayers(Yt.G5,(e=>e.updatePolicy===P.jq.SYNC))}addGeometries(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];for(const n of e)(0,f.Wi)(n.origin)&&(n.origin=this._localOrigins.getOrigin(n.boundingSphere)),this._geometries.set(n.id,n);this._ensureLayerRenderer(t,i).add(e),r===te.$.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e,t)}removeGeometries(e,t,r){for(const n of e)this._geometries.delete((0,f.Wg)(n.id));const i=this._layerRenderers.get(t);i&&(i.remove(e),r===te.$.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e,t))}updateGeometries(e,t,r){const i=this._layerRenderers.get(t);if(i)switch(i.modify(e,r),r){case te.$.State.TRANSFORMATION:case te.$.State.VERTEXATTRS:return this._notifyGraphicGeometryChanged(e,t);case te.$.State.VISIBILITIES:return this._notifyGraphicVisibilityChanged(e,t)}else Kt.warn("Attempted to update geometry for nonexistent layer")}_notifyGraphicGeometryChanged(e,t){if((0,f.Wi)(t.notifyGraphicGeometryChanged))return;let r;for(const i of e){const e=i.graphicUid;(0,f.pC)(e)&&e!==r&&(t.notifyGraphicGeometryChanged(e),r=e)}}_notifyGraphicVisibilityChanged(e,t){if((0,f.Wi)(t.notifyGraphicVisibilityChanged))return;let r;for(const i of e){const e=i.graphicUid;(0,f.pC)(e)&&e!==r&&(t.notifyGraphicVisibilityChanged(e),r=e)}}updateHighlights(e,t){const r=this._layerRenderers.get(t);r?r.modify(e,te.$.State.HIGHLIGHTS):Kt.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return 0===this._geometries.size&&!E.Z.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let t=!1;return this._layerRenderers.forEach((r=>t=r.updateAnimation(e)||t)),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(e,t,r){const n=e.canvasGeometries;if(0===n.numViews)return!1;this._screenToWorldRatio=r*e.mapUnitsPerPixel;const o=t.renderPass;if(this.isEmpty()||o===U.C.MATERIAL_HIGHLIGHT&&!this.hasHighlights||o===U.C.MATERIAL_NORMAL&&!this.hasWater||!e.hasSomeSizedView())return!1;const a=t.fbo;if(!a.isValid())return!1;const l=2*e.resolution,c=e.resolution;a.resize(l,c);const d=this._rctx;ir.pixelRatio=e.pixelRatio*r,this._renderContext.pass=o,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=o===U.C.MATERIAL_NORMAL?Ue.r.DRAPED_WATER:Ue.r.DRAPED_MATERIAL,e.applyViewport(this._rctx),a.bind(d),e.index===i.INNER&&(d.setClearColor(0,0,0,0),d.clearSafe(N.lk.COLOR_BUFFER_BIT));const h=t.type===s.ColorNoRasterImage?er.ExcludeRasterImage:t.type===s.Occluded?er.OccludedOnly:er.Normal;if(h===er.OccludedOnly&&(this._renderContext.renderOccludedMask=ar),E.Z.OVERLAY_DRAW_DEBUG_TEXTURE&&h!==er.OccludedOnly)for(let i=0;i<n.numViews;i++)this._setViewParameters(n.extents[i],e,ir),this._drawDebugTexture(e.resolution,rr[e.index]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((t=>{let{overlayLayer:r,renderer:i}=t;if(h===er.ExcludeRasterImage&&r.drapeSourceType===C.Lw.RasterImage)return;const{fullOpacity:s}=r,u=(0,f.pC)(s)&&s<1&&o===U.C.MATERIAL;u&&(this.bindTemporaryFramebuffer(this._rctx,l,c),d.clearSafe(N.lk.COLOR_BUFFER_BIT));for(let o=0;o<n.numViews;o++)this._setViewParameters(n.extents[o],e,ir),i.render(this._renderContext,this._bindParameters);u&&(0,f.pC)(this._temporaryFBO)&&(a.bind(d),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),kt.PremultipliedAlpha,s,$t.C.OverlayWithTransparency,e.index))})),d.bindFramebuffer(null),a.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,r){(0,f.Wi)(this._temporaryFBO)&&(this._temporaryFBO=new F(e,!1)),this._temporaryFBO.resize(t,r),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}intersect(e,t,r,i){let n=0;this._geometries.forEach((o=>{if(i&&!i(o))return;this._intersectRenderGeometry(o,r,t,0,e,n);const s=this.longitudeCyclical;s&&(o.boundingSphere[0]-o.boundingSphere[3]<s.min&&this._intersectRenderGeometry(o,r,t,s.range,e,n),o.boundingSphere[0]+o.boundingSphere[3]>s.max&&this._intersectRenderGeometry(o,r,t,-s.range,e,n)),n++}))}_intersectRenderGeometry(e,t,r,i,n,o){if(!e.instanceParameters.visible)return;let s=0;(0,f.pC)(e.transformation)&&(i+=e.transformation[12],s=e.transformation[13]),nr[0]=r[0]-i,nr[1]=r[1]-s,nr[2]=1,or[0]=r[0]-i,or[1]=r[1]-s,or[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),n,nr,or,((r,i,s)=>{!function(e,t,r,i,n,o,s){const a={layerUid:o,graphicUid:s,triangleNr:t},l=t=>{t.set(_t.q7.OVERLAY,a,e.dist,e.normal,e.transformation,r,i)};if((null==n.results.min.drapedLayerOrder||r>=n.results.min.drapedLayerOrder)&&(null==n.results.min.dist||n.results.ground.dist<=n.results.min.dist)&&l(n.results.min),n.options.store!==_t.eC.MIN&&(null==n.results.max.drapedLayerOrder||r<n.results.max.drapedLayerOrder)&&(null==n.results.max.dist||n.results.ground.dist>n.results.max.dist)&&l(n.results.max),n.options.store===_t.eC.ALL){const e=(0,vt.LP)(n.ray);l(e),n.results.all.push(e)}}(t,s,e.material.renderPriority,o,n,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,t)}_ensureLayerRenderer(e,t){let r=this._layerRenderers.get(e);return r&&t===r instanceof ht||(r=t?new ht({rctx:this._rctx,materialRepository:this._materialRepository}):new Me({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,r),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.events.emit("content-changed"))),e),this._handles.add((0,v.S1)(r,"updating",(()=>this.notifyChange("updating"))),e)),r}_updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=this.view.map.allLayers;this._layerRenderers.forEach(((t,r)=>{const i=e.indexOf(r.layer);this._sortedLayerRenderers.push(new tr(r,t,i<0?1/0:i))})),this._sortedLayerRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t,r){r.viewport[0]=r.viewport[1]=0,r.viewport[2]=r.viewport[3]=t.resolution,(0,T.q)(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),(0,T.f)(r.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=r,this._bindParameters.camera=r,this._bindParameters.inverseViewport[0]=1/r.fullViewport[2],this._bindParameters.inverseViewport[1]=1/r.fullViewport[3]}_updateHasWater(){const e=(0,p.oE)(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=(0,p.oE)(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=(0,p.oE)(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,t){this._ensureDebugPatternResources(e,e);const r=this._rctx,i=r.useTechnique(this._debugTextureTechnique);i.setUniform4f("uColor",t[0],t[1],t[2],1),i.bindTexture(this._debugPatternTexture,"tex"),r.bindVAO(this._quadVAO),r.drawArrays(N.MX.TRIANGLE_STRIP,0,(0,dt._V)(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const r=new Uint8Array(e*t*4);let i=0;for(let o=0;o<t;o++)for(let n=0;n<e;n++){const s=Math.floor(n/10),a=Math.floor(o/10);s<2||a<2||10*s>e-20||10*a>t-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&s&&1&a?1&n^1&o?0:255:1&s^1&a?0:128)}this._debugPatternTexture=new Xe.x(this._rctx,{target:N.No.TEXTURE_2D,pixelFormat:N.VI.RGBA,dataType:N.Br.UNSIGNED_BYTE,samplingMode:N.cw.NEAREST,width:e,height:t},r);const n=new Ot;n.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(bt,n),this._quadVAO=(0,k.ow)(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};var er;(0,l._)([(0,_.Cb)()],Qt.prototype,"_frameTask",void 0),(0,l._)([(0,_.Cb)()],Qt.prototype,"_sortedLayerRenderersDirty",void 0),(0,l._)([(e,t)=>{var r,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!=(r=null==(i=e._managedDisposables)?void 0:i.slice())?r:[]),e._managedDisposables.unshift(t)}],Qt.prototype,"_shaderTechniqueRepository",void 0),(0,l._)([(e,t)=>{var r,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!=(r=null==(i=e._managedDisposables)?void 0:i.slice())?r:[]),e._managedDisposables.unshift(t)}],Qt.prototype,"_stippleTextureRepository",void 0),(0,l._)([(0,_.Cb)({constructOnly:!0})],Qt.prototype,"view",void 0),(0,l._)([(0,_.Cb)()],Qt.prototype,"worldToPCSRatio",void 0),(0,l._)([(0,_.Cb)()],Qt.prototype,"spatialReference",void 0),(0,l._)([(0,_.Cb)({type:Boolean,readOnly:!0})],Qt.prototype,"updating",null),Qt=(0,l._)([(0,y.j)("esri.views.3d.terrain.OverlayRenderer")],Qt),function(e){e[e.Normal=0]="Normal",e[e.OccludedOnly=1]="OccludedOnly",e[e.ExcludeRasterImage=2]="ExcludeRasterImage"}(er||(er={}));class tr{constructor(e,t,r){this.overlayLayer=e,this.renderer=t,this.index=r}}const rr=[[1,.5,.5],[.5,.5,1]];const ir=new Z.Z;ir.near=1,ir.far=1e4,ir.relativeElevation=null;const nr=(0,b.c)(),or=(0,b.c)(),sr=-2,ar=ee.yD.OccludeAndTransparent},74321:(e,t,r)=>{r.d(t,{k:()=>o});var i=r(98634),n=r(4760);function o(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e.attributes.add(n.T.POSITION,"vec2"),t&&e.varyings.add("uv","vec2"),e.vertex.code.add(i.H`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      ${t?i.H`uv = position * 0.5 + vec2(0.5);`:""}
    }
  `)}},48353:(e,t,r)=>{r.d(t,{U:()=>o});var i=r(98634),n=r(4760);function o(e,t){e.vertex.uniforms.add("intrinsicWidth","float"),t.vvSize?(e.attributes.add(n.T.SIZEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(i.H`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add(n.T.SIZE,"float"),e.vertex.code.add(i.H`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add(n.T.OPACITYFEATUREATTRIBUTE,"float"),e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(i.H`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):e.vertex.code.add(i.H`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.attributes.add(n.T.COLORFEATUREATTRIBUTE,"float"),e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(i.H`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(e.attributes.add(n.T.COLOR,"vec4"),e.vertex.code.add(i.H`vec4 getColor(){
return applyOpacity(color);
}`))}},28156:(e,t,r)=>{r.d(t,{H:()=>n});var i=r(98634);function n(e){const t=i.H`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,r=i.H`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;e.vertex.code.add(t),e.vertex.code.add(r),e.fragment.code.add(t),e.fragment.code.add(r)}},50600:(e,t,r)=>{var i;r.d(t,{RL:()=>l,d9:()=>n,HG:()=>c}),function(e){e[e.OCCLUDED=0]="OCCLUDED",e[e.NOTOCCLUDED=1]="NOTOCCLUDED",e[e.BOTH=2]="BOTH",e[e.COUNT=3]="COUNT"}(i||(i={}));var n,o=r(62993),s=r(98634),a=r(4760);function l(e,t){const r=e;r.include(o.c),r.attributes.add(a.T.POSITION,"vec3"),r.attributes.add(a.T.NORMAL,"vec3"),r.attributes.add(a.T.AUXPOS1,"vec4"),r.vertex.uniforms.add("proj","mat4"),r.vertex.uniforms.add("view","mat4"),r.vertex.uniforms.add("viewNormal","mat4"),r.vertex.uniforms.add("viewport","vec4"),r.vertex.uniforms.add("cameraPosition","vec3"),r.vertex.uniforms.add("polygonOffset","float"),r.vertex.uniforms.add("cameraGroundRelative","float"),r.vertex.uniforms.add("pixelRatio","float"),r.vertex.uniforms.add("perDistancePixelRatio","float"),r.vertex.uniforms.add("renderTransparentlyOccludedHUD","float"),t.verticalOffsetEnabled&&r.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&r.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4"),r.vertex.uniforms.add("hudVisibilityTexture","sampler2D"),r.vertex.constants.add("smallOffsetAngle","float",.984807753012208),r.vertex.code.add(s.H`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),r.vertex.code.add(s.H`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),t.isDraped||r.vertex.code.add(s.H`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`),r.vertex.code.add(s.H`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.screenSizePerspectiveEnabled&&(t.verticalOffsetEnabled||t.screenCenterOffsetUnitsEnabled===n.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.verticalOffsetEnabled?t.screenSizePerspectiveEnabled?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.verticalOffsetEnabled?s.H`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${t.screenCenterOffsetUnitsEnabled!==n.Screen?s.H`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${t.screenCenterOffsetUnitsEnabled===n.Screen?t.screenSizePerspectiveEnabled?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${t.screenCenterOffsetUnitsEnabled===n.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),r.vertex.code.add(s.H`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}function c(e,t){e.setUniform1f("renderTransparentlyOccludedHUD",t.renderTransparentlyOccludedHUD===i.OCCLUDED?1:t.renderTransparentlyOccludedHUD===i.NOTOCCLUDED?0:.75)}!function(e){e[e.World=0]="World",e[e.Screen=1]="Screen",e[e.COUNT=2]="COUNT"}(n||(n={}))},50913:(e,t,r)=>{r.d(t,{R:()=>a});var i=r(21002),n=r(43565),o=r(78980),s=r(98634);function a(e,t){t.multipassGeometryEnabled&&e.vertex.include(n.S),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(s.H`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.multipassGeometryEnabled?s.H`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${t.multipassTerrainEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),t.multipassTerrainEnabled&&e.fragment.include(i.S),e.fragment.uniforms.add("terrainDepthTexture","sampler2D"),e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("inverseViewport","vec2"),e.fragment.include(o.n),e.fragment.code.add(s.H`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${t.multipassTerrainEnabled?s.H`

          vec2 uv = gl_FragCoord.xy * inverseViewport;

          //Read the rgba data from the texture linear depth
          vec4 terrainDepthData = texture2D(terrainDepthTexture, uv);

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);

          //If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          //Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}},7683:(e,t,r)=>{r.d(t,{E:()=>o,K:()=>n});var i=r(98634);function n(e){e.fragment.code.add(i.H`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function o(e){e.fragment.code.add(i.H`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}},29202:(e,t,r)=>{r.d(t,{D:()=>n});var i=r(98634);function n(e){e.fragment.code.add(i.H`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}},37248:(e,t,r)=>{r.d(t,{q:()=>o});var i=r(78980),n=r(98634);function o(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?function(e,t){const r=!(t.draped&&t.stipplePreferContinuous);e.fragment.include(i.n),e.vertex.uniforms.add("stipplePatternPixelSize","float"),e.vertex.uniforms.add("pixelRatio","float"),t.draped?e.vertex.uniforms.add("worldToScreenRatio","float"):(e.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),e.vertex.uniforms.add("cameraPosition","vec3"),e.vertex.code.add(n.H`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),t.stippleRequiresClamp&&e.varyings.add("vStippleDistanceLimits","vec2"),t.stippleRequiresStretchMeasure&&e.varyings.add("vStipplePatternStretch","float"),e.vertex.code.add(n.H`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${s};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),e.vertex.code.add(n.H`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),e.vertex.code.add(n.H`
    if (segmentLengthPseudoScreen >= ${r?"patternLength":"1e4"}) {
  `),e.vertex.code.add(n.H`
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${t.stippleRequiresStretchMeasure?n.H`
              float stretch = repetitions / flooredRepetitions;

              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
              vStipplePatternStretch = max(0.75, stretch);`:""}

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),e.fragment.uniforms.add("stipplePatternTexture","sampler2D"),e.fragment.uniforms.add("stipplePatternSDFNormalizer","float"),e.fragment.uniforms.add("stipplePatternTextureSize","float"),e.fragment.uniforms.add("stipplePatternPixelSizeInv","float"),t.stippleOffColorEnabled&&e.fragment.uniforms.add("stippleOffColor","vec4"),e.fragment.code.add(n.H`float padTexture(float u) {
return (u * stipplePatternTextureSize + 1.0)/(stipplePatternTextureSize + 2.0);
}`),e.fragment.code.add(n.H`
    float getStippleSDF(out bool isClamped) {
      ${t.stippleRequiresClamp?n.H`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:n.H`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${t.stippleScaleWithLineWidth?n.H`u *= vLineSizeInv;`:""}
      u = padTexture(fract(u));

      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));
      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;

      ${t.stippleRequiresStretchMeasure?n.H`return (sdf - 0.5) * vStipplePatternStretch + 0.5;`:n.H`return sdf;`}
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${t.stippleScaleWithLineWidth?n.H`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:n.H`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),t.stippleOffColorEnabled?e.fragment.code.add(n.H`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`):e.fragment.code.add(n.H`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}(e,t):function(e){e.fragment.code.add(n.H`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}(e)}const s=n.H.float(.4)},43565:(e,t,r)=>{r.d(t,{S:()=>o,l:()=>s});var i=r(21002),n=r(98634);function o(e){e.include(i.S),e.uniforms.add("geometryDepthTexture","sampler2D"),e.uniforms.add("nearFar","vec2"),e.code.add(n.H`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}function s(e,t){t.multipassGeometryEnabled&&t.geometryLinearDepthTexture&&e.bindTexture(t.geometryLinearDepthTexture,"geometryDepthTexture")}},8555:(e,t,r)=>{r.d(t,{n:()=>o});var i=r(50951),n=r(98634);function o(e,t){t.viewingMode===i.JY.Global?e.vertex.code.add(n.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(n.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.viewingMode===i.JY.Global?e.vertex.code.add(n.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(n.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}},70755:(e,t,r)=>{r.d(t,{P:()=>s,O:()=>a});var i=r(21002),n=r(98634);function o(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMatrix","mat4"),e.fragment.uniforms.add("proj","mat4"),e.fragment.code.add(n.H`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`)}function s(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("view","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(i.S),e.include(o),e.fragment.code.add(n.H`
  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function a(e,t){t.ssrEnabled&&(e.bindTexture(t.linearDepthTexture,"depthMapView"),e.setUniform2fv("nearFar",t.camera.nearFar),e.setUniformMatrix4fv("view",t.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/t.camera.height),function(e,t){e.bindTexture(t.lastFrameColorTexture,"lastFrameColorMap"),e.setUniformMatrix4fv("reprojectionMatrix",t.reprojectionMatrix),e.setUniformMatrix4fv("proj",t.camera.projectionMatrix)}(e,t))}},68618:(e,t,r)=>{r.d(t,{B:()=>c});var i=r(7683),n=r(29202),o=r(2116),s=r(70755),a=r(8973),l=r(98634);function c(e,t){e.include(o.T,t),e.include(n.D),e.include(i.E),t.cloudsReflectionsEnabled&&e.include(a.j),t.ssrEnabled&&e.include(s.P,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),e.fragment.code.add(l.H`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),e.fragment.code.add(l.H`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.cloudsReflectionsEnabled&&e.fragment.code.add(l.H`vec4 cloudsColor = crossFade == 0 ? renderCloud(reflectedWorld, position) : renderCloudCrossFade(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y*cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * (1.0 - totalFadeInOut);`),t.ssrEnabled?e.fragment.code.add(l.H`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view *vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod*0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor + reflSea * seaColorMod + specular  + foam);`):e.fragment.code.add(l.H`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.cloudsReflectionsEnabled?t.ssrEnabled?e.fragment.code.add(l.H`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):e.fragment.code.add(l.H`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):e.fragment.code.add(l.H`return waterRenderedColor;
}`)}},79246:(e,t,r)=>{r.d(t,{M:()=>o,b:()=>s});var i=r(7683),n=r(98634);function o(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(i.K),e.fragment.code.add(n.H`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}function s(e,t){e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}},8973:(e,t,r)=>{r.d(t,{j:()=>n});var i=r(98634);function n(e){e.fragment.uniforms.add("anchorPosition","vec3").add("anchorPositionCrossFade","vec3").add("fadeInOutFactor","float").add("cloudsHeight","float").add("rotationMatrixClouds","mat4").add("rotationMatrixCloudsCrossFade","mat4").add("radiusCurvatureCorrectionFactor","float").add("radius","float").add("cameraPosition","vec3").add("totalFadeInOut","float").add("crossFade","int").add("crossFadeAnchorFactor","float").add("cloudVariables","vec2").add("cubeMap","samplerCube"),e.fragment.code.add(i.H`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos, float radiusReduction)
{
vec3 dirAnchor = normalize(spherePos);
vec3 sphereOriginOffset = dirAnchor * radiusReduction;
float radiusClouds = radius + cloudsHeight - radiusReduction;
float B = 2.0 * dot(cameraPosition - sphereOriginOffset, dir);
float C = dot(cameraPosition - sphereOriginOffset, cameraPosition - sphereOriginOffset) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),e.fragment.code.add(i.H`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),e.fragment.code.add(i.H`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),e.fragment.code.add(i.H`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(lightingMainDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(lightingMainDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((lightingMainIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * pow(dirDotLight, RIM_SCATTERING_FACTOR) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),e.fragment.code.add(i.H`vec4 getCloudData(vec3 rayDir)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
return mix(vec4(vec3(clamp(1.0 - cloudVariables.y, 0.6, 1.0)), 0.0), cloudData, smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(mu)));
}`),e.fragment.code.add(i.H`vec4 renderCloud(vec3 worldRay, vec3 position)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(normalize(-worldRay), cloudData), totalTransmittance);
}`),e.fragment.code.add(i.H`vec4 renderCloudCrossFade(vec3 worldRay, vec3 position)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColor = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPositionCrossFade, 0.0);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`)}},30425:(e,t,r)=>{r.d(t,{Z:()=>x});var i=r(32718),n=r(16889),o=r(92026),s=r(17842),a=r(14226),l=r(81949),c=r(88396),d=r(6394),h=r(11186),u=r(71353),p=r(90045),f=r(67077),m=r(95773),g=r(40885),v=r(40927),_=r(50951),y=r(97731);const T=i.Z.getLogger("esri.views.3d.webgl-engine.lib.Camera");class x{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._viewUp=(0,u.c)(),this._viewForward=(0,u.c)(),this._viewRight=(0,u.c)(),this._ray=(0,g.Ue)(),this._viewport=(0,f.f)(0,0,1,1),this._padding=(0,f.f)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,d.f)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,l.c)(),this._projectionDirty=!0,this._projectionMatrix=(0,l.c)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,l.c)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,l.c)(),this._frustumDirty=!0,this._frustum=(0,m.Ue)(),this._fullViewport=(0,f.c)(),this.pixelRatio=1,this.relativeElevation=0,(0,o.pC)(e)&&(0,h.g)(this._ray.origin,e),this._center=(0,o.pC)(t)?(0,u.a)(t):(0,u.c)(),this._up=(0,o.pC)(r)?(0,u.a)(r):(0,u.f)(0,0,1)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center)}get ray(){return(0,h.f)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){(0,a.c)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get x(){return this._viewport[0]}set x(e){e+=this._padding[A.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(e){e+=this._padding[A.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[A.RIGHT]+this._padding[A.LEFT]}set fullWidth(e){this.width=e-(this._padding[A.RIGHT]+this._padding[A.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[A.TOP]+this._padding[A.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[A.TOP]+this._padding[A.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[A.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[A.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){this._padding[A.TOP]===e[A.TOP]&&this._padding[A.RIGHT]===e[A.RIGHT]&&this._padding[A.BOTTOM]===e[A.BOTTOM]&&this._padding[A.LEFT]===e[A.LEFT]||(this._viewport[0]+=e[A.LEFT]-this._padding[A.LEFT],this._viewport[1]+=e[A.BOTTOM]-this._padding[A.BOTTOM],this._viewport[2]-=e[A.RIGHT]+e[A.LEFT]-(this._padding[A.RIGHT]+this._padding[A.LEFT]),this._viewport[3]-=e[A.TOP]+e[A.BOTTOM]-(this._padding[A.TOP]+this._padding[A.BOTTOM]),(0,p.c)(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,a.m)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const e=this.width,t=this.height,r=this.near*Math.tan(this.fovY/2),i=r*this.aspect;(0,a.l)(this._projectionMatrix,-i*(1+2*this._padding[A.LEFT]/e),i*(1+2*this._padding[A.RIGHT]/e),-r*(1+2*this._padding[A.BOTTOM]/t),r*(1+2*this._padding[A.TOP]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(e){(0,a.c)(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return(0,y.tM)(this._fov,this.width,this.height)}set fovX(e){this._fov=(0,y.Kj)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return(0,y.RQ)(this._fov,this.width,this.height)}set fovY(e){this._fov=(0,y.zF)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,h.i)(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,a.a)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,a.t)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){(0,h.g)(this._ray.origin,e.eye),(0,h.g)(this._center,e.center),(0,h.g)(this._up,e.up),(0,p.c)(this._viewport,e.viewport),(0,p.c)(this._padding,e.padding),(0,c.c)(this._nearFar,e.nearFar),this._fov=e.fov,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,a.c)(this._viewMatrix,e.viewMatrix),(0,h.g)(this._viewRight,e.viewRight),(0,h.g)(this._viewUp,e.viewUp),(0,h.g)(this._viewForward,e.viewForward)),t._projectionDirty?this._projectionDirty=!0:((0,a.c)(this._projectionMatrix,e.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||((0,m.JG)(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,a.c)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,p.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new x).copyFrom(this)}equals(e){return(0,h.k)(this.eye,e.eye)&&(0,h.k)(this._center,e.center)&&(0,h.k)(this._up,e.up)&&(0,p.g)(this._viewport,e.viewport)&&(0,p.g)(this._padding,e.padding)&&(0,c.e)(this._nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}almostEquals(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;const t=5e-4;(0,h.v)(S,e.eye,e.center),(0,h.v)(C,this.eye,this._center);const r=(0,h.d)(S,C),i=(0,h.w)(S),n=(0,h.w)(C);return r*r>=(1-1e-10)*i*n&&(0,h.x)(e.eye,this.eye)<Math.max(i,n)*t*t&&(0,p.i)(e.padding,this._padding)<.5&&(0,p.i)(e.viewport,this._viewport)<.5}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs((0,v.SR)(this.viewForward,(0,h.f)(S,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,s.s1)();return e[0]=(this.padding[A.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[A.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return e[0]=this.padding[A.LEFT]+this.width*t,e[1]=this.padding[A.BOTTOM]+this.height*r,e[2]=.5,e}setGLViewport(e){const t=this.viewport,r=this.padding;e.setViewport(t[0]-r[3],t[1]-r[2],t[2]+r[1]+r[3],t[3]+r[0]+r[2])}applyProjection(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e!==b&&(0,h.g)(b,e),b[3]=1,r&&(t[2]=-b[2]),(0,p.t)(b,b,this.projectionMatrix),(0,h.a)(b,b,1/Math.abs(b[3]));const i=this.fullViewport;return t[0]=(0,n.t7)(0,i[0]+i[2],.5+.5*b[0]),t[1]=(0,n.t7)(0,i[1]+i[3],.5+.5*b[1]),r||(t[2]=.5*(b[2]+1)),t}projectToScreen(e,t){this.projectToRenderScreen(e,E),this.renderToScreen(E,t)}projectToRenderScreen(e,t){if(b[0]=e[0],b[1]=e[1],b[2]=e[2],b[3]=1,(0,p.t)(b,b,this.viewProjectionMatrix),0===b[3])return null;(0,h.a)(b,b,1/Math.abs(b[3]));const r=this.fullViewport;return"x"in t?(t.x=(0,n.t7)(0,r[0]+r[2],.5+.5*b[0]),t.y=(0,n.t7)(0,r[1]+r[3],.5+.5*b[1])):(t[0]=(0,n.t7)(0,r[0]+r[2],.5+.5*b[0]),t[1]=(0,n.t7)(0,r[1]+r[3],.5+.5*b[1]),t.length>2&&(t[2]=.5*(b[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,E),t)}unprojectFromRenderScreen(e,t){if((0,a.m)(O,this.projectionMatrix,this.viewMatrix),!(0,a.a)(O,O))return null;const r=this.fullViewport;return b[0]=2*(e[0]-r[0])/r[2]-1,b[1]=2*(e[1]-r[1])/r[3]-1,b[2]=2*e[2]-1,b[3]=1,(0,p.t)(b,b,O),0===b[3]?null:(t[0]=b[0]/b[3],t[1]=b[1]/b[3],t[2]=b[2]/b[3],t)}constrainWindowSize(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r;const n=e*this.pixelRatio,o=t*this.pixelRatio,s=Math.max(n-r/2,0),a=Math.max(this.fullHeight-o-i/2,0),l=-Math.min(n-r/2,0),c=-Math.min(this.fullHeight-o-i/2,0);return[s,a,r-l- -Math.min(this.fullWidth-n-r/2,0),i-c- -Math.min(o-i/2,0)]}computeUp(e){e===_.JY.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const r=e[0]*this.pixelRatio,i=this.fullHeight-e[1]*this.pixelRatio;return t[0]=r,t[1]=i,t}renderToScreen(e,t){const r=e[0]/this.pixelRatio,i=(this.fullHeight-e[1])/this.pixelRatio;t[0]=r,t[1]=i}_computeUpGlobal(){(0,h.f)(S,this.center,this.eye);const e=(0,h.l)(this.center);e<1?((0,h.s)(this._up,0,0,1),this._markViewDirty()):Math.abs((0,h.d)(S,this.center))>.9999*(0,h.l)(S)*e||((0,h.c)(this._up,S,this.center),(0,h.c)(this._up,this._up,S),(0,h.n)(this._up,this._up),this._markViewDirty())}_computeUpLocal(){(0,h.r)(S,this.eye,this.center),Math.abs(S[2])<=.9999&&((0,h.a)(S,S,S[2]),(0,h.s)(this._up,-S[0],-S[1],1-S[2]),(0,h.n)(this._up,this._up),this._markViewDirty())}_compareAndSetView(e,t){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,h.k)(e,t)||((0,h.g)(t,e),this._markViewDirty()):T.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&((0,m.q_)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,a.n)(this._viewMatrix,this.eye,this._center,this._up),(0,h.s)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),(0,h.s)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),(0,h.s)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const b=(0,f.c)(),O=(0,l.c)(),S=(0,u.c)(),C=(0,u.c)(),E=(0,s.J$)();var A;!function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(A||(A={}))},94425:(e,t,r)=>{r.d(t,{S:()=>l,p:()=>a});var i=r(92026),n=r(71011),o=r(68401),s=r(68198);class a{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}destroy(){this._map.forEach(((e,t)=>{(0,i.pC)(e)&&this._repository.release(this._material,l(t))}))}load(e,t){this._map.has(t)||this._map.set(t,this._repository.acquire(this._material,l(t)));const r=this._map.get(t);if((0,i.pC)(r)){if(r.ensureResources(e)===o.Rw.LOADED)return r;this._repository.requestRender()}return null}}function l(e){switch(e){default:case s.C.MATERIAL:return n.H.Color;case s.C.MATERIAL_ALPHA:return n.H.Alpha;case s.C.MATERIAL_DEPTH_SHADOWMAP_ALL:return n.H.Shadow;case s.C.MATERIAL_NORMAL:return n.H.Normal;case s.C.MATERIAL_DEPTH:return n.H.Depth;case s.C.MATERIAL_HIGHLIGHT:return n.H.Highlight;case s.C.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:case s.C.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return n.H.Shadow}}},70619:(e,t,r)=>{r.d(t,{Z:()=>x});var i,n=r(11186),o=r(8229),s=r(71353),a=r(55652),l=r(40885),c=r(68401);!function(e){e.length=function(e,t){const r=e[t],i=e[t+1],n=e[t+2];return Math.sqrt(r*r+i*i+n*n)},e.normalize=function(e,t){const r=e[t],i=e[t+1],n=e[t+2],o=1/Math.sqrt(r*r+i*i+n*n);e[t]*=o,e[t+1]*=o,e[t+2]*=o},e.scale=function(e,t,r){e[t]*=r,e[t+1]*=r,e[t+2]*=r},e.add=function(e,t,r,i,n){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t;(n=n||e)[o]=e[t]+r[i],n[o+1]=e[t+1]+r[i+1],n[o+2]=e[t+2]+r[i+2]},e.subtract=function(e,t,r,i,n){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t;(n=n||e)[o]=e[t]-r[i],n[o+1]=e[t+1]-r[i+1],n[o+2]=e[t+2]-r[i+2]}}(i||(i={}));var d=r(74894),h=r(81935),u=r(97731),p=r(4760);const f=i;var m,g,v,_;!function(e){const t=.5,r=[[-t,-t,t],[t,-t,t],[t,t,t],[-t,t,t],[-t,-t,-t],[t,-t,-t],[t,t,-t],[-t,t,-t]],i=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],n=[0,0,1,0,1,1,0,1],o=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),s=new Uint16Array(36);for(let l=0;l<6;l++)for(let e=0;e<6;e++)s[6*l+e]=l;const a=new Uint16Array(36);for(let l=0;l<6;l++)a[6*l+0]=0,a[6*l+1]=1,a[6*l+2]=2,a[6*l+3]=2,a[6*l+4]=3,a[6*l+5]=0;e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(24);for(let i=0;i<8;i++)t[3*i]=r[i][0]*e[0],t[3*i+1]=r[i][1]*e[1],t[3*i+2]=r[i][2]*e[2];return new d.Z([[p.T.POSITION,{size:3,data:t,exclusive:!0}],[p.T.NORMAL,{size:3,data:i}],[p.T.UV0,{size:2,data:n}]],[[p.T.POSITION,o],[p.T.NORMAL,s],[p.T.UV0,a]])}}(m||(m={})),function(e){const t=.5,r=[[-t,0,-t],[t,0,-t],[t,0,t],[-t,0,t],[0,-t,0],[0,t,0]],i=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],n=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),o=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(18);for(let i=0;i<6;i++)t[3*i]=r[i][0]*e[0],t[3*i+1]=r[i][1]*e[1],t[3*i+2]=r[i][2]*e[2];return new d.Z([[p.T.POSITION,{size:3,data:t,exclusive:!0}],[p.T.NORMAL,{size:3,data:i}]],[[p.T.POSITION,n],[p.T.NORMAL,o]])}}(g||(g={})),function(e){const t=.5,r=(0,o.f)(-t,0,-t),i=(0,o.f)(t,0,-t),s=(0,o.f)(0,0,t),a=(0,o.f)(0,.5,0),l=(0,o.c)(),c=(0,o.c)(),h=(0,o.c)(),u=(0,o.c)(),f=(0,o.c)();(0,n.f)(l,r,a),(0,n.f)(c,r,i),(0,n.c)(h,l,c),(0,n.n)(h,h),(0,n.f)(l,i,a),(0,n.f)(c,i,s),(0,n.c)(u,l,c),(0,n.n)(u,u),(0,n.f)(l,s,a),(0,n.f)(c,s,r),(0,n.c)(f,l,c),(0,n.n)(f,f);const m=[r,i,s,a],g=[0,-1,0,h[0],h[1],h[2],u[0],u[1],u[2],f[0],f[1],f[2]],v=[0,1,2,3,1,0,3,2,1,3,0,2],_=[0,0,0,1,1,1,2,2,2,3,3,3];e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(12);for(let r=0;r<4;r++)t[3*r]=m[r][0]*e[0],t[3*r+1]=m[r][1]*e[1],t[3*r+2]=m[r][2]*e[2];return new d.Z([[p.T.POSITION,{size:3,data:t,exclusive:!0}],[p.T.NORMAL,{size:3,data:g}]],[[p.T.POSITION,new Uint16Array(v)],[p.T.NORMAL,new Uint16Array(_)]])}}(v||(v={})),function(e){e.createBoxGeometry=m.createGeometry,e.createDiamondGeometry=g.createGeometry,e.createTetrahedronGeometry=v.createGeometry,e.createSphereGeometry=function(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{uv:!0};const n=-Math.PI,o=2*Math.PI,s=-Math.PI/2,a=Math.PI,l=Math.max(3,Math.floor(t)),c=Math.max(2,Math.floor(r)),h=(l+1)*(c+1),u=new Float32Array(3*h),f=new Float32Array(3*h),m=new Float32Array(2*h),g=[];let v=0;for(let d=0;d<=c;d++){const t=[],r=d/c,i=s+r*a,h=Math.cos(i);for(let s=0;s<=l;s++){const a=s/l,c=n+a*o,d=Math.cos(c)*h,p=Math.sin(i),g=-Math.sin(c)*h;u[3*v]=d*e,u[3*v+1]=p*e,u[3*v+2]=g*e,f[3*v]=d,f[3*v+1]=p,f[3*v+2]=g,m[2*v]=a,m[2*v+1]=r,t.push(v),++v}g.push(t)}const _=new Uint32Array(2*l*(c-1)*3);v=0;for(let d=0;d<c;d++)for(let e=0;e<l;e++){const t=g[d][e],r=g[d][e+1],i=g[d+1][e+1],n=g[d+1][e];0===d?(_[v++]=t,_[v++]=i,_[v++]=n):d===c-1?(_[v++]=t,_[v++]=r,_[v++]=i):(_[v++]=t,_[v++]=r,_[v++]=i,_[v++]=i,_[v++]=n,_[v++]=t)}const y=[[p.T.POSITION,_],[p.T.NORMAL,_]],T=[[p.T.POSITION,{size:3,data:u,exclusive:!0}],[p.T.NORMAL,{size:3,data:f,exclusive:!0}]];return i.uv&&(T.push([p.T.UV0,{size:2,data:m,exclusive:!0}]),y.push([p.T.UV0,_])),i.offset&&(y[0][0]=p.T.OFFSET,T[0][0]=p.T.OFFSET,y.push([p.T.POSITION,new Uint32Array(_.length)]),T.push([p.T.POSITION,{size:3,data:Float64Array.from(i.offset),exclusive:!0}])),new d.Z(T,y)},e.createPolySphereGeometry=function(e,t,r){const i=e;let n,o;if(r)n=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],o=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else{const e=i*(1+Math.sqrt(5))/2;n=[-i,e,0,i,e,0,-i,-e,0,i,-e,0,0,-i,e,0,i,e,0,-i,-e,0,i,-e,e,0,-i,e,0,i,-e,0,-i,-e,0,i],o=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1])}for(let d=0;d<n.length;d+=3)f.scale(n,d,e/f.length(n,d));let s={};function a(t,r){t>r&&([t,r]=[r,t]);const i=t.toString()+"."+r.toString();if(s[i])return s[i];let o=n.length;return n.length+=3,f.add(n,3*t,n,3*r,n,o),f.scale(n,o,e/f.length(n,o)),o/=3,s[i]=o,o}for(let d=0;d<t;d++){const e=o.length,t=new Uint32Array(4*e);for(let r=0;r<e;r+=3){const e=o[r],i=o[r+1],n=o[r+2],s=a(e,i),l=a(i,n),c=a(n,e),d=4*r;t[d]=e,t[d+1]=s,t[d+2]=c,t[d+3]=i,t[d+4]=l,t[d+5]=s,t[d+6]=n,t[d+7]=c,t[d+8]=l,t[d+9]=s,t[d+10]=l,t[d+11]=c}o=t,s={}}const l=new Float32Array(n);for(let d=0;d<l.length;d+=3)f.normalize(l,d);const c=[[p.T.POSITION,o],[p.T.NORMAL,o]],h=[[p.T.POSITION,{size:3,data:new Float32Array(n),exclusive:!0}],[p.T.NORMAL,{size:3,data:l,exclusive:!0}]];return new d.Z(h,c)},e.createPointGeometry=function(e,t,r,i,n,o,s){const a=t?[t[0],t[1],t[2]]:[0,0,0],l=e?[e[0],e[1],e[2]]:[0,0,1];o=o||[0,0];const h=r?[255*r[0],255*r[1],255*r[2],r.length>3?255*r[3]:255]:[255,255,255,255],u=null!=i&&2===i.length?i:[1,1],f=[[p.T.POSITION,{size:3,data:a,exclusive:!0}],[p.T.NORMAL,{size:3,data:l,exclusive:!0}],[p.T.UV0,{size:o.length,data:o}],[p.T.COLOR,{size:4,data:h,exclusive:!0}],[p.T.SIZE,{size:2,data:u}]];if(null!=n){const e=new Float32Array([n[0],n[1],n[2],n[3]]);f.push([p.T.AUXPOS1,{size:4,data:e}])}if(null!=s){const e=new Float32Array([s[0],s[1],s[2],s[3]]);f.push([p.T.AUXPOS2,{size:4,data:e}])}return new d.Z(f,null,c.MX.Point)},e.updatePointGeometry=function(e,t,r,i,n,o,s,a){if(null!=e){const{data:t}=a.getMutableAttribute(p.T.NORMAL);t[0]=e[0],t[1]=e[1],t[2]=e[2]}if(null!=t){const{data:e}=a.getMutableAttribute(p.T.POSITION);e[0]=t[0],e[1]=t[1],e[2]=t[2]}if(null!=r){const{data:e}=a.getMutableAttribute(p.T.COLOR);e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3]}if(null!=i){const{data:e}=a.getMutableAttribute(p.T.SIZE);e[0]=i[0],e[1]=i[1]}if(null!=n){const{data:e}=a.getMutableAttribute(p.T.AUXPOS1);e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]}if(null!=o){const{data:e}=a.getMutableAttribute(p.T.UV0);e[0]=o[0],e[1]=o[1]}if(null!=s){const{data:e}=a.getMutableAttribute(p.T.AUXPOS2);e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3]}},e.createPointArrayGeometry=function(e,t){const r=new Float32Array(3*e.length),i=new Float32Array(t?3*e.length:3),n=new Uint32Array(e.length),o=new Uint32Array(e.length);for(let l=0;l<e.length;l++)r[3*l]=e[l][0],r[3*l+1]=e[l][1],r[3*l+2]=e[l][2],t&&(i[3*l]=t[l][0],i[3*l+1]=t[l][1],i[3*l+2]=t[l][2]),n[l]=l,o[l]=0;t||(i[0]=0,i[1]=1,i[2]=0);const s=[[p.T.POSITION,n],[p.T.NORMAL,t?n:o],[p.T.UV0,o]],a=[[p.T.POSITION,{size:3,data:r,exclusive:!0}],[p.T.NORMAL,{size:3,data:i,exclusive:!0}],[p.T.UV0,{size:2,data:[0,0],exclusive:!0}]];return new d.Z(a,s,c.MX.Point)},e.createTriangleGeometry=function(){const e=new Uint16Array([0,1,2]),t=new Uint16Array([0,0,0]),r=new Uint16Array([0,0,0]),i=[[p.T.POSITION,e],[p.T.NORMAL,t],[p.T.UV0,r]],n=[[p.T.POSITION,{size:3,data:[0,0,0,0,0,100,100,0,0],exclusive:!0}],[p.T.NORMAL,{size:3,data:[0,1,0],exclusive:!0}],[p.T.UV0,{size:2,data:[0,0],exclusive:!0}]];return new d.Z(n,i)};const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function r(e,t,r,i,o){return!(Math.abs((0,n.d)(t,e))>o)&&((0,n.c)(r,e,t),(0,n.n)(r,r),(0,n.c)(i,r,e),(0,n.n)(i,i),!0)}function i(e,t,i,n,o,s,a){return r(e,t,o,s,a)||r(e,i,o,s,a)||r(e,n,o,s,a)}e.createSquareGeometry=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t;const r=new Array(12);for(let t=0;t<4;t++)for(let i=0;i<3;i++)r[3*t+i]=e[t][i];const i=new Uint32Array([0,1,2,2,3,0]),n=[0,0,1],o=new Uint32Array([0,0,0,0,0,0]),s=[0,0,1,0,1,1,0,1],a=[255,255,255,255],l=[[p.T.POSITION,i],[p.T.NORMAL,o],[p.T.UV0,i],[p.T.COLOR,o]],c=[[p.T.POSITION,{size:3,data:r,exclusive:!0}],[p.T.NORMAL,{size:3,data:n,exclusive:!0}],[p.T.UV0,{size:2,data:s,exclusive:!0}],[p.T.COLOR,{size:4,data:a,exclusive:!0}]];return new d.Z(c,l)},e.createConeGeometry=function(e,t,r,i){let n=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=0;const l=t,c=e;let h=(0,o.f)(0,a,0),u=(0,o.f)(0,a+c,0),f=(0,o.f)(0,-1,0),m=(0,o.f)(0,1,0);i&&(a=c,u=(0,o.f)(0,0,0),h=(0,o.f)(0,a,0),f=(0,o.f)(0,1,0),m=(0,o.f)(0,-1,0));const g=[u,h],v=[f,m],_=r+2,y=Math.sqrt(c*c+l*l);if(i)for(let d=r-1;d>=0;d--){const e=d*(2*Math.PI/r),t=(0,o.f)(Math.cos(e)*l,a,Math.sin(e)*l);g.push(t);const i=(0,o.f)(c*Math.cos(e)/y,-l/y,c*Math.sin(e)/y);v.push(i)}else for(let d=0;d<r;d++){const e=d*(2*Math.PI/r),t=(0,o.f)(Math.cos(e)*l,a,Math.sin(e)*l);g.push(t);const i=(0,o.f)(c*Math.cos(e)/y,l/y,c*Math.sin(e)/y);v.push(i)}const T=new Uint32Array(2*(r+2)*3),x=new Uint32Array(2*(r+2)*3);let b=0,O=0;if(n){for(let e=3;e<g.length;e++)T[b++]=1,T[b++]=e-1,T[b++]=e,x[O++]=0,x[O++]=0,x[O++]=0;T[b++]=g.length-1,T[b++]=2,T[b++]=1,x[O++]=0,x[O++]=0,x[O++]=0}if(s){for(let e=3;e<g.length;e++)T[b++]=e,T[b++]=e-1,T[b++]=0,x[O++]=e,x[O++]=e-1,x[O++]=1;T[b++]=0,T[b++]=2,T[b++]=g.length-1,x[O++]=1,x[O++]=2,x[O++]=v.length-1}const S=new Float32Array(3*_);for(let o=0;o<_;o++)S[3*o]=g[o][0],S[3*o+1]=g[o][1],S[3*o+2]=g[o][2];const C=new Float32Array(3*_);for(let o=0;o<_;o++)C[3*o]=v[o][0],C[3*o+1]=v[o][1],C[3*o+2]=v[o][2];const E=[[p.T.POSITION,T],[p.T.NORMAL,x]],A=[[p.T.POSITION,{size:3,data:S,exclusive:!0}],[p.T.NORMAL,{size:3,data:C,exclusive:!0}]];return new d.Z(A,E)},e.createCylinderGeometry=function(e,t,r,i,s,a){const l=i?(0,o.a)(i):(0,o.f)(1,0,0),c=s?(0,o.a)(s):(0,o.f)(0,0,0);a=null==a||a;const h=(0,o.c)();(0,n.n)(h,l);const u=(0,o.c)();(0,n.a)(u,h,Math.abs(e));const f=(0,o.c)();(0,n.a)(f,u,-.5),(0,n.b)(f,f,c);const m=(0,o.f)(0,1,0);Math.abs(1-(0,n.d)(h,m))<.2&&(0,n.s)(m,0,0,1);const g=(0,o.c)();(0,n.c)(g,h,m),(0,n.n)(g,g),(0,n.c)(m,g,h);const v=2*r+(a?2:0),_=r+(a?2:0),y=new Float32Array(3*v),T=new Float32Array(3*_),x=new Float32Array(2*v),b=new Uint32Array(3*r*(a?4:2)),O=new Uint32Array(3*r*(a?4:2));a&&(y[3*(v-2)+0]=f[0],y[3*(v-2)+1]=f[1],y[3*(v-2)+2]=f[2],x[2*(v-2)]=0,x[2*(v-2)+1]=0,y[3*(v-1)+0]=y[3*(v-2)+0]+u[0],y[3*(v-1)+1]=y[3*(v-2)+1]+u[1],y[3*(v-1)+2]=y[3*(v-2)+2]+u[2],x[2*(v-1)]=1,x[2*(v-1)+1]=1,T[3*(_-2)+0]=-h[0],T[3*(_-2)+1]=-h[1],T[3*(_-2)+2]=-h[2],T[3*(_-1)+0]=h[0],T[3*(_-1)+1]=h[1],T[3*(_-1)+2]=h[2]);const S=function(e,t,r){b[e]=t,O[e]=r};let C=0;const E=(0,o.c)(),A=(0,o.c)();for(let o=0;o<r;o++){const e=o*(2*Math.PI/r);(0,n.a)(E,m,Math.sin(e)),(0,n.a)(A,g,Math.cos(e)),(0,n.b)(E,E,A),T[3*o+0]=E[0],T[3*o+1]=E[1],T[3*o+2]=E[2],(0,n.a)(E,E,t),(0,n.b)(E,E,f),y[3*o+0]=E[0],y[3*o+1]=E[1],y[3*o+2]=E[2],x[2*o+0]=o/r,x[2*o+1]=0,y[3*(o+r)+0]=y[3*o+0]+u[0],y[3*(o+r)+1]=y[3*o+1]+u[1],y[3*(o+r)+2]=y[3*o+2]+u[2],x[2*(o+r)+0]=o/r,x[2*o+1]=1;const i=(o+1)%r;S(C++,o,o),S(C++,o+r,o),S(C++,i,i),S(C++,i,i),S(C++,o+r,o),S(C++,i+r,i)}if(a){for(let e=0;e<r;e++){const t=(e+1)%r;S(C++,v-2,_-2),S(C++,e,_-2),S(C++,t,_-2)}for(let e=0;e<r;e++){const t=(e+1)%r;S(C++,e+r,_-1),S(C++,v-1,_-1),S(C++,t+r,_-1)}}const R=[[p.T.POSITION,b],[p.T.NORMAL,O],[p.T.UV0,b]],w=[[p.T.POSITION,{size:3,data:y,exclusive:!0}],[p.T.NORMAL,{size:3,data:T,exclusive:!0}],[p.T.UV0,{size:2,data:x,exclusive:!0}]];return new d.Z(w,R)},e.createTubeGeometry=function(t,r,i,n,o){i=i||10,n=null==n||n,(0,u.hu)(t.length>1);const s=[],a=[];for(let e=0;e<i;e++){s.push([0,-e-1,-(e+1)%i-1]);const t=e/i*2*Math.PI;a.push([Math.cos(t)*r,Math.sin(t)*r])}return e.createPathExtrusionGeometry(a,t,[[0,0,0]],s,n,o)},e.createPathExtrusionGeometry=function(e,t,r,c,h){let u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:(0,o.f)(0,0,0);const f=e.length,m=new Float32Array(t.length*f*3+(6*r.length||0)),g=new Float32Array(t.length*f*3+(r?6:0)),v=(t.length-1)*f*6+3*c.length*2,_=new Uint32Array(v),T=new Uint32Array(v);let x=0,b=0,O=0,S=0;const C=(0,o.c)(),E=(0,o.c)(),A=(0,o.c)(),R=(0,o.c)(),w=(0,o.c)(),P=(0,o.c)(),I=(0,o.c)(),D=(0,s.c)(),M=(0,o.c)(),H=(0,o.c)(),N=(0,o.c)(),L=(0,o.c)(),F=(0,o.c)(),U=(0,a.Ue)();(0,n.s)(M,0,1,0),(0,n.f)(E,t[1],t[0]),(0,n.n)(E,E),h?((0,n.b)(D,t[0],u),(0,n.n)(A,D)):(0,n.s)(A,0,0,1),i(E,A,M,M,w,A,y),(0,n.g)(R,A),(0,n.g)(L,w);for(let i=0;i<r.length;i++)(0,n.a)(P,w,r[i][0]),(0,n.a)(D,A,r[i][2]),(0,n.b)(P,P,D),(0,n.b)(P,P,t[0]),m[x++]=P[0],m[x++]=P[1],m[x++]=P[2];g[b++]=-E[0],g[b++]=-E[1],g[b++]=-E[2];for(let i=0;i<c.length;i++)_[O++]=c[i][0]>0?c[i][0]:-c[i][0]-1+r.length,_[O++]=c[i][1]>0?c[i][1]:-c[i][1]-1+r.length,_[O++]=c[i][2]>0?c[i][2]:-c[i][2]-1+r.length,T[S++]=0,T[S++]=0,T[S++]=0;let z=r.length;const V=r.length-1;for(let o=0;o<t.length;o++){let r=!1;o>0&&((0,n.g)(C,E),o<t.length-1?((0,n.f)(E,t[o+1],t[o]),(0,n.n)(E,E)):r=!0,(0,n.b)(H,C,E),(0,n.n)(H,H),(0,n.b)(N,t[o-1],R),(0,a.Yq)(t[o],H,U),(0,a.BR)(U,(0,l.re)(N,C),D)?((0,n.f)(D,D,t[o]),(0,n.n)(A,D),(0,n.c)(w,H,A),(0,n.n)(w,w)):i(H,R,L,M,w,A,y),(0,n.g)(R,A),(0,n.g)(L,w)),h&&((0,n.b)(D,t[o],u),(0,n.n)(F,D));for(let i=0;i<f;i++)if((0,n.a)(P,w,e[i][0]),(0,n.a)(D,A,e[i][1]),(0,n.b)(P,P,D),(0,n.n)(I,P),g[b++]=I[0],g[b++]=I[1],g[b++]=I[2],(0,n.b)(P,P,t[o]),m[x++]=P[0],m[x++]=P[1],m[x++]=P[2],!r){const e=(i+1)%f;_[O++]=z+i,_[O++]=z+f+i,_[O++]=z+e,_[O++]=z+e,_[O++]=z+f+i,_[O++]=z+f+e;for(let t=0;t<6;t++)T[S++]=_[O-6+t]-V}z+=f}const j=t[t.length-1];for(let i=0;i<r.length;i++)(0,n.a)(P,w,r[i][0]),(0,n.a)(D,A,r[i][1]),(0,n.b)(P,P,D),(0,n.b)(P,P,j),m[x++]=P[0],m[x++]=P[1],m[x++]=P[2];const G=b/3;g[b++]=E[0],g[b++]=E[1],g[b++]=E[2];const B=z-f;for(let i=0;i<c.length;i++)_[O++]=c[i][0]>=0?z+c[i][0]:-c[i][0]-1+B,_[O++]=c[i][2]>=0?z+c[i][2]:-c[i][2]-1+B,_[O++]=c[i][1]>=0?z+c[i][1]:-c[i][1]-1+B,T[S++]=G,T[S++]=G,T[S++]=G;const W=[[p.T.POSITION,_],[p.T.NORMAL,T]],q=[[p.T.POSITION,{size:3,data:m,exclusive:!0}],[p.T.NORMAL,{size:3,data:g,exclusive:!0}]];return new d.Z(q,W)},e.createPolylineGeometry=function(e,t,r){(0,u.hu)(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),(0,u.hu)(3===e[0].length,"createPolylineGeometry(): malformed vertex"),(0,u.hu)(null==t||t.length===e.length,"createPolylineGeometry: need same number of points and normals"),(0,u.hu)(null==t||3===t[0].length,"createPolylineGeometry(): malformed normal");const i=new Float64Array(3*e.length),n=new Uint32Array(2*(e.length-1));let o=0,s=0;for(let c=0;c<e.length;c++){for(let t=0;t<3;t++)i[o++]=e[c][t];c>0&&(n[s++]=c-1,n[s++]=c)}const a=[],l=[];if(a.push([p.T.POSITION,n]),l.push([p.T.POSITION,{size:3,data:i,exclusive:!0}]),t){const r=new Float32Array(3*t.length);let i=0;for(let n=0;n<e.length;n++)for(let e=0;e<3;e++)r[i++]=t[n][e];a.push([p.T.NORMAL,n]),l.push([p.T.NORMAL,{size:3,data:r,exclusive:!0}])}return r&&(l.push([p.T.COLOR,{size:4,data:r}]),a.push([p.T.COLOR,(0,h.p)(r.length/4)])),new d.Z(l,a,c.MX.Line)},e.createExtrudedTriangle=function(e,t,r,i){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const o=new Array(18),s=[[-t,n,i/2],[r,n,i/2],[0,e+n,i/2],[-t,n,-i/2],[r,n,-i/2],[0,e+n,-i/2]],a=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]);for(let l=0;l<6;l++)o[3*l]=s[l][0],o[3*l+1]=s[l][1],o[3*l+2]=s[l][2];return new d.Z([[p.T.POSITION,{size:3,data:o,exclusive:!0}]],[[p.T.POSITION,a]])},e.transformInPlace=function(e,t){const r=e.getMutableAttribute(p.T.POSITION).data;for(let i=0;i<r.length;i+=3){const e=r[i],o=r[i+1],s=r[i+2];(0,n.s)(T,e,o,s),(0,n.m)(T,T,t),r[i]=T[0],r[i+1]=T[1],r[i+2]=T[2]}},e.cgToGIS=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;const r=e.vertexAttributes,i=r.get(p.T.POSITION).data,n=r.get(p.T.NORMAL).data;if(n){const e=t.getMutableAttribute(p.T.NORMAL).data;for(let t=0;t<n.length;t+=3){const r=n[t+1];e[t+1]=-n[t+2],e[t+2]=r}}if(i){const e=t.getMutableAttribute(p.T.POSITION).data;for(let t=0;t<i.length;t+=3){const r=i[t+1];e[t+1]=-i[t+2],e[t+2]=r}}return t},e.makeOrthoBasisDirUp=r,e.makeOrthoBasisDirUpFallback=i}(_||(_={}));const y=.99619469809,T=(0,o.c)(),x=_},19962:(e,t,r)=>{r.d(t,{C1:()=>g});var i=r(92026),n=r(95439),o=r(81949),s=r(11186),a=r(71353),l=r(79803),c=r(68401),d=r(74894),h=r(61403),u=r(59887),p=r(4760),f=r(97882),m=r(58901);class g{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:125e4;this._originSR=e,this._gridSize=t,this._origins=new Map,this._objects=new Map,this._rootOriginId="root/"+(0,n.D)()}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){if((0,i.pC)(v))return this._origins.set(this._rootOriginId,(0,h.al)(v[0],v[1],v[2],this._rootOriginId)),this.getOrigin(e);const t=(0,h.al)(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,t),t}const r=this._gridSize,n=Math.round(e[0]/r),o=Math.round(e[1]/r),a=Math.round(e[2]/r),l=`${n}/${o}/${a}`;let c=this._origins.get(l);const d=.5*r;if((0,s.f)(_,e,t.vec3),_[0]=Math.abs(_[0]),_[1]=Math.abs(_[1]),_[2]=Math.abs(_[2]),_[0]<d&&_[1]<d&&_[2]<d){if(c){const t=Math.max(..._);if((0,s.f)(_,e,c.vec3),_[0]=Math.abs(_[0]),_[1]=Math.abs(_[1]),_[2]=Math.abs(_[2]),Math.max(..._)<t)return c}return t}return c||(c=(0,h.al)(n*r,o*r,a*r,l),this._origins.set(l,c)),c}_drawOriginBox(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[1,1,0,1];const r=window.view,i=r._stage,n=t.toString();if(!this._objects.has(n)){this._material=new m.U({width:2,color:t}),i.add(this._material);const e=new f.F({isPickable:!1}),r=new u.T({castShadow:!1});i.add(r),e.add(r),i.add(e),this._objects.set(n,r)}const s=this._objects.get(n),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],h=a.length,g=new Array(3*h),v=new Uint16Array(2*(h-1)),_=.5*this._gridSize;for(let o=0;o<h;o++)g[3*o+0]=e[0]+(1&a[o]?_:-_),g[3*o+1]=e[1]+(2&a[o]?_:-_),g[3*o+2]=e[2]+(4&a[o]?_:-_),o>0&&(v[2*o+0]=o-1,v[2*o+1]=o);(0,l.CM)(g,this._originSR,0,g,r.renderSpatialReference,0,h);const y=new d.Z([[p.T.POSITION,{size:3,data:g,exclusive:!0}]],[[p.T.POSITION,v]],c.MX.Line);i.add(y),s.addGeometry(y,this._material,o.I)}}let v=null;const _=(0,a.c)()},81268:(e,t,r)=>{r.d(t,{Z8:()=>_,LP:()=>x});var i=r(92026),n=r(14226),o=r(81949),s=r(11186),a=r(71353),l=r(90045),c=r(67077),d=r(40885),h=r(50951),u=r(54463);r(82218);function p(e){return(0,i.pC)(e)&&(0,i.pC)(e.dist)}(0,a.c)();var f=r(76783),m=r(32683);const g=1e-5;class v{constructor(e){this.options=new u.om,this._results=new y,this.transform=new f.yn,this.tolerance=g,this.verticalOffset=null,this._ray=(0,d.Ue)(),this._rayEnd=(0,a.c)(),this._rayBeginTransformed=(0,a.c)(),this._rayEndTransformed=(0,a.c)(),this.viewingMode=null==e?h.JY.Global:e}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,r){this.resetWithRay((0,d.zk)(e,t,this._ray),r)}resetWithRay(e,t){this.camera=t,e!==this._ray&&(0,d.JG)(e,this._ray),0!==this.options.verticalOffset?this.viewingMode===h.JY.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,(0,s.b)(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;this.point=t,this.filterPredicate=n,this.tolerance=null==r?g:r;const s=(0,f.W9)(this.verticalOffset);if((0,i.pC)(e)&&e.length>0){const t=o?e=>{o(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const r of e){const e=r.getSpatialQueryAccelerator&&r.getSpatialQueryAccelerator();(0,i.pC)(e)?((0,i.pC)(s)?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,s):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):r.objects.forAll((e=>t(e)))}}this.sortResults()}intersectObject(e){const t=e.geometryRecords;if(!t)return;const r=e.transformation,n=(0,f.W9)(this.verticalOffset);for(const a of t){const{geometry:t,material:l,instanceParameters:c}=a;if((0,m.PD)(c))continue;const d=t.id;this.transform.setAndInvalidateLazyTransforms(r,a.getShaderTransformation()),(0,s.m)(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),(0,s.m)(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const h=this.transform.transform;(0,i.pC)(n)&&(n.objectTransform=this.transform),l.intersect(t,c,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((t,r,n,s,a,l)=>{if(t>=0){if((0,i.pC)(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;if(s){if(null==this._results.hud.dist||t<this._results.hud.dist){const i={object:e,geometryId:d,triangleNr:n,center:l};this._results.hud.set(u.q7.HUD,i,t,r,o.I,a)}return}const c=i=>i.set(u.q7.OBJECT,{object:e,geometryId:d,triangleNr:n},t,r,h,a);if((null==this._results.min.drapedLayerOrder||a>=this._results.min.drapedLayerOrder)&&(null==this._results.min.dist||t<this._results.min.dist)&&c(this._results.min),this.options.store!==u.eC.MIN&&(null==this._results.max.drapedLayerOrder||a<this._results.max.drapedLayerOrder)&&(null==this._results.max.dist||t>this._results.max.dist)&&c(this._results.max),this.options.store===u.eC.ALL){const i=x(this._ray);i.set(u.q7.OBJECT,{object:e,geometryId:d,triangleNr:n},t,r,h),this._results.all.push(i)}}}),a.shaderTransformation)}}sortResults(){this._results.all.sort(((e,t)=>e.dist!==t.dist?(0,i.Pt)(e.dist,0)-(0,i.Pt)(t.dist,0):e.drapedLayerOrder!==t.drapedLayerOrder?(0,i.Pt)(e.drapedLayerOrder,Number.MAX_VALUE)-(0,i.Pt)(t.drapedLayerOrder,Number.MAX_VALUE):(0,i.Pt)(t.drapedLayerGraphicOrder,Number.MIN_VALUE)-(0,i.Pt)(e.drapedLayerGraphicOrder,Number.MIN_VALUE)))}}function _(e){return new v(e)}class y{constructor(){this._min=new T((0,d.Ue)()),this._max=new T((0,d.Ue)()),this._hud=new T((0,d.Ue)()),this._ground=new T((0,d.Ue)())}get min(){return this._min}get max(){return this._max}get hud(){return this._hud}get ground(){return this._ground}init(e){this._min.init(e),this._max.init(e),this._hud.init(e),this._ground.init(e),this.all=[]}}class T{constructor(e){this.intersector=u.q7.OBJECT,this.normal=(0,a.c)(),this.transformation=(0,o.c)(),this._ray=(0,d.Ue)(),this.init(e)}get ray(){return this._ray}get distanceInRenderSpace(){return(0,i.pC)(this.dist)?((0,s.a)(b,this.ray.direction,this.dist),(0,s.l)(b)):null}getIntersectionPoint(e){return!!p(this)&&((0,s.a)(b,this.ray.direction,this.dist),(0,s.b)(e,this.ray.origin,b),!0)}getTransformedNormal(e){return(0,s.g)(O,this.normal),O[3]=0,(0,l.t)(O,O,this.transformation),(0,s.g)(e,O),(0,s.n)(e,e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=u.q7.OBJECT,(0,d.JG)(e,this._ray)}set(e,t,r,l,c,d,h){this.intersector=e,this.dist=r,(0,s.g)(this.normal,(0,i.Pt)(l,a.U)),(0,n.c)(this.transformation,(0,i.Pt)(c,o.I)),this.target=t,this.drapedLayerOrder=d,this.drapedLayerGraphicOrder=h}copy(e){(0,d.JG)(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,(0,s.g)(this.normal,e.normal),(0,n.c)(this.transformation,e.transformation)}}function x(e){return new T(e)}const b=(0,a.c)(),O=(0,c.c)()},54463:(e,t,r)=>{var i,n;r.d(t,{eC:()=>n,om:()=>o,q7:()=>i}),function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL"}(i||(i={}));class o{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=n.ALL}}!function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"}(n||(n={}))},61403:(e,t,r)=>{r.d(t,{al:()=>o});var i=r(71353);class n{constructor(e,t){this.vec3=e,this.id=t}}function o(e,t,r,o){return new n((0,i.f)(e,t,r),o)}},78289:(e,t,r)=>{var i;r.d(t,{$:()=>i}),function(e){var t,r;(t=e.Geometry||(e.Geometry={}))[t.ADD=1]="ADD",t[t.UPDATE=2]="UPDATE",t[t.REMOVE=4]="REMOVE",(r=e.State||(e.State={}))[r.VISIBILITIES=1]="VISIBILITIES",r[r.VERTEXATTRS=2]="VERTEXATTRS",r[r.TRANSFORMATION=4]="TRANSFORMATION",r[r.HIGHLIGHTS=8]="HIGHLIGHTS",r[r.OCCLUDEES=16]="OCCLUDEES"}(i||(i={}))},59887:(e,t,r)=>{r.d(t,{T:()=>y});var i=r(92026),n=r(14226),o=r(81949),s=r(11186),a=r(71353),l=r(23470),c=r(80064),d=r(68401),h=r(1395),u=r(79100),p=r(13005),f=r(95439);class m{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(e,t,r,i,n,o){this.id=(0,f.D)(),this.geometry=e,this.material=t,this.transformation=r,this.instanceParameters=i,this.origin=n,this._shaderTransformation=o,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return(0,i.pC)(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(e){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,e):this.geometry.computeAttachmentOrigin(e))&&((0,s.m)(e,e,this.getStaticTransformation()),!0)}}m.pool=new p.Z(m);var g=r(47669),v=r(97731),_=r(32683);class y extends h.c{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.type=u.U.Object,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=(0,o.c)(),this._bvObjectSpace=new x,this._bvWorldSpace=new x,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=null==e.castShadow||e.castShadow,this.metadata=e.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new T),this.transformation=(0,o.c)();const{geometries:t,materials:r,transformations:i,origins:n}=e;if(Array.isArray(t)){(0,v.hu)(r.length===t.length,"Object3D: materials don't match geometries"),(0,v.hu)(i.length===t.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=t.length,this._geometries.length=t.length;for(let e=0;e<t.length;e++)this._geometries[e]=t[e],this._geometryRecords[e]=m.pool.acquire(t[e],r[e],(0,o.b)(i[e]),{highlights:null,occludees:null,visible:this._visible},n&&n[e])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(e){(0,n.c)(this._objectTransformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){(0,v.hu)(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e,t,r,n,s){r=r||o.I,this._geometries.push(e);const a=m.pool.acquire(e,t,r,{highlights:null,occludees:null,visible:this._visible},n,s);return this._geometryRecords.push(a),this._hasVolatileTransformation=this._hasVolatileTransformation||(0,i.pC)(a.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:a}),this._invalidateBoundingVolume(),a}removeGeometry(e){const t=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=(0,i.pC)(t.shaderTransformation)?this._geometryRecords.some((e=>(0,i.pC)(e.shaderTransformation))):this._hasVolatileTransformation,t.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:t}),this._invalidateBoundingVolume(),t}removeAllGeometries(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("vertexAttrsUpdated",{object:this,record:e}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometryRecords)e.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new g.O(d.V_.MaskOccludee);for(const t of this._geometryRecords)t.instanceParameters.occludees=(0,_.lr)(t.instanceParameters.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometryRecords)t.instanceParameters.occludees=(0,_.U_)(t.instanceParameters.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new g.O(d.V_.Highlight);for(const t of this._geometryRecords)t.instanceParameters.highlights=(0,_.lr)(t.instanceParameters.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometryRecords)t.instanceParameters.highlights=(0,_.U_)(t.instanceParameters.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,t){return(0,n.m)((0,i.Pt)(t,(0,o.c)()),this.transformation,e.getStaticTransformation())}_getCombinedShaderTransformation(e,t){return t=t||(0,o.c)(),(0,n.m)(t,this.transformation,e.getShaderTransformation()),t}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let n=0;n<this._geometryRecords.length;++n){const e=this._geometries[n],t=this._geometryRecords[n],r=e.boundingInfo;(0,i.pC)(r)&&(this._calculateTransformedBoundingVolume(r,this._bvObjectSpace,t.getShaderTransformation()),this._calculateTransformedBoundingVolume(r,this._bvWorldSpace,this._getCombinedShaderTransformation(t)))}(0,s.e)(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),(0,s.e)(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=(0,a.c)(),t=(0,a.c)(),r=(0,c.u1)(this.transformation);for(let n=0;n<this._geometryRecords.length;++n){const o=this._geometries[n].boundingInfo;if((0,i.Wi)(o))continue;const a=this._geometryRecords[n].getShaderTransformation(),l=(0,c.u1)(a);(0,s.m)(e,o.getCenter(),a);const d=(0,s.i)(e,this._bvObjectSpace.bounds),h=o.getBSRadius()*l;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],d+h),(0,s.m)(t,e,this.transformation);const u=(0,s.i)(t,this._bvWorldSpace.bounds),p=h*r;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],u+p)}this._bvDirty=!1}_calculateTransformedBoundingVolume(e,t,r){const i=e.getBBMin(),n=e.getBBMax(),o=(0,a.a)(i),l=(0,a.a)(n);(0,s.m)(o,o,r),(0,s.m)(l,l,r);for(let s=0;s<3;++s)t.min[s]=Math.min(t.min[s],o[s],l[s]),t.max[s]=Math.max(t.max[s],o[s],l[s]);for(let a=0;a<3;++a){(0,s.g)(o,i),(0,s.g)(l,n),o[a]=n[a],l[a]=i[a],(0,s.m)(o,o,r),(0,s.m)(l,l,r);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],o[e],l[e]),t.max[e]=Math.max(t.max[e],o[e],l[e])}}_invalidateBoundingVolume(){this._bvDirty=!0,(0,i.pC)(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(e,t){(0,i.pC)(this._parentLayer)&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.indexOf(t)>-1,getGeometryIndex:t=>e._geometries.indexOf(t)}}}class T{constructor(){this.min=(0,a.f)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=(0,a.f)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class x extends T{constructor(){super(...arguments),this.bounds=(0,l.c)()}init(){(0,s.s)(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),(0,s.s)(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),(0,l.a)(this.bounds)}}},47669:(e,t,r)=>{r.d(t,{O:()=>n});var i=r(95439);class n{constructor(e){this.channel=e,this.id=(0,i.D)()}}},78329:(e,t,r)=>{r.d(t,{F:()=>i,Z:()=>p});var i,n=r(92026),o=r(13005),s=r(27546),a=r(11186),l=r(71353),c=r(95773),d=r(40885),h=r(23470),u=r(97731);class p{constructor(e,t){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new f,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),f.clearPool(),C[0]=null,P.prune(),L.prune()}add(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.length;this._objectCount+=t,this._grow(e,t);const r=f.acquire();for(let i=0;i<t;i++){const t=e[i];this._isDegenerate(t)?this._degenerateObjects.add(t):(r.init(this._root),this._add(t,r))}f.release(r)}remove(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._objectCount-=e.length;const r=f.acquire();for(const i of e){const e=(0,n.pC)(t)?t:(0,h.b)(this._objectToBoundingSphere(i),I);x(e[3])?(r.init(this._root),this._remove(i,e,r)):this._degenerateObjects.delete(i)}f.release(r),this._shrink()}update(e,t){if(!x(t[3])&&this._isDegenerate(e))return;const r=function(e){return C[0]=e,C}(e);this.remove(r,t),this.add(r)}forEachAlongRay(e,t,r){const i=(0,d.re)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNode(i,e))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(i,e)&&r(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(i,e)&&r(e)})),!0}))}forEachAlongRayWithVerticalOffset(e,t,r,i){const n=(0,d.re)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNodeWithOffset(n,e,i))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(n,e,i)&&r(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(n,e,i)&&r(e)})),!0}))}forEach(e){this._forEachNode(this._root,(t=>{const r=t.node;return r.terminals.forAll(e),null!==r.residents&&r.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:()=>!0,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1/0,o=1/0,s=1/0,l=null;const d=y(e,t),u=a=>{if(--n,!i(a))return;const d=this._objectToBoundingSphere(a);if(!(0,c.hr)(r,d))return;const u=T(e,t,(0,h.g)(d)),p=u-d[3],f=u+d[3];p<o&&(o=p,s=f,l=a)};return this._forEachNodeDepthOrdered(this._root,(i=>{if(n<=0||!(0,c.hr)(r,i.bounds))return!1;if((0,a.a)(A,d,i.halfSize),(0,a.b)(A,A,i.bounds),T(e,t,A)>s)return!1;const o=i.node;return o.terminals.forAll((e=>u(e))),null!==o.residents&&o.residents.forAll((e=>u(e))),!0}),e,t),l}forEachInDepthRange(e,t,r,n,o,s,l){let d=-1/0,u=1/0;const p={setRange:e=>{r===i.FRONT_TO_BACK?(d=Math.max(d,e.near),u=Math.min(u,e.far)):(d=Math.max(d,-e.far),u=Math.min(u,-e.near))}};p.setRange(n);const f=T(t,r,e),m=y(t,r),g=y(t,-r),v=e=>{if(!l(e))return;const i=this._objectToBoundingSphere(e),n=(0,h.g)(i),a=T(t,r,n)-f,m=a-i[3],g=a+i[3];m>u||g<d||!(0,c.hr)(s,i)||o(e,p)};this._forEachNodeDepthOrdered(this._root,(e=>{if(!(0,c.hr)(s,e.bounds))return!1;if((0,a.a)(A,m,e.halfSize),(0,a.b)(A,A,e.bounds),T(t,r,A)-f>u)return!1;if((0,a.a)(A,g,e.halfSize),(0,a.b)(A,A,e.bounds),T(t,r,A)-f<d)return!1;const i=e.node;return i.terminals.forAll((e=>v(e))),null!==i.residents&&i.residents.forAll((e=>v(e))),!0}),t,r)}forEachNode(e){this._forEachNode(this._root,(t=>e(t.node,t.bounds,t.halfSize)))}_intersectsNode(e,t){return v(t.bounds,2*-t.halfSize,R),v(t.bounds,2*t.halfSize,w),(0,u.yK)(e.origin,e.direction,R,w)}_intersectsNodeWithOffset(e,t,r){return v(t.bounds,2*-t.halfSize,R),v(t.bounds,2*t.halfSize,w),r.applyToMinMax(R,w),(0,u.yK)(e.origin,e.direction,R,w)}_intersectsObject(e,t){const r=this._objectToBoundingSphere(t);return!(r[3]>0)||(0,h.i)(r,e)}_intersectsObjectWithOffset(e,t,r){const i=this._objectToBoundingSphere(t);return!(i[3]>0)||(0,h.i)(r.applyToBoundingSphere(i),e)}_forEachNode(e,t){let r=f.acquire().init(e);const i=[r];for(;0!==i.length;){if(r=i.pop(),t(r)&&!r.isLeaf())for(let e=0;e<r.node.children.length;e++)r.node.children[e]&&i.push(f.acquire().init(r).advance(e));f.release(r)}}_forEachNodeDepthOrdered(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i.FRONT_TO_BACK,o=f.acquire().init(e);const s=[o];for(function(e,t,r){if(!L.length)for(let i=0;i<8;++i)L.push({index:0,distance:0});for(let i=0;i<8;++i){const r=b[i];L.data[i].index=i,L.data[i].distance=T(e,t,r)}L.sort(((e,t)=>e.distance-t.distance));for(let i=0;i<8;++i)r[i]=L.data[i].index}(r,n,F);0!==s.length;){if(o=s.pop(),t(o)&&!o.isLeaf())for(let e=7;e>=0;--e){const t=F[e];o.node.children[t]&&s.push(f.acquire().init(o).advance(t))}f.release(o)}}_remove(e,t,r){P.clear();const i=r.advanceTo(t,((e,t)=>{P.push(e.node),P.push(t)}))?r.node.terminals:r.node.residents;if(i.removeUnordered(e),0===i.length)for(let n=P.length-2;n>=0;n-=2){const e=P.data[n],t=P.data[n+1];if(!this._purge(e,t))break}}_nodeIsEmpty(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}_purge(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new s.Z({shrink:!0})),!0)}_add(e,t){t.advanceTo(this._objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let r=0;r<t.length;r++){const i=f.acquire().init(e);this._add(t.getItemAt(r),i),f.release(i)}}_grow(e,t){if(0!==t&&(_(e,t,(e=>this._objectToBoundingSphere(e)),D),x(D[3])&&!this._fitsInsideTree(D)))if(this._nodeIsEmpty(this._root.node))(0,h.b)(D,this._root.bounds),this._root.halfSize=1.25*D[3];else{const e=this._rootBoundsForRootAsSubNode(D);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(D,e):this._growRootAsSubNode(e),f.release(e)}}_rebuildTree(e,t){(0,a.g)(M,t.bounds),M[3]=t.halfSize,_([e,M],2,(e=>e),H);const r=f.acquire().init(this._root);this._root.initFrom(null,H,1.25*H[3]),this._forEachNode(r,(e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0))),f.release(r)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return this._forEachNode(this._root,(e=>(r=Math.max(r,e.depth),r+t<=this._maximumDepth))),r+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],r=e;let i=-1/0;const n=this._root.bounds,o=this._root.halfSize;for(let s=0;s<3;s++){const e=n[s]-o-(r[s]-t),a=r[s]+t-(n[s]+o),l=Math.max(0,Math.ceil(e/(2*o))),c=Math.max(0,Math.ceil(a/(2*o)))+1,d=2**Math.ceil(Math.log(l+c)*Math.LOG2E);i=Math.max(i,d),N[s].min=l,N[s].max=c}for(let s=0;s<3;s++){let e=N[s].min,t=N[s].max;const r=(i-(e+t))/2;e+=Math.ceil(r),t+=Math.floor(r);const a=n[s]-o-e*o*2;E[s]=a+(t+e)*o}return E[3]=i*o*S,f.acquire().initFrom(null,E,i*o,0)}_growRootAsSubNode(e){const t=this._root.node;(0,a.g)(D,this._root.bounds),D[3]=this._root.halfSize,this._root.init(e),e.advanceTo(D,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let r=0,i=0;for(;i<t.length&&null==e;)r=i++,e=t[r];for(;i<t.length;)if(t[i++])return-1;return r}_isDegenerate(e){return!x(this._objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,r=this._root.halfSize;return e[3]<=r&&e[0]>=t[0]-r&&e[0]<=t[0]+r&&e[1]>=t[1]-r&&e[1]<=t[1]+r&&e[2]>=t[2]-r&&e[2]<=t[2]+r}}class f{constructor(){this.bounds=(0,h.c)(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.depth;return this.node=(0,n.pC)(e)?e:f.createEmptyNode(),(0,n.pC)(t)&&(0,h.b)(t,this.bounds),this.halfSize=r,this.depth=i,this}advance(e){let t=this.node.children[e];t||(t=f.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const r=b[e];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.bounds[3]=this.halfSize*S,this}advanceTo(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!r)return t&&t(this,-1),!1;this.node.residents=null}const i=this._childIndex(e);t&&t(this,i),this.advance(i)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new s.Z({shrink:!0}),residents:new s.Z({shrink:!0})}}static acquire(){return f._pool.acquire()}static release(e){f._pool.release(e)}static clearPool(){f._pool.prune()}}function m(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function g(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function v(e,t,r){r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t}function _(e,t,r,i){if(1===t){const t=r(e[0]);(0,h.b)(t,i)}else{R[0]=1/0,R[1]=1/0,R[2]=1/0,w[0]=-1/0,w[1]=-1/0,w[2]=-1/0;for(let i=0;i<t;i++){const t=r(e[i]);x(t[3])&&(m(R,t),g(w,t))}(0,a.e)(i,R,w,.5),i[3]=Math.max(w[0]-R[0],w[1]-R[1],w[2]-R[2])/2}}function y(e,t){let r=1/0,i=null;for(let n=0;n<8;++n){const o=T(e,t,O[n]);o<r&&(r=o,i=O[n])}return i}function T(e,t,r){return t*(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])}function x(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}f._pool=new o.Z(f),function(e){e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(i||(i={}));const b=[(0,l.f)(-1,-1,-1),(0,l.f)(1,-1,-1),(0,l.f)(-1,1,-1),(0,l.f)(1,1,-1),(0,l.f)(-1,-1,1),(0,l.f)(1,-1,1),(0,l.f)(-1,1,1),(0,l.f)(1,1,1)],O=[(0,l.f)(-1,-1,-1),(0,l.f)(-1,-1,1),(0,l.f)(-1,1,-1),(0,l.f)(-1,1,1),(0,l.f)(1,-1,-1),(0,l.f)(1,-1,1),(0,l.f)(1,1,-1),(0,l.f)(1,1,1)],S=Math.sqrt(3),C=[null];const E=(0,h.c)(),A=(0,l.c)(),R=(0,l.c)(),w=(0,l.c)(),P=new s.Z,I=(0,h.c)(),D=(0,h.c)(),M=(0,h.c)(),H=(0,h.c)(),N=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],L=new s.Z,F=[0,0,0,0,0,0,0,0]},69831:(e,t,r)=>{r.d(t,{z:()=>g});var i=r(92026),n=r(95439),o=r(14226),s=r(81949),a=r(11186),l=r(67077),c=r(80064),d=r(68401),h=r(81935);class u{constructor(){this.visible=!0}}var p=r(47669),f=r(4760),m=r(32683);class g{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.data=e,this.material=t,this.boundingSphere=(0,l.c)(),this.instanceParameters=new u,this._transformation=(0,s.c)(),this._shaderTransformationDirty=!0,this.layerUid=(0,i.Pt)(r.layerUid,null),this.graphicUid=(0,i.Pt)(r.graphicUid,null),this.id=r.id?r.id:(0,n.D)(),this.boundingInfo=(0,i.Pt)(r.boundingInfo,null),this.calculateShaderTransformation=(0,i.Pt)(this.calculateShaderTransformation,null),this.castShadow=!!r.castShadow&&r.castShadow}get transformation(){return this._transformation}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,c.u1)(e);(0,i.Wi)(this.boundingInfo)||((0,a.m)(t,this.boundingInfo.getCenter(),e),t[3]=this.boundingInfo.getBSRadius()*r)}get hasShaderTransformation(){return(0,i.pC)(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return(0,i.Wi)(this.calculateShaderTransformation)?(0,i.Pt)(this.transformation,s.I):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=(0,s.c)()),(0,o.c)(this._shaderTransformation,this.calculateShaderTransformation((0,i.Pt)(this.transformation,s.I))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&((0,i.pC)(this._transformation)&&(0,a.m)(e,e,this._transformation),!0);const t=this.indices.get(f.T.POSITION),r=this.vertexAttributes.get(f.T.POSITION);return!!(0,h.cM)(r,t,e)&&((0,i.pC)(this._transformation)&&(0,a.m)(e,e,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const e=new p.O(d.V_.Highlight),t=this.instanceParameters;return t.highlights=(0,m.lr)(t.highlights,e),e}removeHighlight(e){const t=this.instanceParameters;t.highlights=(0,m.U_)(t.highlights,e)}}},97882:(e,t,r)=>{r.d(t,{F:()=>u});var i=r(91505),n=r(100),o=r(92026),s=r(27546),a=r(68401),l=r(1395),c=r(79100);const d=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];var h=r(78329);class u extends l.c{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";var r,o,l;super(),this.apiLayerUid=t,this.type=c.U.Layer,this.events=new i.Z,this.isSliceable=!1,this._objects=new s.Z,this._stageHandles=new n.Z,this.apiLayerUid=t,this.isVisible=null==(r=null==e?void 0:e.isVisible)||r,this.isPickable=null==(o=null==e?void 0:e.isPickable)||o,this.updatePolicy=null!=(l=null==e?void 0:e.updatePolicy)?l:a.jq.ASYNC}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const t of d)this._stageHandles.add(this.events.on(t,(r=>e.handleEvent(t,r))))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),(0,o.pC)(this._octree)&&this._octree.add([e])}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),(0,o.pC)(this._octree)&&this._octree.remove([e]))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),(0,o.pC)(this._octree)&&this._octree.add(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),(0,o.pC)(this._octree)&&this._octree.remove(t)}}sync(){(0,o.pC)(this._stage)&&this.updatePolicy!==a.jq.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){(0,o.pC)(this._octree)&&this._octree.update(e,t)}getSpatialQueryAccelerator(){return(0,o.Wi)(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=(0,o.SC)(this._octree)}_createOctree(){this._octree=new h.Z((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)}}},74818:(e,t,r)=>{r.d(t,{E:()=>R});var i=r(71011),n=r(68401),o=r(23620),s=r(94425),a=r(56529),l=r(78041),c=r(93822),d=r(64226),h=r(22909),u=r(27366),p=r(33280),f=r(137),m=r(15226),g=r(41012),v=r(82144),_=r(31132),y=r(33559),T=r(7566),x=r(27627),b=r(50411),O=r(45028),S=r(36207);class C extends _.A{initializeProgram(e){const t=C.shader.get(),r=this.configuration,i=t.build({output:r.output,oitEnabled:r.transparencyPassType===n.Am.Color,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new x.$(e.rctx,i,T.i)}bindPass(e,t){(0,g.II)(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("eColor",e.color),this.configuration.output===i.H.Highlight&&(0,f.wW)(this.program,t),(this.configuration.output===i.H.Depth||t.multipassTerrainEnabled)&&this.program.setUniform2fv("nearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,m.p)(this.program,t))}bindDraw(e){(0,g.id)(this.program,e),this.program.rebindTextures(),(0,p.DA)(this.program,this.configuration,e)}_createPipeline(e,t){const r=this.configuration,o=e===n.Am.NONE,s=e===n.Am.FrontFace;return(0,S.sm)({blending:r.output!==i.H.Color&&r.output!==i.H.Alpha||!r.transparent?null:o?l.wu:(0,l.j7)(e),culling:(0,S.zp)(r.cullFace),depthTest:{func:(0,l.Bh)(e)},depthWrite:o||s?r.writeDepth&&S.LZ:null,colorWrite:S.BK,stencilWrite:r.sceneHasOcludees?b.s3:null,stencilTest:r.sceneHasOcludees?t?b.eD:b.RY:null,polygonOffset:o||s?r.polygonOffset&&E:(0,l.je)(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}C.shader=new v.J(O.C,(()=>r.e(3173).then(r.bind(r,23173))));const E={factor:1,units:1};class A extends y.m{constructor(){super(...arguments),this.output=i.H.Color,this.cullFace=n.Vr.None,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=n.Am.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,u._)([(0,y.o)({count:i.H.COUNT})],A.prototype,"output",void 0),(0,u._)([(0,y.o)({count:n.Vr.COUNT})],A.prototype,"cullFace",void 0),(0,u._)([(0,y.o)()],A.prototype,"slicePlaneEnabled",void 0),(0,u._)([(0,y.o)()],A.prototype,"vertexColors",void 0),(0,u._)([(0,y.o)()],A.prototype,"transparent",void 0),(0,u._)([(0,y.o)()],A.prototype,"polygonOffset",void 0),(0,u._)([(0,y.o)()],A.prototype,"enableOffset",void 0),(0,u._)([(0,y.o)()],A.prototype,"writeDepth",void 0),(0,u._)([(0,y.o)()],A.prototype,"sceneHasOcludees",void 0),(0,u._)([(0,y.o)({count:n.Am.COUNT})],A.prototype,"transparencyPassType",void 0),(0,u._)([(0,y.o)()],A.prototype,"multipassTerrainEnabled",void 0),(0,u._)([(0,y.o)()],A.prototype,"cullAboveGround",void 0);class R extends a.F5{constructor(e){super(e,P),this.supportsEdges=!0,this.techniqueConfig=new A}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<l.ve,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(e,t,r,i,n,o,s){(0,h.Bw)(e,t,i,n,o,void 0,s)}requiresSlot(e,t){return e===c.r.DRAPED_MATERIAL||((0,s.S)(t)===i.H.Highlight?e===c.r.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?c.r.TRANSPARENT_MATERIAL:c.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:c.r.OPAQUE_MATERIAL))}createGLMaterial(e){return e.output===i.H.Color||e.output===i.H.Alpha||e.output===i.H.Highlight||e.output===i.H.Depth&&this.parameters.writeLinearDepth?new w(e):null}createBufferWriter(){return new d.G_(d.IM)}}class w extends o.Z{updateParameters(e){return this.ensureTechnique(C,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==i.H.Color&&this._output!==i.H.Alpha||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const P={color:[1,1,1,1],transparent:!1,writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:n.Vr.None,sceneHasOcludees:!1,...a.mo}},9992:(e,t,r)=>{r.d(t,{A:()=>K});var i=r(16889),n=r(92026),o=r(17842),s=r(22753),a=r(11873),l=r(14226),c=r(81949),d=r(88396),h=r(6394),u=r(11186),p=r(71353);function f(e){return function(e){return e instanceof Float32Array&&e.length>=16}(e)||function(e){return Array.isArray(e)&&e.length>=16}(e)}var m=r(65156),g=r(55158),v=r(71011),_=r(50600),y=r(81935),T=r(40485),x=r(56529),b=r(93822),O=r(65216),S=r(97731),C=r(4760),E=r(33236),A=r(22909),R=r(32683),w=r(18442),P=r(27366),I=r(33280),D=r(49223),M=r(137),H=r(43565),N=r(15226),L=r(18607),F=r(62993),U=r(41012),z=r(82144),V=r(31132),j=r(33559),G=r(68401),B=r(7566),W=r(78041),q=r(27627),Z=r(8548),k=r(36207);class $ extends V.A{initializeProgram(e){const t=$.shader.get(),r=this.configuration,i=t.build({output:r.output,frontFacePass:r.transparencyPassType===G.Am.FrontFace,viewingMode:e.viewingMode,occlusionTestEnabled:r.occlusionTestEnabled,signedDistanceFieldEnabled:r.sdf,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,debugDrawLabelBorder:r.debugDrawLabelBorder,binaryHighlightOcclusionEnabled:r.binaryHighlightOcclusion,screenCenterOffsetUnitsEnabled:r.screenCenterOffsetUnitsEnabled,screenSizePerspectiveEnabled:r.screenSizePerspective,verticalOffsetEnabled:r.verticalOffset,pixelSnappingEnabled:r.pixelSnappingEnabled,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!1,isDraped:r.isDraped,multipassGeometryEnabled:r.multipassGeometryEnabled,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new q.$(e.rctx,i,B.i)}bindPass(e,t){(0,U.II)(this.program,t.camera.projectionMatrix),this.program.setUniform1f("cameraGroundRelative",t.camera.aboveGround?1:-1),this.program.setUniform1f("perDistancePixelRatio",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),(0,D.Mo)(this.program,e,t),(0,F.y)(this.program,e),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio||1),(0,U.yJ)(this.program,t),this.configuration.output===v.H.Occlusion?(this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,H.l)(this.program,t),(0,N.p)(this.program,t)):((0,_.HG)(this.program,t),(0,w.b)(this.program,e,t.camera.pixelRatio||1),(0,L.kz)(this.program,e),this.configuration.occlusionTestEnabled&&this.program.bindTexture(t.hudVisibilityTexture,"hudVisibilityTexture")),this.configuration.output===v.H.Highlight&&(0,M.wW)(this.program,t)}bindDraw(e){(0,U.id)(this.program,e),(0,U.fb)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),(0,I.DA)(this.program,this.configuration,e),this.program.rebindTextures()}_setPipelineState(e){const t=this.configuration,r=e===G.Am.NONE,i=e===G.Am.FrontFace,n=Z.wb.LEQUAL,o=this.configuration.polygonOffsetEnabled&&J,s=(r||i)&&t.output!==v.H.Highlight?(t.depthEnabled||t.output===v.H.Occlusion)&&k.LZ:null;return(0,k.sm)({blending:t.output===v.H.Color||t.output===v.H.Alpha||t.output===v.H.Highlight?r?X:(0,W.j7)(e):null,depthTest:{func:n},depthWrite:s,colorWrite:k.BK,polygonOffset:o})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return this.configuration.output===v.H.Occlusion?Z.MX.POINTS:Z.MX.TRIANGLES}}$.shader=new z.J(w.H,(()=>r.e(6823).then(r.bind(r,16823))));const J={factor:0,units:-4},X=(0,k.if)(Z.zi.ONE,Z.zi.ONE_MINUS_SRC_ALPHA);class Y extends j.m{constructor(){super(...arguments),this.output=v.H.Color,this.occlusionTestEnabled=!0,this.sdf=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.screenSizePerspective=!1,this.screenCenterOffsetUnitsEnabled=_.d9.World,this.debugDrawLabelBorder=!1,this.binaryHighlightOcclusion=!0,this.slicePlaneEnabled=!1,this.polygonOffsetEnabled=!1,this.depthEnabled=!0,this.transparencyPassType=G.Am.NONE,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.multipassGeometryEnabled=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,P._)([(0,j.o)({count:v.H.COUNT})],Y.prototype,"output",void 0),(0,P._)([(0,j.o)()],Y.prototype,"occlusionTestEnabled",void 0),(0,P._)([(0,j.o)()],Y.prototype,"sdf",void 0),(0,P._)([(0,j.o)()],Y.prototype,"vvSize",void 0),(0,P._)([(0,j.o)()],Y.prototype,"vvColor",void 0),(0,P._)([(0,j.o)()],Y.prototype,"verticalOffset",void 0),(0,P._)([(0,j.o)()],Y.prototype,"screenSizePerspective",void 0),(0,P._)([(0,j.o)({count:_.d9.COUNT})],Y.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,P._)([(0,j.o)()],Y.prototype,"debugDrawLabelBorder",void 0),(0,P._)([(0,j.o)()],Y.prototype,"binaryHighlightOcclusion",void 0),(0,P._)([(0,j.o)()],Y.prototype,"slicePlaneEnabled",void 0),(0,P._)([(0,j.o)()],Y.prototype,"polygonOffsetEnabled",void 0),(0,P._)([(0,j.o)()],Y.prototype,"depthEnabled",void 0),(0,P._)([(0,j.o)({count:G.Am.COUNT})],Y.prototype,"transparencyPassType",void 0),(0,P._)([(0,j.o)()],Y.prototype,"pixelSnappingEnabled",void 0),(0,P._)([(0,j.o)()],Y.prototype,"isDraped",void 0),(0,P._)([(0,j.o)()],Y.prototype,"multipassGeometryEnabled",void 0),(0,P._)([(0,j.o)()],Y.prototype,"multipassTerrainEnabled",void 0),(0,P._)([(0,j.o)()],Y.prototype,"cullAboveGround",void 0);class K extends x.F5{constructor(e){super(e,ye),this.techniqueConfig=new Y}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?_.d9.Screen:_.d9.World,this.techniqueConfig.polygonOffsetEnabled=this.parameters.polygonOffset,this.techniqueConfig.isDraped=this.parameters.isDraped,this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this.techniqueConfig.sdf=this.parameters.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.parameters.vvColorEnabled,e===v.H.Color&&(this.techniqueConfig.debugDrawLabelBorder=!!this.parameters.debugDrawLabelBorder),e===v.H.Highlight&&(this.techniqueConfig.binaryHighlightOcclusion=this.parameters.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.parameters.depthEnabled,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassGeometryEnabled=t.multipassGeometryEnabled,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}intersect(e,t,r,i,o,s,a,l,c){(0,n.pC)(c)?this._intersectDrapedHudGeometry(e,s,a,l,c):this._intersectHudGeometry(e,t,r,i,a,l)}_intersectDrapedHudGeometry(e,t,r,i,o){const s=e.vertexAttributes.get(C.T.POSITION),a=e.vertexAttributes.get(C.T.SIZE),l=this.parameters,c=(0,w.c)(l);let d=1,h=1;if((0,n.pC)(i)){const e=i(fe);d=e[0],h=e[5]}d*=e.screenToWorldRatio,h*=e.screenToWorldRatio;const u=ge*e.screenToWorldRatio;for(let n=0;n<s.data.length/s.size;n++){const i=n*s.size,p=s.data[i],f=s.data[i+1],m=n*a.size;let g;ve[0]=a.data[m]*d,ve[1]=a.data[m+1]*h,l.textureIsSignedDistanceField&&(g=l.outlineSize*e.screenToWorldRatio/2),te(t,p,f,ve,u,g,l,c)&&r(o.dist,o.normal,-1,!0)}}_intersectHudGeometry(e,t,r,i,o,a){if(!i.options.selectionMode||!i.options.hud||(0,R.PD)(t))return;const c=this.parameters;let d=1,h=1;if((0,s.f)(ce,r),(0,n.pC)(a)){const e=a(fe);d=e[0],h=e[5],function(e){const t=e[0],r=e[1],i=e[2],n=e[3],o=e[4],s=e[5],a=e[6],l=e[7],c=e[8],d=1/Math.sqrt(t*t+r*r+i*i),h=1/Math.sqrt(n*n+o*o+s*s),u=1/Math.sqrt(a*a+l*l+c*c);e[0]=t*d,e[1]=r*d,e[2]=i*d,e[3]=n*h,e[4]=o*h,e[5]=s*h,e[6]=a*u,e[7]=l*u,e[8]=c*u}(ce)}const f=e.vertexAttributes.get(C.T.POSITION),m=e.vertexAttributes.get(C.T.SIZE),g=e.vertexAttributes.get(C.T.NORMAL),v=e.vertexAttributes.get(C.T.AUXPOS1);(0,S.hu)(f.size>=3);const _=i.point,y=i.camera,T=(0,w.c)(c);d*=y.pixelRatio,h*=y.pixelRatio;const x="screen"===this.parameters.centerOffsetUnits;for(let n=0;n<f.data.length/f.size;n++){const e=n*f.size;(0,u.s)(ne,f.data[e],f.data[e+1],f.data[e+2]),(0,u.m)(ne,ne,r);const t=n*m.size;ve[0]=m.data[t]*d,ve[1]=m.data[t+1]*h,(0,u.m)(ne,ne,y.viewMatrix);const s=n*v.size;if((0,u.s)(ue,v.data[s+0],v.data[s+1],v.data[s+2]),!x&&(ne[0]+=ue[0],ne[1]+=ue[1],0!==ue[2])){const e=ue[2];(0,u.n)(ue,ne),(0,u.f)(ne,ne,(0,u.a)(ue,ue,e))}const a=n*g.size;if((0,u.s)(oe,g.data[a],g.data[a+1],g.data[a+2]),this._normalAndViewAngle(oe,ce,y,pe),this._applyVerticalOffsetTransformationView(ne,pe,y,re),y.applyProjection(ne,se),se[0]>-1){let e=Math.floor(se[0])+this.parameters.screenOffset[0],t=Math.floor(se[1])+this.parameters.screenOffset[1];x&&(e+=ue[0],0!==ue[1]&&(t+=(0,O.sX)(ue[1],re.factorAlignment))),(0,O.TU)(ve,re.factor,ve);const r=me*y.pixelRatio;let n;if(c.textureIsSignedDistanceField&&(n=c.outlineSize*y.pixelRatio/2),te(_,e,t,ve,r,n,c,T)){const e=i.ray;if((0,u.m)(le,ne,(0,l.a)(he,y.viewMatrix)),se[0]=_[0],se[1]=_[1],y.unprojectFromRenderScreen(se,ne)){const t=(0,p.c)();(0,u.g)(t,e.direction);const r=1/(0,u.l)(t);(0,u.a)(t,t,r),o((0,u.i)(e.origin,ne)*r,t,-1,!0,1,le)}}}}}computeAttachmentOrigin(e,t){const r=e.vertexAttributes;if(!r)return!1;const i=r.get(C.T.POSITION),n=e.indices.get(C.T.POSITION);return(0,y.NO)(i,n,t)}createBufferWriter(){return new xe(this)}_normalAndViewAngle(e,t,r,i){return f(t)&&(t=(0,s.f)(de,t)),(0,u.t)(i.normal,e,t),(0,u.m)(i.normal,i.normal,r.viewInverseTransposeMatrix),i.cosAngle=(0,u.d)(ae,_e),i}_updateScaleInfo(e,t,r){const i=this.parameters;i.screenSizePerspective?(0,O.PV)(r,t,i.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),i.screenSizePerspectiveAlignment?(0,O.PV)(r,t,i.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}applyShaderOffsetsView(e,t,r,i,n,o,s){const a=this._normalAndViewAngle(t,r,n,pe);return this._applyVerticalGroundOffsetView(e,a,n,s),this._applyVerticalOffsetTransformationView(s,a,n,o),this._applyPolygonOffsetView(s,a,i[3],n,s),this._applyCenterOffsetView(s,i,s),s}applyShaderOffsetsNDC(e,t,r,i,o){return this._applyCenterOffsetNDC(e,t,r,i),(0,n.pC)(o)&&(0,u.g)(o,i),this._applyPolygonOffsetNDC(i,t,r,i),i}_applyPolygonOffsetView(e,t,r,n,o){const s=n.aboveGround?1:-1;let a=Math.sign(r);0===a&&(a=s);const l=s*a;if(this.parameters.shaderPolygonOffset<=0)return(0,u.g)(o,e);const c=(0,i.uZ)(Math.abs(t.cosAngle),.01,1),d=1-Math.sqrt(1-c*c)/c/n.viewport[2];return(0,u.a)(o,e,l>0?d:1/d),o}_applyVerticalGroundOffsetView(e,t,r,i){const n=(0,u.l)(e),o=r.aboveGround?1:-1,s=.5*r.computeRenderPixelSizeAtDist(n),a=(0,u.a)(ne,t.normal,o*s);return(0,u.b)(i,e,a),i}_applyVerticalOffsetTransformationView(e,t,r,i){const n=this.parameters;if(!n.verticalOffset||!n.verticalOffset.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const r=(0,u.l)(e);this._updateScaleInfo(i,r,t.cosAngle)}else i.factor.scale=1,i.factorAlignment.scale=1;return e}const o=(0,u.l)(e),s=n.screenSizePerspectiveAlignment||n.screenSizePerspective,a=(0,A.Hx)(r,o,n.verticalOffset,t.cosAngle,s);return this._updateScaleInfo(i,o,t.cosAngle),(0,u.a)(t.normal,t.normal,a),(0,u.b)(e,e,t.normal)}_applyCenterOffsetView(e,t,r){const i="screen"!==this.parameters.centerOffsetUnits;return r!==e&&(0,u.g)(r,e),i&&(r[0]+=t[0],r[1]+=t[1],t[2]&&((0,u.n)(oe,r),(0,u.b)(r,r,(0,u.a)(oe,oe,t[2])))),r}_applyCenterOffsetNDC(e,t,r,i){const n="screen"!==this.parameters.centerOffsetUnits;return i!==e&&(0,u.g)(i,e),n||(i[0]+=t[0]/r.fullWidth*2,i[1]+=t[1]/r.fullHeight*2),i}_applyPolygonOffsetNDC(e,t,r,i){const n=this.parameters.shaderPolygonOffset;if(e!==i&&(0,u.g)(i,e),n){const e=r.aboveGround?1:-1,o=e*Math.sign(t[3]);i[2]-=(o||e)*n}return i}requiresSlot(e){if(e===b.r.DRAPED_MATERIAL)return!0;const{drawInSecondSlot:t,occlusionTest:r}=this.parameters;return e===(t?b.r.LABEL_MATERIAL:b.r.HUD_MATERIAL)||r&&e===b.r.OCCLUSION_PIXELS}createGLMaterial(e){return e.output===v.H.Color||e.output===v.H.Alpha?new ee(e):e.output===v.H.Highlight?new Q(e):null}calculateRelativeScreenBounds(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,m.Ue)();return function(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ie;(0,d.c)(i,e.anchorPos),i[0]*=-t[0],i[1]*=-t[1],i[0]+=e.screenOffset[0]*r,i[1]+=e.screenOffset[1]*r}(this.parameters,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r}}class Q extends T.Z{constructor(e){super({...e,...e.material.parameters})}updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this.selectProgram(e)}selectProgram(e){return this.ensureTechnique($,e)}beginSlot(e){return this.updateParameters(e)}bind(e,t){this.bindTextures(t.program),this.bindTextureScale(t.program),t.bindPass(this._material.parameters,e)}}class ee extends Q{_isOcclusionSlot(e){return e.slot===b.r.OCCLUSION_PIXELS&&this._material.parameters.occlusionTest&&(this._output===v.H.Color||this._output===v.H.Alpha)}selectProgram(e){return this.ensureTechnique($,e,this._isOcclusionSlot(e)?v.H.Occlusion:this._output)}bind(e,t){this._isOcclusionSlot(e)||(this.bindTextures(t.program),this.bindTextureScale(t.program)),t.bindPass(this._material.parameters,e)}}function te(e,t,r,i,n,o,s,a){let l=t-n-(a[0]>0?i[0]*a[0]:0),c=l+i[0]+2*n,d=r-n-(a[1]>0?i[1]*a[1]:0),h=d+i[1]+2*n;if(s.textureIsSignedDistanceField){const e=s.distanceFieldBoundingBox;l+=i[0]*e[0],d+=i[1]*e[1],c-=i[0]*(1-e[2]),h-=i[1]*(1-e[3]),l-=o,c+=o,d-=o,h+=o}return e[0]>l&&e[0]<c&&e[1]>d&&e[1]<h}const re={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},ie=(0,h.a)(),ne=(0,p.c)(),oe=(0,p.c)(),se=(0,o.J$)(),ae=(0,p.c)(),le=(0,p.c)(),ce=(0,a.c)(),de=(0,a.c)(),he=(0,c.c)(),ue=(0,p.c)(),pe={normal:ae,cosAngle:0},fe=(0,c.c)(),me=1,ge=2,ve=[0,0],_e=(0,p.f)(0,0,1),ye={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:(0,h.f)(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawLabelBorder:!1,isDraped:!1,...x.mo},Te=(0,g.U$)().vec3f(C.T.POSITION).vec3f(C.T.NORMAL).vec2f(C.T.UV0).vec4u8(C.T.COLOR).vec2f(C.T.SIZE).vec4f(C.T.AUXPOS1).vec4f(C.T.AUXPOS2);class xe{constructor(e){this.material=e,this.vertexBufferLayout=Te}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get(C.T.POSITION).length}write(e,t,r,i){(0,E.ho)(t.indices.get(C.T.POSITION),t.vertexAttributes.get(C.T.POSITION).data,e.transformation,r.position,i,6),(0,E.s5)(t.indices.get(C.T.NORMAL),t.vertexAttributes.get(C.T.NORMAL).data,e.invTranspTransformation,r.normal,i,6);{const e=t.vertexAttributes.get(C.T.UV0).data;let n,o,s,a;if(null==e||e.length<4){const e=this.material.parameters;n=0,o=0,s=e.texCoordScale[0],a=e.texCoordScale[1]}else n=e[0],o=e[1],s=e[2],a=e[3];s=Math.min(1.99999,s+1),a=Math.min(1.99999,a+1);const l=t.indices.get(C.T.POSITION).length,c=r.uv0;let d=i;for(let t=0;t<l;++t)c.set(d,0,n),c.set(d,1,o),d+=1,c.set(d,0,s),c.set(d,1,o),d+=1,c.set(d,0,s),c.set(d,1,a),d+=1,c.set(d,0,s),c.set(d,1,a),d+=1,c.set(d,0,n),c.set(d,1,a),d+=1,c.set(d,0,n),c.set(d,1,o),d+=1}(0,E.Vs)(t.indices.get(C.T.COLOR),t.vertexAttributes.get(C.T.COLOR).data,4,r.color,i,6);{const e=t.indices.get(C.T.SIZE),n=t.vertexAttributes.get(C.T.SIZE).data,o=e.length,s=r.size;let a=i;for(let t=0;t<o;++t){const r=n[2*e[t]],i=n[2*e[t]+1];for(let e=0;e<6;++e)s.set(a,0,r),s.set(a,1,i),a+=1}}t.indices.get(C.T.AUXPOS1)&&t.vertexAttributes.get(C.T.AUXPOS1)&&(0,E.SW)(t.indices.get(C.T.AUXPOS1),t.vertexAttributes.get(C.T.AUXPOS1).data,r.auxpos1,i,6),t.indices.get(C.T.AUXPOS2)&&t.vertexAttributes.get(C.T.AUXPOS2)&&(0,E.SW)(t.indices.get(C.T.AUXPOS2),t.vertexAttributes.get(C.T.AUXPOS2).data,r.auxpos2,i,6)}}},99196:(e,t,r)=>{r.d(t,{Y:()=>j});var i=r(32718),n=r(92026),o=r(17842),s=r(88396),a=r(11186),l=r(71353),c=r(95773),d=r(85981),h=r(55652),u=r(25158),p=r(71011),f=r(81935),m=r(23620),g=r(56529),v=r(93822),_=r(97731),y=r(4760),T=r(33236),x=r(64226),b=r(22909),O=r(32683),S=r(27366),C=r(33280),E=r(137),A=r(41012),R=r(82144),w=r(31132),P=r(33559),I=r(7566),D=r(27627),M=r(50411),H=r(99337),N=r(8548),L=r(36207);class F extends w.A{constructor(e,t,r){super(e,t,r),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==p.H.Highlight}initializeProgram(e){const t=F.shader.get(),r=this.configuration,i=t.build({output:r.output,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:r.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleRequiresClamp:!1,stippleScaleWithLineWidth:!1,stipplePreferContinuous:r.stipplePreferContinuous});return new D.$(e.rctx,i,I.i)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t){if((0,A.II)(this.program,t.camera.projectionMatrix),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.stippleEnabled){const{pixelSize:e,sdfNormalizer:r,pixels:i}=(0,n.pC)(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};this.program.setUniform1f("stipplePatternSDFNormalizer",r),this.program.setUniform1f("stipplePatternTextureSize",i),this.program.setUniform1f("stipplePatternPixelSize",e),this.program.setUniform1f("stipplePatternPixelSizeInv",1/e),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/t.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),this.program.setUniform2f("ndcToPixel",t.camera.fullViewport[2]/2,t.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",e.color),this.program.setUniform1f("alphaCoverage",Math.min(1,e.width*t.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const t=(0,n.Wg)(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}this.configuration.output===p.H.Highlight&&(0,E.wW)(this.program,t)}bindDraw(e){(0,A.id)(this.program,e),this.stippleEnabled&&!this.configuration.draped&&(0,A.fb)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),(0,C.DA)(this.program,this.configuration,e),this.program.rebindTextures()}initializePipeline(){const e=this.configuration,t=(0,L.wK)(N.zi.SRC_ALPHA,N.zi.ONE,N.zi.ONE_MINUS_SRC_ALPHA,N.zi.ONE_MINUS_SRC_ALPHA),r=function(t){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,L.sm)({blending:r,depthTest:M.JN,depthWrite:i,colorWrite:L.BK,stencilWrite:e.sceneHasOcludees?M.s3:null,stencilTest:e.sceneHasOcludees?t?M.eD:M.RY:null})};return e.output===p.H.Color?(this._occludeePipelineState=r(!0,e.transparent||this.stippleEnabled?t:null,L.LZ),r(!1,e.transparent||this.stippleEnabled?t:null,L.LZ)):r(!1)}get primitiveType(){return N.MX.LINES}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}F.shader=new R.J(H.N,(()=>r.e(8569).then(r.bind(r,78569))));class U extends P.m{constructor(){super(...arguments),this.output=p.H.Color,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.sceneHasOcludees=!1}}(0,S._)([(0,P.o)({count:p.H.COUNT})],U.prototype,"output",void 0),(0,S._)([(0,P.o)()],U.prototype,"slicePlaneEnabled",void 0),(0,S._)([(0,P.o)()],U.prototype,"vertexColors",void 0),(0,S._)([(0,P.o)()],U.prototype,"transparent",void 0),(0,S._)([(0,P.o)()],U.prototype,"draped",void 0),(0,S._)([(0,P.o)()],U.prototype,"stippleEnabled",void 0),(0,S._)([(0,P.o)()],U.prototype,"stippleOffColorEnabled",void 0),(0,S._)([(0,P.o)()],U.prototype,"stipplePreferContinuous",void 0),(0,S._)([(0,P.o)()],U.prototype,"sceneHasOcludees",void 0);const z=i.Z.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");var V;!function(e){e[e.START=0]="START",e[e.END=1]="END"}(V||(V={}));class j extends g.F5{constructor(e){super(e,W),this._techniqueConfig=new U}getTechniqueConfig(e,t){this._techniqueConfig.output=e,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.vertexColors=this.parameters.vertexColors,this._techniqueConfig.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._techniqueConfig.draped=t.slot===v.r.DRAPED_MATERIAL;const r=(0,n.pC)(this.parameters.stipplePattern);return this._techniqueConfig.stippleEnabled=r,this._techniqueConfig.stippleOffColorEnabled=r&&(0,n.pC)(this.parameters.stippleOffColor),this._techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this._techniqueConfig.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._techniqueConfig}getPassParameters(){return this.parameters}intersect(e,t,r,i,o,s,a,l,c){(0,n.pC)(c)?(0,b.TT)(e,i,c,s,1,a):this._intersectLineGeometry(e,t,r,i,a)}_intersectLineGeometry(e,t,r,i,n){if(!i.options.selectionMode||(0,O.PD)(t))return;if(!(0,_.kG)(r))return void z.error("intersection assumes a translation-only matrix");const o=e.vertexAttributes.get(y.T.POSITION).data,l=i.camera,u=te;(0,s.c)(u,i.point);(0,a.s)(re[0],u[0]-2,u[1]+2,0),(0,a.s)(re[1],u[0]+2,u[1]+2,0),(0,a.s)(re[2],u[0]+2,u[1]-2,0),(0,a.s)(re[3],u[0]-2,u[1]-2,0);for(let s=0;s<4;s++)if(!l.unprojectFromRenderScreen(re[s],ie[s]))return;(0,h.zk)(l.eye,ie[0],ie[1],ne),(0,h.zk)(l.eye,ie[1],ie[2],oe),(0,h.zk)(l.eye,ie[2],ie[3],se),(0,h.zk)(l.eye,ie[3],ie[0],ae);let p=Number.MAX_VALUE,f=0;for(let s=0;s<o.length-5;s+=3){if(q[0]=o[s]+r[12],q[1]=o[s+1]+r[13],q[2]=o[s+2]+r[14],Z[0]=o[s+3]+r[12],Z[1]=o[s+4]+r[13],Z[2]=o[s+5]+r[14],(0,h.jH)(ne,q)<0&&(0,h.jH)(ne,Z)<0||(0,h.jH)(oe,q)<0&&(0,h.jH)(oe,Z)<0||(0,h.jH)(se,q)<0&&(0,h.jH)(se,Z)<0||(0,h.jH)(ae,q)<0&&(0,h.jH)(ae,Z)<0)continue;if(l.projectToRenderScreen(q,J),l.projectToRenderScreen(Z,X),J[2]<0&&X[2]>0){(0,a.f)(k,q,Z);const e=l.frustum,t=-(0,h.jH)(e[c.Nu.NEAR],q)/(0,a.d)(k,(0,h.mJ)(e[c.Nu.NEAR]));(0,a.a)(k,k,t),(0,a.b)(q,q,k),l.projectToRenderScreen(q,J)}else if(J[2]>0&&X[2]<0){(0,a.f)(k,Z,q);const e=l.frustum,t=-(0,h.jH)(e[c.Nu.NEAR],Z)/(0,a.d)(k,(0,h.mJ)(e[c.Nu.NEAR]));(0,a.a)(k,k,t),(0,a.b)(Z,Z,k),l.projectToRenderScreen(Z,X)}else if(J[2]<0&&X[2]<0)continue;J[2]=0,X[2]=0;const e=(0,d.Jk)((0,d.zk)(J,X,Q),u);e<p&&(p=e,(0,a.g)(Y,q),(0,a.g)(K,Z),f=s/3)}const m=i.rayBegin,g=i.rayEnd;if(p<4){let e=Number.MAX_VALUE;if((0,d.AR)((0,d.zk)(Y,K,Q),(0,d.zk)(m,g,ee),$)){(0,a.f)($,$,m);const t=(0,a.l)($);(0,a.a)($,$,1/t),e=t/(0,a.i)(m,g)}n(e,$,f,!1)}}computeAttachmentOrigin(e,t){const r=e.vertexAttributes;if(!r)return!1;const i=r.get(y.T.POSITION);return(0,f.qZ)(i,null,!1,t)}requiresSlot(e){return e===v.r.OPAQUE_MATERIAL||e===v.r.DRAPED_MATERIAL}createGLMaterial(e){return e.output===p.H.Color||e.output===p.H.Highlight?new G(e):null}createBufferWriter(){const e=this.parameters.vertexColors?x.IM:x.wp;return(0,n.Wi)(this.parameters.stipplePattern)?new x.G_(e):new B(e.clone().vec3f(y.T.AUXPOS1).vec2f(y.T.UV0))}}class G extends m.Z{updateParameters(e){return this.ensureTechnique(F,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output===p.H.Color&&this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}class B{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(y.T.POSITION).length}write(e,t,r,i){(0,T.NK)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,i),this._writeAuxpos1(e,t,r,i),this._writeUV0(e,t,r,i)}_writeAuxpos1(e,t,r,i){const n=r.getField(y.T.AUXPOS1,u.ct),o=t.indices.get(y.T.POSITION),s=t.vertexAttributes.get(y.T.POSITION).data,a=e.transformation,l=n.typedBufferStride,c=n.typedBuffer;i*=l;for(let d=0;d<o.length-1;d+=2)for(const e of[1,0]){const t=3*o[d+e],r=s[t],n=s[t+1],h=s[t+2],u=a[0]*r+a[4]*n+a[8]*h+a[12],p=a[1]*r+a[5]*n+a[9]*h+a[13],f=a[2]*r+a[6]*n+a[10]*h+a[14];c[i]=u,c[i+1]=p,c[i+2]=f,i+=l}}_writeUV0(e,t,r,i){var n;const o=r.getField(y.T.UV0,u.Eu),s=t.indices.get(y.T.POSITION),l=t.vertexAttributes.get(y.T.POSITION).data,c=null==(n=t.vertexAttributes.get(y.T.DISTANCETOSTART))?void 0:n.data,d=e.transformation,h=o.typedBufferStride,p=o.typedBuffer;let f=0;p[i*=h]=V.START,p[i+1]=f,i+=h;const m=3*s[0],g=(0,a.s)(q,l[m],l[m+1],l[m+2]);d&&(0,a.m)(g,g,d);const v=Z,_=s.length-1;let T=1;const x=c?(e,t,r)=>f=c[r]:(e,t,r)=>f+=(0,a.i)(e,t);for(let u=1;u<_;u+=2){const e=3*s[u];(0,a.s)(v,l[e],l[e+1],l[e+2]),d&&(0,a.m)(v,v,d),x(g,v,T++);for(let t=0;t<2;++t)p[i]=1-t,p[i+1]=f,i+=h;(0,a.g)(g,v)}const b=3*s[_];(0,a.s)(v,l[b],l[b+1],l[b+2]),d&&(0,a.m)(v,v,d),x(g,v,T),p[i]=V.END,p[i+1]=f}}const W={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleOffColor:null,stipplePreferContinuous:!0,sceneHasOcludees:!1,...g.mo},q=(0,l.c)(),Z=(0,l.c)(),k=(0,l.c)(),$=(0,l.c)(),J=(0,o.J$)(),X=(0,o.J$)(),Y=(0,l.c)(),K=(0,l.c)(),Q=(0,d.Ue)(),ee=(0,d.Ue)(),te=(0,l.c)(),re=[(0,o.J$)(),(0,o.J$)(),(0,o.J$)(),(0,o.J$)()],ie=[(0,l.c)(),(0,l.c)(),(0,l.c)(),(0,l.c)()],ne=(0,h.Ue)(),oe=(0,h.Ue)(),se=(0,h.Ue)(),ae=(0,h.Ue)()},58901:(e,t,r)=>{r.d(t,{U:()=>$});var i=r(32718),n=r(16889),o=r(92026),s=r(17842),a=r(88396),l=r(11186),c=r(71353),d=r(95773),h=r(85981),u=r(55652),p=r(55158),f=r(71011),m=r(81935),g=r(23620),v=r(94425),_=r(56529),y=r(93822),T=r(97731),x=r(4760),b=r(62930),O=r(32683),S=r(98186),C=r(27366),E=r(14226),A=r(11185),R=r(33280),w=r(137),P=r(15226),I=r(18607),D=r(41012),M=r(82144),H=r(31132),N=r(33559),L=r(68401),F=r(78041),U=r(27627),z=r(50411),V=r(8548),j=r(36207);const G=new Map([[x.T.POSITION,0],[x.T.SUBDIVISIONFACTOR,1],[x.T.UV0,2],[x.T.AUXPOS1,3],[x.T.AUXPOS2,4],[x.T.SIZE,6],[x.T.SIZEFEATUREATTRIBUTE,6],[x.T.COLOR,5],[x.T.COLORFEATUREATTRIBUTE,5],[x.T.OPACITYFEATUREATTRIBUTE,7]]);class B extends H.A{constructor(e,t,r){super(e,t,r),this.stippleTextureRepository=e.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==f.H.Highlight}initializeProgram(e){const t=B.shader.get(),r=this.configuration,i=t.build({oitEnabled:r.transparencyPassType===L.Am.Color,output:r.output,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:r.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleRequiresClamp:!0,stippleScaleWithLineWidth:r.stippleScaleWithLineWidth,stipplePreferContinuous:r.stipplePreferContinuous,capType:r.capType,roundJoins:r.roundJoins,vvColor:r.vvColor,vvSize:r.vvSize,vvInstancingEnabled:!0,vvOpacity:r.vvOpacity,falloffEnabled:r.falloffEnabled,innerColorEnabled:r.innerColorEnabled,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround,wireframe:r.wireframe});return new U.$(e.rctx,i,G)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t){if((0,D.II)(this.program,t.camera.projectionMatrix),this.configuration.output===f.H.Highlight&&(0,w.wW)(this.program,t),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,P.p)(this.program,t)),this.program.setUniform1f("intrinsicWidth",e.width),this.program.setUniform4fv("intrinsicColor",e.color),this.program.setUniform1f("miterLimit","miter"!==e.join?0:e.miterLimit),this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio),this.program.setUniform2f("screenSize",t.camera.fullViewport[2],t.camera.fullViewport[3]),(0,I.s0)(this.program,e),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.stippleEnabled){const{pixelSize:r,sdfNormalizer:i,pixels:n}=(0,o.pC)(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};if(this.program.setUniform1f("stipplePatternSDFNormalizer",i),this.program.setUniform1f("stipplePatternTextureSize",n),this.program.setUniform1f("stipplePatternPixelSize",r),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/t.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),this.configuration.stippleOffColorEnabled){const t=(0,o.Wg)(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",e.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",(0,o.Pt)(e.innerColor,e.color)),this.program.setUniform1f("innerWidth",e.innerWidth*t.camera.pixelRatio))}bindDraw(e){(0,D.id)(this.program,e),this.stippleEnabled&&!this.configuration.draped&&(0,D.fb)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),(0,R.Vv)(this.program,this.configuration,e.slicePlane,{origin:e.origin,view:e.camera.viewMatrix}),this.program.setUniformMatrix4fv("inverseProjectionMatrix",(0,E.a)(A.MP.get(),e.camera.projectionMatrix)),this.program.rebindTextures()}_makePipelineState(e,t){const r=this.configuration,i=e===L.Am.NONE,n=e===L.Am.FrontFace;return(0,j.sm)({blending:r.output===f.H.Color||r.output===f.H.Alpha?i?F.wu:(0,F.j7)(e):null,depthTest:{func:(0,F.Bh)(e)},depthWrite:i?r.writeDepth&&j.LZ:(0,F.K5)(e),colorWrite:j.BK,stencilWrite:r.sceneHasOcludees?z.s3:null,stencilTest:r.sceneHasOcludees?t?z.eD:z.RY:null,polygonOffset:i||n?r.polygonOffset&&W:F.E0})}initializePipeline(){const e=this.configuration,t=e.polygonOffset&&W;return e.occluder&&(this._occluderPipelineTransparent=(0,j.sm)({blending:F.wu,polygonOffset:t,depthTest:z.zV,depthWrite:null,colorWrite:j.BK,stencilWrite:null,stencilTest:z.YD}),this._occluderPipelineOpaque=(0,j.sm)({blending:F.wu,polygonOffset:t,depthTest:z.zV,depthWrite:null,colorWrite:j.BK,stencilWrite:z.P7,stencilTest:z.ii}),this._occluderPipelineMaskWrite=(0,j.sm)({blending:null,polygonOffset:t,depthTest:z.JN,depthWrite:null,colorWrite:null,stencilWrite:z.s3,stencilTest:z.eD})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?V.MX.LINES:V.MX.TRIANGLE_STRIP}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===y.r.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===y.r.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}}B.shader=new M.J(S.R,(()=>r.e(6279).then(r.bind(r,56279))));const W={factor:0,units:-4};class q extends N.m{constructor(){super(...arguments),this.output=f.H.Color,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.capType=S.C.BUTT,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=L.Am.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1}}(0,C._)([(0,N.o)({count:f.H.COUNT})],q.prototype,"output",void 0),(0,C._)([(0,N.o)()],q.prototype,"occluder",void 0),(0,C._)([(0,N.o)()],q.prototype,"slicePlaneEnabled",void 0),(0,C._)([(0,N.o)()],q.prototype,"transparent",void 0),(0,C._)([(0,N.o)()],q.prototype,"polygonOffset",void 0),(0,C._)([(0,N.o)()],q.prototype,"writeDepth",void 0),(0,C._)([(0,N.o)()],q.prototype,"draped",void 0),(0,C._)([(0,N.o)()],q.prototype,"stippleEnabled",void 0),(0,C._)([(0,N.o)()],q.prototype,"stippleOffColorEnabled",void 0),(0,C._)([(0,N.o)()],q.prototype,"stippleScaleWithLineWidth",void 0),(0,C._)([(0,N.o)()],q.prototype,"stipplePreferContinuous",void 0),(0,C._)([(0,N.o)({count:S.C.COUNT})],q.prototype,"capType",void 0),(0,C._)([(0,N.o)()],q.prototype,"roundJoins",void 0),(0,C._)([(0,N.o)()],q.prototype,"vvSize",void 0),(0,C._)([(0,N.o)()],q.prototype,"vvColor",void 0),(0,C._)([(0,N.o)()],q.prototype,"vvOpacity",void 0),(0,C._)([(0,N.o)()],q.prototype,"falloffEnabled",void 0),(0,C._)([(0,N.o)()],q.prototype,"innerColorEnabled",void 0),(0,C._)([(0,N.o)()],q.prototype,"sceneHasOcludees",void 0),(0,C._)([(0,N.o)({count:L.Am.COUNT})],q.prototype,"transparencyPassType",void 0),(0,C._)([(0,N.o)()],q.prototype,"multipassTerrainEnabled",void 0),(0,C._)([(0,N.o)()],q.prototype,"cullAboveGround",void 0),(0,C._)([(0,N.o)()],q.prototype,"wireframe",void 0);const Z=i.Z.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");var k;!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(k||(k={}));class $ extends _.F5{constructor(e){super(e,X),this._vertexAttributeLocations=G,this.techniqueConfig=new q,this.layout=this.createLayout()}isClosed(e,t){return ee(this.parameters,e,t)}dispose(){}getPassParameters(){return this.parameters}getTechniqueConfig(e,t){this.techniqueConfig.output=e,this.techniqueConfig.draped=t.slot===y.r.DRAPED_MATERIAL;const r=(0,o.pC)(this.parameters.stipplePattern);return this.techniqueConfig.stippleEnabled=r,this.techniqueConfig.stippleOffColorEnabled=r&&(0,o.pC)(this.parameters.stippleOffColor),this.techniqueConfig.stippleScaleWithLineWidth=r&&this.parameters.stippleScaleWithLineWidth,this.techniqueConfig.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.roundJoins="round"===this.parameters.join,this.techniqueConfig.capType=this.parameters.cap,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.parameters.innerWidth>0&&(0,o.pC)(this.parameters.innerColor),this.techniqueConfig.falloffEnabled=this.parameters.falloff>0,this.techniqueConfig.occluder=this.parameters.renderOccluded===_.yD.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig.wireframe=this.parameters.wireframe,this.techniqueConfig}intersect(e,t,r,i,n,s,a,l,c){(0,o.pC)(c)?this._intersectDrapedLineGeometry(e,i,c,s,a):this._intersectLineGeometry(e,t,r,i,a)}_intersectDrapedLineGeometry(e,t,r,i,o){if(!t.options.selectionMode)return;const s=e.vertexAttributes.get(x.T.POSITION).data,a=e.vertexAttributes.get(x.T.SIZE);let l=this.parameters.width;if(this.parameters.vvSizeEnabled){const t=e.vertexAttributes.get(x.T.SIZEFEATUREATTRIBUTE).data[0];l*=(0,n.uZ)(this.parameters.vvSizeOffset[0]+t*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else a&&(l*=a.data[0]);const c=i[0],d=i[1],h=(l/2+4)*e.screenToWorldRatio;let u=Number.MAX_VALUE,p=0;for(let f=0;f<s.length-5;f+=3){const e=s[f],t=s[f+1],r=c-e,i=d-t,o=s[f+3]-e,a=s[f+4]-t,l=(0,n.uZ)((o*r+a*i)/(o*o+a*a),0,1),h=o*l-r,m=a*l-i,g=h*h+m*m;g<u&&(u=g,p=f/3)}u<h*h&&o(r.dist,r.normal,p,!1)}_intersectLineGeometry(e,t,r,i,o){if(!i.options.selectionMode||(0,O.PD)(t))return;if(!(0,T.kG)(r))return void Z.error("intersection assumes a translation-only matrix");const s=e.vertexAttributes,c=s.get(x.T.POSITION).data;let p=this.parameters.width;if(this.parameters.vvSizeEnabled){const e=s.get(x.T.SIZEFEATUREATTRIBUTE).data[0];p*=(0,n.uZ)(this.parameters.vvSizeOffset[0]+e*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else s.has(x.T.SIZE)&&(p*=s.get(x.T.SIZE).data[0]);const f=i.camera,m=oe;(0,a.c)(m,i.point);const g=p*f.pixelRatio/2+4*f.pixelRatio;(0,l.s)(me[0],m[0]-g,m[1]+g,0),(0,l.s)(me[1],m[0]+g,m[1]+g,0),(0,l.s)(me[2],m[0]+g,m[1]-g,0),(0,l.s)(me[3],m[0]-g,m[1]-g,0);for(let n=0;n<4;n++)if(!f.unprojectFromRenderScreen(me[n],ge[n]))return;(0,u.zk)(f.eye,ge[0],ge[1],ve),(0,u.zk)(f.eye,ge[1],ge[2],_e),(0,u.zk)(f.eye,ge[2],ge[3],ye),(0,u.zk)(f.eye,ge[3],ge[0],Te);let v=Number.MAX_VALUE,_=0;const y=Q(this.parameters,s,e.indices)?c.length-2:c.length-5;for(let n=0;n<y;n+=3){te[0]=c[n]+r[12],te[1]=c[n+1]+r[13],te[2]=c[n+2]+r[14];const e=(n+3)%c.length;if(re[0]=c[e]+r[12],re[1]=c[e+1]+r[13],re[2]=c[e+2]+r[14],(0,u.jH)(ve,te)<0&&(0,u.jH)(ve,re)<0||(0,u.jH)(_e,te)<0&&(0,u.jH)(_e,re)<0||(0,u.jH)(ye,te)<0&&(0,u.jH)(ye,re)<0||(0,u.jH)(Te,te)<0&&(0,u.jH)(Te,re)<0)continue;if(f.projectToRenderScreen(te,se),f.projectToRenderScreen(re,ae),se[2]<0&&ae[2]>0){(0,l.f)(ie,te,re);const e=f.frustum,t=-(0,u.jH)(e[d.Nu.NEAR],te)/(0,l.d)(ie,(0,u.mJ)(e[d.Nu.NEAR]));(0,l.a)(ie,ie,t),(0,l.b)(te,te,ie),f.projectToRenderScreen(te,se)}else if(se[2]>0&&ae[2]<0){(0,l.f)(ie,re,te);const e=f.frustum,t=-(0,u.jH)(e[d.Nu.NEAR],re)/(0,l.d)(ie,(0,u.mJ)(e[d.Nu.NEAR]));(0,l.a)(ie,ie,t),(0,l.b)(re,re,ie),f.projectToRenderScreen(re,ae)}else if(se[2]<0&&ae[2]<0)continue;se[2]=0,ae[2]=0;const t=(0,h.Jk)((0,h.zk)(se,ae,de),m);t<v&&(v=t,(0,l.g)(le,te),(0,l.g)(ce,re),_=n/3)}const b=i.rayBegin,S=i.rayEnd;if(v<g*g){let e=Number.MAX_VALUE;if((0,h.AR)((0,h.zk)(le,ce,de),(0,h.zk)(b,S,he),ne)){(0,l.f)(ne,ne,b);const t=(0,l.l)(ne);(0,l.a)(ne,ne,1/t),e=t/(0,l.i)(b,S)}o(e,ne,_,!1)}}computeAttachmentOrigin(e,t){const r=e.vertexAttributes;if(!r)return null;const i=e.indices,n=r.get(x.T.POSITION);return(0,m.qZ)(n,i?i.get(x.T.POSITION):null,i&&Q(this.parameters,r,i),t)}createLayout(){const e=(0,p.U$)().vec3f(x.T.POSITION).f32(x.T.SUBDIVISIONFACTOR).vec2f(x.T.UV0).vec3f(x.T.AUXPOS1).vec3f(x.T.AUXPOS2);return this.parameters.vvSizeEnabled?e.f32(x.T.SIZEFEATUREATTRIBUTE):e.f32(x.T.SIZE),this.parameters.vvColorEnabled?e.f32(x.T.COLORFEATUREATTRIBUTE):e.vec4f(x.T.COLOR),this.parameters.vvOpacityEnabled&&e.f32(x.T.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new Y(this.layout,this.parameters)}requiresSlot(e,t){if(e===y.r.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===_.yD.OccludeAndTransparentStencil)return e===y.r.OPAQUE_MATERIAL||e===y.r.OCCLUDER_MATERIAL||e===y.r.TRANSPARENT_OCCLUDER_MATERIAL;const r=(0,v.S)(t);return r===f.H.Color||r===f.H.Alpha?e===(this.parameters.writeDepth?y.r.TRANSPARENT_MATERIAL:y.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===y.r.OPAQUE_MATERIAL}createGLMaterial(e){return e.output===f.H.Color||e.output===f.H.Alpha||e.output===f.H.Highlight||e.output===f.H.Depth?new J(e):null}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),this._requiresTransparent(e)&&(e.transparent=!0)}_requiresTransparent(e){return!!((e.color&&e.color[3])<1||e.innerWidth>0&&this._colorRequiresTransparent(e.innerColor)||e.stipplePattern&&this._colorRequiresTransparent(e.stippleOffColor)||e.falloff>0)}_colorRequiresTransparent(e){return(0,o.pC)(e)&&e[3]<1&&e[3]>0}}class J extends g.Z{updateParameters(e){return this.ensureTechnique(B,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==f.H.Color&&this._output!==f.H.Alpha||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const X={width:0,color:[1,1,1,1],join:"miter",cap:S.C.BUTT,miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleOffColor:null,stippleScaleWithLineWidth:!1,stipplePreferContinuous:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,wireframe:!1,..._.mo,...b.S};class Y{constructor(e,t){this.parameters=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const r=t.stipplePattern?1:0;switch(this.parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=S.N+r}}_isClosed(e){return Q(this.parameters,e.vertexAttributes,e.indices)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=e.indices.get(x.T.POSITION).length/2+1,r=this._isClosed(e);let i=r?2:4;return i+=((r?t:t-1)-(r?0:1))*(2*this.numJoinSubdivisions+4),i+=2,this.parameters.wireframe&&(i=2+4*(i-2)),i}write(e,t,r,i){var n;const o=ue,s=pe,a=fe,c=t.vertexAttributes.get(x.T.POSITION).data,d=t.indices&&t.indices.get(x.T.POSITION),h=null==(n=t.vertexAttributes.get(x.T.DISTANCETOSTART))?void 0:n.data;d&&d.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let u=1,p=0;this.parameters.vvSizeEnabled?p=t.vertexAttributes.get(x.T.SIZEFEATUREATTRIBUTE).data[0]:t.vertexAttributes.has(x.T.SIZE)&&(u=t.vertexAttributes.get(x.T.SIZE).data[0]);let f=[1,1,1,1],m=0;this.parameters.vvColorEnabled?m=t.vertexAttributes.get(x.T.COLORFEATUREATTRIBUTE).data[0]:t.vertexAttributes.has(x.T.COLOR)&&(f=t.vertexAttributes.get(x.T.COLOR).data);let g=0;this.parameters.vvOpacityEnabled&&(g=t.vertexAttributes.get(x.T.OPACITYFEATUREATTRIBUTE).data[0]);const v=c.length/3,_=e.transformation,y=new Float32Array(r.buffer),T=this.vertexBufferLayout.stride/4;let b=i*T;const O=b;let S=0;const C=h?(e,t,r)=>S=h[r]:(e,t,r)=>S+=(0,l.i)(e,t),E=(e,t,r,i,n,o,s)=>{if(y[b++]=t[0],y[b++]=t[1],y[b++]=t[2],y[b++]=i,y[b++]=s,y[b++]=n,y[b++]=e[0],y[b++]=e[1],y[b++]=e[2],y[b++]=r[0],y[b++]=r[1],y[b++]=r[2],this.parameters.vvSizeEnabled?y[b++]=p:y[b++]=u,this.parameters.vvColorEnabled)y[b++]=m;else{const e=Math.min(4*o,f.length-4);y[b++]=f[e+0],y[b++]=f[e+1],y[b++]=f[e+2],y[b++]=f[e+3]}this.parameters.vvOpacityEnabled&&(y[b++]=g)};b+=T,(0,l.s)(s,c[0],c[1],c[2]),_&&(0,l.m)(s,s,_);const A=this._isClosed(t);if(A){const e=c.length-3;(0,l.s)(o,c[e],c[e+1],c[e+2]),_&&(0,l.m)(o,o,_)}else(0,l.s)(a,c[3],c[4],c[5]),_&&(0,l.m)(a,a,_),E(s,s,a,1,k.LEFT_CAP_START,0,0),E(s,s,a,1,k.RIGHT_CAP_START,0,0),(0,l.g)(o,s),(0,l.g)(s,a);const R=A?0:1,w=A?v:v-1;for(let x=R;x<w;x++){const e=(x+1)%v*3;(0,l.s)(a,c[e+0],c[e+1],c[e+2]),_&&(0,l.m)(a,a,_),C(o,s,x),E(o,s,a,0,k.LEFT_JOIN_END,x,S),E(o,s,a,0,k.RIGHT_JOIN_END,x,S);const t=this.numJoinSubdivisions;for(let r=0;r<t;++r){const e=(r+1)/(t+1);E(o,s,a,e,k.LEFT_JOIN_END,x,S),E(o,s,a,e,k.RIGHT_JOIN_END,x,S)}E(o,s,a,1,k.LEFT_JOIN_START,x,S),E(o,s,a,1,k.RIGHT_JOIN_START,x,S),(0,l.g)(o,s),(0,l.g)(s,a)}A?((0,l.s)(a,c[3],c[4],c[5]),_&&(0,l.m)(a,a,_),S=C(o,s,w),E(o,s,a,0,k.LEFT_JOIN_END,R,S),E(o,s,a,0,k.RIGHT_JOIN_END,R,S)):(S=C(o,s,w),E(o,s,s,0,k.LEFT_CAP_END,w,S),E(o,s,s,0,k.RIGHT_CAP_END,w,S)),K(y,O+T,y,O,T),b=K(y,b-T,y,b,T),this.parameters.wireframe&&this._addWireframeVertices(r,O,b,T)}_addWireframeVertices(e,t,r,i){const n=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,r-t);let s=0;const a=e=>s=K(o,e,n,s,i);for(let l=0;l<o.length-1;l+=2*i)a(l),a(l+2*i),a(l+1*i),a(l+2*i),a(l+1*i),a(l+3*i)}}function K(e,t,r,i,n){for(let o=0;o<n;o++)r[i++]=e[t++];return i}function Q(e,t,r){return ee(e,t.get(x.T.POSITION).data,r?r.get(x.T.POSITION):null)}function ee(e,t,r){return!!e.isClosed&&(r?r.length>2:t.length>6)}const te=(0,c.c)(),re=(0,c.c)(),ie=(0,c.c)(),ne=(0,c.c)(),oe=(0,c.c)(),se=(0,s.J$)(),ae=(0,s.J$)(),le=(0,c.c)(),ce=(0,c.c)(),de=(0,h.Ue)(),he=(0,h.Ue)(),ue=(0,c.c)(),pe=(0,c.c)(),fe=(0,c.c)(),me=[(0,s.J$)(),(0,s.J$)(),(0,s.J$)(),(0,s.J$)()],ge=[(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)()],ve=(0,u.Ue)(),_e=(0,u.Ue)(),ye=(0,u.Ue)(),Te=(0,u.Ue)()},62930:(e,t,r)=>{r.d(t,{S:()=>o});var i=r(11873),n=r(8229);const o={vvSizeEnabled:!1,vvSizeMinSize:(0,n.f)(1,1,1),vvSizeMaxSize:(0,n.f)(100,100,100),vvSizeOffset:(0,n.f)(0,0,0),vvSizeFactor:(0,n.f)(1,1,1),vvSizeValue:(0,n.f)(1,1,1),vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvOpacityEnabled:!1,vvOpacityValues:[0,0,0,0,0,0,0,0],vvOpacityOpacities:[1,1,1,1,1,1,1,1],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:(0,i.c)()}},82694:(e,t,r)=>{r.d(t,{H:()=>Ae});var i=r(71011),n=r(92026),o=r(38499);class s{constructor(){this.enabled=!0,this._time=0}get time(){return(0,o.HA)(this._time)}advance(e){return(0,n.pC)(e.forcedTime)?this._time!==e.forcedTime&&(this._time=e.forcedTime,!0):!(!this.enabled||0===e.dt)&&(this._time+=e.dt,!0)}}var a=r(94425),l=r(56529),c=r(78041),d=r(93822),h=r(68401),u=r(23620),p=r(27366),f=r(93169),m=r(85015),g=r(16889),v=r(49861),_=(r(63780),r(25243),r(69912)),y=r(14226),T=r(81949),x=r(11186),b=r(71353),O=(r(48976),r(98131)),S=r(40927);r(11185);function C(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:A;return[e[0],e[1],e[2],e[3]]}function E(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:C();return(0,x.c)(r,e,t),(0,x.n)(r,r),r[3]=(0,S.EU)(e,t),r}const A=[0,0,1,0];(0,O.a)(),(0,O.a)();var R=r(4685),w=r(82144),P=r(31132),I=r(7566),D=r(27627),M=r(8548),H=r(36207);class N extends P.A{constructor(e){super(e,null,(()=>this.destroy()))}initializeProgram(e){const t=N.shader.get().build();return new D.$(e.rctx,t,I.i)}initializePipeline(){return(0,H.sm)({blending:(0,H.if)(M.zi.ONE,M.zi.SRC_ALPHA),depthTest:{func:M.wb.LEQUAL},colorWrite:H.BK})}}N.shader=new w.J(R.C,(()=>r.e(3359).then(r.bind(r,43359))));var L,F=r(46784),U=r(27135);let z=L=class extends F.wq{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new L({cloudCover:this.cloudCover})}};(0,p._)([(0,U.J)({cloudy:"cloudy"})],z.prototype,"type",void 0),(0,p._)([(0,v.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1}})],z.prototype,"cloudCover",void 0),z=L=(0,p._)([(0,_.j)("esri.views.3d.environment.CloudyWeather")],z);const V=z;var j;let G=j=class extends F.wq{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new j({fogStrength:this.fogStrength})}};(0,p._)([(0,U.J)({foggy:"foggy"})],G.prototype,"type",void 0),(0,p._)([(0,v.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1}})],G.prototype,"fogStrength",void 0),G=j=(0,p._)([(0,_.j)("esri.views.3d.environment.FoggyWeather")],G);const B=G;var W;let q=W=class extends F.wq{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new W({cloudCover:this.cloudCover,precipitation:this.precipitation})}};(0,p._)([(0,U.J)({rainy:"rainy"})],q.prototype,"type",void 0),(0,p._)([(0,v.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1}})],q.prototype,"cloudCover",void 0),(0,p._)([(0,v.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1}})],q.prototype,"precipitation",void 0),q=W=(0,p._)([(0,_.j)("esri.views.3d.environment.RainyWeather")],q);const Z=q;var k;let $=k=class extends m.Z{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5}clone(){return new k({cloudCover:this.cloudCover,precipitation:this.precipitation})}};(0,p._)([(0,U.J)({snowy:"snowy"})],$.prototype,"type",void 0),(0,p._)([(0,v.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1}})],$.prototype,"cloudCover",void 0),(0,p._)([(0,v.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1}})],$.prototype,"precipitation",void 0),$=k=(0,p._)([(0,_.j)("esri.views.3d.environment.SnowyWeather")],$);const J=$;var X;let Y=X=class extends F.wq{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new X({cloudCover:this.cloudCover})}};(0,p._)([(0,U.J)({sunny:"sunny"})],Y.prototype,"type",void 0),(0,p._)([(0,v.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1}})],Y.prototype,"cloudCover",void 0),Y=X=(0,p._)([(0,_.j)("esri.views.3d.environment.SunnyWeather")],Y);const K={key:"type",base:null,typeMap:{sunny:Y,cloudy:V,rainy:Z,snowy:J,foggy:B}};Object.keys(K.typeMap);const Q=1e4;var ee=r(32534);let te=class extends m.Z{constructor(e){super(e),this._inverseProjectionMatrix=(0,T.c)(),this._inverseViewMatrix=(0,T.c)(),this._technique=new N(e),this._vao=(0,ee.ow)(e.rctx),this._setDefaultParallax(e.radius)}destroy(){this._technique=(0,n.RY)(this._technique),this._vao=(0,n.O3)(this._vao)}render(e,t,r){this._parameters.clouds=t;const i=e.camera;if((0,n.Wi)(this._vao)||(0,n.Wi)(i))return;const o=e.rctx,s=o.useTechnique(this._technique);e.scenelightingData.setLightDirectionUniform(s),e.scenelightingData.setUniforms(s,!1,!1),(0,y.a)(this._inverseProjectionMatrix,i.projectionMatrix),(0,y.a)(this._inverseViewMatrix,i.viewMatrix),s.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),s.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),s.setUniform2f("cloudVariables",this._parameters.clouds.coverage,this._parameters.clouds.absorption),this._setParallaxParams(i.eye,r),e.cloudsCompositionParams=this._parameters,se(s,i,this._parameters),o.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),o.drawArrays(M.MX.TRIANGLE_STRIP,0,4)}get isFading(){return this._parameters.crossFade.stage!==ne.FINISHED||this._parameters.fadeInOut.stage!==ie.FINISHED||this._parameters.fadeIn.stage!==re.FINISHED||this._parameters.fadeInOutHeight.stage!==oe.FINISHED}_setDefaultParallax(e){this._parameters={parallax:{anchorPointClouds:(0,b.c)(),radius:e,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:(0,T.c)()},parallaxNew:{anchorPointClouds:(0,b.c)(),radius:e,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:(0,T.c)()},crossFade:{stage:ne.FINISHED,factor:0,distanceThresholdFactor:.3},fadeInOut:{stage:ie.FINISHED,factor:0,distanceThresholdFactor:.6},fadeIn:{stage:re.FINISHED,factor:0,distanceThresholdFactor:2},fadeInOutHeight:{stage:oe.FINISHED,factor:-1},cameraPositionLastFrame:(0,b.c)(),startTime:0,startTimeHeightFade:0,clouds:null}}_isCameraPositionFinal(e){return(0,x.y)(this._parameters.cameraPositionLastFrame,e)}_setFadeInStage(e){const t=this._isCameraPositionFinal(e);this._parameters.fadeIn.stage===re.FINISHED&&(this._parameters.fadeIn.factor=1,(0,x.g)(this._parameters.parallax.anchorPointClouds,ce),this._parameters.fadeIn.stage=re.CHANGE_ANCHOR,this._parameters.crossFade.stage=ne.FINISHED,this._parameters.fadeInOut.stage=ie.FINISHED),this._parameters.fadeIn.stage===re.CHANGE_ANCHOR&&t&&((0,x.g)(this._parameters.parallax.anchorPointClouds,ce),this._parameters.fadeIn.stage=re.FADE_IN,this._parameters.startTime=performance.now()),this._parameters.fadeIn.factor>0&&this._parameters.fadeIn.stage===re.FADE_IN&&(this._parameters.fadeIn.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeIn.factor<=0&&this._parameters.fadeIn.stage===re.FADE_IN&&(this._parameters.fadeIn.stage=re.FINISHED,this._parameters.fadeIn.factor=0)}_setCrossFadingStage(){this._parameters.crossFade.stage===ne.FINISHED&&((0,x.g)(this._parameters.parallaxNew.anchorPointClouds,ce),this._parameters.startTime=performance.now(),this._parameters.crossFade.factor=0,this._parameters.crossFade.stage=ne.CROSS_FADE),this._parameters.crossFade.factor<1&&this._parameters.crossFade.stage===ne.CROSS_FADE&&(this._parameters.crossFade.factor=(performance.now()-this._parameters.startTime)/500),this._parameters.crossFade.factor>=1&&this._parameters.crossFade.stage===ne.CROSS_FADE&&(this._parameters.crossFade.stage=ne.FINISHED,this._parameters.crossFade.factor=1,(0,x.g)(this._parameters.parallax.anchorPointClouds,this._parameters.parallaxNew.anchorPointClouds))}_setFadeInOutStage(e){this._parameters.fadeInOut.stage===ie.FINISHED&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=0,this._parameters.fadeInOut.stage=ie.FADE_OUT),this._parameters.fadeInOut.factor<1&&this._parameters.fadeInOut.stage===ie.FADE_OUT&&(this._parameters.fadeInOut.factor=(performance.now()-this._parameters.startTime)/250),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===ie.FADE_OUT&&(this._parameters.fadeInOut.factor=1,(0,x.g)(this._parameters.parallax.anchorPointClouds,ce)),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===ie.FADE_OUT&&this._isCameraPositionFinal(e)&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=1,this._parameters.fadeInOut.stage=ie.FADE_IN,this._parameters.crossFade.stage=ne.FINISHED,this._parameters.crossFade.factor=0),this._parameters.fadeInOut.factor>0&&this._parameters.fadeInOut.stage===ie.FADE_IN&&(this._parameters.fadeInOut.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeInOut.factor<=0&&this._parameters.fadeInOut.stage===ie.FADE_IN&&(this._parameters.fadeInOut.stage=ie.FINISHED,this._parameters.fadeInOut.factor=0)}_setFadeInOutHeight(e){const t=performance.now();this._parameters.startTimeHeightFade=this._parameters.fadeInOutHeight.stage===oe.FINISHED?t:this._parameters.startTimeHeightFade,e?this._parameters.fadeInOutHeight.factor+=(t-this._parameters.startTimeHeightFade)/500:this._parameters.fadeInOutHeight.factor-=(t-this._parameters.startTimeHeightFade)/500,this._parameters.startTimeHeightFade=t,this._parameters.fadeInOutHeight.factor=(0,g.uZ)(this._parameters.fadeInOutHeight.factor,0,1),this._parameters.fadeInOutHeight.stage=oe.HEIGHT_FADE}_setParallaxParams(e,t){this._parameters.fadeInOutHeight.factor<0&&(this._parameters.fadeInOutHeight.factor=(0,x.l)(e)-this._parameters.parallax.radius>Q?1:0),(0,x.n)(ce,e),(0,x.a)(ce,ce,this._parameters.parallax.radius),0===this._parameters.parallax.anchorPointClouds[0]&&0===this._parameters.parallax.anchorPointClouds[1]&&0===this._parameters.parallax.anchorPointClouds[2]&&(0,x.g)(this._parameters.parallax.anchorPointClouds,ce);const r=(0,x.l)((0,x.f)(de,this._parameters.parallax.anchorPointClouds,ce));let i=!0;r>this._parameters.fadeIn.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeIn.stage!==re.FINISHED?this._setFadeInStage(e):r>this._parameters.fadeInOut.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeInOut.stage!==ie.FINISHED?this._setFadeInOutStage(e):r>this._parameters.crossFade.distanceThresholdFactor*this._parameters.parallax.cloudsHeight&&!t||this._parameters.crossFade.stage!==ne.FINISHED?this._setCrossFadingStage():i=!1;const n=(0,x.l)(e),o=n-this._parameters.parallax.radius;(o>17e3||o<-1e4)&&this._parameters.fadeInOutHeight.factor<1?this._parameters.fadeInOutHeight.factor=1:(o>Q||o<-3500)&&this._parameters.fadeInOutHeight.factor<1?this._setFadeInOutHeight(!0):o<Q&&o>-3500&&this._parameters.fadeInOutHeight.factor>0?this._setFadeInOutHeight(!1):this._parameters.fadeInOutHeight.stage=oe.FINISHED,this._parameters.parallax.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(n*n-this._parameters.parallax.radius*this._parameters.parallax.radius,0))/n,E(ae,this._parameters.parallax.anchorPointClouds,le),this._parameters.parallax.transform=(0,T.c)(),(0,y.e)(this._parameters.parallax.transform,this._parameters.parallax.transform,le[3],le),i&&(E(ae,this._parameters.parallaxNew.anchorPointClouds,le),this._parameters.parallaxNew.transform=(0,T.c)(),(0,y.e)(this._parameters.parallaxNew.transform,this._parameters.parallaxNew.transform,le[3],le)),(0,x.g)(this._parameters.cameraPositionLastFrame,e)}};var re,ie,ne,oe;function se(e,t,r){e.bindTexture(r.clouds.cubeMap.colorTexture,"cubeMap"),e.setUniform1f("cloudsHeight",r.parallax.cloudsHeight),e.setUniformMatrix4fv("rotationMatrixClouds",r.parallax.transform),e.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",r.parallaxNew.transform),e.setUniform3fv("anchorPosition",r.parallax.anchorPointClouds),e.setUniform3fv("anchorPositionCrossFade",r.parallaxNew.anchorPointClouds),r.fadeInOut.stage!==ie.FINISHED?e.setUniform1f("totalFadeInOut",r.fadeInOutHeight.factor+Math.max((0,g.uZ)(r.fadeInOut.factor,0,1))):e.setUniform1f("totalFadeInOut",r.fadeInOutHeight.factor+Math.max((0,g.uZ)(r.fadeIn.factor,0,1))),e.setUniform1f("radiusCurvatureCorrectionFactor",r.parallax.radiusCurvatureCorrectionFactor),e.setUniform1i("crossFade",r.crossFade.stage),e.setUniform1f("crossFadeAnchorFactor",(0,g.uZ)(r.crossFade.factor,0,1)),e.setUniform1f("radius",r.parallax.radius),e.setUniform3fv("cameraPosition",t.eye)}(0,p._)([(0,v.Cb)({constructOnly:!0})],te.prototype,"rctx",void 0),(0,p._)([(0,v.Cb)({constructOnly:!0})],te.prototype,"viewingMode",void 0),(0,p._)([(0,v.Cb)({constructOnly:!0})],te.prototype,"radius",void 0),te=(0,p._)([(0,_.j)("esri.views.3d.environment.CloudsComposition")],te),function(e){e[e.FINISHED=0]="FINISHED",e[e.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",e[e.FADE_IN=2]="FADE_IN"}(re||(re={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.FADE_OUT=1]="FADE_OUT",e[e.FADE_IN=2]="FADE_IN"}(ie||(ie={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.CROSS_FADE=1]="CROSS_FADE"}(ne||(ne={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.HEIGHT_FADE=1]="HEIGHT_FADE"}(oe||(oe={}));const ae=(0,b.f)(0,0,1),le=C(),ce=(0,b.c)(),de=(0,b.c)();var he=r(33280),ue=r(137),pe=r(15226),fe=r(41481),me=r(23235),ge=r(70755),ve=r(79246),_e=r(41012),ye=r(33559),Te=r(49810);class xe extends P.A{constructor(e,t,r){super(e,t,r),this._textureRepository=e.waterTextureRepository}initializeProgram(e){const t=xe.shader.get(),r=this.configuration,i=t.build({oitEnabled:r.transparencyPassType===h.Am.Color,output:r.output,viewingMode:e.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,pbrMode:fe.f7.Water,useCustomDTRExponentForWater:!0,ssrEnabled:r.useSSR,cloudsReflectionsEnabled:(0,f.Z)("enable-feature:clouds-reflections"),highStepCount:!0,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new D.$(e.rctx,i,I.i)}bindPass(e,t){(0,_e.II)(this.program,t.camera.projectionMatrix),t.multipassTerrainEnabled&&(this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,pe.p)(this.program,t)),this.configuration.output===i.H.Color&&(t.lighting.setUniforms(this.program,!1,!1),(0,ge.O)(this.program,t),(0,f.Z)("enable-feature:clouds-reflections")&&(0,n.pC)(t.cloudsCompositionParams)&&se(this.program,t.camera,t.cloudsCompositionParams)),this.configuration.output!==i.H.Color&&this.configuration.output!==i.H.Normal||((0,ve.b)(this.program,e),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",e.color),this.configuration.output===i.H.Highlight&&(0,ue.wW)(this.program,t)}bindDraw(e){(0,_e.id)(this.program,e),this.program.rebindTextures(),this.configuration.output!==i.H.Color&&this.configuration.output!==i.H.Alpha||(0,_e.fb)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),this.configuration.output===i.H.Color&&(0,me.O2)(this.program,e),this.configuration.output!==i.H.Color&&this.configuration.output!==i.H.Alpha&&this.configuration.output!==i.H.Highlight||(0,he.DA)(this.program,this.configuration,e)}_setPipelineState(e){const t=this.configuration,r=e===h.Am.NONE,n=e===h.Am.FrontFace;return(0,H.sm)({blending:t.output!==i.H.Normal&&t.output!==i.H.Highlight&&t.transparent?r?c.wu:(0,c.j7)(e):null,depthTest:{func:(0,c.Bh)(e)},depthWrite:r?t.writeDepth&&H.LZ:(0,c.K5)(e),colorWrite:H.BK,polygonOffset:r||n?null:(0,c.je)(t.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}xe.shader=new w.J(Te.W,(()=>r.e(9106).then(r.bind(r,19106))));class be extends ye.m{constructor(){super(...arguments),this.output=i.H.Color,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=h.Am.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,p._)([(0,ye.o)({count:i.H.COUNT})],be.prototype,"output",void 0),(0,p._)([(0,ye.o)()],be.prototype,"receiveShadows",void 0),(0,p._)([(0,ye.o)()],be.prototype,"slicePlaneEnabled",void 0),(0,p._)([(0,ye.o)()],be.prototype,"transparent",void 0),(0,p._)([(0,ye.o)()],be.prototype,"enableOffset",void 0),(0,p._)([(0,ye.o)()],be.prototype,"writeDepth",void 0),(0,p._)([(0,ye.o)()],be.prototype,"useSSR",void 0),(0,p._)([(0,ye.o)()],be.prototype,"isDraped",void 0),(0,p._)([(0,ye.o)({count:h.Am.COUNT})],be.prototype,"transparencyPassType",void 0),(0,p._)([(0,ye.o)()],be.prototype,"multipassTerrainEnabled",void 0),(0,p._)([(0,ye.o)()],be.prototype,"cullAboveGround",void 0);class Oe extends u.Z{updateParameters(e){return this.ensureTechnique(xe,e)}setElapsedTimeUniform(e){const t=.001*this._material.animation.time;e.setUniform1f("timeElapsed",t*this._material.parameters.animationSpeed)}_updateShadowState(e){e.shadowMappingEnabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMappingEnabled})}_updateSSRState(e){e.ssrEnabled!==this._material.parameters.ssrEnabled&&this._material.setParameters({ssrEnabled:e.ssrEnabled})}ensureResources(e){const t=this._techniqueRep.constructionContext.waterTextureRepository;return t.ready||t.updating||t.loadTextures(e),t.ready?h.Rw.LOADED:h.Rw.LOADING}beginSlot(e){return this._output===i.H.Color&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.parameters,e),this._output!==i.H.Normal&&this._output!==i.H.Color||this.setElapsedTimeUniform(t.program)}}var Se=r(64226),Ce=r(22909),Ee=r(30895);class Ae extends l.F5{constructor(e){super(e,Ee.a),this._techniqueConfig=new be,this.animation=new s}getTechniqueConfig(e,t){return this._techniqueConfig.output=e,this._techniqueConfig.writeDepth=this.parameters.writeDepth,this._techniqueConfig.receiveShadows=this.parameters.receiveShadows,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.transparent=this.parameters.transparent,this._techniqueConfig.useSSR=this.parameters.ssrEnabled,this._techniqueConfig.isDraped=this.parameters.isDraped,this._techniqueConfig.transparencyPassType=t.transparencyPassType,this._techniqueConfig.enableOffset=t.camera.relativeElevation<c.ve,this._techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this._techniqueConfig.cullAboveGround=t.cullAboveGround,this._techniqueConfig}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<Re;const r=this.animation.advance(e);return this.animation.enabled&&r}intersect(e,t,r,i,n,o,s){(0,Ce.Bw)(e,t,i,n,o,void 0,s)}requiresSlot(e,t){switch((0,a.S)(t)){case i.H.Normal:return e===d.r.DRAPED_WATER;case i.H.Color:if(this.parameters.isDraped)return e===d.r.DRAPED_MATERIAL;break;case i.H.Highlight:return e===d.r.OPAQUE_MATERIAL||e===d.r.DRAPED_MATERIAL}let r=d.r.OPAQUE_MATERIAL;return this.parameters.transparent&&(r=this.parameters.writeDepth?d.r.TRANSPARENT_MATERIAL:d.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===r}createGLMaterial(e){if(e.output===i.H.Color&&this.parameters.isDraped)return e.output=i.H.Draped,new Oe(e);switch(e.output){case i.H.Color:case i.H.Normal:case i.H.Highlight:case i.H.Alpha:return new Oe(e)}return null}createBufferWriter(){return new Se.G_(Se.W1)}}const Re=35e3},64226:(e,t,r)=>{r.d(t,{G_:()=>c,IM:()=>l,W1:()=>a,wp:()=>s});var i=r(55158),n=r(4760),o=r(33236);const s=(0,i.U$)().vec3f(n.T.POSITION),a=(0,i.U$)().vec3f(n.T.POSITION).vec2f(n.T.UV0),l=(0,i.U$)().vec3f(n.T.POSITION).vec4u8(n.T.COLOR);class c{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(n.T.POSITION).length}write(e,t,r,i){(0,o.NK)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,i)}}},30895:(e,t,r)=>{r.d(t,{Z:()=>s,a:()=>o});var i=r(6394),n=r(56529);const o={waveStrength:.06,waveTextureRepeat:32,waveDirection:(0,i.f)(1,0),waveVelocity:.05,flowStrength:.015,flowOffset:-.5,animationSpeed:.35,color:[0,0,0,0],transparent:!0,writeDepth:!0,slicePlaneEnabled:!1,isDraped:!1,receiveShadows:!0,ssrEnabled:!1,...n.mo},s={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}}},86700:(e,t,r)=>{r.d(t,{Dp:()=>a,z5:()=>s});var i=r(92026);const n={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},o={dash:n.dash,"dash-dot":[...n.dash,...n.dot],dot:n.dot,"long-dash":n["long-dash"],"long-dash-dot":[...n["long-dash"],...n.dot],"long-dash-dot-dot":[...n["long-dash"],...n.dot,...n.dot],none:null,"short-dash":n["short-dash"],"short-dash-dot":[...n["short-dash"],...n["short-dot"]],"short-dash-dot-dot":[...n["short-dash"],...n["short-dot"],...n["short-dot"]],"short-dot":n["short-dot"],solid:null};function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return{pattern:[e,e],pixelRatio:t}}function a(e){return(0,i.pC)(e)&&"style"===e.type?function(e){return(0,i.pC)(e)?function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return(0,i.Wi)(e)?e:{pattern:e.slice(),pixelRatio:t}}(o[e],8):null}(e.style):null}}}]);
//# sourceMappingURL=1221.f678856b.chunk.js.map