"use strict";(self.webpackChunkfield_sustainability_helper=self.webpackChunkfield_sustainability_helper||[]).push([[7481],{37481:function(e,t,i){i.r(t),i.d(t,{default:function(){return x}});var r=i(15861),s=i(37762),n=i(15671),a=i(43144),u=i(87757),o=i(10064),l=i(32718),h=i(92026),c=i(65156),f=i(376),d=i(77095),y=i(20311),p=i(31904),_=i(21149),v=i(36876),m=l.Z.getLogger("esri.views.2d.layers.features.support.whereUtils"),w={getAttribute:function(e,t){return e.field(t)}};function b(e,t){return k.apply(this,arguments)}function k(){return k=(0,r.Z)(u.mark((function e(t,r){var s,n,a;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.e(8562).then(i.bind(i,48562));case 2:return s=e.sent,e.prev=3,(n=s.WhereClause.create(t,r)).isStandardized||(a=new o.Z("mapview - bad input","Unable to apply filter's definition expression, as expression is not standardized.",n),m.error(a)),e.abrupt("return",(function(e){var t=e.readArcadeFeature();return n.testFeature(t,w)}));case 9:return e.prev=9,e.t0=e.catch(3),e.abrupt("return",(m.warn("mapview-bad-where-clause","Encountered an error when evaluating where clause",t),function(e){return!0}));case 12:case"end":return e.stop()}}),e,null,[[3,9]])}))),k.apply(this,arguments)}var I=l.Z.getLogger("esri.views.2d.layers.features.controllers.FeatureFilter"),x=function(){function e(t){(0,n.Z)(this,e),this._geometryBounds=(0,c.Ue)(),this._idToVisibility=new Map,this._serviceInfo=t}return(0,a.Z)(e,[{key:"hash",get:function(){return this._hash}},{key:"check",value:function(e){return this._applyFilter(e)}},{key:"clear",value:function(){var e=this._resetAllHiddenIds();return this.update(),{show:e,hide:[]}}},{key:"invalidate",value:function(){var e=this;this._idToVisibility.forEach((function(t,i){e._idToVisibility.set(i,0)}))}},{key:"setKnownIds",value:function(e){var t,i=(0,s.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._idToVisibility.set(r,1)}}catch(n){i.e(n)}finally{i.f()}}},{key:"setTrue",value:function(e){var t=this,i=[],r=[],s=new Set(e);return this._idToVisibility.forEach((function(e,n){var a=!!(1&t._idToVisibility.get(n)),u=s.has(n);!a&&u?i.push(n):a&&!u&&r.push(n),t._idToVisibility.set(n,u?3:0)})),{show:i,hide:r}}},{key:"createQuery",value:function(){var e=this.geometry,t=this.spatialRel,i=this.where,r=this.timeExtent,s=this.objectIds;return _.Z.fromJSON({geometry:e,spatialRel:t,where:i,timeExtent:r,objectIds:s})}},{key:"update",value:function(){var e=(0,r.Z)(u.mark((function e(t,i){var r;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._hash=JSON.stringify(t),e.next=3,(0,p.j6)(t,null,i);case 3:return r=e.sent,e.next=6,Promise.all([this._setGeometryFilter(r),this._setIdFilter(r),this._setAttributeFilter(r),this._setTimeFilter(r)]);case 6:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_setAttributeFilter",value:function(){var e=(0,r.Z)(u.mark((function e(t){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.where){e.next=2;break}return e.abrupt("return",(this._clause=null,void(this.where=null)));case 2:return e.next=4,b(t.where,this._serviceInfo.fieldsIndex);case 4:this._clause=e.sent,this.where=t.where;case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_setIdFilter",value:function(e){this._idsToShow=e&&e.objectIds&&new Set(e.objectIds),this._idsToHide=e&&e.hiddenIds&&new Set(e.hiddenIds),this.objectIds=e&&e.objectIds}},{key:"_setGeometryFilter",value:function(){var e=(0,r.Z)(u.mark((function e(t){var i,r,s;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.geometry){e.next=2;break}return e.abrupt("return",(this._spatialQueryOperator=null,this.geometry=null,void(this.spatialRel=null)));case 2:return i=t.geometry,r=t.spatialRel||"esriSpatialRelIntersects",e.next=6,(0,d.cW)(r,i,this._serviceInfo.geometryType,this._serviceInfo.hasZ,this._serviceInfo.hasM);case 6:s=e.sent,(0,f.$P)(this._geometryBounds,i),this._spatialQueryOperator=s,this.geometry=i,this.spatialRel=r;case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_setTimeFilter",value:function(e){if(this.timeExtent=this._timeOperator=null,e&&e.timeExtent)if(this._serviceInfo.timeInfo)this.timeExtent=e.timeExtent,this._timeOperator=(0,y.y)(this._serviceInfo.timeInfo,e.timeExtent,v.k);else{var t=new o.Z("feature-layer-view:time-filter-not-available","Unable to apply time filter, as layer doesn't have time metadata.",e.timeExtent);I.error(t)}}},{key:"_applyFilter",value:function(e){return this._filterByGeometry(e)&&this._filterById(e)&&this._filterByTime(e)&&this._filterByExpression(e)}},{key:"_filterByExpression",value:function(e){return!this.where||this._clause(e)}},{key:"_filterById",value:function(e){return(!this._idsToHide||!this._idsToHide.size||!this._idsToHide.has(e.getObjectId()))&&(!this._idsToShow||!this._idsToShow.size||this._idsToShow.has(e.getObjectId()))}},{key:"_filterByGeometry",value:function(e){if(!this.geometry)return!0;var t=e.readHydratedGeometry();return!!t&&this._spatialQueryOperator(t)}},{key:"_filterByTime",value:function(e){return!(0,h.pC)(this._timeOperator)||this._timeOperator(e)}},{key:"_resetAllHiddenIds",value:function(){var e=this,t=[];return this._idToVisibility.forEach((function(i,r){1&i||(e._idToVisibility.set(r,1),t.push(r))})),t}}]),e}()}}]);
//# sourceMappingURL=7481.f8719a72.chunk.js.map