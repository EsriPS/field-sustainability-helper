"use strict";(self.webpackChunkfield_sustainability_helper=self.webpackChunkfield_sustainability_helper||[]).push([[1786],{97879:function(e,t,r){r.d(t,{Z:function(){return l}});var n=r(15671),a=r(43144),i=r(66978),l=function(){function e(){(0,n.Z)(this,e),this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}return(0,a.Z)(e,[{key:"add",value:function(e,t,r){this._layerById[t]=r,this._layerByName[e]=r}},{key:"featureSetByName",value:function(e){return void 0===this._layerByName[e]?this.resolvePromise(null):this.resolvePromise(this._layerByName[e])}},{key:"featureSetById",value:function(e){return void 0===this._layerById[e]?this.resolvePromise(null):this.resolvePromise(this._layerById[e])}},{key:"castToText",value:function(){return"object, FeatureSetCollection"}},{key:"resolvePromise",value:function(e){return(0,i.DB)(e)}}]),e}()},31786:function(e,t,r){r.r(t),r.d(t,{constructAssociationMetaDataFeatureSetFromUrl:function(){return ie},constructFeatureSet:function(){return ne},constructFeatureSetFromPortalItem:function(){return ye},constructFeatureSetFromRelationship:function(){return le},constructFeatureSetFromUrl:function(){return re},convertToFeatureSet:function(){return he},createFeatureSetCollectionFromMap:function(){return oe},createFeatureSetCollectionFromService:function(){return de},getPortal:function(){return ce},initialiseMetaDataCache:function(){return ee},lookupUser:function(){return fe}});var n=r(1413),a=r(15671),i=r(43144),l=r(60136),s=r(54062),u=r(37762),o=r(19545),d=r(76200),c=r(97879),f=r(67820),h=r(52639),y=r(44715),p=r(12829),_=r(89066),v=r(34333),g=r(74066),m=r(82279),F=r(29876),w=r(65247),S=r(869),k=r(48562);var b=function(){function e(){(0,a.Z)(this,e)}return(0,i.Z)(e,[{key:"clone",value:function(){var t=new e;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}},{key:"toStatisticsName",value:function(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}],[{key:"parseStatField",value:function(t,r,n){var a=new e;a.field=t;var i=k.WhereClause.create(r,n),l=function(e){if("function"===e.parseTree.type){if(0===e.parseTree.args.value.length)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");var t=k.WhereClause.create((0,w.XF)(e.parseTree.args.value[0],F.Bj.Standardised,e.parameters),e.fieldsIndex);return{name:e.parseTree.name,expr:t}}return null}(i);if(null===l)throw new Error("Invalid Statistic Function");var s=l.name.toUpperCase().trim();if("MIN"===s){if(a.typeofstat="MIN",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===s){if(a.typeofstat="MAX",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===s)a.typeofstat="COUNT",a.workingexpr=l.expr;else if("STDEV"===s){if(a.typeofstat="STDDEV",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===s){if(a.typeofstat="SUM",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===s){if(a.typeofstat="AVG",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===s){if(a.typeofstat="AVG",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==s)throw new Error("Invalid Statistic Function");if(a.typeofstat="VAR",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}return a}}]),e}(),I=r(9997),D=r(66978),C=r(78952),R=r(83040),Z=r(52410);function T(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}var x=function(e){(0,l.Z)(r,e);var t=(0,s.Z)(r);function r(e){var n;return(0,a.Z)(this,r),(n=t.call(this,e))._decodedStatsfield=[],n._decodedGroupbyfield=[],n._candosimplegroupby=!0,n.phsyicalgroupbyfields=[],n.objectIdField="ROW__ID",n._internalObjectIdField="ROW__ID",n._adaptedFields=[],n.declaredClass="esri.arcade.featureset.actions.Aggregate",n._uniqueIds=1,n._maxQuery=10,n._maxProcessing=10,n._parent=e.parentfeatureset,n._config=e,n}return(0,i.Z)(r,[{key:"isTable",value:function(){return!0}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._getFilteredSet("",null,null,null,e).then((function(e){return t._wset=e,t._wset})):(0,D.DB)(this._wset)}},{key:"_isInFeatureSet",value:function(){return F.dj.InFeatureSet}},{key:"_nextUniqueName",value:function(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;var t="T"+this._uniqueIds.toString();return e[t]=1,t}},{key:"_convertToEsriFieldType",value:function(e){return e}},{key:"_initialiseFeatureSet",value:function(){var e={},t=!1,r=1,n=this._parent?this._parent.getFieldsIndex():new Z.Z([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){for(var a=!1,i=0;i<this._config.groupbyfields.length;i++)if(this._config.groupbyfields[i].name.toLowerCase()===this.objectIdField.toLowerCase()){a=!0;break}if(!1===a)for(var l=0;l<this._config.statsfields.length;l++)if(this._config.statsfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){a=!0;break}!1===a?t=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}var s,o=(0,u.Z)(this._config.statsfields);try{for(o.s();!(s=o.n()).done;){var d=s.value,c=new b;c.field=d.name,c.tofieldname=d.name,c.workingexpr=d.expression instanceof k.WhereClause?d.expression:k.WhereClause.create(d.expression,n),c.typeofstat=T(d.statistic),this._decodedStatsfield.push(c)}}catch(U){o.e(U)}finally{o.f()}this._decodedGroupbyfield=[];var f,h=(0,u.Z)(this._config.groupbyfields);try{for(h.s();!(f=h.n()).done;){var y=f.value,_={name:y.name,singlefield:null,tofieldname:y.name,expression:y.expression instanceof k.WhereClause?y.expression:k.WhereClause.create(y.expression,n)};this._decodedGroupbyfield.push(_)}}catch(U){h.e(U)}finally{h.f()}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";var v,g=(0,u.Z)(this._parent.fields);try{for(g.s();!(v=g.n()).done;){e[v.value.name.toUpperCase()]=1}}catch(U){g.e(U)}finally{g.f()}this.types=null}else this.geometryType=F.Qk.point,this.typeIdField="",this.types=null,this.spatialReference=new C.Z({wkid:4326});this.fields=[];var m=new b;m.field=this._nextUniqueName(e),m.tofieldname=this.objectIdField,m.workingexpr=k.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),m.typeofstat="MIN",this._decodedStatsfield.push(m);var S,I=(0,u.Z)(this._decodedGroupbyfield);try{for(I.s();!(S=I.n()).done;){var D=S.value,x=new R.Z;if(D.name=this._nextUniqueName(e),x.name=D.tofieldname,x.alias=x.name,(0,w.y5)(D.expression)){var N=this._parent.getField((0,w.zR)(D.expression,F.Bj.Standardised));if(!N)throw new Error("Field is not present for Aggregation");D.name=N.name,D.singlefield=N.name,this.phsyicalgroupbyfields.push(N.name),x.type=N.type}else{x.type=this._convertToEsriFieldType((0,w.DT)(D.expression,this._parent.fields));var E=new R.Z;E.name=D.name,E.alias=E.name,this.phsyicalgroupbyfields.push(D.name),this._adaptedFields.push(new p.yN(E,D.expression)),this._candosimplegroupby=!1}this.fields.push(x)}}catch(U){I.e(U)}finally{I.f()}if(this._adaptedFields.length>0){var B,P=(0,u.Z)(this._parent.fields);try{for(P.s();!(B=P.n()).done;){var A=B.value;this._adaptedFields.push(new p.$X(A))}}catch(U){P.e(U)}finally{P.f()}}for(var L=0;L<this._decodedStatsfield.length;L++){var O=new R.Z,j=null,q=this._decodedStatsfield[L];q.field=this._nextUniqueName(e),q.tofieldname===this.objectIdField&&(this._internalObjectIdField=q.field),O.name=q.tofieldname,O.alias=O.name;var G=null!==q.workingexpr&&(0,w.y5)(q.workingexpr)?(0,w.zR)(q.workingexpr,F.Bj.Standardised):"";switch(this._decodedStatsfield[L].typeofstat){case"SUM":if(""!==G){if(!(j=this._parent.getField(G)))throw new Error("Field is not present for Aggregation");O.type=j.type}else O.type="double";break;case"MIN":case"MAX":if(""!==G){if(!(j=this._parent.getField(G)))throw new Error("Field is not present for Aggregation");O.type=j.type}else O.type="double";break;case"COUNT":O.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==G&&!(j=this._parent.getField(G)))throw new Error("Field is not present for Aggregation");O.type="double"}this.fields.push(O)}}},{key:"_canDoAggregates",value:function(){return(0,D.DB)(!1)}},{key:"_getFeatures",value:function(e,t,r,n){var a=this;-1!==t&&this._featureCache[t];var i=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,i)?this._expandPagedSet(e,i,0,0,n).then((function(){return a._getFeatures(e,t,r,n)})):(0,D.DB)("success")}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;if(""!==e)return(0,D.DB)(new g.Z([],[],!0,null));var l=null,s={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then((function(){if(null!==r)for(var e=0;e<i._decodedStatsfield.length;e++)if(!0===(0,w.hq)(r,i._decodedStatsfield[e].tofieldname)){s.nowhereclause=!0,r=null;break}if(null!==n){s.ordered=!0;for(var t=0;t<i._decodedStatsfield.length;t++)if(!0===n.scanForField(i._decodedStatsfield[t].tofieldname)){n=null,s.ordered=!1;break}if(null!==n){var a,l=(0,u.Z)(i._decodedGroupbyfield);try{for(l.s();!(a=l.n()).done;){var o=a.value;if(null===o.singlefield&&!0===n.scanForField(o.tofieldname)){n=null,s.ordered=!1;break}}}catch(d){l.e(d)}finally{l.f()}}}return!1===i._candosimplegroupby?(0,D.DB)(!1):i._parent._canDoAggregates(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,null)})).then((function(e){if(e){var t=null;r&&(t=i._reformulateWhereClauseWithoutGroupByFields(r));var u=null;return n&&(u=i._reformulateOrderClauseWithoutGroupByFields(n)),i._parent._getAggregatePagesDataSourceDefinition(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,t,u,i._internalObjectIdField).then((function(e){return i._checkCancelled(a),l=!0===s.nowhereclause?new g.Z(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===s.ordered&&e._ordered,i._clonePageDefinition(e.pagesDefinition)):new g.Z(e._candidates.slice(0),e._known.slice(0),!0===s.ordered&&e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}var o=i._parent;if(i._adaptedFields.length>0&&(o=new p.Xx({parentfeatureset:i._parent,adaptedFields:i._adaptedFields,extraFilter:null})),!0===s.nowhereclause)l=new g.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new _.Z({parentfeatureset:o,orderbyclause:new m.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}});else{var d=o;if(null!==r){var c=null;r&&(c=i._reformulateWhereClauseWithoutGroupByFields(r)),d=new f.Z({parentfeatureset:d,whereclause:c})}l=new g.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new _.Z({parentfeatureset:d,orderbyclause:new m.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}})}return l}))}},{key:"_reformulateWhereClauseWithoutStatsFields",value:function(e){var t,r=(0,u.Z)(this._decodedStatsfield);try{for(r.s();!(t=r.n()).done;){var n=t.value;e=(0,w.bB)(e,n.tofieldname,(0,w.zR)(n.workingexpr,F.Bj.Standardised),this._parent.getFieldsIndex())}}catch(a){r.e(a)}finally{r.f()}return e}},{key:"_reformulateWhereClauseWithoutGroupByFields",value:function(e){var t,r=(0,u.Z)(this._decodedGroupbyfield);try{for(r.s();!(t=r.n()).done;){var n=t.value;n.tofieldname!==n.name&&(e=(0,w.bB)(e,n.tofieldname,(0,w.zR)(n.expression,F.Bj.Standardised),this._parent.getFieldsIndex()))}}catch(a){r.e(a)}finally{r.f()}return e}},{key:"_reformulateOrderClauseWithoutGroupByFields",value:function(e){var t,r=[],n=(0,u.Z)(this._decodedGroupbyfield);try{for(n.s();!(t=n.n()).done;){var a=t.value;a.tofieldname!==a.name&&r.push({field:a.tofieldname,newfield:a.name})}}catch(i){n.e(i)}finally{n.f()}return r.length>0?e.replaceFields(r):e}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}},{key:"_refineSetBlock",value:function(e,t,r){var n=this;try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery))return this._expandPagedSet(e,this._maxQuery,0,0,r).then((function(){return n._refineSetBlock(e,t,r)}));this._checkCancelled(r);e._candidates.length;return this._refineKnowns(e,t),e._candidates.length,e._candidates.length,(0,D.DB)(e)}catch(a){return(0,D.d1)(a)}}},{key:"_expandPagedSet",value:function(e,t,r,n,a){return this._expandPagedSetFeatureSet(e,t,r,n,a)}},{key:"_getPhysicalPage",value:function(e,t,r){var n=this;return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?(0,D.Ue)((function(t,a){n._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,r,[]).then((function(e){t(e)}),a)})):this._getAgregagtePhysicalPage(e,t,r).then((function(e){var t,r=(0,u.Z)(e);try{for(r.s();!(t=r.n()).done;){var a,i=t.value,l={geometry:i.geometry,attributes:{}},s=(0,u.Z)(n._decodedGroupbyfield);try{for(s.s();!(a=s.n()).done;){var o=a.value;l.attributes[o.tofieldname]=i.attributes[o.name]}}catch(y){s.e(y)}finally{s.f()}var d,c=(0,u.Z)(n._decodedStatsfield);try{for(c.s();!(d=c.n()).done;){var f=d.value;l.attributes[f.tofieldname]=i.attributes[f.field]}}catch(y){c.e(y)}finally{c.f()}n._featureCache[l.attributes[n.objectIdField]]=new h.Z(l)}}catch(y){r.e(y)}finally{r.f()}return e.length}))}},{key:"_sequentialGetPhysicalItem",value:function(e,t,r,n){var a=this;return(0,D.Ue)((function(i,l){null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(r)),!0===e.pagesDefinition.internal.fullyResolved||0===t?i(n.length):a._nextAggregateItem(e,t,r,n,(function(l){null===l?i(n.length):(t-=1,i(a._sequentialGetPhysicalItem(e,t,r,n)))}),l)}))}},{key:"_nextAggregateItem",value:function(e,t,r,n,a,i){var l=this;try{(0,y.X)(e.pagesDefinition.internal.iterator.next()).then((function(s){if(null===s)if(null!==e.pagesDefinition.internal.workingItem){var u=l._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);n.push(u),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(u.attributes[l.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,a(null)}else e.pagesDefinition.internal.fullyResolved=!0,a(null);else{var o=l._generateAggregateHash(s);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[s],id:o};else{if(o!==e.pagesDefinition.internal.workingItem.id){var d=l._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return n.push(d),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(d.attributes[l.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[s],id:o},void a(d)}e.pagesDefinition.internal.workingItem.features.push(s)}l._nextAggregateItem(e,t,r,n,a,i)}}),i)}catch(s){i(s)}}},{key:"_calculateFieldStat",value:function(e,t,r){for(var n=[],a=0;a<e.features.length;a++)if(null!==t.workingexpr){var i=t.workingexpr.calculateValue(e.features[a]);null!==i&&n.push(i)}else n.push(null);switch(t.typeofstat){case"MIN":r.attributes[t.tofieldname]=(0,S.tj)("min",n,-1);break;case"MAX":r.attributes[t.tofieldname]=(0,S.tj)("max",n,-1);break;case"SUM":r.attributes[t.tofieldname]=(0,S.tj)("sum",n,-1);break;case"COUNT":r.attributes[t.tofieldname]=n.length;break;case"VAR":r.attributes[t.tofieldname]=(0,S.tj)("var",n,-1);break;case"STDDEV":r.attributes[t.tofieldname]=(0,S.tj)("stddev",n,-1);break;case"AVG":r.attributes[t.tofieldname]=(0,S.tj)("avg",n,-1)}return!0}},{key:"_calculateAndAppendAggregateItem",value:function(e){var t,r={attributes:{},geometry:null},n=(0,u.Z)(this._decodedGroupbyfield);try{for(n.s();!(t=n.n()).done;){var a=t.value,i=a.singlefield?e.features[0].attributes[a.singlefield]:a.expression.calculateValue(e.features[0]);r.attributes[a.tofieldname]=i}}catch(f){n.e(f)}finally{n.f()}var l,s=(0,u.Z)(this._decodedStatsfield);try{for(s.s();!(l=s.n()).done;){var o=l.value;this._calculateFieldStat(e,o,r)}}catch(f){s.e(f)}finally{s.f()}for(var d=[],c=0;c<this._decodedStatsfield.length;c++)d.push(this._calculateFieldStat(e,this._decodedStatsfield[c],r));return this._featureCache[r.attributes[this.objectIdField]]=new h.Z({attributes:r.attributes,geometry:r.geometry}),r}},{key:"_generateAggregateHash",value:function(e){var t,r="",n=(0,u.Z)(this._decodedGroupbyfield);try{for(n.s();!(t=n.n()).done;){var a=t.value,i=a.singlefield?e.attributes[a.singlefield]:a.expression.calculateValue(e);r+=null==i?":":":"+i.toString()}}catch(l){n.e(l)}finally{n.f()}return(0,I.F)(r,I.M.String)}},{key:"_stat",value:function(){return(0,D.DB)({calculated:!1})}},{key:"getFeatureByObjectId",value:function(){return(0,D.DB)(null)}}],[{key:"registerAction",value:function(){v.Z._featuresetFunctions.groupby=function(e,t){return new r({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}]),r}(v.Z),N=r(28113),E=r(45184),B=r(19191),P=r(77981),A=r(94990),L=r(83406),O=(r(35995),r(68860),r(11812),r(99837),r(34211)),j=(r(59486),r(5192)),q=r(21149),G=r(24246),U=r(77946),W=(r(93169),r(92975),r(49818)),M=r(99086),Q=(r(50689),r(54307),r(70436)),V=r(33997),z=r(62357),J=function(e){(0,l.Z)(r,e);var t=(0,s.Z)(r);function r(e){var n;return(0,a.Z)(this,r),(n=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",n._removeGeometry=!1,n._overrideFields=null,n.formulaCredential=null,n._pageJustIds=!1,n._requestStandardised=!1,n._useDefinitionExpression=!0,e.spatialReference&&(n.spatialReference=e.spatialReference),n._transparent=!0,n._maxProcessing=1e3,n._layer=e.layer,n._wset=null,void 0!==e.outFields&&(n._overrideFields=e.outFields),void 0!==e.includeGeometry&&(n._removeGeometry=!1===e.includeGeometry),n}return(0,i.Z)(r,[{key:"_maxQueryRate",value:function(){return F.tI}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(e){this._pageJustIds=e}},{key:"convertQueryToLruCacheKey",value:function(e){var t=(0,F.hd)(e.toJSON());return(0,I.F)(t,I.M.String)}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=(0,D.Ue)((function(t,r){try{if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(n){r(n)}}),r),e._layer.load()}catch(n){r(n)}}))),this._loadPromise}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e,t=[],r=(0,u.Z)(this.fields);try{for(r.s();!(e=r.n()).done;){var n=e.value;if("oid"===n.type)t.push(n);else{var a,i=(0,u.Z)(this._layer.outFields);try{for(i.s();!(a=i.n()).done;){if(a.value.toLowerCase()===n.name.toLowerCase()){t.push(n);break}}}catch(g){i.e(g)}finally{i.f()}}}}catch(g){r.e(g)}finally{r.f()}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var l,s=[],o=[],d=(0,u.Z)(this.fields);try{for(d.s();!(l=d.n()).done;){var c=l.value;if("oid"===c.type)s.push(c),o.push(c.name);else{var f,h=(0,u.Z)(this._overrideFields);try{for(h.s();!(f=h.n()).done;){if(f.value.toLowerCase()===c.name.toLowerCase()){s.push(c),o.push(c.name);break}}}catch(g){h.e(g)}finally{h.f()}}}}catch(g){d.e(g)}finally{d.f()}this.fields=s,this._overrideFields=o}if(this._layer.source&&this._layer.source.sourceJSON){var y=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=F.Bj.StandardisedNoInterval,null!=y&&y>=10.61&&(this._databaseType=F.Bj.Standardised)):null!=y&&(y>=10.5&&(this._databaseType=F.Bj.StandardisedNoInterval,this._requestStandardised=!0),y>=10.61&&(this._databaseType=F.Bj.Standardised))}this.objectIdField=this._layer.objectIdField;var p,_=(0,u.Z)(this.fields);try{for(_.s();!(p=_.n()).done;){var v=p.value;"global-id"===v.type&&(this.globalIdField=v.name)}}catch(g){_.e(g)}finally{_.f()}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"_isInFeatureSet",value:function(){return F.dj.InFeatureSet}},{key:"_refineSetBlock",value:function(e){return(0,D.DB)(e)}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):(0,D.DB)(this._wset)}},{key:"_runDatabaseProbe",value:function(e){var t=this;return(0,D.Ue)((function(r,n){try{t._ensureLoaded().then((function(){try{var a=new q.Z;a.where=e.replace("OBJECTID",t._layer.objectIdField),t._layer.queryObjectIds(a).then((function(){r(!0)}),(function(){try{r(!1)}catch(e){n(e)}}))}catch(i){n(i)}}))}catch(a){n(a)}}))}},{key:"_canUsePagination",value:function(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}},{key:"_cacheableFeatureSetSourceKey",value:function(){return this._layer.url}},{key:"pbfSupportedForQuery",value:function(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}},{key:"queryPBF",value:function(e){return e.quantizationParameters={mode:"edit"},(0,j.executeQueryPBF)(this._layer.parsedUrl,e,new Q.J({})).then((function(e){return W.default.fromJSON((0,L.cn)(e.data)).unquantize()}))}},{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}},{key:"executeQuery",value:function(e,t){var r=this,n="execute"===t?U.e:"executeForCount"===t?O.P:G.G,a="execute"===t&&this.pbfSupportedForQuery(e),i=null;if(this.recentlyUsedQueries){var l=this.convertQueryToLruCacheKey(e);null===(i=this.recentlyUsedQueries.getFromCache(l))&&(i=!0!==a?n(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(l,i),i=i.catch((function(e){throw r.recentlyUsedQueries.removeFromCache(l),e})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===i&&(i=!0!==a?n(this._layer.parsedUrl.path,e):this.queryPBF(e)),i}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;return this.databaseType().then((function(l){if(i.isTable()&&t&&null!==e&&""!==e)return new g.Z([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,r,n,a);var s="",u=!1;null!==n&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(s=n.constructClause(),u=!0);var o=new q.Z;return o.where=null===r?null===t?"1=1":"":(0,w.zR)(r,l),i._requestStandardised&&(o.sqlFormat="standard"),o.spatialRelationship=i._makeRelationshipEnum(e),o.outSpatialReference=i.spatialReference,o.orderByFields=""!==s?s.split(","):null,o.geometry=null===t?null:t,o.relationParameter=i._makeRelationshipParam(e),i.executeQuery(o,"executeForIds").then((function(e){return null===e&&(e=[]),i._checkCancelled(a),new g.Z([],e,u,null)}))}))}},{key:"_expandPagedSet",value:function(e,t,r,n,a){return this._expandPagedSetFeatureSet(e,t,r,n,a)}},{key:"_getFilteredSetUsingPaging",value:function(e,t,r,n,a){var i=this;try{var l="",s=!1;return null!==n&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(l=n.constructClause(),s=!0),this.databaseType().then((function(n){var u=null===r?null===t?"1=1":"":(0,w.zR)(r,n);i._layer.definitionExpression&&i._useDefinitionExpression&&(u=""!==u?"(("+i._layer.definitionExpression+") AND ("+u+"))":i._layer.definitionExpression);var o=i._maxQueryRate(),d=i._layer.capabilities.query.maxRecordCount;void 0!==d&&d<o&&(o=d);var c=null;if(!0===i._pageJustIds)c=new g.Z([],["GETPAGES"],s,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:l,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{var f=!0;!0===i._removeGeometry&&(f=!1);var h=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);c=new g.Z([],["GETPAGES"],s,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:h.join(","),resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:l,returnGeometry:f,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return i._expandPagedSet(c,o,0,1,a).then((function(){return c}))}))}catch(u){return(0,D.d1)(u)}}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,r){var n=this;try{var a=e.pagesDefinition.internal.lastRetrieved,i=a,l=e.pagesDefinition.internal.lastPage,s=new q.Z;return this._requestStandardised&&(s.sqlFormat="standard"),s.spatialRelationship=e.pagesDefinition.spatialRel,s.relationParameter=e.pagesDefinition.relationParam,s.outFields=e.pagesDefinition.outFields.split(","),s.num=e.pagesDefinition.resultRecordCount,s.start=e.pagesDefinition.internal.lastPage,s.geometry=e.pagesDefinition.geometry,s.where=e.pagesDefinition.where,s.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,s.returnGeometry=e.pagesDefinition.returnGeometry,s.outSpatialReference=this.spatialReference,this.executeQuery(s,"execute").then((function(t){if(n._checkCancelled(r),e.pagesDefinition.internal.lastPage!==l)return"done";for(var s=0;s<t.features.length;s++)e.pagesDefinition.internal.set[i+s]=t.features[s].attributes[n._layer.objectIdField];if(!1===n._pageJustIds)for(var u=0;u<t.features.length;u++)n._featureCache[t.features[u].attributes[n._layer.objectIdField]]=t.features[u];return(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}))}catch(u){return(0,D.d1)(u)}}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var r,n=!1,a=(0,u.Z)(t);try{for(a.s();!(r=a.n()).done;){if(r.value.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}}}catch(i){a.e(i)}finally{a.f()}return!1===n&&t.push(this.objectIdField),t}},{key:"_getFeatures",value:function(e,t,r,n){var a=this,i=[];try{if(-1!==t&&void 0===this._featureCache[t]&&i.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,n).then((function(){return a._getFeatures(e,t,r,n)}));for(var l=0,s=e._lastFetchedIndex;s<e._known.length;s++){if(e._lastFetchedIndex+=1,l++,void 0===this._featureCache[e._known[s]]){var u=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var o=this._layer._mode;if(void 0!==o._featureMap[e._known[s]]){var d=o._featureMap[e._known[s]];null!==d&&(u=!0,this._featureCache[e._known[s]]=d)}}if(!1===u&&(e._known[s]!==t&&i.push(e._known[s]),i.length>=this._maxProcessingRate()-1))break}if(l>=r&&0===i.length)break}if(0===i.length)return(0,D.DB)("success");try{var c=new q.Z;return this._requestStandardised&&(c.sqlFormat="standard"),c.objectIds=i,c.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),c.returnGeometry=!0,!0===this._removeGeometry&&(c.returnGeometry=!1),c.outSpatialReference=this.spatialReference,this.executeQuery(c,"execute").then((function(e){if(a._checkCancelled(n),void 0!==e.error)return(0,D.d1)(new Error(e.error));for(var t=0;t<e.features.length;t++)a._featureCache[e.features[t].attributes[a._layer.objectIdField]]=e.features[t];return"success"}))}catch(f){return(0,D.d1)(f)}}catch(f){return(0,D.d1)(f)}}},{key:"_getDistinctPages",value:function(e,t,r,n,a,i,l,s,u){var o=this;return this._ensureLoaded().then((function(){return o.databaseType()})).then((function(d){for(var c=r.parseTree.column,f=0;f<o._layer.fields.length;f++)if(o._layer.fields[f].name.toLowerCase()===c.toLowerCase()){c=o._layer.fields[f].name;break}var h=new q.Z;o._requestStandardised&&(h.sqlFormat="standard");var y=null===i?null===a?"1=1":"":(0,w.zR)(i,d);return o._layer.definitionExpression&&o._useDefinitionExpression&&(y=""!==y?"(("+o._layer.definitionExpression+") AND ("+y+"))":o._layer.definitionExpression),h.where=y,h.spatialRelationship=o._makeRelationshipEnum(n),h.relationParameter=o._makeRelationshipParam(n),h.geometry=null===a?null:a,h.returnDistinctValues=!0,h.returnGeometry=!1,h.outFields=[c],o.executeQuery(h,"execute").then((function(d){if(o._checkCancelled(u),!d.hasOwnProperty("features"))return(0,D.d1)(new Error("Unnexected Result querying statistics from layer"));for(var f=!1,h=0;h<o._layer.fields.length;h++)if(o._layer.fields[h].name===c){"date"===o._layer.fields[h].type&&(f=!0);break}for(var y=0;y<d.features.length;y++){if(f){var p=d.features[y].attributes[c];null!==p?s.push(new Date(p)):s.push(p)}else s.push(d.features[y].attributes[c]);if(s.length>=l)break}return 0===d.features.length?s:d.features.length===o._layer.capabilities.query.maxRecordCount&&s.length<l?o._getDistinctPages(e+d.features.length,t,r,n,a,i,l,s,u).then((function(e){return{calculated:!0,result:e}})):s}))}))}},{key:"_distinctStat",value:function(e,t,r,n,a,i,l){return this._getDistinctPages(0,e,t,r,n,a,i,[],l).then((function(e){return{calculated:!0,result:e}}))}},{key:"isTable",value:function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}},{key:"_countstat",value:function(e,t,r,n){var a=this;return this.databaseType().then((function(e){var i=new q.Z;if(a._requestStandardised&&(i.sqlFormat="standard"),a.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};var l=null===n?null===r?"1=1":"":(0,w.zR)(n,e);return a._layer.definitionExpression&&a._useDefinitionExpression&&(l=""!==l?"(("+a._layer.definitionExpression+") AND ("+l+"))":a._layer.definitionExpression),i.where=l,i.where=l,i.spatialRelationship=a._makeRelationshipEnum(t),i.relationParameter=a._makeRelationshipParam(t),i.geometry=null===r?null:r,i.returnGeometry=!1,a.executeQuery(i,"executeForCount").then((function(e){return{calculated:!0,result:e}}))}))}},{key:"_stats",value:function(e,t,r,n,a,i,l){var s=this;return this._ensureLoaded().then((function(){var u=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsSqlExpression,o=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsStatistics,d=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsDistinct;return"count"===e?d?s._countstat(e,r,n,a):{calculated:!1}:!1===o||!1===(0,w.y5)(t)&&!1===u||!1===t.isStandardized?""!==r||null!==a?{calculated:!1}:s._manualStat(e,t,i,l):"distinct"===e?!1===d?""!==r||null!==a?{calculated:!1}:s._manualStat(e,t,i,l):s._distinctStat(e,t,r,n,a,i,l):s.databaseType().then((function(i){if(s.isTable()&&n&&null!==r&&""!==r)return{calculated:!0,result:null};var l=new q.Z;s._requestStandardised&&(l.sqlFormat="standard");var u=null===a?null===n?"1=1":"":(0,w.zR)(a,i);s._layer.definitionExpression&&s._useDefinitionExpression&&(u=""!==u?"(("+s._layer.definitionExpression+") AND ("+u+"))":s._layer.definitionExpression),l.where=u,l.spatialRelationship=s._makeRelationshipEnum(r),l.relationParameter=s._makeRelationshipParam(r),l.geometry=null===n?null:n;var o=new V.Z;o.statisticType=(0,S.g3)(e),o.onStatisticField=(0,w.zR)(t,i),o.outStatisticFieldName="ARCADE_STAT_RESULT",l.returnGeometry=!1;var d="ARCADE_STAT_RESULT";return l.outStatistics=[o],s.executeQuery(l,"execute").then((function(e){if(!e.hasOwnProperty("features")||0===e.features.length)return(0,D.d1)(new Error("Unnexected Result querying statistics from layer"));for(var t=!1,r=0;r<e.fields.length;r++)if("ARCADE_STAT_RESULT"===e.fields[r].name.toUpperCase()){d=e.fields[r].name,"date"===e.fields[r].type&&(t=!0);break}if(t){var n=e.features[0].attributes[d];return null!==n&&(n=new Date(e.features[0].attributes[d])),{calculated:!0,result:n}}return{calculated:!0,result:e.features[0].attributes[d]}}))}))}))}},{key:"_stat",value:function(e,t,r,n,a,i,l){return this._stats(e,t,r,n,a,i,l)}},{key:"_canDoAggregates",value:function(e,t){var r=this;return this._ensureLoaded().then((function(){var e=!1,n=r._layer.capabilities&&r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsSqlExpression;if(void 0!==r._layer.capabilities&&null!==r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsStatistics&&!0===r._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(var a=0;a<t.length-1;a++)null!==t[a].workingexpr&&(!1===t[a].workingexpr.isStandardized||!1===(0,w.y5)(t[a].workingexpr)&&!1===n)&&(e=!1);return!1!==e}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,n,a,i,l){var s=this;return this._ensureLoaded().then((function(){return s.databaseType()})).then((function(u){var o="",d=!1,c=!1;null!==i&&s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsOrderBy&&(o=i.constructClause(),c=!0),s._layer.capabilities&&s._layer.capabilities.query&&!1===s._layer.capabilities.query.supportsPagination&&(c=!1,d=!0,o=s._layer.objectIdField);for(var f=[],h=0;h<t.length;h++){var y=new V.Z;y.onStatisticField=null!==t[h].workingexpr?(0,w.zR)(t[h].workingexpr,u):"",y.outStatisticFieldName=t[h].field,y.statisticType=t[h].toStatisticsName(),f.push(y)}""===o&&(o=e.join(","));var p=s._maxQueryRate(),_=s._layer.capabilities.query.maxRecordCount;void 0!==_&&_<p&&(p=_);var v=null===a?null===n?"1=1":"":(0,w.zR)(a,u);return s._layer.definitionExpression&&s._useDefinitionExpression&&(v=""!==v?"(("+s._layer.definitionExpression+") AND ("+v+"))":s._layer.definitionExpression),new g.Z([],["GETPAGES"],c,{groupbypage:!0,spatialRel:s._makeRelationshipEnum(r),relationParam:s._makeRelationshipParam(r),outFields:["*"],useOIDpagination:d,generatedOid:l,resultRecordCount:p,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:f,geometry:null===n?null:n,where:v,orderByFields:o,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))}},{key:"_getAgregagtePhysicalPage",value:function(e,t,r){var n=this;try{var a=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(a=""!==a?"("+a+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());var i=e.pagesDefinition.internal.lastRetrieved,l=i,s=e.pagesDefinition.internal.lastPage,u=new q.Z;return this._requestStandardised&&(u.sqlFormat="standard"),u.where=a,u.spatialRelationship=e.pagesDefinition.spatialRel,u.relationParameter=e.pagesDefinition.relationParam,u.outFields=e.pagesDefinition.outFields,u.outStatistics=e.pagesDefinition.outStatistics,u.geometry=e.pagesDefinition.geometry,u.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,u.num=e.pagesDefinition.resultRecordCount,u.start=e.pagesDefinition.internal.lastPage,u.returnGeometry=e.pagesDefinition.returnGeometry,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&u.geometry&&u.spatialRelationship?(0,D.DB)([]):this.executeQuery(u,"execute").then((function(t){if(n._checkCancelled(r),!t.hasOwnProperty("features"))return(0,D.d1)(new Error("Unnexected Result querying aggregates from layer"));var a=[];if(e.pagesDefinition.internal.lastPage!==s)return[];for(var u=0;u<t.features.length;u++)e.pagesDefinition.internal.set[l+u]=t.features[u].attributes[e.pagesDefinition.generatedOid];for(var o=0;o<t.features.length;o++)a.push(new h.Z({attributes:t.features[o].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,a}))}catch(o){return(0,D.d1)(o)}}},{key:"relationshipMetaData",value:function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}},{key:"serviceUrl",value:function(){return(0,F.US)(this._layer.parsedUrl.path)}},{key:"queryAttachments",value:function(e,t,r,n,a){var i=this;if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){var l={objectIds:[e],returnMetadata:a};return(t&&t>0||r&&r>0)&&(l.size=[t&&t>0?t:0,r&&r>0?r:t+1]),n&&n.length>0&&(l.attachmentTypes=n),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:l,method:"attachments"}),this._layer.queryAttachments(l).then((function(t){var r=[];return t&&t[e]&&t[e].forEach((function(t){var n=i._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString(),l=null;a&&t.exifInfo&&(l=z.Z.convertJsonToArcade(t.exifInfo,!0)),r.push(new B.Z(t.id,t.name,t.contentType,t.size,n,l))})),r}))}return(0,D.DB)([])}},{key:"queryRelatedFeatures",value:function(e){var t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),(0,d.default)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then((function(e){if(e.data){var t={},r=e.data;if(r&&r.relatedRecordGroups){var n,a=r.spatialReference,i=(0,u.Z)(r.relatedRecordGroups);try{for(i.s();!(n=i.n()).done;){var l,s=n.value,o=s.objectId,d=[],c=(0,u.Z)(s.relatedRecords);try{for(c.s();!(l=c.n()).done;){var f=l.value;f.geometry&&(f.geometry.spatialReference=a);var y=new h.Z({geometry:f.geometry?(0,P.im)(f.geometry):null,attributes:f.attributes});d.push(y)}}catch(p){c.e(p)}finally{c.f()}t[o]={features:d,exceededTransferLimit:!0===r.exceededTransferLimit}}}catch(p){i.e(p)}finally{i.f()}}return t}return(0,D.d1)("Invalid Request")}))}},{key:"getFeatureByObjectId",value:function(e,t){var r=new q.Z;return r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=this.spatialReference,r.where=this.objectIdField+"="+e.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:r,method:"execute"}),(0,U.e)(this._layer.parsedUrl.path,r).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getIdentityUser",value:function(){var e=this;return this.load().then((function(){var t,r=null==(t=o.id)?void 0:t.findCredential(e._layer.url);return r?r.userId:null}))}},{key:"getOwningSystemUrl",value:function(){var e=this;return this.load().then((function(){var t,r=null==(t=o.id)?void 0:t.findServerInfo(e._layer.url);if(r)return(0,D.DB)(r.owningSystemUrl);var n=e._layer.url,a=n.toLowerCase().indexOf("/rest/services");return(n=a>-1?n.substring(0,a):n)?(n+="/rest/info",(0,D.Ue)((function(e,t){(0,d.default)(n,{query:{f:"json"}}).then((function(t){var r="";t.data&&t.data.owningSystemUrl&&(r=t.data.owningSystemUrl),e(r)}),(function(t){e("")}))}))):(0,D.DB)("")}))}},{key:"getDataSourceFeatureSet",value:function(){var e=new r({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e}}],[{key:"create",value:function(e,t,n,a,i){return new r({layer:new A.default({url:e,outFields:null===t?["*"]:t}),spatialReference:n,lrucache:a,interceptor:i})}}]),r}(v.Z),K=r(84272),X=function(e){(0,l.Z)(r,e);var t=(0,s.Z)(r);function r(e){var n;return(0,a.Z)(this,r),(n=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",n._findObjectId=-1,n._requestStandardised=!1,n._removeGeometry=!1,n._overrideFields=null,n.featureObjectId=null,n.relatedLayer=null,n.relationship=null,e.spatialReference&&(n.spatialReference=e.spatialReference),n._transparent=!0,n._maxProcessing=1e3,n._layer=e.layer,n._wset=null,n._findObjectId=e.objectId,n.featureObjectId=e.objectId,n.relationship=e.relationship,n.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(n._overrideFields=e.outFields),void 0!==e.includeGeometry&&(n._removeGeometry=!1===e.includeGeometry),n}return(0,i.Z)(r,[{key:"_maxQueryRate",value:function(){return F.tI}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=(0,D.Ue)((function(t,r){(0,D.$6)([e._layer.load(),e.relatedLayer.load()]).then((function(){e._initialiseFeatureSet(),t(e)}),r)}))),this._loadPromise}},{key:"nativeCapabilities",value:function(){return this.relatedLayer.nativeCapabilities()}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var e,t=[],r=[],n=(0,u.Z)(this.fields);try{for(n.s();!(e=n.n()).done;){var a=e.value;if("oid"===a.type)t.push(a),r.push(a.name);else{var i,l=(0,u.Z)(this._overrideFields);try{for(l.s();!(i=l.n()).done;){if(i.value.toLowerCase()===a.name.toLowerCase()){t.push(a),r.push(a.name);break}}}catch(o){l.e(o)}finally{l.f()}}}}catch(o){n.e(o)}finally{n.f()}this.fields=t,this._overrideFields=r}var s=this._layer.nativeCapabilities();s&&(this._databaseType=s.databaseType,this._requestStandardised=s.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}},{key:"databaseType",value:function(){var e=this;return this.relatedLayer.databaseType().then((function(){return e._databaseType=e.relatedLayer._databaseType,e._databaseType}))}},{key:"isTable",value:function(){return this.relatedLayer.isTable()}},{key:"_isInFeatureSet",value:function(){return F.dj.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):(0,D.DB)(this._wset)}},{key:"_changeFeature",value:function(e){var t,r={},n=(0,u.Z)(this.fields);try{for(n.s();!(t=n.n()).done;){var a=t.value;r[a.name]=e.attributes[a.name]}}catch(i){n.e(i)}finally{n.f()}return new h.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:r})}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;return this.databaseType().then((function(){if(i.isTable()&&t&&null!==e&&""!==e)return new g.Z([],[],!0,null);var l=i._layer.nativeCapabilities();if(!1===l.canQueryRelated)return new g.Z([],[],!0,null);if(l.capabilities.queryRelated&&l.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,r,n,a);var s="",u=!1;null!==n&&l.capabilities&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(s=n.constructClause(),u=!0);var o=new M.Z;o.objectIds=[i._findObjectId];var d=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);o.outFields=d,o.relationshipId=i.relationship.id,o.where="1=1";var c=!0;return!0===i._removeGeometry&&(c=!1),o.returnGeometry=c,i._requestStandardised&&(o.sqlFormat="standard"),o.outSpatialReference=i.spatialReference,o.orderByFields=""!==s?s.split(","):null,l.source.queryRelatedFeatures(o).then((function(n){i._checkCancelled(a);for(var l=n[i._findObjectId]?n[i._findObjectId].features:[],s=[],o=0;o<l.length;o++)i._featureCache[l[o].attributes[i.relatedLayer.objectIdField]]=l[o],s.push(l[o].attributes[i.relatedLayer.objectIdField]);var d=t&&null!==e&&""!==e,c=null!=r;return new g.Z(d||c?s:[],d||c?[]:s,u,null)}))}))}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var r,n=!1,a=(0,u.Z)(t);try{for(a.s();!(r=a.n()).done;){if(r.value.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}}}catch(i){a.e(i)}finally{a.f()}return!1===n&&t.push(this.objectIdField),t}},{key:"_getFilteredSetUsingPaging",value:function(e,t,r,n,a){var i=this;try{var l="",s=!1,u=this._layer.nativeCapabilities();return null!==n&&u&&u.capabilities.queryRelated&&!0===u.capabilities.queryRelated.supportsOrderBy&&(l=n.constructClause(),s=!0),this.databaseType().then((function(){var n=i._maxQueryRate(),o=u.capabilities.query.maxRecordCount;void 0!==o&&o<n&&(n=o);var d,c=t&&null!==e&&""!==e,f=null!=r,h=!0;!0===i._removeGeometry&&(h=!1);var y=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);return d=new g.Z(c||f?["GETPAGES"]:[],c||f?[]:["GETPAGES"],s,{outFields:y.join(","),resultRecordCount:n,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:l,returnGeometry:h,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),i._expandPagedSet(d,n,0,0,a).then((function(){return d}))}))}catch(o){return(0,D.d1)(o)}}},{key:"_expandPagedSet",value:function(e,t,r,n,a){return this._expandPagedSetFeatureSet(e,t,r,n,a)}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,r){var n=this;try{var a=e.pagesDefinition.internal.lastRetrieved,i=a,l=e.pagesDefinition.internal.lastPage,s=this._layer.nativeCapabilities(),u=new M.Z;return!0===this._requestStandardised&&(u.sqlFormat="standard"),u.relationshipId=this.relationship.id,u.objectIds=e.pagesDefinition.objectIds,u.resultOffset=e.pagesDefinition.internal.lastPage,u.resultRecordCount=e.pagesDefinition.resultRecordCount,u.outFields=e.pagesDefinition.outFields.split(","),u.where=e.pagesDefinition.where,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,u.returnGeometry=e.pagesDefinition.returnGeometry,u.outSpatialReference=this.spatialReference,s.source.queryRelatedFeatures(u).then((function(t){if(n._checkCancelled(r),e.pagesDefinition.internal.lastPage!==l)return 0;for(var s=t[n._findObjectId]?t[n._findObjectId].features:[],u=0;u<s.length;u++)e.pagesDefinition.internal.set[i+u]=s[u].attributes[n.relatedLayer.objectIdField];for(var o=0;o<s.length;o++)n._featureCache[s[o].attributes[n.relatedLayer.objectIdField]]=s[o];var d=!t[n._findObjectId]||!1===t[n._findObjectId].exceededTransferLimit;return s.length!==e.pagesDefinition.resultRecordCount&&d&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+s.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,s.length}))}catch(o){return(0,D.d1)(o)}}},{key:"_getFeatures",value:function(e,t,r,n){var a=this,i=[];-1!==t&&void 0===this._featureCache[t]&&i.push(t);var l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,n).then((function(){return a._getFeatures(e,t,r,n)}));for(var s=0,u=e._lastFetchedIndex;u<e._known.length&&(++s<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[u]&&void 0===this._featureCache[e._known[u]]&&(e._known[u]!==t&&i.push(e._known[u]),i.length>r)))&&!(s>=r&&0===i.length);u++);return 0===i.length?(0,D.DB)("success"):(0,D.d1)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e,t,r){return(0,D.DB)(e)}},{key:"_stat",value:function(e,t,r,n,a,i,l){return(0,D.DB)({calculated:!1})}},{key:"gdbVersion",get:function(){return this.relatedLayer.gdbVersion}},{key:"_canDoAggregates",value:function(e,t,r,n,a){return(0,D.DB)(!1)}},{key:"relationshipMetaData",value:function(){return this.relatedLayer.relationshipMetaData()}},{key:"serviceUrl",value:function(){return this.relatedLayer.serviceUrl()}},{key:"queryAttachments",value:function(e,t,r,n,a){return this.relatedLayer.queryAttachments(e,t,r,n,a)}},{key:"getFeatureByObjectId",value:function(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}},{key:"getOwningSystemUrl",value:function(){return this.relatedLayer.getOwningSystemUrl()}},{key:"getIdentityUser",value:function(){return this.relatedLayer.getIdentityUser()}},{key:"getDataSourceFeatureSet",value:function(){return this.relatedLayer}}]),r}(v.Z),$=r(26609),H=r(70032),Y=r(98995);function ee(){null===$.Z.applicationCache&&($.Z.applicationCache=new $.Z)}function te(e,t){if($.Z.applicationCache){var r=$.Z.applicationCache.getLayerInfo(e);if(r)return r.then((function(r){return(0,D.DB)(new A.default({url:e,outFields:t,sourceJSON:r}))}));var n=new A.default({url:e,outFields:t}),a=(0,D.Ue)((function(e,t){n.load().then((function(){e(n.sourceJSON)}),(function(e){t(e)}))}));return $.Z.applicationCache&&($.Z.applicationCache.setLayerInfo(e,a),a=a.catch((function(t){throw $.Z.applicationCache.clearLayerInfo(e),t}))),a.then((function(){return(0,D.DB)(n)}))}return(0,D.DB)(new A.default({url:e,outFields:t}))}function re(e,t,r,n,a){var i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;return te(e,["*"]).then((function(e){return(0,D.DB)(ne(e,t,r,n,a,i))}))}function ne(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;return!0===e._hasMemorySource()?new K.Z({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:i}):new J({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:i})}function ae(e){if(null!==$.Z.applicationCache){var t=$.Z.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=(0,d.default)(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),(0,D.DB)(t)}return(0,D.DB)({layers:[],tables:[]})}));return null!==$.Z.applicationCache&&($.Z.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw $.Z.applicationCache.clearLayerInfo(e),t}))),r}function ie(e,t){var r={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return ae(e).then((function(n){if(r.metadata=n,n.controllerDatasetLayers&&void 0!==n.controllerDatasetLayers.utilityNetworkLayerId&&null!==n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers){var a,i=(0,u.Z)(n.layers);try{for(i.s();!(a=i.n()).done;){var l=a.value;r.layerNameLkp[l.id]=l.name}}catch(h){i.e(h)}finally{i.f()}}if(n.tables){var s,o=(0,u.Z)(n.tables);try{for(o.s();!(s=o.n()).done;){var c=s.value;r.layerNameLkp[c.id]=c.name}}catch(h){o.e(h)}finally{o.f()}}var f=n.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=f,function(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==$.Z.applicationCache){var n=$.Z.applicationCache.getLayerInfo(r);if(null!==n)return n}var a=(0,d.default)(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==$.Z.applicationCache&&($.Z.applicationCache.setLayerInfo(r,a),a=a.catch((function(e){throw $.Z.applicationCache.clearLayerInfo(r),e}))),a}(e,f).then((function(n){if(n){r.queryelem=n,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);var a,i=(0,u.Z)(r.queryelem.dataElement.domainNetworks);try{for(i.s();!(a=i.n()).done;){var l,s=a.value,o=(0,u.Z)(s.edgeSources?s.edgeSources:[]);try{for(o.s();!(l=o.n()).done;){var c=l.value,y={layerId:c.layerId,sourceId:c.sourceId,className:r.layerNameLkp[c.layerId]?r.layerNameLkp[c.layerId]:null};y.className&&(r.lkp[y.className]=y)}}catch(h){o.e(h)}finally{o.f()}var p,_=(0,u.Z)(s.junctionSources?s.junctionSources:[]);try{for(_.s();!(p=_.n()).done;){var v=p.value,g={layerId:v.layerId,sourceId:v.sourceId,className:r.layerNameLkp[v.layerId]?r.layerNameLkp[v.layerId]:null};g.className&&(r.lkp[g.className]=g)}}catch(h){_.e(h)}finally{_.f()}}}catch(h){i.e(h)}finally{i.f()}if(r.queryelem.dataElement.terminalConfigurations){var m,F=(0,u.Z)(r.queryelem.dataElement.terminalConfigurations);try{for(F.s();!(m=F.n()).done;){var w,S=m.value,b=(0,u.Z)(S.terminals);try{for(b.s();!(w=b.n()).done;){var I=w.value;r.terminals.push({terminalId:I.terminalId,terminalName:I.terminalName})}}catch(h){b.e(h)}finally{b.f()}}}catch(h){F.e(h)}finally{F.f()}}return function(e){if(null!==$.Z.applicationCache){var t=$.Z.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=(0,d.default)(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return(0,D.DB)(t)}return(0,D.DB)(null)}));return null!==$.Z.applicationCache&&($.Z.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw $.Z.applicationCache.clearLayerInfo(e),t}))),r}(e+"/"+f).then((function(n){if(n.systemLayers&&void 0!==n.systemLayers.associationsTableId&&null!==n.systemLayers.associationsTableId){var a=[];return r.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),re(e+"/"+n.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"].concat(a),!1,null,null).then((function(e){return e.load()})).then((function(e){return r.unVersion>=4?(e=e.filter(k.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e})).then((function(e){return{lkp:r.lkp,associations:e,unVersion:r.unVersion,terminals:r.terminals}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}function le(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,u=e.serviceUrl();return u?re(u="/"===u.charAt(u.length-1)?u+t.relatedTableId.toString():u+"/"+t.relatedTableId.toString(),n,a,i,l,s).then((function(u){return new X({layer:e,relatedLayer:u,relationship:t,objectId:r,spatialReference:n,outFields:a,includeGeometry:i,lrucache:l,interceptor:s})})):null}f.Z.registerAction(),x.registerAction(),_.Z.registerAction(),N.Z.registerAction(),E.Z.registerAction();var se=function(e){(0,l.Z)(r,e);var t=(0,s.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return(0,a.Z)(this,r),(n=t.call(this))._map=e,n._overridespref=i,n.lrucache=l,n.interceptor=s,n._instantLayers=[],n}return(0,i.Z)(r,[{key:"_makeAndAddFeatureSet",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=ne(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n}},{key:"featureSetByName",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return t.featureSetByName(e,r,a)}catch(i){return(0,D.d1)(i)}}));null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),l=0;l<this._instantLayers.length;l++){var s=this._instantLayers[l];if(s.opitem.title===e&&s.includeGeometry===r&&s.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var u=this._map.allLayers.find((function(t){return t instanceof A.default&&t.title===e}));if(u)return this.resolvePromise(this._makeAndAddFeatureSet(u,r,a));if(this._map.tables){var o=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)}));if(o){if(o instanceof A.default)return this.resolvePromise(this._makeAndAddFeatureSet(o,r,a));if(o._materializedTable);else{var d=o.outFields?o:(0,n.Z)((0,n.Z)({},o),{},{outFields:["*"]});o._materializedTable=new A.default(d)}return o._materializedTable.load().then((function(){return t.resolvePromise(t._makeAndAddFeatureSet(o._materializedTable,r,a))}))}}return this.resolvePromise(null)}},{key:"featureSetById",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return t.featureSetById(e,r,a)}catch(i){return(0,D.d1)(i)}}));null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),l=0;l<this._instantLayers.length;l++){var s=this._instantLayers[l];if(s.opitem.id===e&&s.includeGeometry===r&&s.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var u=this._map.allLayers.find((function(t){return t instanceof A.default&&t.id===e}));if(u)return this.resolvePromise(this._makeAndAddFeatureSet(u,r,a));if(this._map.tables){var o=this._map.tables.find((function(t){return t.id===e}));if(o){if(o instanceof A.default)return this.resolvePromise(this._makeAndAddFeatureSet(o,r,a));if(o._materializedTable);else{var d=(0,n.Z)((0,n.Z)({},o),{},{outFields:["*"]});o._materializedTable=new A.default(d)}return o._materializedTable.load().then((function(){return t.resolvePromise(t._makeAndAddFeatureSet(o._materializedTable,r,a))}))}}return this.resolvePromise(null)}}]),r}(c.Z),ue=function(e){(0,l.Z)(r,e);var t=(0,s.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return(0,a.Z)(this,r),(n=t.call(this))._url=e,n._overridespref=i,n.lrucache=l,n.interceptor=s,n.metadata=null,n._instantLayers=[],n}return(0,i.Z)(r,[{key:"url",get:function(){return this._url}},{key:"_makeAndAddFeatureSet",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=ne(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n}},{key:"_loadMetaData",value:function(){var e=this;return ae(this._url).then((function(t){return e.metadata=t,t}))}},{key:"load",value:function(){return this._loadMetaData()}},{key:"clone",value:function(){return new r(this._url,this._overridespref,this.lrucache,this.interceptor)}},{key:"featureSetByName",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null===n&&(n=["*"]),n=(n=n.slice(0)).sort();for(var a=JSON.stringify(n),i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.title===e&&l.includeGeometry===r&&l.outFields===a)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(a){var i,l=null,s=(0,u.Z)(a.layers?a.layers:[]);try{for(s.s();!(i=s.n()).done;){var o=i.value;o.name===e&&(l=o)}}catch(h){s.e(h)}finally{s.f()}if(!l){var d,c=(0,u.Z)(a.tables?a.tables:[]);try{for(c.s();!(d=c.n()).done;){var f=d.value;f.name===e&&(l=f)}}catch(h){c.e(h)}finally{c.f()}}return l?te(t._url+"/"+l.id,["*"]).then((function(e){return t._makeAndAddFeatureSet(e,r,n)})):t.resolvePromise(null)}))}},{key:"featureSetById",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];null===n&&(n=["*"]),n=(n=n.slice(0)).sort();var a=JSON.stringify(n);e=null!=e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.id===e&&l.includeGeometry===r&&l.outFields===a)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(a){var i,l=null,s=(0,u.Z)(a.layers?a.layers:[]);try{for(s.s();!(i=s.n()).done;){var o=i.value;null!==o.id&&void 0!==o.id&&o.id.toString()===e&&(l=o)}}catch(h){s.e(h)}finally{s.f()}if(!l){var d,c=(0,u.Z)(a.tables?a.tables:[]);try{for(c.s();!(d=c.n()).done;){var f=d.value;null!==f.id&&void 0!==f.id&&f.id.toString()===e&&(l=f)}}catch(h){c.e(h)}finally{c.f()}}return l?te(t._url+"/"+l.id,["*"]).then((function(e){return t._makeAndAddFeatureSet(e,r,n)})):t.resolvePromise(null)}))}}]),r}(c.Z);function oe(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new se(e,t,r,n)}function de(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new ue(e,t,r,n)}function ce(e,t){return null===e?t:new H.Z({url:e.field("url")})}function fe(e,t,r){return o.id.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===t&&e.user&&e.user.sourceJSON&&!1===r?(0,D.DB)(e.user.sourceJSON):""===t?(0,d.default)(e.restUrl+"/community/self",{responseType:"json",query:(0,n.Z)({f:"json"},!1===r?{}:{returnUserLicenseTypeExtensions:!0})}).then((function(e){if(e.data){var t=e.data;if(t&&t.username)return(0,D.DB)(t)}return(0,D.DB)(null)})):(0,d.default)(e.restUrl+"/community/users/"+t,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.error?null:(0,D.DB)(t)}return(0,D.DB)(null)})):(0,D.DB)(null)}function he(e,t,r,n,a){if(null===e)return null;if(e instanceof A.default){switch(t){case"datasource":return ne(e,a,e.outFields,!0,r,n).getDataSourceFeatureSet();case"parent":case"root":return ne(e,a,e.outFields,!0,r,n)}return null}if(e instanceof v.Z)switch(t){case"datasource":return e.getDataSourceFeatureSet();case"parent":return e;case"root":return e.getRootFeatureSet()}return null}function ye(e,t,r,n,a,i,l){var s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if($.Z.applicationCache){var u=$.Z.applicationCache.getLayerInfo(e+":"+i.url);if(u)return u.then((function(e){try{var u=new A.default({url:(0,F.US)(e.url)+"/"+t,outFields:["*"]});return(0,D.DB)(ne(u,r,n,a,l,s))}catch(i){return(0,D.d1)(i)}}),(function(e){return(0,D.d1)(e)}))}return(0,D.Ue)((function(u,o){var d=new Y.default({id:e,portal:i}).load();$.Z.applicationCache&&$.Z.applicationCache.setLayerInfo(e+":"+i.url,d),d.then((function(e){try{var d=new A.default({url:(0,F.US)(e.url)+"/"+t,outFields:["*"]});u(ne(d,r,n,a,l,s))}catch(i){o(i)}}),(function(t){$.Z.applicationCache&&$.Z.applicationCache.clearLayerInfo(e+":"+i.url),o(t)}))}))}},12829:function(e,t,r){r.d(t,{$X:function(){return g},QP:function(){return m},TO:function(){return F},Xx:function(){return S},yN:function(){return w}});var n=r(37762),a=r(60136),i=r(54062),l=r(15671),s=r(43144),u=r(52639),o=r(47238),d=r(34333),c=r(74066),f=r(29876),h=r(65247),y=r(66978),p=r(48562),_=r(78952),v=function(){function e(t){(0,l.Z)(this,e),this.field=t,this.sqlRewritable=!1}return(0,s.Z)(e,[{key:"postInitialization",value:function(e,t){}}]),e}(),g=function(e){(0,a.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n;return(0,l.Z)(this,r),(n=t.call(this,e)).sqlRewritable=!0,n}return(0,s.Z)(r,[{key:"extractValue",value:function(e){return e.attributes[this.field.name]}},{key:"rewriteSql",value:function(e){return{rewritten:this.sqlRewritable,where:e}}}]),r}(v),m=function(e){(0,a.Z)(r,e);var t=(0,i.Z)(r);function r(e,n,a){var i;return(0,l.Z)(this,r),(i=t.call(this,(0,f.JW)(e))).originalField=e,i.sqlRewritable=!0,i.field.name=n,i.field.alias=a,i}return(0,s.Z)(r,[{key:"rewriteSql",value:function(e,t){return{rewritten:this.sqlRewritable,where:(0,h.bB)(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return e.attributes[this.originalField.name]}}]),r}(v),F=function(e){(0,a.Z)(r,e);var t=(0,i.Z)(r);function r(e,n,a){var i;for(var s in(0,l.Z)(this,r),(i=t.call(this,e)).codefield=n,i.lkp=a,i.reverseLkp={},a)i.reverseLkp[a[s]]=s;return i.sqlRewritable=!0,i}return(0,s.Z)(r,[{key:"rewriteSql",value:function(e,t){var n=this.evaluateNodeToWhereClause(e.parseTree,f.Bj.Standardised,this.field.name,this.codefield instanceof p.WhereClause?(0,h.zR)(this.codefield,f.Bj.Standardised):this.codefield,e.parameters);return n.indexOf(r.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:p.WhereClause.create(n,t._parent.getFieldsIndex())}}},{key:"evaluateNodeToWhereClause",value:function(e,t){var a,i,l,s,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,d=arguments.length>4?arguments[4]:void 0;switch(e.type){case"interval":return(0,h.TE)(this.evaluateNodeToWhereClause(e.value,t,u,o,d),e.qualifier,e.op);case"case_expression":var c=" CASE ";"simple"===e.format&&(c+=this.evaluateNodeToWhereClause(e.operand,t,u,r.BADNESS,d));for(var f=0;f<e.clauses.length;f++)c+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[f].operand,t,u,r.BADNESS,d)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[f].value,t,u,r.BADNESS,d);return null!==e.else&&(c+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,u,r.BADNESS,d)),c+=" END ";case"param":var y=d[e.value.toLowerCase()];if("string"==typeof y)return"'"+d[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(y instanceof Date)return(0,h.oX)(y,t);if(y instanceof Array){for(var p=[],_=0;_<y.length;_++)"string"==typeof y[_]?p.push("'"+y[_].toString().replace(/'/g,"''")+"'"):y[_]instanceof Date?p.push((0,h.oX)(y[_],t)):p.push(y[_].toString());return p}return y.toString();case"expr_list":i=[];var v,g=(0,n.Z)(e.value);try{for(g.s();!(v=g.n()).done;){var m=v.value;i.push(this.evaluateNodeToWhereClause(m,t,u,o,d))}}catch(x){g.e(x)}finally{g.f()}return i;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,u,r.BADNESS,d)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" AND "+this.evaluateNodeToWhereClause(e.right,t,u,o,d)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" OR "+this.evaluateNodeToWhereClause(e.right,t,u,o,d)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" IS NOT NULL )";case"IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var F,w=[],S=!0,k=(0,n.Z)(e.right.value);try{for(k.s();!(F=k.n()).done;){var b=F.value;if("string"!==b.type){S=!1;break}if(void 0===this.lkp[b.value]){S=!1;break}w.push(this.lkp[b.value].toString())}}catch(x){k.e(x)}finally{k.f()}if(S)return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" IN ("+w.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,u,o,d)," ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" IN ("+a.join(",")+")) "}return(s=this.evaluateNodeToWhereClause(e.right,t,u,o,d))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" IN ("+s.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" IN ("+s+")) ";case"NOT IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var I,D=[],C=!0,R=(0,n.Z)(e.right.value);try{for(R.s();!(I=R.n()).done;){var Z=I.value;if("string"!==Z.type){C=!1;break}if(void 0===this.lkp[Z.value]){C=!1;break}D.push(this.lkp[Z.value].toString())}}catch(x){R.e(x)}finally{R.f()}if(C)return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" NOT IN ("+D.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,u,o,d)," ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" NOT IN ("+a.join(",")+")) "}return(s=this.evaluateNodeToWhereClause(e.right,t,u,o,d))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" NOT IN ("+s.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,d)+" NOT IN ("+s+")) ";case"BETWEEN":return l=this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,d)," ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,d)+" BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"NOTBETWEEN":return l=this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,d)," ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,d)+" NOT BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,d)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,d)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,d)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,d)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,d)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,d)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,d)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,d)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+o+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+o+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,d)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,d)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,d)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,d)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,h.oX)(e.value,t);case"number":return e.value.toString();case"current_time":return(0,h.vR)("date"===e.mode,t);case"column_ref":return u&&u.toLowerCase()===e.column.toLowerCase()?"("+o+")":e.column;case"function":var T=this.evaluateNodeToWhereClause(e.args,t,u,r.BADNESS,d);return(0,h.fz)(e.name,T,t)}throw new Error("Unsupported sql syntax "+e.type)}},{key:"extractValue",value:function(e){return this.codefield instanceof p.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]}}]),r}(v);F.BADNESS="_!!!_BAD_LKP_!!!!";var w=function(e){(0,a.Z)(r,e);var t=(0,i.Z)(r);function r(e,n){var a;return(0,l.Z)(this,r),(a=t.call(this,e)).sql=n,a}return(0,s.Z)(r,[{key:"rewriteSql",value:function(e,t){return{rewritten:!0,where:(0,h.bB)(e,this.field.name,(0,h.zR)(this.sql,f.Bj.Standardised),t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return this.sql.calculateValueCompiled(e)}}]),r}(v),S=function(e){(0,a.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n;return(0,l.Z)(this,r),(n=t.call(this,e))._calcFunc=null,n.declaredClass="esri.arcade.featureset.actions.Adapted",n.adaptedFields=null,n._extraFilter=null,n._extraFilter=e.extraFilter,n._parent=e.parentfeatureset,n._maxProcessing=30,n.adaptedFields=e.adaptedFields,n}return(0,s.Z)(r,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new _.Z({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=f.Qk.point,this.typeIdField="",this.types=null),this.fields=[];var e,t=(0,n.Z)(this.adaptedFields);try{for(t.s();!(e=t.n()).done;){var r=e.value;r.postInitialization(this,this._parent),this.fields.push(r.field)}}catch(a){t.e(a)}finally{t.f()}}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._extraFilter?t._getFilteredSet("",null,null,null,e):t._parent._getSet(e)})).then((function(r){return t._checkCancelled(e),t._wset=new c.Z(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):(0,y.DB)(this._wset)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,r,a){var i=this,l=[];-1!==t&&void 0===this._featureCache[t]&&l.push(t);var s=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,s))return this._expandPagedSet(e,s,0,0,a).then((function(){return i._getFeatures(e,t,r,a)}));for(var d=0,f=e._lastFetchedIndex;f<e._known.length&&(++d<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[f]]&&(e._known[f]!==t&&l.push(e._known[f]),l.length>=s)));f++);if(0===l.length)return(0,y.DB)("success");e=new c.Z([],l,e._ordered,null);var h=Math.min(l.length,r);return this._parent._getFeatures(e,-1,h,a).then((function(){i._checkCancelled(a);for(var e=[],t=0;t<h;t++){var r=i._parent._featureFromCache(l[t]);void 0!==r&&e.push({geometry:r.geometry,attributes:r.attributes,id:l[t]})}for(var s=0,d=e;s<d.length;s++){var c,f=d[s],y=[],p=(0,n.Z)(i.adaptedFields);try{for(p.s();!(c=p.n()).done;){var _=c.value;y[_.field.name]=_.extractValue(f)}}catch(v){p.e(v)}finally{p.f()}i._featureCache[f.id]=new u.Z({attributes:y,geometry:(0,o.r1)(f.geometry)})}return"success"}))}},{key:"_fetchAndRefineFeatures",value:function(){return(0,y.d1)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,r,a,i){var l,s=this,u=this._reformulateWithoutAdaptions(r);l=u.cannot,r=u.where;var o=!1;if(null!==a){o=!0;var d,f=[],y=(0,n.Z)(this.adaptedFields);try{for(y.s();!(d=y.n()).done;){var p=d.value;if(!(p instanceof g)&&!0===a.scanForField(p.field.name)){if(!(p instanceof m)){a=null,o=!1;break}f.push({field:p.field.name,newfield:p.originalField.name})}}}catch(_){y.e(_)}finally{y.f()}a&&f.length>0&&(a=a.replaceFields(f))}return null!==r?null!==this._extraFilter&&(r=(0,h.$e)(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then((function(){return s._parent._getFilteredSet(e,t,r,a,i)})).then((function(e){return s._checkCancelled(i),!0===l?new c.Z(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===o&&e._ordered,s._clonePageDefinition(e.pagesDefinition)):new c.Z(e._candidates.slice(0),e._known.slice(0),!0===o&&e._ordered,s._clonePageDefinition(e.pagesDefinition))}))}},{key:"_reformulateWithoutAdaptions",value:function(e){var t={cannot:!1,where:e};if(null!==e){var r,a=(0,n.Z)(this.adaptedFields);try{for(a.s();!(r=a.n()).done;){var i=r.value;if(!0===(0,h.hq)(e,i.field.name)){var l=i.rewriteSql(e,this);if(!0!==l.rewritten){t.cannot=!0,t.where=null;break}t.where=l.where}}}catch(s){a.e(s)}finally{a.f()}}return t}},{key:"_stat",value:function(e,t,r,n,a,i,l){var s=this,u=!1,o=this._reformulateWithoutAdaptions(t);return u=o.cannot,t=o.where,o=this._reformulateWithoutAdaptions(a),u=u||o.cannot,null!==(a=o.where)?null!==this._extraFilter&&(a=(0,h.$e)(this._extraFilter,a)):a=this._extraFilter,!0===u?null===a&&""===r&&null===n?this._manualStat(e,t,i,l):(0,y.DB)({calculated:!1}):this._parent._stat(e,t,r,n,a,i,l).then((function(u){return!1===u.calculated?null===a&&""===r&&null===n?s._manualStat(e,t,i,l):{calculated:!1}:u}))}},{key:"_canDoAggregates",value:function(e,t,r,a,i){if(null===this._parent)return(0,y.DB)(!1);for(var l=0;l<e.length;l++){var s,u=(0,n.Z)(this.adaptedFields);try{for(u.s();!(s=u.n()).done;){var o=s.value;if(e[l].toLowerCase()===o.field.name.toLowerCase()&&!(o instanceof g))return(0,y.DB)(!1)}}catch(m){u.e(m)}finally{u.f()}}for(var d=[],c=0;c<t.length;c++){var f=t[c];if(null!==f.workingexpr){var p=this._reformulateWithoutAdaptions(f.workingexpr);if(p.cannot)return(0,y.DB)(!1);var _=f.clone();_.workingexpr=p.where,d.push(_)}else d.push(f)}var v=this._reformulateWithoutAdaptions(i);return v.cannot?(0,y.DB)(!1):(null!==(i=v.where)?null!==this._extraFilter&&(i=(0,h.$e)(this._extraFilter,i)):i=this._extraFilter,this._parent._canDoAggregates(e,d,r,a,i))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,n,a,i,l){if(null===this._parent)return(0,y.d1)(new Error("Should never be called"));for(var s=[],u=0;u<t.length;u++){var o=t[u];if(null!==o.workingexpr){var d=this._reformulateWithoutAdaptions(o.workingexpr);if(d.cannot)return(0,y.d1)(new Error("Should never be called"));var c=o.clone();c.workingexpr=d.where,s.push(c)}else s.push(o)}var f=this._reformulateWithoutAdaptions(a);return f.cannot?(0,y.d1)(new Error("Should never be called")):(null!==(a=f.where)?null!==this._extraFilter&&(a=(0,h.$e)(this._extraFilter,a)):a=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,s,r,n,a,i,l))}}],[{key:"findField",value:function(e,t){var r,a=(0,n.Z)(e);try{for(a.s();!(r=a.n()).done;){var i=r.value;if(i.name.toLowerCase()===t.toString().toLowerCase())return i}}catch(l){a.e(l)}finally{a.f()}return null}}]),r}(d.Z)},67820:function(e,t,r){r.d(t,{Z:function(){return y}});var n=r(15671),a=r(43144),i=r(60136),l=r(54062),s=r(34333),u=r(74066),o=r(29876),d=r(65247),c=r(66978),f=r(48562),h=r(78952),y=function(e){(0,i.Z)(r,e);var t=(0,l.Z)(r);function r(e){var a;return(0,n.Z)(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.actions.AttributeFilter",a._maxProcessing=1e3,a._parent=e.parentfeatureset,e.whereclause instanceof f.WhereClause?(a._whereclause=e.whereclause,a._whereClauseFunction=null):(a._whereClauseFunction=e.whereclause,a._whereclause=null),a}return(0,a.Z)(r,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new h.Z({wkid:4326}),this.geometryType=o.Qk.point)}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getFilteredSet("",null,t._whereclause,null,e)})).then((function(r){return t._checkCancelled(e),null!==t._whereClauseFunction?t._wset=new u.Z(r._candidates.slice(0).concat(r._known.slice(0)),[],r._ordered,t._clonePageDefinition(r.pagesDefinition)):t._wset=new u.Z(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):(0,c.DB)(this._wset)}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);return t===o.dj.NotInFeatureSet?t:void 0===(t=this._idstates[e])?o.dj.Unknown:t}},{key:"_getFeature",value:function(e,t,r){return this._parent._getFeature(e,t,r)}},{key:"_getFeatures",value:function(e,t,r,n){return this._parent._getFeatures(e,t,r,n)}},{key:"_featureFromCache",value:function(e){return this._parent._featureFromCache(e)}},{key:"executeWhereClause",value:function(e){return this._whereclause.testFeature(e)}},{key:"executeWhereClauseDeferred",value:function(e){if(null!==this._whereClauseFunction)try{var t=this._whereClauseFunction(e);return(0,c.y8)(t)?t:(0,c.DB)(t)}catch(r){return(0,c.d1)(r)}return(0,c.DB)(this.executeWhereClause(e))}},{key:"_fetchAndRefineFeatures",value:function(e,t,r){var n=this,a=new u.Z([],e,!1,null),i=Math.min(t,e.length);return this._parent._getFeatures(a,-1,i,r).then((function(){if(n._checkCancelled(r),null==n._whereClauseFunction){for(var a=0;a<i;a++){var l=n._parent._featureFromCache(e[a]);!0===n.executeWhereClause(l)?n._idstates[e[a]]=o.dj.InFeatureSet:n._idstates[e[a]]=o.dj.NotInFeatureSet}return"success"}for(var s=[],u=0;u<i;u++){var d=n._parent._featureFromCache(e[u]);s.push(n.executeWhereClauseDeferred(d))}return(0,c.$6)(s).then((function(r){for(var a=0;a<t;a++)!0===r[a]?n._idstates[e[a]]=o.dj.InFeatureSet:n._idstates[e[a]]=o.dj.NotInFeatureSet;return"success"}))}))}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;return null!==this._whereClauseFunction||(null!==r?null!==this._whereclause&&(r=(0,d.$e)(this._whereclause,r)):r=this._whereclause),this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,r,n,a)})).then((function(e){return i._checkCancelled(a),null!==i._whereClauseFunction?new u.Z(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)):new u.Z(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_stat",value:function(e,t,r,n,a,i,l){var s=this;if(null!==this._whereClauseFunction)return null===a&&""===r&&null===n?this._manualStat(e,t,i,l):(0,c.DB)({calculated:!1});var u=this._whereclause;return null!==a&&null!==this._whereclause&&(u=(0,d.$e)(this._whereclause,a)),this._parent._stat(e,t,r,n,u,i,l).then((function(u){return!1===u.calculated?null===a&&""===r&&null===n?s._manualStat(e,t,i,l):{calculated:!1}:u}))}},{key:"_canDoAggregates",value:function(e,t,r,n,a){return null!==this._whereClauseFunction?(0,c.DB)(!1):(null!==a?null!==this._whereclause&&(a=(0,d.$e)(this._whereclause,a)):a=this._whereclause,null===this._parent?(0,c.DB)(!1):this._parent._canDoAggregates(e,t,r,n,a))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,n,a,i,l){return null===this._parent?(0,c.d1)(new Error("Should never be called")):(null!==a?null!==this._whereclause&&(a=(0,d.$e)(this._whereclause,a)):a=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,r,n,a,i,l))}}],[{key:"registerAction",value:function(){s.Z._featuresetFunctions.filter=function(e){if("function"==typeof e)return new r({parentfeatureset:this,whereclause:e});var t=null;return e instanceof f.WhereClause&&(t=e),new r({parentfeatureset:this,whereclause:t})}}}]),r}(s.Z)},89066:function(e,t,r){r.d(t,{Z:function(){return h}});var n=r(37762),a=r(15671),i=r(43144),l=r(60136),s=r(54062),u=r(44715),o=r(34333),d=r(74066),c=r(82279),f=r(66978),h=function(e){(0,l.Z)(r,e);var t=(0,s.Z)(r);function r(e){var n;return(0,a.Z)(this,r),(n=t.call(this,e))._orderbyclause=null,n.declaredClass="esri.arcade.featureset.actions.OrderBy",n._maxProcessing=100,n._orderbyclause=e.orderbyclause,n._parent=e.parentfeatureset,n}return(0,i.Z)(r,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,t._orderbyclause,e)})).then((function(r){return t._checkCancelled(e),t._wset=r,t._wset})):(0,f.DB)(this._wset)}},{key:"manualOrderSet",value:function(e,t){var r=this;return this.getIdColumnDictionary(e,[],-1,t).then((function(e){r._orderbyclause.order(e);for(var t=new d.Z([],[],!0,null),n=0;n<e.length;n++)t._known.push(e[n].id);return t}))}},{key:"getIdColumnDictionary",value:function(e,t,r,a){var i=this;if(r<e._known.length-1){var l=this._maxQueryRate();if("GETPAGES"===e._known[r+1])return(0,u.X)(this._parent._expandPagedSet(e,l,0,0,a)).then((function(){return i.getIdColumnDictionary(e,t,r,a)}));for(var s=r+1,o=[];s<e._known.length&&"GETPAGES"!==e._known[s];)o.push(e._known[s]),s++;return r+=o.length,(0,u.X)(this._parent._getFeatureBatch(o,a)).then((function(l){i._checkCancelled(a);var s,u=(0,n.Z)(l);try{for(u.s();!(s=u.n()).done;){var o=s.value;t.push({id:o.attributes[i.objectIdField],feature:o})}}catch(d){u.e(d)}finally{u.f()}return i.getIdColumnDictionary(e,t,r,a)}))}return e._candidates.length>0?(0,u.X)(this._refineSetBlock(e,this._maxProcessingRate(),a)).then((function(){return i._checkCancelled(a),i.getIdColumnDictionary(e,t,r,a)})):(0,f.DB)(t)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,r,n){return this._parent._getFeatures(e,t,r,n)}},{key:"_featureFromCache",value:function(e){if(void 0===this._featureCache[e]){var t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}},{key:"_fetchAndRefineFeatures",value:function(){return(0,f.d1)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;return this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,r,null===n?i._orderbyclause:n,a)})).then((function(e){i._checkCancelled(a);var n=new d.Z(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition)),l=!0;return e._candidates.length>0&&(l=!1),!1===n._ordered?i.manualOrderSet(n,a).then((function(e){return!1===l&&(null===t&&null===r||(e=new d.Z(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)))),e})):n}))}}],[{key:"registerAction",value:function(){o.Z._featuresetFunctions.orderBy=function(e){return""===e?this:new r({parentfeatureset:this,orderbyclause:new c.Z(e)})}}}]),r}(o.Z)},45184:function(e,t,r){r.d(t,{Z:function(){return c}});var n=r(15671),a=r(43144),i=r(60136),l=r(54062),s=r(34333),u=r(74066),o=r(29876),d=r(66978),c=function(e){(0,i.Z)(r,e);var t=(0,l.Z)(r);function r(e){var a;return(0,n.Z)(this,r),(a=t.call(this,e))._topnum=0,a.declaredClass="esri.arcade.featureset.actions.Top",a._countedin=0,a._maxProcessing=100,a._topnum=e.topnum,a._parent=e.parentfeatureset,a}return(0,a.Z)(r,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getSet(e)})).then((function(e){return t._wset=new u.Z(e._candidates.slice(0),e._known.slice(0),!1,t._clonePageDefinition(e.pagesDefinition)),t._setKnownLength(t._wset)>t._topnum&&(t._wset._known=t._wset._known.slice(0,t._topnum)),t._setKnownLength(t._wset)>=t._topnum&&(t._wset._candidates=[]),t._wset})):(0,d.DB)(this._wset)}},{key:"_setKnownLength",value:function(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?e._known.length-1:e._known.length}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);if(t===o.dj.NotInFeatureSet)return t;var r=this._idstates[e];return r===o.dj.InFeatureSet||r===o.dj.NotInFeatureSet?r:t===o.dj.InFeatureSet&&void 0===r?this._countedin<this._topnum?(this._idstates[e]=o.dj.InFeatureSet,this._countedin++,o.dj.InFeatureSet):(this._idstates[e]=o.dj.NotInFeatureSet,o.dj.NotInFeatureSet):o.dj.Unknown}},{key:"_expandPagedSet",value:function(e,t,r,n,a){var i=this;if(null===this._parent)return(0,d.d1)(new Error("Parent Paging not implemented"));if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){var l=e._known.length;return l>0&&"GETPAGES"===e._known[l-1]&&(e._known.length=l-1),(l=e._candidates.length)>0&&"GETPAGES"===e._candidates[l-1]&&(e._candidates.length=l-1),(0,d.DB)("success")}return this._parent._expandPagedSet(e,t,r,n,a).then((function(t){return i._setKnownLength(e)>i._topnum&&(e._known.length=i._topnum),i._setKnownLength(e)>=i._topnum&&(e._candidates.length=0),t}))}},{key:"_getFeatures",value:function(e,t,r,n){var a=this,i=[],l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,n).then((function(){return a._getFeatures(e,t,r,n)}));-1!==t&&void 0===this._featureCache[t]&&i.push(t);for(var s=0,o=e._lastFetchedIndex;o<e._known.length&&(++s<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[o]]&&(e._known[o]!==t&&i.push(e._known[o]),i.length>l)));o++);if(0===i.length)return(0,d.DB)("success");var c=new u.Z([],i,!1,null),f=Math.min(i.length,r);return this._parent._getFeatures(c,-1,f,n).then((function(){for(var e=0;e<f;e++){var t=a._parent._featureFromCache(i[e]);void 0!==t&&(a._featureCache[i[e]]=t)}return"success"}))}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;return this._ensureLoaded().then((function(){return i._getSet(a)})).then((function(e){return new u.Z(e._candidates.slice(0).concat(e._known.slice(0)),[],!1,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_refineKnowns",value:function(e,t){for(var r=0,n=null,a=[],i=0;i<e._candidates.length;i++){var l=this._isInFeatureSet(e._candidates[i]);if(l===o.dj.InFeatureSet){if(e._known.push(e._candidates[i]),r+=1,null===n?n={start:i,end:i}:n.end===i-1?n.end=i:(a.push(n),n={start:i,end:i}),e._known.length>=this._topnum)break}else if(l===o.dj.NotInFeatureSet)null===n?n={start:i,end:i}:n.end===i-1?n.end=i:(a.push(n),n={start:i,end:i}),r+=1;else if(l===o.dj.Unknown)break;if(r>=t)break}null!==n&&a.push(n);for(var s=a.length-1;s>=0;s--)e._candidates.splice(a[s].start,a[s].end-a[s].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])}},{key:"_stat",value:function(){return(0,d.DB)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return(0,d.DB)(!1)}}],[{key:"registerAction",value:function(){s.Z._featuresetFunctions.top=function(e){return new r({parentfeatureset:this,topnum:e})}}}]),r}(s.Z)},84272:function(e,t,r){r.d(t,{Z:function(){return m}});var n=r(37762),a=r(15671),i=r(43144),l=r(60136),s=r(54062),u=r(52639),o=r(34333),d=r(74066),c=r(29876),f=r(65247),h=r(66978),y=r(32238),p=r(94990),_=r(87165),v=r(83040),g=r(21149),m=function(e){(0,l.Z)(r,e);var t=(0,s.Z)(r);function r(e){var n;return(0,a.Z)(this,r),(n=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",n._removeGeometry=!1,n._overrideFields=null,n._forceIsTable=!1,e.spatialReference&&(n.spatialReference=e.spatialReference),n._transparent=!0,n._maxProcessing=1e3,n._layer=e.layer,n._wset=null,!0===e.isTable&&(n._forceIsTable=!0),void 0!==e.outFields&&(n._overrideFields=e.outFields),void 0!==e.includeGeometry&&(n._removeGeometry=!1===e.includeGeometry),n}return(0,i.Z)(r,[{key:"_maxQueryRate",value:function(){return c.tI}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=(0,h.Ue)((function(t,r){if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(n){r(n)}}),r),e._layer.load()}))),this._loadPromise}},{key:"gdbVersion",get:function(){return""}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e,t=[],r=(0,n.Z)(this.fields);try{for(r.s();!(e=r.n()).done;){var a=e.value;if("oid"===a.type)t.push(a);else{var i,l=(0,n.Z)(this._layer.outFields);try{for(l.s();!(i=l.n()).done;){if(i.value.toLowerCase()===a.name.toLowerCase()){t.push(a);break}}}catch(g){l.e(g)}finally{l.f()}}}}catch(g){r.e(g)}finally{r.f()}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var s,u=[],o=[],d=(0,n.Z)(this.fields);try{for(d.s();!(s=d.n()).done;){var f=s.value;if("oid"===f.type)u.push(f),o.push(f.name);else{var h,y=(0,n.Z)(this._overrideFields);try{for(y.s();!(h=y.n()).done;){if(h.value.toLowerCase()===f.name.toLowerCase()){u.push(f),o.push(f.name);break}}}catch(g){y.e(g)}finally{y.f()}}}}catch(g){d.e(g)}finally{d.f()}this.fields=u,this._overrideFields=o}this.objectIdField=this._layer.objectIdField;var p,_=(0,n.Z)(this.fields);try{for(_.s();!(p=_.n()).done;){var v=p.value;"global-id"===v.type&&(this.globalIdField=v.name)}}catch(g){_.e(g)}finally{_.f()}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=c.Bj.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"isTable",value:function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}},{key:"_isInFeatureSet",value:function(){return c.dj.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):(0,h.DB)(this._wset)}},{key:"_changeFeature",value:function(e){var t,r={},a=(0,n.Z)(this.fields);try{for(a.s();!(t=a.n()).done;){var i=t.value;r[i.name]=e.attributes[i.name]}}catch(l){a.e(l)}finally{a.f()}return new u.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:r})}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this,l="",s=!1;if(null!==n&&(l=n.constructClause(),s=!0),this.isTable()&&t&&null!==e&&""!==e){var u=new d.Z([],[],!0,null);return(0,h.DB)(u)}var o=new g.Z;return o.where=null===r?null===t?"1=1":"":(0,f.zR)(r,c.Bj.Standardised),o.spatialRelationship=this._makeRelationshipEnum(e),o.outSpatialReference=this.spatialReference,o.orderByFields=""!==l?l.split(","):null,o.geometry=null===t?null:t,o.returnGeometry=!0,o.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(o).then((function(e){if(null===e)return new d.Z([],[],s,null);i._checkCancelled(a);var t=[];return e.features.forEach((function(e){var r=e.attributes[i._layer.objectIdField];t.push(r),i._featureCache[r]=i._changeFeature(e)})),new d.Z([],t,s,null)}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_queryAllFeatures",value:function(){var e=this;if(this._wset)return(0,h.DB)(this._wset);var t=new g.Z;return t.where="1=1",this._ensureLoaded().then((function(){if(e._layer.source&&e._layer.source.items){var r=[];return e._layer.source.items.forEach((function(t){var n=t.attributes[e._layer.objectIdField];r.push(n),e._featureCache[n]=e._changeFeature(t)})),e._wset=new d.Z([],r,!1,null),e._wset}return e._layer.queryFeatures(t).then((function(t){var r=[];return t.features.forEach((function(t){var n=t.attributes[e._layer.objectIdField];r.push(n),e._featureCache[n]=e._changeFeature(t)})),e._wset=new d.Z([],r,!1,null),e._wset}))}))}},{key:"_getFeatures",value:function(e,t,r){var n=[];-1!==t&&void 0===this._featureCache[t]&&n.push(t);for(var a=e._lastFetchedIndex;a<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[a]]&&(e._known[a]!==t&&n.push(e._known[a]),n.length>r)));a++);return 0===n.length?(0,h.DB)("success"):(0,h.d1)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e){return(0,h.DB)(e)}},{key:"_stat",value:function(){return(0,h.DB)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return(0,h.DB)(!1)}},{key:"relationshipMetaData",value:function(){return[]}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}},{key:"queryAttachments",value:function(){return(0,h.DB)([])}},{key:"getFeatureByObjectId",value:function(e){var t=new g.Z;return t.where=this.objectIdField+"="+e.toString(),this._layer.queryFeatures(t).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getOwningSystemUrl",value:function(){return(0,h.DB)("")}},{key:"getIdentityUser",value:function(){return(0,h.DB)("")}}],[{key:"_cloneAttr",value:function(e){var t={};for(var r in e)t[r]=e[r];return t}},{key:"create",value:function(e,t){var a=e.layerDefinition.objectIdField,i=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",l=[];if(e.layerDefinition.types){var s,u=(0,n.Z)(e.layerDefinition.types);try{for(u.s();!(s=u.n()).done;){var o=s.value;l.push(_.Z.fromJSON(o))}}catch(O){u.e(O)}finally{u.f()}}var d=e.layerDefinition.geometryType;void 0===d&&(d=e.featureSet.geometryType||"");var c=e.featureSet.features,f=t.toJSON();if(""===a||void 0===a){var h,g=!1,m=(0,n.Z)(e.layerDefinition.fields);try{for(m.s();!(h=m.n()).done;){var F=h.value;if("oid"===F.type||"esriFieldTypeOID"===F.type){a=F.name,g=!0;break}}}catch(O){m.e(O)}finally{m.f()}if(!1===g){for(var w="FID",S=!0,k=0;S;){var b,I=!0,D=(0,n.Z)(e.layerDefinition.fields);try{for(D.s();!(b=D.n()).done;){if(b.value.name===w){I=!1;break}}}catch(O){D.e(O)}finally{D.f()}!0===I?S=!1:w="FID"+(++k).toString()}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:w,alias:w});for(var C=[],R=0;R<c.length;R++)C.push({geometry:e.featureSet.features[R].geometry,attributes:e.featureSet.features[R].attributes?this._cloneAttr(e.featureSet.features[R].attributes):{}}),C[R].attributes[w]=R;c=C,a=w}}var Z,T=[],x=(0,n.Z)(e.layerDefinition.fields);try{for(x.s();!(Z=x.n()).done;){var N=Z.value;N instanceof v.Z?T.push(N):T.push(v.Z.fromJSON(N))}}catch(O){x.e(O)}finally{x.f()}var E=d;switch(E){case"esriGeometryPoint":E="point";break;case"esriGeometryPolyline":E="polyline";break;case"esriGeometryPolygon":E="polygon";break;case"esriGeometryExtent":E="extent";break;case"esriGeometryMultipoint":E="multipoint"}var B,P=(0,n.Z)(c);try{for(P.s();!(B=P.n()).done;){var A=B.value;A.geometry&&A.geometry instanceof y.Z==0&&(A.geometry.type=E,void 0===A.geometry.spatialReference&&(A.geometry.spatialReference=f))}}catch(O){P.e(O)}finally{P.f()}var L={outFields:["*"],source:c,fields:T,types:l,typeIdField:i,objectIdField:a,spatialReference:t};return L.geometryType=E||"point",new r({layer:new p.default(L),spatialReference:t,isTable:null===E||""===E})}}]),r}(o.Z)},82279:function(e,t,r){r.d(t,{Z:function(){return s}});var n=r(37762),a=r(15671),i=r(43144);function l(e,t){return e===t?0:null===e?-1:null===t?1:e<t?-1:1}var s=function(){function e(t){(0,a.Z)(this,e);var r=t.split(",");this._fields=[],this._directions=[];for(var n=0;n<r.length;n++){var i=r[n].match(/\S+/g);this._fields.push(i[0]),2===i.length?"asc"===i[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}return(0,i.Z)(e,[{key:"constructClause",value:function(){for(var e="",t=0;t<this._fields.length;t++)0!==t&&(e+=","),e+=this._fields[t],1===this._directions[t]?e+=" ASC":e+=" DESC";return e}},{key:"order",value:function(e){var t=this;e.sort((function(e,r){for(var n=0;n<t._fields.length;n++){var a,i=t.featureValue(e.feature,t._fields[n],n),s=t.featureValue(r.feature,t._fields[n],n);if(0!==(a=1===t._directions[n]?l(i,s):-1*l(i,s)))return a}return 0}))}},{key:"scanForField",value:function(e){for(var t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}},{key:"replaceFields",value:function(t){for(var r="",a=0;a<this._fields.length;a++){0!==a&&(r+=",");var i,l=this._fields[a],s=(0,n.Z)(t);try{for(s.s();!(i=s.n()).done;){var u=i.value;if(l.toLowerCase()===u.field.toLowerCase()){l=u.newfield;break}}}catch(o){s.e(o)}finally{s.f()}r+=l,1===this._directions[a]?r+=" ASC":r+=" DESC"}return new e(r)}},{key:"featureValue",value:function(e,t,r){var n=e.attributes[t];if(void 0!==n)return n;for(var a in e.attributes)if(t.toLowerCase()===a.toLowerCase())return this._fields[r]=a,e.attributes[a];return null}}]),e}()},9997:function(e,t,r){r.d(t,{F:function(){return p},M:function(){return n}});var n={Base64:0,Hex:1,String:2,Raw:3};function a(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function i(e){for(var t=[],r=0,n=8*e.length;r<n;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<r%32;return t}function l(e){for(var t=[],r=0,n=32*e.length;r<n;r+=8)t.push(String.fromCharCode(e[r>>5]>>>r%32&255));return t.join("")}function s(e){for(var t="0123456789abcdef",r=[],n=0,a=4*e.length;n<a;n++)r.push(t.charAt(e[n>>2]>>n%4*8+4&15)+t.charAt(e[n>>2]>>n%4*8&15));return r.join("")}function u(e){for(var t=[],r=0,n=4*e.length;r<n;r+=3)for(var a=(e[r>>2]>>r%4*8&255)<<16|(e[r+1>>2]>>(r+1)%4*8&255)<<8|e[r+2>>2]>>(r+2)%4*8&255,i=0;i<4;i++)8*r+6*i>32*e.length?t.push("="):t.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>6*(3-i)&63));return t.join("")}function o(e,t,r,n,i,l){return a(function(e,t){return e<<t|e>>>32-t}(a(a(t,e),a(n,l)),i),r)}function d(e,t,r,n,a,i,l){return o(t&r|~t&n,e,t,a,i,l)}function c(e,t,r,n,a,i,l){return o(t&n|r&~n,e,t,a,i,l)}function f(e,t,r,n,a,i,l){return o(t^r^n,e,t,a,i,l)}function h(e,t,r,n,a,i,l){return o(r^(t|~n),e,t,a,i,l)}function y(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var r=1732584193,n=-271733879,i=-1732584194,l=271733878,s=0;s<e.length;s+=16){var u=r,o=n,y=i,p=l;r=d(r,n,i,l,e[s+0],7,-680876936),l=d(l,r,n,i,e[s+1],12,-389564586),i=d(i,l,r,n,e[s+2],17,606105819),n=d(n,i,l,r,e[s+3],22,-1044525330),r=d(r,n,i,l,e[s+4],7,-176418897),l=d(l,r,n,i,e[s+5],12,1200080426),i=d(i,l,r,n,e[s+6],17,-1473231341),n=d(n,i,l,r,e[s+7],22,-45705983),r=d(r,n,i,l,e[s+8],7,1770035416),l=d(l,r,n,i,e[s+9],12,-1958414417),i=d(i,l,r,n,e[s+10],17,-42063),n=d(n,i,l,r,e[s+11],22,-1990404162),r=d(r,n,i,l,e[s+12],7,1804603682),l=d(l,r,n,i,e[s+13],12,-40341101),i=d(i,l,r,n,e[s+14],17,-1502002290),r=c(r,n=d(n,i,l,r,e[s+15],22,1236535329),i,l,e[s+1],5,-165796510),l=c(l,r,n,i,e[s+6],9,-1069501632),i=c(i,l,r,n,e[s+11],14,643717713),n=c(n,i,l,r,e[s+0],20,-373897302),r=c(r,n,i,l,e[s+5],5,-701558691),l=c(l,r,n,i,e[s+10],9,38016083),i=c(i,l,r,n,e[s+15],14,-660478335),n=c(n,i,l,r,e[s+4],20,-405537848),r=c(r,n,i,l,e[s+9],5,568446438),l=c(l,r,n,i,e[s+14],9,-1019803690),i=c(i,l,r,n,e[s+3],14,-187363961),n=c(n,i,l,r,e[s+8],20,1163531501),r=c(r,n,i,l,e[s+13],5,-1444681467),l=c(l,r,n,i,e[s+2],9,-51403784),i=c(i,l,r,n,e[s+7],14,1735328473),r=f(r,n=c(n,i,l,r,e[s+12],20,-1926607734),i,l,e[s+5],4,-378558),l=f(l,r,n,i,e[s+8],11,-2022574463),i=f(i,l,r,n,e[s+11],16,1839030562),n=f(n,i,l,r,e[s+14],23,-35309556),r=f(r,n,i,l,e[s+1],4,-1530992060),l=f(l,r,n,i,e[s+4],11,1272893353),i=f(i,l,r,n,e[s+7],16,-155497632),n=f(n,i,l,r,e[s+10],23,-1094730640),r=f(r,n,i,l,e[s+13],4,681279174),l=f(l,r,n,i,e[s+0],11,-358537222),i=f(i,l,r,n,e[s+3],16,-722521979),n=f(n,i,l,r,e[s+6],23,76029189),r=f(r,n,i,l,e[s+9],4,-640364487),l=f(l,r,n,i,e[s+12],11,-421815835),i=f(i,l,r,n,e[s+15],16,530742520),r=h(r,n=f(n,i,l,r,e[s+2],23,-995338651),i,l,e[s+0],6,-198630844),l=h(l,r,n,i,e[s+7],10,1126891415),i=h(i,l,r,n,e[s+14],15,-1416354905),n=h(n,i,l,r,e[s+5],21,-57434055),r=h(r,n,i,l,e[s+12],6,1700485571),l=h(l,r,n,i,e[s+3],10,-1894986606),i=h(i,l,r,n,e[s+10],15,-1051523),n=h(n,i,l,r,e[s+1],21,-2054922799),r=h(r,n,i,l,e[s+8],6,1873313359),l=h(l,r,n,i,e[s+15],10,-30611744),i=h(i,l,r,n,e[s+6],15,-1560198380),n=h(n,i,l,r,e[s+13],21,1309151649),r=h(r,n,i,l,e[s+4],6,-145523070),l=h(l,r,n,i,e[s+11],10,-1120210379),i=h(i,l,r,n,e[s+2],15,718787259),n=h(n,i,l,r,e[s+9],21,-343485551),r=a(r,u),n=a(n,o),i=a(i,y),l=a(l,p)}return[r,n,i,l]}function p(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.Hex,r=t||n.Base64,a=y(i(e),8*e.length);switch(r){case n.Raw:return a;case n.Hex:return s(a);case n.String:return l(a);case n.Base64:return u(a)}}}}]);
//# sourceMappingURL=1786.425fb85f.chunk.js.map